<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-2024/archive-logs" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">【存档】log-xxx | Lucas Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://xbpk3t.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://xbpk3t.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://xbpk3t.github.io/2024/archive-logs"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="【存档】log-xxx | Lucas Blog"><meta data-rh="true" name="description" content="GMP"><meta data-rh="true" property="og:description" content="GMP"><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://xbpk3t.github.io/2024/archive-logs"><link data-rh="true" rel="alternate" href="https://xbpk3t.github.io/zh-Hans/2024/archive-logs" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://xbpk3t.github.io/2024/archive-logs" hreflang="en"><link data-rh="true" rel="alternate" href="https://xbpk3t.github.io/2024/archive-logs" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RV6E9N0CVW-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G0687BFERF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-G0687BFERF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Lucas Blog" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.22eca29c.css">
<script src="/assets/js/runtime~main.3ba128dd.js" defer="defer"></script>
<script src="/assets/js/main.82049043.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Hacking" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Hacking" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Hacking</b></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Archive</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">2024</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/2024/archive-logs">【存档】log-xxx</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/geektime-lessons">速读几本极客时间课程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/reading-methods">《聪明的阅读者》读书笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/monthly9">Monthly#9</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/mysql-lessons">《MySQL 45讲》读书笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/goreleaser">用 goreleaser 代替 changelogithub</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/tech-team-managing">《技术管理实战 36 讲》读书笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/flomo-bulk-delete">flomo批量删除脚本</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/deprecated-commands">【存档】备份一些repo命令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/alfred-vs">alfred-vs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024">s</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/running">running</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/Design-Pattern">设计模式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/code-spec">代码规范</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/regex">regex</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/ssh-protocol">ssh协议</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/tcpdump">tcpdump</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/xq">相亲</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/zhihu">知乎文章摘录</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/buy-byd-seal-06gt">【海豹06GT】购车记录</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/feed-manage-2">信息源管理2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/monthly8">Monthly#8</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/sun-zi">《孙子兵法》读书笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/system-design-interview">《搞定系统设计：面试敲开大厂的门》</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/how-to-write-commentary">《时评写作十讲》读书笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/how-to-write-book-review">怎么写书评？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/zai-zhi-tian-xia">《宰执天下》书评</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/wechat-read-app">微信读书APP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/golang-error">golang错误处理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/record-for-paris-olympics">巴黎奥运会纪录</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/sql">常用mysql sql整理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/pre-commit">为什么在CI中应该用pre-commit代替linters?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/argumentative-writing">议论文</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/feed-manage-1">信息源管理1（rss）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/shell-syntax">shell脚本常用语法</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/weekly13">Weekly#13</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/politics-of-legitimacy">《合法性的政治》读书笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2024/leng-jing">【Hac棱镜】文章合集</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">2023</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2023/weekly52">Weekly#52</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2023/weekly40">Weekly#40</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2023/kernel">《趣谈 Linux 操作系统》读书笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2023/network-protocol">network-protocol</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2023/secretary-work-handbook">《秘书工作手记》读书笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2023/capital-in-the-twenty-first-century">《21世纪资本论》读书笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2023/ru-zi-di">《孺子帝》读后感</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2023/renamer-tool">文件批量重命名工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/2023/feng-hua-marathon">复盘奉化马拉松</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">2000</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/minimalist">极简生活</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/books">books.yml</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs">docs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/movies">movies.yml</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/music">music常识</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tv">tv.yml</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/x">x</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">2024</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">【存档】log-xxx</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>【存档】log-xxx</h1><div class="container_mg8B margin-vert--md"><time datetime="2024-10-14">October 14, 2024</time></div></header><div class="toolbar_VBrL"></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gmp">GMP<a href="#gmp" class="hash-link" aria-label="Direct link to GMP" title="Direct link to GMP">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="进程线程用户态线程">进程、线程、用户态线程<a href="#进程线程用户态线程" class="hash-link" aria-label="Direct link to 进程、线程、用户态线程" title="Direct link to 进程、线程、用户态线程">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 协程是什么？为什么协程会被称为“用户态线程”？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 协程就是用户态线程，本质就是用户态自己切换 CPU，在协程这一层次，线程=CPU。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">线程分为内核态线程和用户态线程，用户态线程指的就是协程 (所以，狭义上，我们只把内核态线程称为线程)</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">，用户态线程需要绑定内核态线程，CPU 只能感知到内核态线程，感知不到用户  态线程。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 线程的调度是 OS 实现的，对开发者不可见，而协程是在用户态实现的，对开发者可见。这就是为什么协程会被称为“用户态线程”。我们自己可以控制协程的调度。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 因为协程会在函数被暂停执行时，保存函数的运行状态，并且可以从保存的状态中恢复并继续运行。这不就是 OS 对线程的调度吗？线程也可以被暂停，操作系统保存线程运行状态，然后去调度其他线程。此后，该线程再次被分配 CPU 时还可以继续运行，就像没有被暂停过一样。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 协程的使用场景？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">协程的使用场景，主要是 IO 密集型</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">。IO 密集型程序，CPU 利用率很低，使用协程，可以让用户按 照实际情况调度，充分利用 CPU，在当前多核 CPU 的架构中非常重要。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 协程和线程有哪几种映射关系？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">用户线程和内核线程</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`1:1`</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">，一个用户线程映射一个内核线程，所以用户空间的切换就涉及到内核线程的切换，1 个协程绑定 1 个线程，这种最容易实现。协程的调度都由 CPU 完成了，不存在 N:1 缺点，但有一个缺点是协程的创建、删除和切换的代价都由 CPU 完成，有点略显昂贵了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">用户线程和内核线程</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`N:1`</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">，</span><span class="token code-snippet code keyword" style="color:#00009f">`1:1 模型`</span><span class="token plain">的性能开销较大，而且受限于线程数量的限制，而</span><span class="token code-snippet code keyword" style="color:#00009f">`N:1`</span><span class="token plain">的模型在用户空间完成线程间的同步、销毁、切换，对于内核来说是完全透明的，不涉及线程的切换。N 个协程绑定 1 个线程，优点就是协程在用户态线程即完成切换，不会陷入到内核态，这种切换非常的轻量快速。但也有很大的缺点，1 个进程的所有协程都绑定在 1 个线程上，一是某个程序用不了硬件的多核加速能力，二是一旦某协程阻塞，造成线程阻塞，本进程的其他协程都无法执行了，根本就没有并发的能力了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">用户线程和内核线程</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`M:N`</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">，</span><span class="token code-snippet code keyword" style="color:#00009f">`N:1`</span><span class="token plain">的缺点是 OS 无法感知到用户态的线程，所以可能造成一个线程被阻塞，导致整个进程被阻塞挂掉，</span><span class="token code-snippet code keyword" style="color:#00009f">`M:N 模型`</span><span class="token plain">就解决了这个问题，也是实现原生协程的关键。M 个协程绑定 N 个线程，是 N:1 和 1:1 类型的结合，克服了以上 2 种模型的缺点，但实现起来最为复杂</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">两大思想</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 复用线程：协程本身就是运行在一组线程之上，不需要频繁的创建、销毁线程，而是对线程的复用。在调度器中复用线程还有 2 个体现：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1）work stealing，当本线程无可运行的 G 时，尝试从其他线程绑定的 P 偷取 G，而不是销毁线程。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2）hand off，当本线程因为 G 进行系统调用阻塞时，线程释放绑定的 P，把 P 转移给其他空闲的线程执行。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 利用并行：GOMAXPROCS 设置 P 的数量，当 GOMAXPROCS 大于 1 时，就最多有 GOMAXPROCS 个线程处于运行状态，这些线程可能分布在多个 CPU 核上同时运行，使得并发利用并行。另外，GOMAXPROCS 也限制了并发的程度，比如 GOMAXPROCS = 核数/2，则最多利用了一半的 CPU 核进行并行。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gmp-调度器">GMP 调度器<a href="#gmp-调度器" class="hash-link" aria-label="Direct link to GMP 调度器" title="Direct link to GMP 调度器">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><em>GMP 调度策略（不如说是 goroutine 的“生老病死”更合适，几个方面都概括到了）？</em></p><p><em>GMP 是 golang 实现 CSP 并发模型的一种方案</em></p><ul>
<li><code>G代表协程</code>，每次 go 调用的时候，都会创建一个协程对象</li>
<li><code>M代表内核线程Machine</code>，每次创建一个 M 的时候，都会有一个底层线程创建；所有的 G 任务，最终还是在 M 上执行</li>
<li><code>P代表  调度器Processor</code>，每个运行的 M 都必须绑定一个 P，就像线程必须在一个 CPU 核上执行一样</li>
</ul><p>线程由 CPU 调度是抢占式的，而协程由用户态调度是协作式的 (一个协程让出 CPU 之后，才执行下一个协程)</p></div></div>
<ul>
<li>GMP 模型里，G 和 M 直接绑定就可以了，为什么要有 P？(抢占式调度器相较于之前调度器的优势？) 能不能不要 P？为什么不在 M 上直接实现本地队列和工作窃取，而是用 P 实现？</li>
</ul>
<p><del>可以把 GMP 类比成生产线，G 就是流水线上的小工，M 就是流水线</del></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">scheduler 底层原理 #</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">实际上在操作系统看来，所有的程序都是在执行多线程。将 goroutines 调度到线程上执行，仅仅是 runtime 层面的一个概念，在操作系统之上的层面。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">有三个基础的结构体来实现 goroutines 的调度。g，m，p。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">g 代表一个 goroutine，它包含：表示 goroutine 栈的一些字段，指示当前 goroutine 的状态，指示当前运行到的指令地址，也就是 PC 值。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m 表示内核线程，包含正在运行的 goroutine 等字段。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p 代表一个虚拟的 Processor，它维护一个处于 Runnable 状态的 g 队列，m 需要获得 p 才能运行 g。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">当然还有一个核心的结构体：sched，它总览全局。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Runtime 起始时会启动一些 G：垃圾回收的 G，执行调度的 G，运行用户代码的 G；并且会创建一个 M 用来开始 G 的运行。随着时间的推移，更多的 G 会被创建出来，更多的 M 也会被创建出来。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">当然，在 Go 的早期版本，并没有 p 这个结构体，m 必须从一个全局的队列里获取要运行的 g，因此需要获取一个全局的锁，当并发量大的时候，锁就成了瓶颈。后来在大神 Dmitry Vyokov 的实现里，加上了 p 结构体。每个 p 自己维护一个处于 Runnable 状态的 g 的队列，解决了原来的全局锁问题。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Go scheduler 的核心思想是：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reuse threads；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">限制同时运行（不包含阻塞）的线程数为 N，N 等于 CPU 的核心数目；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">线程私有的 runqueues，并且可以从其他线程 stealing goroutine 来运行，线程阻塞后，可以将 runqueues 传递给其他线程。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gmp-changelog">GMP changelog<a href="#gmp-changelog" class="hash-link" aria-label="Direct link to GMP changelog" title="Direct link to GMP changelog">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">今天的 Go 语言调度器有着优异的性能，但是如果我们回头看 Go 语言的 0.x 版本的调度器会发现最初的调度器不仅实现非常简陋，也无法支撑高并发的服务。调度器经过几个大版本的迭代才有今天的优异性能，历史上几个不同版本的调度器引入了不同的改进，也存在着不同的缺陷：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">单线程调度器 · 0.x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 只包含 40 多行代码；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 程序中只能存在一个活跃线程，由 G-M 模型组成；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">多线程调度器 · 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 允许运行多线程的程序；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 全局锁导致竞争严重；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">任务窃取调度器 · 1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 引入了处理器 P，构成了目前的 G-M-P 模型；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 在处理器 P 的基础上实现了基于工作窃取的调度器；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 在某些情况下，Goroutine 不会让出线程，进而造成饥饿问题；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 时间过长的垃圾回收（Stop-the-world，STW）会导致程序长时间无法工作；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">抢占式调度器 · 1.2 </span><span class="token strike punctuation" style="color:#393A34">~</span><span class="token strike content"> 至今</span><br></span><span class="token-line" style="color:#393A34"><span class="token strike content"> 基于协作的抢占式调度器 - 1.2 </span><span class="token strike punctuation" style="color:#393A34">~</span><span class="token plain"> 1.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  通过编译器在函数调用时插入抢占检查指令，在函数调用时检查当前 Goroutine 是否发起了抢占请求，实现基于协作的抢占式调度；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Goroutine 可能会因为垃圾回收和循环长时间占用资源导致程序暂停；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 基于信号的抢占式调度器 - 1.14 ~ 至今</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  实现基于信号的真抢占式调度；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  垃圾回收在扫描栈时会触发抢占调度；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  抢占的时间点不够多，还不能覆盖全部的边缘情况；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">非均匀存储访问调度器 · 提案</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 对运行时的各种资源进行分区；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 实现非常复杂，到今天还没有提上日程；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">除了多线程、任务窃取和抢占式调度器之外，Go 语言社区目前还有一个非均匀存储访问（Non-uniform memory access，NUMA）调度器的提案。在这一节中，我们将依次介绍不同版本调度器的实现原理以及未来可能会实现的调度器提案。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">运行时 G-M-P 模型中引入的处理器 P 是线程和 Goroutine 的中间层，我们从它的结构体中就能看到处理器与 M 和 G 的关系：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">处理器持有一个由可运行的 Goroutine 组成的环形的运行队列 runq，还反向持有一个线程。调度器在调度时会从处理器的队列中选择队列头的 Goroutine 放到线程 M 上执行。如下所示的图片展示了 Go 语言中的线程 M、处理器 P 和 Goroutine 的关系。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">基于工作窃取的多线  程调度器将每一个线程绑定到了独立的 CPU 上，这些线程会被不同处理器管理，不同的处理器通过工作窃取对任务进行再分配实现任务的平衡，也能提升调度器和 Go 语言程序的整体性能，今天所有的 Go 语言服务都受益于这一改动。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Go 语言的调度器在最初的几个版本中迅速迭代，但是从 1.2 版本之后调度器就没有太多的变化，直到 1.14 版本引入了真正的抢占式调度才解决了自 1.2 以来一直存在的问题。在可预见的未来，Go 语言的调度器还会进一步演进，增加触发抢占式调度的时间点以减少存在的边缘情况。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gmp-运行机制调度流程golang-目前异步抢占的整体流程"><em>GMP 运行机制/调度流程：golang 目前异步抢占的整体流程？</em><a href="#gmp-运行机制调度流程golang-目前异步抢占的整体流程" class="hash-link" aria-label="Direct link to gmp-运行机制调度流程golang-目前异步抢占的整体流程" title="Direct link to gmp-运行机制调度流程golang-目前异步抢占的整体流程">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">给正在运行的两个线程命名为 M1 和 M2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">M1 发送中断信号 (</span><span class="token code-snippet code keyword" style="color:#00009f">`signalM(mp, sigPreempt)`</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">M2 收到信号，操作系统中断其执行代码，并切换到信号处理函数 (</span><span class="token code-snippet code keyword" style="color:#00009f">`sighandler(signum, info, ctxt, gp)`</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">M2 修改执行的上下文，并恢复到修改后的位置 (</span><span class="token code-snippet code keyword" style="color:#00009f">`asyncPreempt`</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">重新进入调度循环，而调度其他协程 (</span><span class="token code-snippet code keyword" style="color:#00009f">`preemptPark`</span><span class="token plain">和</span><span class="token code-snippet code keyword" style="color:#00009f">`gopreempt_m`</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> CHANGELOG</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 老调度器只有 M 和 G(全局协程队列)，存在很多问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 新调度器引入了</span><span class="token code-snippet code keyword" style="color:#00009f">`Processor`</span><span class="token plain">包含了运行协程的资源，如果线程想运行协程，需要先获取 P，P 中还包含了可运行的 G 队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`工作窃取 work stealing`</span><span class="token plain">是用来解决 process 的问题的，当 M 绑定的 P 没有可以运行的 G 时，可以从其他运行的 M，偷取 G</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">协作式的抢占式调度，基于信号的抢占式调度器</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="map">map<a href="#map" class="hash-link" aria-label="Direct link to map" title="Direct link to map">​</a></h2>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>本文可以看作是对 <a href="https://golang.design/go-questions/map/" target="_blank" rel="noopener noreferrer">hashmap | Go 程序员面试笔试宝典</a> 的整理和总结</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="golang-map的实现原理">golang map的实现原理<a href="#golang-map的实现原理" class="hash-link" aria-label="Direct link to golang map的实现原理" title="Direct link to golang map的实现原理">​</a></h3>
<p>在开始介绍golang map的实现原理之前，先用几个问题热热身，调动一下我们对于map的基本认知</p>
<ul>
<li>map有哪几种实现方法？hashtable和search-tree有啥区别？为啥目前大部分语言都用hashmap而非search-tree?</li>
<li>实现hashtable的keypoints?</li>
</ul>
<p><em><strong>keypoints 无非是 hash func, load factor, hash-collision, 双桶, 渐进式rehash</strong></em></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> hmap </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> count     </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> flags     </span><span class="token builtin">uint8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> B         </span><span class="token builtin">uint8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> noverflow </span><span class="token builtin">uint16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> hash0     </span><span class="token builtin">uint32</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> buckets    unsafe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pointer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> oldbuckets unsafe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pointer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> nevacuate  </span><span class="token builtin">uintptr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> extra </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mapextra </span><span class="token comment" style="color:#999988;font-style:italic">// optional fields</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>参照golang map源码就可以看到</p>
<ul>
<li>hash0 就是 hash func</li>
<li>buckets, oldbuckets 就是双桶</li>
<li>B 就是 load factor</li>
</ul>
<p>除此之外，就是 count, flags, noverflow, nevacuate</p>
<p>[map.png]</p>
<p>[bmap-ds.png]</p>
<p>可以看到bmap的kv不是 k/v/k/v/... 这种格式，而是 k/k/v/v/... 这种格式，是为了节省内存。因为k/v这种格式的话，每组之间都需要padding，如果 k/k/v/v 的话，则每个bucket共享一个padding即可</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">每个 bucket 设计成最多只能放 8 个 key-value 对，如果有第 9 个 key-value 落入当前的 bucket，那就需要再构建一个 bucket ，通过 overflow 指针连接起来。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">哈希表的每个桶都只能存储 8 个键值对，一旦当前哈希的某个桶超出 8 个，新的键值对就会存储到哈希的溢出桶中。随着键值对数量的增加，溢出桶的数量和哈希的装载因子也会逐渐升高，超过一定范围就会触发扩容，扩容会将桶的数量翻倍，元素再分配的过程也是在调用写操作时增量进行的，不会造成性能的瞬时巨大抖动。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>每个bucket(也就是bmap)只存储8个kv，超出就放到新bucket</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="遍历过程">遍历过程<a href="#遍历过程" class="hash-link" aria-label="Direct link to 遍历过程" title="Direct link to 遍历过程">​</a></h4>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="扩容机制">扩容机制<a href="#扩容机制" class="hash-link" aria-label="Direct link to 扩容机制" title="Direct link to 扩容机制">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">查看 hashGrow() 以及 渐进式扩容 growWork().</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">当 map 的负载因子超过预设的阈值（通常是 6.5）或者溢出桶（overflow buckets）数量过多时，Go 会触发 map 的扩容机制。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">为什么需要扩容？</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"> 随着 map 中元素的增加，发生哈希冲突的概率会增加，Map 的读写性能也会下降，所以我们需要更多的桶和更大的内存来保证 Map 的读写性能。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">具体怎么扩容？有哪些扩容策略？</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"> 在实际应用中，当装载因子超过某个阈值时，会动态地增加 Map 长度，实现自动扩容。map 长度变化，所有 key 在 map 中对应的索引都需要重新计算；但是一次性完成扩容的性能太差，所以需要渐进式扩容；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`装载因子`</span><span class="token plain">和</span><span class="token code-snippet code keyword" style="color:#00009f">`溢出桶的数量`</span><span class="token plain">是决定哈希表是否进行扩容的关键指标；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 扩容实际上是以空间换时间的手段，在 map 将要添加、修改或者删除 key 时，都会检查是否需要扩容；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 扩容分为增量扩容和等量扩容；增量扩容，会直接把桶的个数增加一倍，把原来一个桶的 key 重新分配到两个桶中；等量扩容，不会更改桶的个数，只会把桶中的数据变得紧凑；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 扩容过程是渐进式的，主要是防止一次扩容需要搬迁太多 key，引发性能问题；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 触发扩容的时机是增加了新元素，桶搬迁的时机则发生在赋值、删除期间，每次最多搬迁两个桶。</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">查找、赋值、删除的一个很核心的内容是如何定位到 key 所在的位置，需要重点理解。</span><span class="token italic punctuation" style="color:#393A34">*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="缩容机制">缩容机制<a href="#缩容机制" class="hash-link" aria-label="Direct link to 缩容机制" title="Direct link to 缩容机制">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">伪缩容，因为map 的扩缩容的主要区别在于 hmap.B 的容量大小改变，而缩容由于 hmap.B 压根没变，内存空间的占用也是没有变化的（具体来说就是，在删除元素时，并不会释放内存），所以一定不要往 golang 的 map 中塞入太多数据。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">若是扩容，则 bigger 为 1，也就是 B+1。代表 hash 表容量扩大 1 倍。不满足就是缩容，也就是 hash 表容量不变。可以得出结论：map 的扩缩容的主要区别在于 hmap.B 的容量大小改变。而缩容由于 hmap.B 压根没变，内存空间的占用也是没有变化的。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="swissmaptype">SwissMapType<a href="#swissmaptype" class="hash-link" aria-label="Direct link to SwissMapType" title="Direct link to SwissMapType">​</a></h3>
<p><a href="https://groups.google.com/g/golang-checkins/c/YkzdsibwrPg?pli=1" target="_blank" rel="noopener noreferrer">[go] all: split old and swiss map abi and compiler integration</a></p>
<p><a href="https://go-review.googlesource.com/c/go/+/580779" target="_blank" rel="noopener noreferrer">all: split old and swiss map abi and compiler integration (580779) · Gerrit Code Review</a></p>
<p><a href="http://pekue.top/2023/03/14/tool_swissmap/" target="_blank" rel="noopener noreferrer">SwissMap(Go外部哈希表)</a></p>
<p>把之前的 src/runtime/hashmap.go 拆成了 src/runtime/map_noswiss.go 和 src/runtime/map_swiss.go 两个，为了更好的compiler编译</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="syncmap">sync.Map<a href="#syncmap" class="hash-link" aria-label="Direct link to sync.Map" title="Direct link to sync.Map">​</a></h3>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="syncmap-1">sync.Map<a href="#syncmap-1" class="hash-link" aria-label="Direct link to sync.Map" title="Direct link to sync.Map">​</a></h3>
<p>优点：</p>
<ul>
<li><em>通过读写分离，降低锁时间来提高效率，尤其适合读多写少的场景</em></li>
<li>空间换时间。通过冗余的两个数据结构 (read、dirty)，实现加锁对性能的影响</li>
<li>使用只读数据 (read)，避免读写冲突。</li>
<li>动态调整，miss 次数多了之后，将 dirty 数据提升为 read。</li>
<li>double-checking。</li>
<li>延迟删除。删除一个 kv 只是打标记，只有在提升 dirty 的时候才清理删除的数据。</li>
<li>优先从 read 读取、更新、删除，因为对 read 的读取不需要锁。</li>
</ul>
<p>缺点：</p>
<p><em>sync.Map 不适于大量写的场景（  读操作性能好）</em>，这样会导致 read map 时读不到数据而进一步加锁读取，而 dirty map 也会一直晋升为 read map，整体性能较差</p>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 实现</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">实际上 sync.Map 有两个 map 构成，一个用于读（dirty），一个用于写（read）。用于写的叫 dirty，采用互斥锁进行加锁，对于只读的数据会先读提供读的 map，然后才会去读 dirty。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">为了优化 sync.Map 的性能，还提供了一个 missed 计数，用于来决策何时将 dirty 中的元素变成只读的 map 元素等操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> read 和 dirty 是共享内存的，尽量减少冗余内存的开销。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> read 是原子性的，可以并发读，写需要加锁。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 读的时候先 read 中取，如果没有则会尝试去 dirty 中读取（需要有标记位 readOnly.amended 配合）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> dirty 就是原生 Map 类型，需要配合各类锁读写。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 当 read 中 miss 次数等于 dirty 长度时，dirty 会提升为 read，并且清理已经删除的 k-v（延迟更新，具体如何清理需要 enrty 中的 p 标记位配合）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 双检查（在加锁后会再次对值检查一遍是否依然符合条件）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> sync.Map 适用于读多写少的场景。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> sync.Map 没有提供获取长度 size 的方法，需要通过遍历来计算。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 对比</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> map 不支持并发是因为当赋值和删除时，是置写操作位。当 置了之后有别的协程用任何操作进行时都会报错。如果想要 map 线程安全，解决方案是用 sync.map，或者互斥锁/读写锁+map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> sync.map 使用了读写分离来去保证线程安全的，sync.map 的数据结构分为读 map、写 map、还有互斥锁以及一个记录穿透次数的值。具体实现是每个协程来读取时，都会先读取读部分的 kv，没有则去读写部分的 kv(操作写部分时都会上锁)。当穿透到写部分的次数大于写部分的长度时，就会将写部分同步到读部分，并且把写部分清空。所以多协程下一般都会先打到无锁的读部分，这能保证读取性能。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">主要是基于性能考虑，如果只是为少数程序增加安全性，导致 map 所有的操作都要处理 mutex，将会降低大多数程序的性能。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ref">ref<a href="#ref" class="hash-link" aria-label="Direct link to ref" title="Direct link to ref">​</a></h3>
<ul>
<li><a href="https://draveness.me/golang/docs/part2-foundation/ch03-datastructure/golang-hashmap/" target="_blank" rel="noopener noreferrer">map| Go 语言设计与实现</a></li>
</ul>
<p><a href="https://blog.csdn.net/tptpppp/article/details/103510214" target="_blank" rel="noopener noreferrer">Redis和Go中map的异同_go的map 和 redis的map实现有啥共同点吗-CSDN博客</a></p>
<p><a href="https://www.cnblogs.com/williamjie/p/11205593.html" target="_blank" rel="noopener noreferrer">redis渐进式rehash机制 - 割肉机 - 博客园</a></p>
<p><a href="https://golang.design/go-questions/interface/iface-eface/" target="_blank" rel="noopener noreferrer">iface 和 eface 的区别是什么 | Go 程序员面试笔试宝典</a></p>
<p><a href="https://draveness.me/golang/docs/part2-foundation/ch03-datastructure/golang-array-and-slice/" target="_blank" rel="noopener noreferrer">Go 语言切片的实现原理 | Go 语言设计与实现</a></p>
<p><a href="https://github.com/cch123/golang-notes?tab=readme-ov-file" target="_blank" rel="noopener noreferrer">cch123/golang-notes: Go source code analysis(zh-cn)</a></p>
<p><a href="https://github.com/cch123/golang-notes/blob/master/map.md#%E5%88%A0%E9%99%A4" target="_blank" rel="noopener noreferrer">golang-notes/map.md at master · cch123/golang-notes</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="互斥锁-mutex">互斥锁 Mutex<a href="#互斥锁-mutex" class="hash-link" aria-label="Direct link to 互斥锁 Mutex" title="Direct link to 互斥锁 Mutex">​</a></h2>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> mutex 有哪两种模式？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`正常模式`</span><span class="token plain"> 阻塞等待的 goroutine 保存在 FIFO 队列中，唤醒的 goroutine 不直接拥有锁，需要与新来的 goroutine 竞争获取锁。因为新来的 goroutine 很多已经占有了 CPU，所以唤醒的 goroutine 在竞争中很容易输；但如果一个 goroutine 获取锁失败超过 1ms，则会将 Mutex 切换为饥饿模式。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`饥饿模式`</span><span class="token plain"> 直接将</span><span class="token code-snippet code keyword" style="color:#00009f">`等待队列中队头的 goroutine`</span><span class="token plain">直接解锁，新来的 goroutine 也不会尝试获得锁，而是直接插入到</span><span class="token code-snippet code keyword" style="color:#00009f">`等待队列的队尾`</span><span class="token plain">。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> *mutex 的实现机制？*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">临界区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">两个并发进程尝试访问相同的内存资源，他们访问内存的方式不是原子的，就会出现竞争;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">用 mutex 在临界区加锁，来保证内存访问不出错;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 为了避免线程安全问题，把一部分程序保护起来，这部分程序就称为“临界区”。临界区就是一个被共享的资源，或者说是一个整体的一组共享资源。（比如对数据库的访问、对某一个共享数据结构的操作、对一个 I/O 设备的使用、对一个连接池中的连接的调用）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">使  用互斥锁，限定临界区只能同时由一个线程持有</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">mutex 底层使用 atomic 包中的 CAS 操作来保证加锁时的原子性，CAS 底层就是通过 LOCK+CMPXCHGL 汇编指令实现的</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">每行代码都带注释，带你看懂 Go 互斥锁的源码</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzUzNTY5MzU2MA==&amp;mid=2247495599&amp;idx=1&amp;sn=688a32a841c08ab02d453cfcee77c95a</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="读写锁-rwmutex">读写锁 RWMutex<a href="#读写锁-rwmutex" class="hash-link" aria-label="Direct link to 读写锁 RWMutex" title="Direct link to 读写锁 RWMutex">​</a></h2>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 用读写锁解决在读多写少场景下，互斥锁的性能问题，也就是</span><span class="token code-snippet code keyword" style="color:#00009f">`readers-writers 问题`</span><span class="token plain">（同时有多个读或者多个写，但是只要有一个线程在执行写操作，其他线程都不能执行读写操作）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用场景：可以明确区分 reader 和 writer goroutine 的场景，且有大量的并发读、少量的并发写，并且有强烈的性能需求，你就可以考虑使用读写锁替换互斥锁。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> RWMutex 的设计方案</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">RWMutex 使用</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`写优先`</span><span class="token italic content">方案，一个正在阻塞的 Lock 调用会排除新的 reader 请求到锁</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`读优先 read-preferring`</span><span class="token plain">读优先的设计可以提供很高的并发性。但是，在竞争激烈的情况下可能会导致写饥饿。因为，如果有大量的读，这种设计会导致只有所有的读都释放了锁之后，写才可能获取到锁。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`写优先 write-preferring`</span><span class="token plain">写优先的设计，如果已经有一个 writer 在等待请求锁的话，他会阻止新来的请求锁的 reader 获取到锁，所以优先保障 writer。当然，如果有一些 reader 已经 请求了锁，新请求的 writer 也会等待已经存在的 reader 都释放锁之后才能获取。所以，写优先级设计中的优先权，是针对新来的请求而言的。这种设计主要为了避免 writer 的饥饿问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`不指定优先级`</span><span class="token plain">这种设计比较简单，不区分 reader 和 writer 的优先级。</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">某些场景下这种不指定优先级的设计反而更有效，因为读优先会导致写饥饿，写优先会导致读饥饿。这种不指定优先级的访问，解决了饥饿的问题。</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="syncwaitgroup">sync.WaitGroup<a href="#syncwaitgroup" class="hash-link" aria-label="Direct link to sync.WaitGroup" title="Direct link to sync.WaitGroup">​</a></h2>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> WaitGroup 是 sync 包用来做任务编排的并发原语。他解决的是</span><span class="token code-snippet code keyword" style="color:#00009f">`并发 - 等待`</span><span class="token plain">的问题。比如：我们要完成一个大的任务，需要使用并行的 goroutine 执行三个小任务，只有这三个小任务都完成，我们才能去执行后面的任务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> WaitGroup 阻塞等待的 goroutine，等三个小任务都完成了，再唤醒他们</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 要看懂 WaitGroup 的源码实现，我们需要有一些前置知识，例如</span><span class="token code-snippet code keyword" style="color:#00009f">`信号量`</span><span class="token plain">、</span><span class="token code-snippet code keyword" style="color:#00009f">`内存对齐`</span><span class="token plain">、</span><span class="token code-snippet code keyword" style="color:#00009f">`原子操作`</span><span class="token plain">、</span><span class="token code-snippet code keyword" style="color:#00009f">`移位运算`</span><span class="token plain">和</span><span class="token code-snippet code keyword" style="color:#00009f">`指针转换`</span><span class="token plain">等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 但其实 WaitGroup 的实现思路还是蛮简单的，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">通过结构体字段</span><span class="token code-snippet code keyword" style="color:#00009f">`state1`</span><span class="token plain">维护了两个计数器和一个信号量，计数器分别是通过</span><span class="token code-snippet code keyword" style="color:#00009f">`Add()`</span><span class="token plain">添加的子 goroutine 的计数值 counter，通过</span><span class="token code-snippet code keyword" style="color:#00009f">`Wait()`</span><span class="token plain">陷入阻塞的 waiter 数，信号量用于阻塞与唤醒 Waiter。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">当执行</span><span class="token code-snippet code keyword" style="color:#00009f">`Add(positive n)`</span><span class="token plain">时，counter +=n，表明新增 n 个子 goroutine 执行任务。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">每个子 goroutine 完成任务之后，需要调用</span><span class="token code-snippet code keyword" style="color:#00009f">`Done()`</span><span class="token plain">函数将 counter 值减 1，当最后一个子 goroutine 完成时，counter 值会是 0，此时就需要唤醒阻塞在</span><span class="token code-snippet code keyword" style="color:#00009f">`Wait()`</span><span class="token plain">调用中的 Waiter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> wg 常见错误用法？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">不要在循环里调用 wg.Wait()，否则会阻塞，导致无法执行后面的循环</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 通过 Add() 函数添加的 counter 数一定要与后续通过 Done() 减去的数值一致。如果前者大，那么阻塞在 Wait() 调用处的 goroutine 将永远得不到唤醒；如果后者大，将会引发 panic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> Add() 的增量函数应该最先得到执行。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 不要对 WaitGroup 对象进行复制使用。如果要复用 WaitGroup，则必须在所有先前的 Wait() 调用返回之后再进行新的 Add() 调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 计数器设置为负值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 不期望的 Add 时机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 前一个 wait 还没结束就重用 WaitGroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wg.Done 一定要写在 gofunc 里，一定要加 defer，确保在该区块内最后执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="golang-内存管理">golang 内存管理<a href="#golang-内存管理" class="hash-link" aria-label="Direct link to golang 内存管理" title="Direct link to golang 内存管理">​</a></h2>
<p><a href="https://mp.weixin.qq.com/s/qF5eiWYkcwTnZ2tFwpzx2Q" target="_blank" rel="noopener noreferrer">紧急下班：修炼内功---内存模型和垃圾回收，不焦虑打工指南</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651440710&amp;idx=2&amp;sn=3847c6a275fa09f9051fcab250c8b817#tocbar--1dhark4" target="_blank" rel="noopener noreferrer">万字长文图解 Go 内存管理分析：工具、分配和回收原理</a></p>
<p><a href="https://i6448038.github.io/2019/05/18/golang-mem/" target="_blank" rel="noopener noreferrer">图解Golang的内存分配 [ 菜刚RyuGou的博客 ]</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzUzNTY5MzU2MA==&amp;mid=2247497180&amp;idx=1&amp;sn=e4f5e0a92f6ddfeed65cb33efb1db977" target="_blank" rel="noopener noreferrer">看了这篇你会发现，你是懂Go内存分配的</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651453471&amp;idx=1&amp;sn=b30294daeee5bfaa9c5508be698dcd4d" target="_blank" rel="noopener noreferrer">超干货！彻底搞懂Golang内存管理和垃圾回收</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651453875&amp;idx=1&amp;sn=883e1b4ac26d62e2d15f96b426885cb0" target="_blank" rel="noopener noreferrer">一文彻底理解Go语言栈内存/堆内存</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="golang-的内存管理"><strong>golang 的内存管理？</strong><a href="#golang-的内存管理" class="hash-link" aria-label="Direct link to golang-的内存管理" title="Direct link to golang-的内存管理">​</a></h3>
<p>内存管理有哪些组件？golang 的内存管理组件？</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>内存管理=分配 + 回收</p><p><em>狭义上来说，内存管理只针对堆内存而言。栈内存  由编译器自动分配和回收（比如说栈上的函数参数、局部变量、调用函数栈），这些都自动随着函数创建而分配，随着函数执行完成而销毁。</em></p><ul>
<li>栈内存管理（由编译器管理）<!-- -->
<ul>
<li>堆内存管理（由开发者和编译器共同管理）</li>
<li>内存分配（申请内存，内存分配器 Allocator）</li>
<li>内存回收 GC</li>
</ul>
</li>
</ul></div></div>
<ul>
<li><em><code>内存管理器 TCMalloc</code>+<code>逃逸分析</code>+<code>垃圾回收</code></em></li>
<li>golang 的内存管理借鉴了 TCMalloc，但是随着 golang 的迭代，内存管理与 TCMalloc 不同的地方越来越多，但是<em>其主要思想、原理和概念都和 TCMalloc 一致</em></li>
</ul>
<hr>
<ul>
<li><code>mutator</code>用户程序</li>
<li><code>allocator</code>分配器</li>
<li><code>collector</code>收集器</li>
<li><em>当 mutator 申请内存时，会通过 allocator 申请新内存，而 allocator 会负责从堆中初始化相应的内存区域</em></li>
</ul>
<hr>
<p>内存管理组件</p>
<ul>
<li><code>mspan</code><em>内存管理的基础单元，直接存储数据的地方</em>，就是方便根据对象大小来分配使用的内存块，一共有 67 种类型，用来解决内存碎片问题，提高内存使用率</li>
<li><code>mcache</code><em>线程缓存，为每个逻辑处理器 P 提供一个本地 span 缓存</em>，每个运行期的协程都会绑定的一个 mcache(具体来讲是绑定的 GMP 并发模型中的 P，所以可以无锁分配 mspan)，mcache 会分配协程运行中所需要的内存空间 (mspan)</li>
<li><code>mcentral</code><em>中心缓存，被所有的逻辑处理器 P 共享</em>，mcentral 为所有 mcache 切分好后备的 mspan</li>
<li><code>mheap</code><em>页堆，可以认为是 golang 程序持有的整个堆空间，mheap 全局唯一</em>，还会管理闲置的 span，需要时向 OS 申请新内存</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tcmalloc- 是什么tcmalloc-怎么进行内存分配">TCMalloc 是什么？TCMalloc 怎么进行内存分配？<a href="#tcmalloc-是什么tcmalloc-怎么进行内存分配" class="hash-link" aria-label="Direct link to TCMalloc 是什么？TCMalloc 怎么进行内存分配？" title="Direct link to TCMalloc 是什么？TCMalloc 怎么进行内存分配？">​</a></h3>
<p>TCMalloc(Thread Caching Malloc)</p>
<p><em>TCMalloc 的核心思想是，切分内存多级管理降低锁粒度</em>(把内存切成几块，通过多级管理降低锁的粒度)；将可用的堆内存采用二级分配的方式进行管理：每个线程都会维护一个独立的内存池，进行内存分配时优先从该内存池中分配，当内存池不足时，才会向全局内存池申请，以避免不同线程对全局内存池的频繁竞争；</p>
<p>TCMalloc 把内存分成若干大小的 class 块，这种算法由于需要将对象的内存映射到最接近的 class，因此会有内存浪费的问题。但是分成的若干级别可以 free-lock 进行访问，这在多线程程序中，性能会大大提升。</p>
<p><em>使用多级缓存将对象大小分类，并按照类别使用不同的分配策略</em></p>
<hr>
<p><em>为每个线程预先分配一块缓存，线程申请小内存时，可以从缓存分配内存</em>，这样有 3 个好处：</p>
<ul>
<li><em>引入虚拟内存后，让内存的并发访问问题的粒度从多进程级别，降低到多线程级别</em>，这是快速分配内存的第一个层次</li>
<li>为线程预分配缓存需要进行一次系统调用，后续线程申请小内存时，从缓存分配，都是在用户态执行，没有系统调用，<em>缩短了内存总体的分配和释放时间</em>，这是快速分配内存的第二个层次</li>
<li>多个线程同时申请小内存时，从各自的缓存分配，访问的是不同的地址空间，无需加锁，<em>把内存并发访问的粒度进一步降低了</em>，这是快速分配内存的第三个层次</li>
</ul>
<hr>
<ul>
<li><code>对小于16B的微对象</code>(<code>tiny allocations</code>)，通过 mcache 分配，分配的对象都是不包含指针的，例如一些小的字符串和不包含指针的独立的逃逸变量等。</li>
<li><code>对大于32K的大对象</code>(<code>large allocations</code>)，通过 mheap 分配</li>
<li><code>对大于16B，小于32K的小对象</code>(<code>small allocations</code>)，从 mcache 到 mcentral 到 mheap 依次判断是否有可用块，如果有就分配，没有就向下一级申请。如果 mheap 依然没有，就向 OS 申请一系列新页，如果 mheap 有了，就根据 BestFit 算法找到最合适的 mspan，如果申请到的 mspan 超出申请大小，将会根据需求切分以返回所需页数，剩余页数构成一个新的 mspan，放回 mheap 的空闲列表</li>
</ul>
<hr>
<p>TCMalloc 内存管理</p>
<ul>
<li>线程内存</li>
<li>页堆</li>
</ul>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">TCMalloc may operate in one of two fashions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> (default) per-CPU caching, where TCMalloc maintains memory caches local to individual logical cores. Per-CPU caching is enabled when running TCMalloc on any Linux kernel that utilizes restartable sequences (RSEQ). Support for RSEQ was merged in Linux 4.18.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> per-thread caching, where TCMalloc maintains memory caches local to each application thread. If RSEQ is unavailable, TCMalloc reverts to using this legacy behavior.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NOTE: the “TC” in TCMalloc refers to Thread Caching, which was originally a distinguishing feature of TCMalloc; the name remains as a legacy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In both cases, these cache implementations allows TCMalloc to avoid requiring locks for most memory allocations and deallocations.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>所以现在TCMalloc应该改名为CCMalloc(CPU Caching Malloc)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="内存可见性和-happens-before">内存可见性和 happens-before<a href="#内存可见性和-happens-before" class="hash-link" aria-label="Direct link to 内存可见性和 happens-before" title="Direct link to 内存可见性和 happens-before">​</a></h3>
<p>前面操作的结果对后续操作是可见的，对逻辑顺序的保证，是 golang 给出的保证，只要遵守这 5 点准则，就能保证内存可见性，解决<code>协程并发安全问题</code></p>
<ul>
<li><code>go 初始化</code>，优先执行 init() 函数</li>
<li><code>协程创建和销毁</code>保证创建顺序，不保证销毁顺序</li>
<li><code>channel 的收发</code>，一共 4 条规则，不多说</li>
<li><code>locks</code></li>
<li><code>once</code></li>
</ul>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzUzNTY5MzU2MA==&amp;mid=2247496821&amp;idx=1&amp;sn=0bf417c024cfc3bb0467ebf34a0c22b1" target="_blank" rel="noopener noreferrer">Happens before 原则在 Go 内存模型中的应用举例</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="golang-内存结构">golang 内存结构<a href="#golang-内存结构" class="hash-link" aria-label="Direct link to golang 内存结构" title="Direct link to golang 内存结构">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>基于 TCMalloc</p></div></div>
<p>Go 在程序启动时 先向操作系统申请一块内存，并将其分配到三个区域：</p>
<ul>
<li>arena 区域 (512GB，64 位操作系统)，即堆区，Go 动态分配的内存都在该区域，其将内存分割成 8KB 大小的页，一些页组合起来称为 mspan</li>
<li>bitmap 区域 (16GB)，标识 arena 区域哪些地址保存了对象，并用 4bit   标志位表示对象是否包含指针、GC 标记信息。bitmap 中一个 byte 大小的内存对应 arena 区域中 4 个指针大小（指针大小为 8B）的内存，所以 bitmap 区域的大小是 512GB/(4*8B)=16GB</li>
<li>spans 区域 (512MB)：存放 mspan（arena 分割的页组合起来的内存管理基本单元）的指针，每个指针对应一页，所以 spans 区域的大小就是 512GB/8KB*8B=512MB。(除以 8KB 是计算 arena 区域的页数，而最后乘以 8 是计算 spans 区域所有指针的大小。创建 mspan 的时候，按页填充对应的 spans 区域，在回收 object 时，根据地址很容易就能找到它所属的 mspan)</li>
</ul>
<p>mspan 是 Go 内存管理的基本单元，mspan 是由一片连续的 8KB 的页组成的大块内存。这里的页和操作系统本身的页不是一回事，它一般是操作系统页大小的几倍。即 mspan 是一个包含起始地址、mspan 规格、页的数量等内容的双端链表</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="golang-others">golang others<a href="#golang-others" class="hash-link" aria-label="Direct link to golang others" title="Direct link to golang others">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="golang-changelog">golang CHANGELOG<a href="#golang-changelog" class="hash-link" aria-label="Direct link to golang CHANGELOG" title="Direct link to golang CHANGELOG">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> golang1.14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> interface 的菱形组合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> golang1.16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`go:embed`</span><span class="token plain">支持静态资源嵌入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 在 Linux 下的默认内存管理策略会从</span><span class="token code-snippet code keyword" style="color:#00009f">`MADV_FREE`</span><span class="token plain">改回</span><span class="token code-snippet code keyword" style="color:#00009f">`MADV_DONTNEED`</span><span class="token plain">策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 模块版本回撤</span><span class="token code-snippet code keyword" style="color:#00009f">`mod edit -retract=xxx`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 废弃 io/ioutil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 新增 io/fs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 调整 slice 的扩容策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> golang1.17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 编译器性能提升 5%，</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">从基于</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`Plan9 ABI`</span><span class="token italic content">的</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`堆栈调用约定`</span><span class="token italic content">改为</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`调用惯例`</span><span class="token italic content">，也就是，从原有的基于堆栈的函数参数和结果传递的方式改为基于寄存器的函数参数和结果传递</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">，在性能上，现在直接存储和计算都在寄存器上，和以前基于堆栈存储，再计算相比，现在这种模式势必是性能更优的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> gomod 的直接依赖和间接依赖分开，以及延时模块加载 (间接依赖模块在真正需要时才加载)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 切片转指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> golang1.18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 泛型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 给互斥锁加了 TryLock 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> fuzz test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> golang1.19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 内存模型：（这个没看懂，再看看）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 引入 Soft memory limit，来优化 GOGC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">万字长文告诉你 Go 1.19 中值得关注的几个变化</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651453407&amp;idx=1&amp;sn=97785ac0e80ad80b9c42f6021669656e</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> golang1.20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">golang1.20 是 golang1.18 之后最大的语法变化，其中最大的 feat 就是“允许切片直接转换为数组”和编译器优化技术 PGO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">slice 转数组（byte slice 和 string 的转换优化）</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 添加 interface 作为 Comparable 类型，之后就可以直接比较 interface 了（之前版本会编译报错，因为</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">golang 泛型里 comparable 这个类型约束有个坑，就是和 golang 里定义的可比较类型不一致</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">unsafe 包添加了 Slice() SliceData() String() StringData() 函数，用来构造和解构 slice  和 string</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token strike punctuation" style="color:#393A34">~~</span><span class="token strike content">值比较</span><span class="token strike punctuation" style="color:#393A34">~~</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> context 包添加 context.WithCancelCause() 支持自定义取消 </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">Go1.20 新特性：context 支持自定义取消原因</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651453958&amp;idx=1&amp;sn=a063f923ee4ebb53da951e18faee9628</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 拓展测试覆盖率 coverage 到应用整体</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> time 包加了三个时间 layout 格式常量，以后直接用</span><span class="token code-snippet code keyword" style="color:#00009f">`DateTime`</span><span class="token plain">/</span><span class="token code-snippet code keyword" style="color:#00009f">`DateOnly`</span><span class="token plain">/</span><span class="token code-snippet code keyword" style="color:#00009f">`TimeOnly`</span><span class="token plain">即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支持 wrapping 多个 errors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">除此之外还有：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 编译器优化技术 PGO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arean 手动管理内存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="process-thread-goroutine-区别"><em><strong>process, thread, goroutine 区别</strong></em><a href="#process-thread-goroutine-区别" class="hash-link" aria-label="Direct link to process-thread-goroutine-区别" title="Direct link to process-thread-goroutine-区别">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">谈到 goroutine，绕不开的一个话题是：它和 thread 有什么区别？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">参考资料【How Goroutines Work】告诉我们可以从三个角度区别：内存消耗、创建与销毀、切换。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">内存占用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">创建一个 goroutine 的栈内存消耗为 2 KB，实际运行过程中，如果栈空间不够用，会自动进 行扩容。创建一个 thread 则需要消耗 1 MB 栈内存，而且还需要一个被称为“a guard page”的区域用于和其他 thread 的栈空间进行隔离。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">对于一个用 Go 构建的 HTTP Server 而言，对到来的每个请求，创建一个 goroutine 用来处理是非常轻松的一件事。而如果用一个使用线程作为并发原语的语言构建的服务，例如 Java 来说，每个请求对应一个线程则太浪费资源了，很快就会出 OOM 错误（OutOfMemoryError）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">创建和销毀</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread 创建和销毀都会有巨大的消耗，因为要和操作系统打交道，是内核级的，通常解决的办法就是线程池。而 goroutine 因为是由 Go runtime 负责管理的，创建和销毁的消耗非常小，是用户级。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">切换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">当 threads 切换时，需要保存各种寄存器，以便将来恢复：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16 general purpose registers, PC (Program Counter), SP (Stack Pointer), segment registers, 16 XMM registers, FP coprocessor state, 16 AVX registers, all MSRs etc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">而 goroutines 切换只需保存三个寄存器：Program Counter, Stack Pointer and BP。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">一般而言，线程切换会消耗 1000-1500 纳秒，一个纳秒平均可以执行 12-18 条指令。所以由于线程切换，执行指令的条数会减少 12000-18000。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Goroutine 的切换约为 200 ns，相当于 2400-3600 条指令。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">因此，goroutines 切换成本比 threads 要小得多。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>基本上和我们上面总结的没啥区别，  主要还是上下文切换、创建和销毁的开销更小。也就是更灵活。</p>
<p>但是他说的寄存器不是很清楚</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>总结一下：</p><p>我们还是拿进程比做公司项目，线程和协程比做大项目下的子项目和某个功能的开发。</p><p>进程调度和线程调度从调度算法、上下文切换、调度机制等方面其实都没啥区别。比如说，调度算法都是 FIFO、SJPF、CFS、MLFQ、轮询之类的（本质上来说是 CPU 调度算法，而不是什么进程或者线程的调度算法），上下文切换也是类似的，调度机制也是类似，都是主动调度和被动调度两种。</p><p>但是一定需要注意的是，两者最本质的区别就是，进程是抢夺 CPU，线程则是抢夺进程（最终抢夺 CPU）。</p><p>项目之所以要分成多个子项目组，不也是为了能够并发执行吗？同样的，如果子项目一旦阻塞（没完成任务），那你整个项目（进程）就阻塞了。那么用户态线程就类似外包项目组，更灵活，随时可以创建、销毁，开销很低，并且即使阻塞，也不会导致整个进程阻塞。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用-golang-时可能导致内存泄漏的场景"><em>使用 golang 时，可能导 致内存泄漏的场景？</em><a href="#使用-golang-时可能导致内存泄漏的场景" class="hash-link" aria-label="Direct link to 使用-golang-时可能导致内存泄漏的场景" title="Direct link to 使用-golang-时可能导致内存泄漏的场景">​</a></h3>
<p>一些可能会导致内存泄漏的场景？</p>
<ul>
<li>切分字符串/切片导致暂时内存泄漏</li>
<li>未重置丢失的切片元素中的指针，导致暂时内存泄漏</li>
<li>协程被阻塞导致内存泄漏 (如果被临时阻塞就是临时内存泄漏，如果被永久阻塞就永久内存泄漏)</li>
<li>defer 调用函数导致暂时内存泄漏</li>
<li>没有停止不再使用的<code>time.Ticker</code>导致永久内存泄漏</li>
<li>不正确地使用<code>析构函数 finalizer</code>导致永久内存泄漏</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="common-misuses-of-chan"><strong>Common Misuses of chan?</strong><a href="#common-misuses-of-chan" class="hash-link" aria-label="Direct link to common-misuses-of-chan" title="Direct link to common-misuses-of-chan">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;操作&quot;: &quot;close&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;nil chan&quot;: &quot;panic&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;closed chan&quot;: &quot;panic&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;not nil, not closed chan&quot;: &quot;正常关闭&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;操作&quot;: &quot;`读 &lt;- ch`&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;nil chan&quot;: &quot;阻塞&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;closed chan&quot;: &quot;读到对应类型的零值&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;not nil, not closed chan&quot;: &quot;阻塞或正常读取数据。缓冲型 chan 为空或非缓冲型 channel 没有等待发送者时会阻塞&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;操作&quot;: &quot;`写 ch &lt;-`&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;nil chan&quot;: &quot;阻塞&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;closed chan&quot;: &quot;panic&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;not nil, not closed chan&quot;: &quot;阻塞或正常写入数据。非缓冲型 channel 没有等待接收者或缓冲型 channel buf 满时会被阻塞&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p><code>不要通过chan阻塞主协程</code>，主程序在<em>读取一个没有生产者的 channel 时会被判断为死锁</em>，如果是在新开的协程中是没有问题的，同理，主程序在<em>往没有消费者的协程中写入数据时也会发生死锁</em></p>
<ul>
<li>已关闭的 chan，读取时会返回 nil，不会被阻塞，所以在 seletc 中需要判断返回值是否不为 nil。</li>
<li><code>chan&lt;-</code>(只写的 chan) 可以被关闭，也就是说关闭 chan，应该是写入者的责任。多个写入者时，需要在外面使用一个 wg，等所有写入者完成之后再关闭。</li>
<li>time.After() 返回一个只读的 chan，不需要自己关闭。</li>
<li>两个协程使用两个无缓冲的 chan，互为读写来交换信息时，可能会死锁。解决方法是使用有缓冲的 chan，或者使用 context 来交互。(后者更好)</li>
</ul>
<hr>
<ul>
<li>chan 的哪些操作会引发 panic？三种</li>
</ul>
<hr>
<ul>
<li>主程序在读取一个没有生产者的 channel 时会被判断为死锁，如果是在新开的协程中是没有问题的，同理主程序在往没有消费者的协程中写入数据时也会发生死锁</li>
<li>当通道被两个协程操作时，如果一方因为阻塞导致另一放阻塞则会发生死锁，如下代  码创建两个通道，开启两个协程 (主协程和子协程)，主协程从 c2 读取数据，子协程往 c1，c2 写入数据，因为 c1，c2 都是无缓冲通道，所以往 c1 写时会阻塞，从 c2 读取时也会会阻塞，从而发生死锁</li>
<li>并发执行多个不依赖的服务</li>
<li>select 监听 pipeline，合并多个 pipeline 的值到一个</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="regex">regex<a href="#regex" class="hash-link" aria-label="Direct link to regex" title="Direct link to regex">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="正则表达式">正则表达式<a href="#正则表达式" class="hash-link" aria-label="Direct link to 正则表达式" title="Direct link to 正则表达式">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>注意两点：</p><ul>
<li>正则只列举语法没用，一定要把具体使用列出来</li>
<li>简单的字符使用不列举，只列举出贪婪模式/惰性模式/环视断言之类比较复杂的内容</li>
</ul></div></div>
<ul>
<li><a href="https://github.com/ziishaned/learn-regex/blob/master/translations/README-cn.md" target="_blank" rel="noopener noreferrer">learn-regex/README-cn.md at master · ziishaned/learn-regex</a></li>
<li><a href="https://tool.oschina.net/uploads/apidocs/jquery/regexp.html" target="_blank" rel="noopener noreferrer">正则表达式手册</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="基础">基础<a href="#基础" class="hash-link" aria-label="Direct link to 基础" title="Direct link to 基础">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">量词（重复次数）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`*`</span><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> 0n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`+`</span><span class="token plain"> + 1n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`?`</span><span class="token plain"> ? 01 表示可以不出现，比如</span><span class="token code-snippet code keyword" style="color:#00009f">`an?`</span><span class="token plain">可以匹配到</span><span class="token code-snippet code keyword" style="color:#00009f">`a`</span><span class="token plain">和</span><span class="token code-snippet code keyword" style="color:#00009f">`an`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`{}运算符`</span><span class="token plain"> 用来限定一个或一组字符可以重复出现的次数 </span><span class="token code-snippet code keyword" style="color:#00009f">`be{2}r`</span><span class="token plain"> 用来匹配 beer </span><span class="token code-snippet code keyword" style="color:#00009f">`be{3,}r`</span><span class="token plain">表示至少出现 3 次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> {m,n} 出现 m 到 n 次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">特殊单字符（简写字符集）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> \d 数字[0-9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> \D 非数字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> \w 字母数字下划线[a-zA-Z0-9_]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> \W 非字符数字下划线</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> \s 所有空格字符串[\t\n\f\r\p{Z}]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> \S 匹配除了空格以外的字符</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">空白符（其他项）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> . 任意字符（换行除外）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> \f 换页符</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> \n 换行符</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> \r 回车符</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> \t 制表符</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> \v 垂直制表符</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="特殊运算符">特殊运算符<a href="#特殊运算符" class="hash-link" aria-label="Direct link to 特殊运算符" title="Direct link to 特殊运算符">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">锚点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`^号`</span><span class="token plain">: 开头，插入符，表示开始匹配字符串，只匹配行首</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`$号`</span><span class="token plain">: 结尾，结束符，只匹配（该字符串）行尾的字符</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">范围</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`转义运算符\`</span><span class="token plain"> 匹配</span><span class="token code-snippet code keyword" style="color:#00009f">`特殊字符{ } [ ] / \ + * . $ ^ | ？`</span><span class="token plain">时，用来转义这些特殊字符</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`或运算符|`</span><span class="token plain"> 表示或者（比如用</span><span class="token code-snippet code keyword" style="color:#00009f">`(\*|\.)`</span><span class="token plain">匹配</span><span class="token code-snippet code keyword" style="color:#00009f">`(*) Asterisk.`</span><span class="token plain">中的</span><span class="token code-snippet code keyword" style="color:#00009f">`*`</span><span class="token plain">和</span><span class="token code-snippet code keyword" style="color:#00009f">`.`</span><span class="token plain">）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`点运算符.`</span><span class="token plain"> 匹配任意</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">单个字符</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">，但不匹配换行符</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`特征标群(...)`</span><span class="token plain"> () 被视为一个整体 </span><span class="token code-snippet code keyword" style="color:#00009f">`(?:):非捕获分组`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`be[^ou]r`</span><span class="token plain"> 不能是括号中的任意单个字符，反选匹配出</span><span class="token code-snippet code keyword" style="color:#00009f">`bear beor beer beur`</span><span class="token plain">中的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>或运算符</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// \d{15}|\d{18}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// \d{18}|\d{15}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>不保存子组</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// \d{15}(\d{3})?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// \d{15}(?:\d{3})?</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 非获取匹配 (non-capturing)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 非获取匹配是获取匹配的反面，在使用括号 () 的情况下，非获取匹配并不会作为匹配项返回</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// (也不能用于后向引用).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//   非获取匹配通常是为了使一个由多个字符组成的匹配项能够加上量词，却又不希望该匹配项会作为捕获的结果返回。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 非获取匹配使用 (?:).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;1234&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">^</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">$</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;1234&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;1234&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">^</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?:</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?:</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?:</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?:</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">$</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;1234&quot;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;1234&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">^</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?:</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?:</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">$</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;1234&quot;, &quot;2&quot;, &quot;3&quot;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;1234&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">^</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?:</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">{2}</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">$</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;1234&quot;, &quot;1&quot;, &quot;4&quot;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>分组引用</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 忽略大小写 + 分组引用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// (?i)cat \1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 正则表达式内引用从 \1 开始索引 (因为 \0 是 ASCII 里的空字符 NUL)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;12&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">^</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex backreference keyword" style="color:#00009f">\1</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">$</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;11&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">^</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex backreference keyword" style="color:#00009f">\1</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">$</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;11&quot;, &quot;1&quot;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// $&amp; 引用整个匹配到的字符串，可以用以下函数转义所有特殊字符。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">escapeRegExp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex char-class char-class-punctuation punctuation" style="color:#393A34">[</span><span class="token regex regex-source language-regex char-class" style="color:#36acaa">.*+?^${}()|[</span><span class="token regex regex-source language-regex char-class special-escape escape" style="color:#36acaa">\]</span><span class="token regex regex-source language-regex char-class special-escape escape" style="color:#36acaa">\\</span><span class="token regex regex-source language-regex char-class char-class-punctuation punctuation" style="color:#393A34">]</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;\\$&amp;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>替换时引用</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">替换时引用在replace的第二个参数里使用</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 从$1开始索引</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;1234&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">^</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">$</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;[$$]&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// $$ 用于代表原本的 $</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [$]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;1234&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">^</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">$</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;[$1][$2][$3][$4]&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [1][2][3][4]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;1234&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">^</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">$</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;[$&amp;]&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [1234]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;1234&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">^</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?:</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">$</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;[$1][$2][$3][$4]&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 第一个数字为非获取匹配</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [2][3][4][$4] 只匹配到 3 个，$4不存在</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>给正则添加注释</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 正则还可以通过 (?#xxx) 的形式添加注释</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// (\w+)(?#word) \1(?#word repeat again)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="模式修正符">模式修正符<a href="#模式修正符" class="hash-link" aria-label="Direct link to 模式修正符" title="Direct link to 模式修正符">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`忽略大小写i`</span><span class="token plain"> ignore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`全局搜索g`</span><span class="token plain"> global</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`多行修饰符m`</span><span class="token plain"> multiline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`贪婪匹配(默认)`</span><span class="token plain">和</span><span class="token code-snippet code keyword" style="color:#00009f">`惰性匹配？`</span><span class="token plain"> 正则默认贪婪匹配，用</span><span class="token code-snippet code keyword" style="color:#00009f">`.*?r`</span><span class="token plain">惰性匹配出</span><span class="token code-snippet code keyword" style="color:#00009f">`ber beer beeer`</span><span class="token plain">中的</span><span class="token code-snippet code keyword" style="color:#00009f">`ber`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 独占模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>惰性模式</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 惰性模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 在量词后加上 ? 将使得相关匹配项变成非贪婪模式，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 在非贪婪模式下匹配将尽可能匹配短内容，这会返回更多匹配项：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;12345&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;12345&quot;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;12345&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+?</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>多行匹配</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 多行匹配</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// m 标志位代表多行匹配，^和$将用于匹配任意行的开头和结尾，而不再是整个字符串的开头和结尾。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;1\n2\n3&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">^</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">$</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;1\n2\n3&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">^</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+</span><span class="token regex regex-source language-regex anchor function" style="color:#d73a49">$</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">mg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>具名捕获</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 具名捕获</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">[name1](url1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">[name2](url2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c"></span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> groups </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> text</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">matchAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex special-escape escape" style="color:#36acaa">\[</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?&lt;</span><span class="token regex regex-source language-regex group punctuation group-name variable" style="color:#36acaa">name</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">&gt;</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\S</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex special-escape escape" style="color:#36acaa">\]</span><span class="token regex regex-source language-regex special-escape escape" style="color:#36acaa">\(</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?&lt;</span><span class="token regex regex-source language-regex group punctuation group-name variable" style="color:#36acaa">url</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">&gt;</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\S</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex special-escape escape" style="color:#36acaa">\)</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">groups</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">groups</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>忽略大小写</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 如果用正则匹配，实现部分区分大小写，另一部分不区分大小写，这该如何操作呢？就比如说我现在想要，the cat 中的 the 不区分大小写，cat 区分大小写。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ((?i)the) cat</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// the cat</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// The cat</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// THE cat</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// thE cat</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// (?i)cat</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// cat CAT caT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="断言零宽度断言">断言（零宽度断言）<a href="#断言零宽度断言" class="hash-link" aria-label="Direct link to 断言（零宽度断言）" title="Direct link to 断言（零宽度断言）">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`正向先行断言?= 存在`</span><span class="token plain"> 比如用</span><span class="token code-snippet code keyword" style="color:#00009f">`\d+(?=PM)`</span><span class="token plain">匹配出</span><span class="token code-snippet code keyword" style="color:#00009f">`Date: 4 Aug 3PM`</span><span class="token plain">中的</span><span class="token code-snippet code keyword" style="color:#00009f">`3`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`负向先行断言?! 排除`</span><span class="token plain"> 用</span><span class="token code-snippet code keyword" style="color:#00009f">`(?&lt;=\$)\d+`</span><span class="token plain">匹配出</span><span class="token code-snippet code keyword" style="color:#00009f">`Product Code: 1064 Price: $5`</span><span class="token plain">中的</span><span class="token code-snippet code keyword" style="color:#00009f">`5`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`正向后发断言?&lt;= 存在`</span><span class="token plain"> 用</span><span class="token code-snippet code keyword" style="color:#00009f">`(?&lt;!\$)\d+`</span><span class="token plain">匹配出上面的</span><span class="token code-snippet code keyword" style="color:#00009f">`1064`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`负向后发断言?&lt;! 排除`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>正向断言</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 非获取匹配经常能代替正向断言。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// (?=)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 正向断言</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;Hello World&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">Hello</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?=</span><span class="token regex regex-source language-regex" style="color:#36acaa"> World</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;Hello&quot;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 非获取匹配</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;Hello World&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">Hello</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?:</span><span class="token regex regex-source language-regex" style="color:#36acaa"> World</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;Hello World&quot;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 正向断言做不到，因为断言之后的内容不可能同时是&quot; My &quot;和&quot;World&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;Hello My World&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">Hello</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?=</span><span class="token regex regex-source language-regex" style="color:#36acaa"> My </span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex" style="color:#36acaa">World</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 非获取匹配能做到，因为它是匹配</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;Hello My World&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">Hello</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?:</span><span class="token regex regex-source language-regex" style="color:#36acaa"> My </span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex" style="color:#36acaa">World</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;Hello My World&quot;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>正向否定断言</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// (?!)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;Hello Kitty&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">Hello</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?!</span><span class="token regex regex-source language-regex" style="color:#36acaa"> World</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;Hello&quot;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;Hello World&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">Hello</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?!</span><span class="token regex regex-source language-regex" style="color:#36acaa"> World</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 这是一句废话，因为断言之后的内容只能是&quot; Kitty&quot;, 必然不可能是&quot; World&quot;, 可以直接去掉断言部分。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;Hello Kitty&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">Hello</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?!</span><span class="token regex regex-source language-regex" style="color:#36acaa"> World</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex" style="color:#36acaa"> Kitty</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;Hello Kitty&quot;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>反向断言</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// (?&lt;=)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 和正向断言一样，非获取匹配经常能代替反向断言。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 反向断言</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;Hello World&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?&lt;=</span><span class="token regex regex-source language-regex" style="color:#36acaa">Hello </span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex" style="color:#36acaa">World</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;World&quot;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 非获取匹配</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;Hello World&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?:</span><span class="token regex regex-source language-regex" style="color:#36acaa">Hello </span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex" style="color:#36acaa">World</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;Hello World&quot;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 反向断言做不到，因为断言之前的内容不可能同时是&quot;Hello&quot;和&quot; My &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;Hello My World&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">Hello</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?&lt;=</span><span class="token regex regex-source language-regex" style="color:#36acaa"> My </span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex" style="color:#36acaa">World</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 非获取匹配能做到</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;Hello My World&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">Hello</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?:</span><span class="token regex regex-source language-regex" style="color:#36acaa"> My </span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex" style="color:#36acaa">World</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;Hello My World&quot;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>反向否定断言</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 反向否定断言 (Negative lookbehind assertion)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// (?&lt;!)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;Hello World&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?&lt;!</span><span class="token regex regex-source language-regex" style="color:#36acaa">Hello </span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex" style="color:#36acaa">World</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;Goodbye World&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?&lt;!</span><span class="token regex regex-source language-regex" style="color:#36acaa">Hello </span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex" style="color:#36acaa">World</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;World&quot;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 这是一句废话，因为断言前面只能是&quot;Goodbye &quot;, 必然不可能是&quot;Hello &quot;, 可以直接去掉断言部分。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&#x27;Goodbye World&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">Goodbye </span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">(?&lt;!</span><span class="token regex regex-source language-regex" style="color:#36acaa">Hello </span><span class="token regex regex-source language-regex group punctuation" style="color:#393A34">)</span><span class="token regex regex-source language-regex" style="color:#36acaa">World</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [&quot;Goodbye World&quot;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 零宽断言/环视断言</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// (?&lt;!\d)\d{6}(?!\d)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// (?&lt;!\w)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="unicode">unicode<a href="#unicode" class="hash-link" aria-label="Direct link to unicode" title="Direct link to unicode">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">正则匹配 unicode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emoji</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/\p{Emoji}/u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">汉字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/\p{Han}/u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">等价于</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/\p{Script=Han}/u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/\p{General_Category=Letter}/u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">该模式不匹配数字和各种语言使用的标点符号。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="docker">docker<a href="#docker" class="hash-link" aria-label="Direct link to docker" title="Direct link to docker">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>我说说我对docker的想法，docker=namespace+cgroup+rootfs+容器引擎。其中namespace和cgroup  都是直接通过linux kernel实现的。network则是通过flannel和calico实现的，而flannel实际上是通过linux 的overlay实现的，而calico则是通过netfilter实现的。这三点是docker底层的核心，除此之外的rootfs、容器image格式和runtime就不太重要了。我的理解对吗？</p></div></div>
<hr>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>什么是容器？docker 解决了哪些痛点？docker 容器怎么保证隔离性？</p><p>容器 = cgroup(资源控制) + namespace(访问隔离) + rootfs(文件系统隔离。镜像的本质就是一个 rootfs 文件) + 容器引擎 (生命周期控制)</p></div></div>
<p>docker 解决了虚拟化的两大痛点</p>
<ul>
<li>namespace: 运行环境启动速度慢（提效）</li>
<li>cgroup: 资源利用率低（降费）</li>
</ul>
<p>docker 容器是怎么保证“进程使用的资源是被隔离的”？</p>
<hr>
<p>cgroup: cpu、cpuset、cpuacct、memory、device、freezer、blkio、pid</p>
<p><em>用 cgroup 来实现资源限制，docker 容器有两种 cgroup 驱动，一种是 systemd，另一种是 cgroupfs。</em></p>
<ul>
<li><code>systemd</code> systemd 是 cgroup 的一个驱动。这个驱动是因为 systemd 本身可以提供一个 cgroup 管理方式。所以如果用 systemd 做 cgroup 驱动的话，所有的写 cgroup 操作都必须通  过 systemd 的接口来完成，不能手动更改 cgroup 的文件。</li>
<li><code>cgroupfs</code> 比如说要限制内存是多少、要用 CPU share 为多少？其实直接把 pid 写入对应的一个 cgroup 文件，然后把对应需要限制的资源也写入相应的 memory cgroup 文件和 CPU 的 cgroup 文件就可以了</li>
</ul>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzI2ODAwMzUwNA==&amp;mid=2649296734&amp;idx=1&amp;sn=ec98a1fdbd011c5610bd5aa3537d23fb" target="_blank" rel="noopener noreferrer">彻底搞懂容器技术的基石：cgroup</a></p>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`mount`</span><span class="token plain">: mout namespace 就是保证容器看到的文件系统的视图，是容器镜像提供的一个文件系统，也就是说它看不见宿主机上的其它文件，除了通过 -v 参数 bound 的那种模式，是可以把宿主机上面的一些目录和文件，让它在容器里面可见的；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`uts`</span><span class="token plain">: 隔离了 hostname 和 domain；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`pid`</span><span class="token plain">: 保证了容器的 init 进程是以 1 号进程来启动的；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`network`</span><span class="token plain">: 除了容器用 host 网络这种模式之外，其他所有的网络模式都有一个自己的 network namespace 的文件；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`user`</span><span class="token plain">: 控制用户 UID 和 GID 在容器内部和宿主机上的一个映射，不过这个 namespace 用的比较少</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`ipc`</span><span class="token plain">: 控制了进程兼通信的一些东西，比方说信号量；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`cgroup`</span><span class="token plain">: 用 cgroup namespace 带来的一个好处是容器中看到的 cgroup 视图是以根的形式来呈现的，这样的话就和宿主机上面进程看到的 cgroup namespace 的一个视图方式是相同的；另 外一个好处是让容器内部使用 cgroup 会变得更安全。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/425747451" target="_blank" rel="noopener noreferrer">轻松理解 Docker 网络虚拟化基础之网络 namespace！ - 知乎</a></li>
<li><a href="https://mp.weixin.qq.com/s/ldAHGBfyXV0j21xxkx42wQ" target="_blank" rel="noopener noreferrer">容器技术的本质之 NameSpace</a></li>
</ul>
<hr>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>需要注意的是，docker就是直接使用了linux kernel的namespace和cgroup，没有自定义实现任何功能</p></div></div>
<hr>
<ul>
<li><em>docker 的网络模式有哪几种？</em></li>
<li>容器怎么对应用进行  打包？有哪几种方法？</li>
<li>使用 Flannel 解决什么问题？</li>
<li><em>calico 是什么？calico 的架构？calico 网络模型的设计思路？calico 网络的转发细节？</em></li>
</ul>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> docker 的网络模式有哪几种？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`host网络`</span><span class="token plain">直接使用宿主机网络，优点在于延迟低，缺点在于不能端口映射和自定义路由规则了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`container网络`</span><span class="token plain">使用这个网络模式，容器就和另一个容器共享一个 namespace，而不是和宿主机共享。这个容器不会创建自己的网卡，自己的 IP，而是和另一个容器共享网卡和 IP。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`bridge网络`</span><span class="token plain">是 docker 默认的网络模式，</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">这种模式下，除了分配隔离的网络 namespace 之外，docker 还会为所有的容器设置 IP</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">。当 Docker 服务器在主机上启动之后，会创建新的虚拟网桥 docker0，随后在该主机上启动的全部服务在默认情况下都与该网桥相连。对于单机模式，bridge 驱动已经可以满足基本的需求了。但是这种模式下容器使用 NAT 方式与外界通信，这就增加了通信的复杂性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`overlay网络`</span><span class="token plain">，overlay 驱动采用 IETF 标准的 VXLAN 方式，并且是 VXLAN 中被普遍认为最大规模的云计算虚拟化环境的 SDN controller 模式。使用 overlay 网络，还需要如 consul、etcd 或者 zk 之类的服务。启动 docker 时也许要额外参数来指定所使用的配置存储服务地址。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content url" style="color:#36acaa">[</span><span class="token italic content url content" style="color:#36acaa">iptables 及 docker 容器网络分析 - This Cute World</span><span class="token italic content url" style="color:#36acaa">](</span><span class="token italic content url" style="color:#36acaa">https://thiscute.world/posts/iptables-and-container-networks/#1-iptables-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5---%E5%9B%9B%E8%A1%A8%E4%BA%94%E9%93%BE</span><span class="token italic content url" style="color:#36acaa">)</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">轻松理解 Docker 网络虚拟化基础之 veth 设备！ - 知乎</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://zhuanlan.zhihu.com/p/411224778</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">深入理解 Linux 上软件实现的“交换机” - Bridge! - 知乎</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://zhuanlan.zhihu.com/p/421276975</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content url" style="color:#36acaa">[</span><span class="token italic content url content" style="color:#36acaa">聊聊容器网络和 iptables</span><span class="token italic content url" style="color:#36acaa">](</span><span class="token italic content url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2ODAwMzUwNA==&amp;mid=2649298134&amp;idx=2&amp;sn=241a065050cdd5326813b23772a515b3</span><span class="token italic content url" style="color:#36acaa">)</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker 容器通过 veth 连接到 bridge 上，bridge 负责在不同的“端口”之间转发数据包，实现 docker 之间互相通信</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">Docker 参考架构：设计可扩展、可移植的 Docker 容器网络</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651449964&amp;idx=2&amp;sn=3f1fa4c91ea630e516c2ba9d1feaba67</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> 容器打包应用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> flannel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">flannel-io/flannel: flannel is a network fabric for containers, designed for Kubernetes</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://github.com/flannel-io/flannel</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">使用 Flannel 解决什么问题？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">flannel 使用 UDP 实现 overlay 网络的方案，解决了 docker 的跨宿主机的连通性问题</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> flannel 用来解决容器跨主机互通的问题，这个解决方式其实和虚拟机的网络互通模型都是通过隧道的；但是 flannel 有一个非常好的模式，就是给不同的物理机设置不同的网段，这一点和虚拟机的 overlay 的模式完全不同</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 跨物理机的连通性问题，在虚拟机里有成熟的方案，就是 VXLAN，那么 Flannel 也用 VXLAN 呢？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">手工模拟实现 Docker 容器网络！ - 知乎</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://zhuanlan.zhihu.com/p/433060892</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">怎么从传统的 Linux 网络视角理解容器网络？</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzA5OTAyNzQ2OA==&amp;mid=2649749842&amp;idx=1&amp;sn=88ee2b2a7601fe68e61d2739c39bb540</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> calico</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">calico 是什么？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">calico 直接使用物理机作为路由器的模式</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">，这种模式没有虚拟化开销，性能比较高</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> calico 的主要组件包括路由，iptables 的配置组件 felix，路由广播组件 BGP speaker，以及大规模场景下的 BGP Route Reflector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 为了解决跨网段的问题，calico 还有一种 ipip 模式，也就是通过打隧道的方式，从隧道端点来看，将本来不是邻居的两台机器，变成相邻的机器；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">calico 的架构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 路由配置组件 felix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 路由广播组件 BGP speaker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 安全策略组件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 全连接复杂性与规模问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 跨网段访问问题，calico 模式还有一个问题，就是物理机跨网段的问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">calico 的核心在于不走 overlay 网络，不引入另外的网络性能损耗，而是将转发全部用三层网络的路由转发来实现</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">只不过具体的实现和上面的过程稍有区别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面文档里写的云山雾绕的，看不懂</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">能否给我讲讲容器网络的 flannel 和 calico？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">当然可以！flannel 和 calico 是两种常见的容器网络解决方案。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">Flannel</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"> 是一个为容器设计的虚拟网络层。它使用了一种称为 VXLAN（Virtual Extensible LAN）的技术来创建一个覆盖在现有物理网络之上的虚拟网络。Flannel 的主要目标是为容器提供一个简单且可靠的网络连接，使得容器可以在集群中通信。它通常用于在 Kubernetes 集群中创建 Overlay 网络。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Flannel 的工作原理如下：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 每个节点上都运行一个名为 flanneld 的代理程序，该程序负责创建和管理虚拟网络。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> flanneld 为每个节点分配一个唯一的子网（称为 flannel 子网）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 当容器创建时，flanneld 会为容器分配一 个唯一的 IP 地址，并将其路由到 flannel 子网上的其他节点。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">Calico</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"> 是另一种流行的容器网络解决方案，提供了一个高性能的容器网络和安全性策略引擎。Calico 的设计目标是为大规模容器和云原生环境提供高度可扩展的网络解决方案。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Calico 的工作原理如下：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 每个节点上都运行一个名为 calico-node 的代理程序，该程序负责虚拟网络的创建和管理。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> Calico 使用 BGP（Border Gateway Protocol）协议来路由容器之间的流量，它利用节点上的路由表来确定流量的路径。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> Calico 还支持网络策略，允许管理员定义网络访问控制规则，以确保容器之间的安全通信。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总结来说，Flannel 和 Calico 都是容器网络解决方案，旨在提供容器之间的可靠通信和网络安全。Flannel 使用 VXLAN 技术创建覆盖网络，而 Calico 使用 BGP 协议路由容器流量，并提供了网络策略功能。选择使用哪个解决方案通常取决于特定的使用案例和需求。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flannel 和 calico 和 linux kernel 有关系吗？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">是的，flannel 和 calico 与 Linux 内核有一定的关系。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">Flannel</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"> 依赖于 Linux 内核  中的一些网络功能和特性来实现虚拟网络。具体来说，它使用了 Linux 内核中的 Overlay 网络技术，例如 VXLAN（Virtual Extensible LAN）和 IPsec（Internet Protocol Security）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VXLAN 是一种提供覆盖网络的技术，它在 Linux 内核中实现了对虚拟网络的创建和管理。Flannel 使用 VXLAN 来创建容器之间的虚拟网络，使它们能够在不同的物理主机上进行通信。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IPsec 是一种网络安全协议，用于对通信进行加密和认证。Flannel 使用 IPsec 来提供容器之间的安全通信。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">Calico</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"> 也依赖于 Linux 内核中的一些网络功能来实现其容器网络和安全性策略。它使用 Linux 内核中的路由表来路由容器之间的流量，并使用 BGP（Border Gateway Protocol）协议来动态更新路由信息。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">此外，Calico 还使用 Linux 内核中的 Netfilter 框架来实现网络策略。Netfilter 是 Linux 内核中的一个功能强大的防火墙框架，它允 许管理员定义网络访问控制规则，以限制容器之间的通信。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">因此，flannel 和 calico 都依赖于 Linux 内核中的一些网络功能和特性来实现其容器网络解决方案。它们与 Linux 内核紧密集成，利用内核提供的功能来实现虚拟网络、路由和安全性。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>存储驱动 overlay2</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzI2ODAwMzUwNA==&amp;mid=2649298035&amp;idx=1&amp;sn=f50cedf24e69f0c0408a9a90ca166d30" target="_blank" rel="noopener noreferrer">聊聊 Docker 的存储驱动 Overlay2</a></p>
<hr>
<ul>
<li>docker 容器里的进程 pid 号是怎么申请出来的？具体流程？ <a href="https://mp.weixin.qq.com/s?__biz=MjM5Njg5NDgwNA==&amp;mid=2247490751&amp;idx=1&amp;sn=3bdb4a61db8b9361f91369a6c88a4e54" target="_blank" rel="noopener noreferrer">Docker 容器里进程的 pid 是如何申请出来的？</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dtm-分布式事务">DTM (分布式事务)<a href="#dtm-分布式事务" class="hash-link" aria-label="Direct link to DTM (分布式事务)" title="Direct link to DTM (分布式事务)">​</a></h3>
<ul>
<li>什么是分布式事务？为什么需要分布式事务？事务的 ACID 特性分别是什么？ <strong>技术选型：分布式事务的核心需求？有哪些常见的分布式事务解决方案？尝试对比，各自的适用场景？</strong></li>
<li><em>什么是 XA 协议？什么是 2PC？2PC 的缺点（2PC 为什么不好做水平拓展）？3PC 是啥？3PC 解决了 2PC 的哪些问题？3PC 和 2PC 有啥区别？</em></li>
</ul>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">基于分布式系统的 CAP 理论，我们就有了各种</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">在一致性和可用性之间做出权衡的分布式事务方案</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">常见的分布式事务的解决方案？有哪些保证分布式事务数据一致性的方案？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 2PC 提交 (基于 XA 协议)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 3PC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 1PC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> TCC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 基于消息的分布式事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">几种分布式事务方案的对比？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`一致性保证`</span><span class="token plain">XA&gt;TCC=SAGA&gt;事务消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`业务友好性`</span><span class="token plain">XA&gt;事务消息&gt;SAGA&gt;TCC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`性能损耗`</span><span class="token plain">XA&gt;TCC&gt;SAGA=事务消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> TCC: 适用于一致性要求较高的短事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> SAGA: 一致性要求较低的长事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> XA: 并发要求不高的事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 事务消息：不需要回滚的事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> XA 协议是分布式事务的规范协议，2PC 和 3PC 都是 XA 协议的实现，XA 协议定义了一个保证分布式事务数据一致性的模型，模型中包含全局事务管理器和资源管理器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`全局事务管理器`</span><span class="token plain"> 一般是数据库中间件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`资源管理器`</span><span class="token plain"> 是分布式集群每个服务对应的数据库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">2PC 就是吃饭 AA 制，3PC 则是对 AA 制有人逃单的兜底</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是 2PC？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 2PC 也依赖于日志，只要存储介质不出问题，2PC 就能够达到最终一致性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 2PC 有两种节点，1 个中心化协调者节点，和 N 个参与者节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 2PC 的两个阶段分别是什么？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 协调者询问所有参与者是否可以提交事务，所有参与者向协调者投票</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 协调者根据所有参与者的投票结果，做出是否事务可以全局提交的决定，并且通知所有的参与者执行该决定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 2PC 的缺点？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`数据不一致`</span><span class="token plain">2PC 不能水平拓展，基于两阶段提交的分布式事务在提交事务时需要在多个节点之间进行协调，这会导致事务在访问共享资源时发生冲突和死锁的概率增高，随着数据库节点的增多，这种趋势会越来越严重</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`同步阻塞`</span><span class="token plain">2PC 是一个阻塞的协议，在第二阶段，参与者在事务未提交之前，会一直锁定其占有的本地资源对象，直到收到来自协调者的 commit 指令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`单点故障`</span><span class="token plain">2PC 只有一个协调者，在第二阶段，参与者在收到协调者的进一步之前会一直锁住本地资源，如果唯一的协调者此时出现故障而崩溃掉之后，那么所有参与者都将无限期地阻塞下去，也就是一直锁住本地资源对象而导致其他进程无法使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`容错能力差`</span><span class="token plain">，比如在节点宕机或者超时的情况下，无法确定流程的状态，只能不断重试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`性能较差`</span><span class="token plain">，消息交互多，并且受最慢节点的影响</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 2PC 为什么不好做水平拓展？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 3PC 是什么？3PC 解决了 2PC 的哪些问题？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 3PC 比起 2PC，仅仅是</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">使用 </span><span class="token italic content code-snippet code keyword" style="color:#00009f">`超时回滚`</span><span class="token italic content">机制解决了</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`单点故障`</span><span class="token italic content">和</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`同步阻塞`</span><span class="token italic content">，没有根本的解决数据一致性问题</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 主要是为了解决 2PC 的阻塞问题，从原来的两个阶段拓展为三个阶段，并且增加了超时机制。3PC 只是解决了在异常情况下 2PC 的阻塞问题，但导致一次提交要传递 6 条消息，延时很大。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 3PC 是怎么解决 2PC 无法保证，在协调者和参与者都挂掉的情况下，节点恢复之后的数据一致性问题？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 2PC 和 3PC 的区别？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`阶段的区别`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 2PC 是提交事务请求以及执行事务请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 3PC 把 2PC 的提交事务请求拆成了 CanCommit 和 PreCommit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`超时判断`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 3PC 在协调者、参与者中都加入了超时判断机制，2PC 只有协调者有超时机制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 加入的超时机制在某种程度上解决了 2PC 的单点、阻塞问题 (但是并没有真正解决)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 3PC 在 commit 之前增加了 PreCommit，使得在参与者收不到确认时，依然可以从容地 commit 或者 rollback，避免资源锁定太久导致浪费。但是 3PC 同样存在很多问题，比如 </span><span class="token code-snippet code keyword" style="color:#00009f">`拜占庭将军问题`</span><span class="token plain">(因为很难通 过多次询问来解决系统间的分歧问题，尤其是在超时状态下互不信任的分布式网络)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> TCC(补偿事务)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> TCC 是什么？有什么优势？TCC 有哪些特点？TCC 的执行流程？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> TCC 是什么？TCC 有哪些特点？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> TryConfirmCancel</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">一次完整的交易由一系列微交易的 Try 操作组成，如果所有的 Try 操作都成功，最终由微交易框架来统一 Confirm，否则统一 Cancel，从而实现了类似经典两阶段提交协议（2PC）的强一致性</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">TCC 在保证强一致性的同时，最大限度提高系统的可伸缩性和可用性</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 位于业务服务层而非资源层，由业务层保证原子性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 没有单独的准备 (Prepare) 阶段，降低了提交协议的成本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> Try 操作 兼备资源操作与准备能力</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> Try 操作可以灵活选择业务资源的锁定粒度，而不是锁住整个资源，提高了并发度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> TCC 的执行流程？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`Try`</span><span class="token plain">：预留业务资源。Try 操作完成所有的子业务检查，预留必要的业务资源，实现与其  他事务的隔离</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`Confirm`</span><span class="token plain">：确认执行业务操作。Confirm 使用 Try 阶段预留的业务资源真正执行业务，而且 Confirm 操作满足幂等性，以遍支持重试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`Cancel`</span><span class="token plain">：取消执行业务操作。Cancel 操作释放 Try 阶段预留的业务资源，同样也满足幂等性</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 基于异步消息的分布式事务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">有哪些“基于异步消息的事务机制”？请分别概述，以及其区别？</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">有哪些“基于异步消息的事务机制”？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`本地消息表`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`事务消息`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">本地消息表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 把消息写入本地数据库，通过本地事务保证主事务和消息写入的原子性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 然后通过 pull 或者 push 模式，从业务获取消息并执行。如果是 push 模式，那么一般使用具有持久化功能的消息队列，从事务务订阅消息。如果是 pull 模式，那么从事务定时去拉取消息，然后执行。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> MongoDB 的写入就很像本地消息表，在 WriteConcern 为 w:1 的情况下，更新操作只要写到 oplog 以及 primary 就可以向客户端返回。secondary 异步拉取 oplog 并本地记录执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">事务消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">事务消息依赖于支持“事务消息”的消息队列（用消息中间件来实现 2PC，将本地事务和发消息都放在一个分布式事务里，保证要么本地操作成功，然后对外发送消息也成功，要么两者都失败）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这两种方式有什么区别？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 这两种方式的区别在于，怎么保证主事务的提交与消息发送这两个操作的原子性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 相比本地消息表的方式，事务消息由消息中间件保证本地事务与消息的原子性，不依赖于本地数据库存储消息。但实现了“事务消息”的消息队列比较少，还不够通用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 不管是本地消息表还是事务消息，都需要保证从事务执行且仅仅执行一次，exact once。如果失败，需要重试，但也不可能无限次的重试，当从事务最终失败的情况下，需要通知主业务回滚吗？但是此时，主事务已经提交，因此只能通过补偿，实现逻辑上的回滚，而当前时间点距主事务的提交已经有一定时间，回滚也可能失败。因  此，最好是保证从事务逻辑上不会失败，万一失败，记录 log 并报警，人工介入。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 刚性事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 柔性事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 本地事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 分布式事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 单阶段原子提交协议 (1PC)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 二阶段提交 (2PC)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 定义</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 原理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 性能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 恢复</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 缺陷</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> XA 标准接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 三阶段提交 (3PC)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> Paxos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> Basic-Paxos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> Multi-Paxos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> Raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 算法类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 锁并发控制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 时间戳并发控制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 乐观并发控制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 分布式事务与 paxos 算法，raft  算法有什么关系？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 事务的方案会有什么潜在问题？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 高并发易落地的分布式事务，是行业没有很好解决的难题，那怎么办呢？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 互联网的业务特点，数据量较大，并发量较大，经常使用拆库的方式提升系统的性能。如果进行了拆库，余额、订单、流水可能分布在不同的数据库上，甚至不同的数据库实例上，此时就不能用数据库原生事务来保证数据的一致性了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 补偿事务是一种常见的实践</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">几种分布式事务有啥区别？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这里有几种常见的分布式事务协议，它们在实现方式和一致性保证方面有所不同：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 2PC (Two-Phase Commit) 提交（基于 XA 协议）：2PC 是一种经典的分布式事务协议。它包含两个阶段：准备阶段和提交阶段。在准备阶段，事务协调者向所有参与者发送准备请求，并等待参与者的响应。如果所有参与者都准备好提交事务，事务协调者发送提交请求，否则发送中止请求。基于 XA 协议是一种实现 2PC 的方式，它使用了全局事务标识符（Global Transaction Identifier，简称 GTID）来跟踪和协调分布式事务的执行。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 3PC (Three-Phase Commit)：3PC 是对 2PC 的改进，旨在解决 2PC 的一些问题。3PC 引入了一个额外的阶段，即预提交阶段。在这个阶段，事务协调者会询问参与者是否可以预提交事务。如果所有参与者都可以预提交，那么在提交阶段将进行最终提交。否则，将进行中止操作。3PC 通过引入预提交阶段来减少参与者在等待阶段的阻塞时间，但仍然存在阻塞和单点故障的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 1PC (One-Phase Commit)：1PC 是一种基于阻塞的分布式事务协议。在 1PC 中，事务协调者直接向所有参与者发送提交请求，而无需进行准备和协调。这种协议的好处是没有额外的阻塞时间，但它依赖于参与者的可靠性，如果有参与者失败，会导致整个事务的失败。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> TCC (Try-Confirm-Cancel)：TCC 是一种补偿性的分布式事务协议。在 TCC 中，事务被分解为三个阶段：尝试（Try）、确认（Confirm）和取消（Cancel）。在尝试阶段，事务协调者会向参与者发送尝试请求，参与者会执行预操作，但不会真正提交。在确认阶段，事务协调者会向参与者发送确认请求，参与者将执行真正的提交操作。如果在任何阶段发生错误，事务协调者将发送取消请求，参与者执行回滚操作。TCC 提供了一种灵活的方式来处理分布式事务，但需要开发人员显式地编写补偿逻辑。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">5.</span><span class="token plain"> 基于消息的分布式事务：这是一种基于消息队列的分布式事务实现方式。在这种模式中，事务的操作被封装为消息，并通过消息队列进行传递。消息队列可以保证消息的可靠传递，并且具备一定程度的事务性。在这种模式下，事务的参与者通过订阅和处理消息来执行操作，并可以通过消息队列的机制来实现事务的一致性和隔离性。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这些分布式事务协议在实现复杂度、性能、可靠性和可扩展性等方面有所不同，选择适合的协议要根据具体应用场景和需求进行评估。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">能否理解为2PC实际上就是类似于mysql的2PC？原理上是类似的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">是的，你可以将分布式事务中的 2PC 协议类比为数据库中的 2PC。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在 MySQL 中，2PC 是指两阶段提交。它的工作方式与分布式事务中的 2PC 相似。在 MySQL 的 2PC 中，事务协调者充当事务的管理者，而参与者是数据库实例。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在准备阶段，事务协调者会向所有参与者发送准备请求，询问它们是否准备好进行提交。参与者会执行本地的预提交操作，并将准备好的响应发送回事务协调者。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在提交阶段，如果所有参与者都准备好提交，事务协调者会向所有参与者发送提交请求，要求它们执行最终的提交操作。如果有任何参与者未能准备好提交，事务协调者会向所有参与者发送中止请求，要求它们执行回滚操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">所以，从原理上来说，MySQL 的 2PC 和分布式事务中的 2PC 都涉及两个阶段的协调和提交操作。然而，分布式事务的 2PC 更为复杂，因为它需要处理网络通信、故障恢复和参与者的分布性等额外的挑战。此外，分布式事务的 2PC 还可以由不同的实现方式，如基于 XA 协议等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">尽管两者在原理上相似，但在实际应用中，分布式事务的 2PC 更具挑战性，需要解决更多的问题，并考虑分布式环境下的特殊情况。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">那DTM呢？现在我看这个是比较主流的分布式事务解决方案</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DTM（Distributed Transaction Manager）是一种主流的分布式事务解决方案之一。它是一个分布式事务管理器，用于协调和管理分布式环境中的事务。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DTM 提供了一种可靠的方式来处理分布式事务，它具备以下特点：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 分布式事务协调：DTM 充当事务协调者，负责协调参与者的操作，并确保所有参与者在事务中保持一致性。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 分布式事务日志：DTM 使用分布式事务日志来记录事务的状态和操作。这些日志可以用于故障恢复和回滚操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 高可用性和容错性：DTM 具备高可用性和容错性，可以处理参与者的故障，并保证事务的一致性。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 支持多种数据库和消息队列：DTM 可以与多种数据库和消息队列集成，使得它适用于各种不同的应用场景。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DTM 通过提供分布式事务管理功能，简化了开发人员在构建分布式系统时处理事务的复杂性。它可以用于各种分布式应用，如微服务架构、分布式数据库、分布式消息队列等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">需要注意的是，DTM 只是分布式事务解决方案中的一种，还有其他的解决方案如基于 Saga 模式的分布式事务、基于事件溯源的分布式事务等，每种解决方案都有其适用的场景和特点。选择合适的分布式事务解决方案需要考虑具体的需求和系统架构。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">但是，你知道的，我们会在一个项目中使用各种数据库，  比如postgres, mongo, elasticsearch, influxdb等等各种类型的数据库，分布式事务是怎么保证在这些数据库的数据一致性的呢？按照我的想法，分布式事务难道不应该是数据库服务本身应该提供的吗？比如说我们使用vitess实现mysql高可用，那vitess本身就应该给我们保证分布式事务的数据一致性。不是吗？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">你提出的观点是正确的。在一个项目中使用多种类型的数据库时，确保跨数据库的数据一致性是一个挑战。传统的分布式事务解决方案（如2PC）可能无法直接适用于不同类型的数据库。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">实际上，确保不同类型数据库之间的数据一致性是一个复杂的问题，需要考虑到各种因素，如数据库的特性、支持的事务模型、数据复制和同步机制等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">一种常见的做法是通过应用程序层面来实现分布式事务的数据一致性。应用程序可以使用分布式事务管理器（如DTM或其他框架）来协调不同数据库之间的操作，并在需要时进行回滚或撤销操作。这种方 式下，数据库服务本身并不提供对跨数据库的分布式事务的原生支持。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">例如，你提到的 Vitess 是一个用于扩展 MySQL 的分布式数据库中间件。Vitess 提供了分布式事务的支持，并提供了一些机制来确保数据的一致性，例如将事务操作路由到正确的分片、协调分片的提交或回滚等。这样，应用程序可以在使用 Vitess 时通过 Vitess 提供的机制来实现跨数据库的分布式事务的数据一致性。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总结起来，对于不同类型的数据库，确保跨数据库的数据一致性通常需要应用程序层面的支持，可能需要借助分布式事务管理器、分布式数据库中间件或其他相关工具和框架来实现。数据库服务本身并不一定提供原生的分布式事务支持，而是通过应用程序层面的协调和管理来保证数据的一致性。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="redis">redis<a href="#redis" class="hash-link" aria-label="Direct link to redis" title="Direct link to redis">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="redis-的-changelog">redis 的 CHANGELOG<a href="#redis-的-changelog" class="hash-link" aria-label="Direct link to redis 的 CHANGELOG" title="Direct link to redis 的 CHANGELOG">​</a></h3>
<p>只列出新 feature 以及比较重要的优化项</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> redis2.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支持 lua 脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支持 redis 的 benchmark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> redis2.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支持 PSYNC 部分重新复制替代原主从复制方案</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支持 redis-sentinel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> redis3.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支持 redis-cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> redis3.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支持 GEO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 优化 SDS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> redis4.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支持</span><span class="token code-snippet code keyword" style="color:#00009f">`异步多线程(BIO线程)`</span><span class="token plain">，主要是 LazyFree 异步删除机制 (比如 unlink、flushdb 和 flushall)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支持 PYSNC2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支持</span><span class="token code-snippet code keyword" style="color:#00009f">`自定义模块`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支持混合持久化（RDB-AOF 持久化）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> redis5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支持 stream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 优化 jemalloc 内存分配器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> redis6.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">支持</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`客户端缓存`</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">，客户端缓存的原理？怎么使用？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`ACL权限管理`</span><span class="token plain">替代 rename 来避免危险命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> Threaded IO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> Redis Cluster Proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`Disque消息队列`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="redis-服务调优有哪些方法"><strong>redis 服务调优，有哪些方法？</strong><a href="#redis-服务调优有哪些方法" class="hash-link" aria-label="Direct link to redis-服务调优有哪些方法" title="Direct link to redis-服务调优有哪些方法">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>其实这个问题没啥意思，服务调优分为两部分</p><p>linux本身优化（在下面），和redis配置调优（写到redis.conf里了）</p></div></div>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Redis 服务调优脚本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 设置最大内存限制为2GB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cli config </span><span class="token builtin class-name">set</span><span class="token plain"> maxmemory 2gb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 降低系统的swappiness值为10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 如果绑定 NUMA 亲和性，可以优化性能。但是生产环境千万不要绑定，否则当占用内存超过当前 node 后，会直接 swap，而不是使用其他 node 的内存，掉入`NUMA 陷阱`，严重拖慢 redis 性能。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sysctl</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">vm.swappiness</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 禁用THP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sh</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 安装并启用 NTP 时间同步服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt-get</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> ntp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> ntp start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 修改 ulimit 参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 注意：以下示例是修改当前终端窗口的 ulimit 值，不会永久生效</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">ulimit</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">65535</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 增加 TCP backlog 大小为511</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sysctl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-w</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">net.core.somaxconn</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">511</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 设置 redis 使用 swap 的时机</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 默认情况下，Linux 内核的 swappiness 值为 60。较高的值会导致内核更积极地使用交换空间，而较低的值会减少对交换空间的使用。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 请注意，这只会修改当前的 swappiness 值，并不会永久生效。如果希望永久更改 swappiness 值，你需要修改 /etc/sysctl.conf 文件，找到 vm.swappiness 行并将其更新为所需的值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sysctl</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">vm.swappiness</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">value</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 让修改生效</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sysctl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TCP backlog</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 要配置 Linux 的 TCP backlog 大小，可以通过修改 net.core.somaxconn 参数来实现。TCP backlog 是指 TCP 服务器监听时，允许处于等待连接状态的客户端的数量。较大的 backlog 数值可以提高服务器的并发连接能力。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sysctl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-w</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">net.core.somaxconn</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">value</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sysctl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>有哪些方法可以降低 redis 的内存使用？</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><em>这种问题也还是从底层和使用两方面来说</em></p><p>底层来说，redis 服务调优中的内存分配（jemalloc/THP/swap）、过期策略和淘汰策略都是为了降低内存使用。<em>这些都可以通过配置进行优化。</em></p><p>从使用上来说，需要选择适合的数据结构（比如说如果（value 为 bool 时）用 bitset 代替 set，用 stream 代替 list），redis 分库等方面。</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="跨平台方案">跨平台方案<a href="#跨平台方案" class="hash-link" aria-label="Direct link to 跨平台方案" title="Direct link to 跨平台方案">​</a></h2>
<p><em><a href="https://www.bilibili.com/video/BV1D8411o71k/" target="_blank" rel="noopener noreferrer">跨平台开发该不该用Flutter？2023年版Flutter全面解析_哔哩哔哩_bilibili</a></em> 视频不错，很喜欢这种娓娓道来的感觉</p>
<p>看这个视频时，我想到了两个问题：</p>
<ul>
<li>这几种移动端跨平台方案，从现在的视角来看是一地鸡毛。大家还是转回移动端原生语言的方案 。但是那个时候我们是真心认为“js统一大前端”的。</li>
<li>dart和ts都是对js类型支持的解决方案，那么为啥dart在和ts的竞争中失败了？</li>
</ul>
<p>这个视频也一下子把我拉回到6、7年前我刚刚入行的时候，那个时候移动端余温尚存，各种移动端跨平台方案层出不穷，大家都在讨论各种“三端一致”的方案。实话说如果不是这个视频，这部分记忆都要淡忘了。几种主流方案：</p>
<ul>
<li>移动端打包浏览器跨平台（比如Hbuilder, AppCan, Cordova）</li>
<li>react-native, uniapp(相当于vue的react-native)</li>
<li>flutter</li>
</ul>
<p>这三种方案各有优劣，第一种方案是最早的跨端方案，主打快糙猛，很快就被淘汰了。后两种方案，react-native以及uniapp这种就是用js来调用各种原生移动端语言的API的，可想而知，一定会存在适配问题，并且会很慢（因为走了两层，并且无论是js还是swift, OC, java, kotlin性能都不算很好）。flutter则使用dart实现，dart可以理解为某种js方言，flutter则是吸取了以上教训，直接自己（通过chrome的render engine, skia）实现各种移动端的UI，那么这种方案的问题也同样可想而知，生态问题！如果使用flutter就不能使用。</p>
<p><em>所以通过这两种解决方案，可以看到是左右为难，用粘合层来实现就会有性能问题，用类似flutter自己实现的方案则无法使用移动端现有生态。并且二者都会存在很多适配问题。</em></p>
<p><em>至于为啥到最后一地鸡毛，大概还是因为跨平台本身可能还是个伪需求</em>。某种开发者认为很重要，技术管理者认为一般重要，但是老板认为不重要的东西。并且确实以上三种方案从开发角度，也都离原生应用差的有点远，可能会有各种延迟、不适配之类的bug。总结来说就是老板认为不重要，开发者认为重要但是实现不了。最后一地鸡毛也就不奇怪了。</p>
<hr>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>TUI爱好者希望所有操作都能在terminal中完成，但是实际上效率并没有提升，不是吗？这些TUI都有更好的GUI alternatives，并且很多就只是个插件，属实没啥意义。</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rbac">RBAC<a href="#rbac" class="hash-link" aria-label="Direct link to RBAC" title="Direct link to RBAC">​</a></h2>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">有哪些权限控制方案？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">有哪些权限控制方案？什么是 RBAC？传统 RBAC 需要几张表？5 张，用户、角色、操作、及其三者之间的关系表 RBAC 有哪些变种？(RBAC96 模型)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> ACL 权限控制 基于访问控制列表的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> RBAC 权限控制 基于角色的权限控制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> Auth 权限控制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> DAC 自主访问控制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> MAC 强制访问控制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> ABAC 基于属性的访问控制模型，阿里云，AWS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RBAC 有哪些变种？(RBAC96 模型)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> RBAC0 模型；（最基础的 5 张表的 RBAC；）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> RBAC1 模型；引入了</span><span class="token code-snippet code keyword" style="color:#00009f">`角色继承关系`</span><span class="token plain">，即角色具有上下级的关系，角色间的继承关系可分为</span><span class="token code-snippet code keyword" style="color:#00009f">`一般继承关系`</span><span class="token plain">和</span><span class="token code-snippet code keyword" style="color:#00009f">`受限继承关系`</span><span class="token plain">，一个角色可以分配 n 个子角色；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> RBAC2 模型；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 添加了</span><span class="token code-snippet code keyword" style="color:#00009f">`责任分离关系`</span><span class="token plain">，对角色的约束控制；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 互斥角色</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 基数约束</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 先决条件角色</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> RBAC3 模型；</span><span class="token code-snippet code keyword" style="color:#00009f">`最全面的 RBAC 模型，基于 RBAC0，将 RBAC1 和 RBAC2 做了整合；`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 用户组模型；（这个有点奇怪；把用户组和角色挂起关系，管理员直接给用户组分配角色，用户加入用户组自动拥有该用户组下所有角色对应的所有权限；）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 适用于用户和角色非常多，而且很多用户有相同属性的情况，在用户和角色中间使用用户组来收束角色，举个例子：</span><span class="token code-snippet code keyword" style="color:#00009f">`n 个用户，平均每个用户 x 个角色，那么 RBAC0 就需要分配 nx 次，如果有 k 个用户组的话就是 k*(n+x) 次`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 分为</span><span class="token code-snippet code keyword" style="color:#00009f">`有上下级关系的用户组`</span><span class="token plain">和</span><span class="token code-snippet code keyword" style="color:#00009f">`普通用户组`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 基于</span><span class="token code-snippet code keyword" style="color:#00009f">`有上下级关系的用户组模型`</span><span class="token plain">拓展出的适用于大型 ERP 系统的</span><span class="token code-snippet code keyword" style="color:#00009f">`组织/职位/用户组模型`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="shop">shop<a href="#shop" class="hash-link" aria-label="Direct link to shop" title="Direct link to shop">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sku">sku<a href="#sku" class="hash-link" aria-label="Direct link to sku" title="Direct link to sku">​</a></h3>
<p>怎么设计 sku 系统的表</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">主表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 商品表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> sku 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> sku 属性表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 商品表对 sku 表一对多，sku 表对 sku 属性表一对多</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">拓展性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 分类表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 商品表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> sku 表（库存表）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 属性名表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 属性值表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 商品和属性的关联表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 商品和属性的筛选表（用 sql 全文检索实现筛选）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 商品搜索表</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>库存</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 有哪些场景需要库存回滚？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> （用户未支付）用户下单后后悔了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> （用户支付后取消）用户下单&amp;支付后后悔了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> （风控取消）风控识别到异常行为，强制取消订单</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> （耦合系统故障）比如提交订单时提单系统 T1 同时会调用积分扣减系统 X1、库存扣减系统 X2、优惠券系统 X3，假如 X1,X2 成功后，调用 X3 失败，需要回滚用户积分与商家库存。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 库存扣减有哪些方案？库存扣多了，怎么办？怎么保证不多扣？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 用“设置库存”替代“扣减库存”，以保证幂等性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用 CAS 乐观锁，在“设置库存”时加上原始库存的比对，避免数据不一致</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="购物车">购物车<a href="#购物车" class="hash-link" aria-label="Direct link to 购物车" title="Direct link to 购物车">​</a></h3>
<p>购物车的功能：</p>
<ul>
<li>把商品添加到购物车，即订购</li>
<li>删除购物车中已定购的商品</li>
<li>修改购物车中某一本图书的订购数量</li>
<li>清空购物车</li>
<li>显示购物车中商品清单及数量、价格</li>
</ul>
<hr>
<ul>
<li>购物车表怎么设计？</li>
<li>redis 实现购物车</li>
<li>怎么基于购物车实现简单的商品推荐？使用集合的“交并差集”，根据用户的购物车记录或者购买记录等等用户行为做一些商品推荐</li>
</ul>
<p>未登录用户添加商品到购物车，登录后，怎么合并购物车？</p>
<ul>
<li>未登录下加入购物车很简单，具体操作如下，服务端下发 key，客户端把 key 存本地，添加购物车时，服务端创建一个结构为<code>shopcart:notlogin:{key}</code>的 hash，值为<code>goodsId:{附加数据}</code>，再次添加时直接找到对应 key，往里面添加新数据就可以了</li>
<li>登录后合并购物车，具体操作如下，登录后异步任务，把上面的<code>shopcart:notlogin:{key}</code>的数据插入到数据库，和登录状态下的购物车数据合并，再 rewrite 到<code>shopcart:login:{userId}</code>里</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="订单模块">订单模块<a href="#订单模块" class="hash-link" aria-label="Direct link to 订单模块" title="Direct link to 订单模块">​</a></h3>
<p>订单模块的表设计：订单模块都有哪些 表？</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 主表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 购物车表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 订单表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 订单商品详情表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 附属表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 订单发票表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 订单物流表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 订单退货表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 收货地址表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 用于电话营销的订单模块的拓展设计</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 订单业务审核流程表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 订单提成表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 订单调度表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支付状态：未支付，已支付</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 物流状态：未发货，已发货，已签收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 订单状态：等待付款，等待发货，确认收货，交易完成，交易关闭</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 售后状态：申请售后，退款完成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>订单模块中订单状态和支付状态的关系？</p>
<p>tx_id 和 tx_code 分别是什么？有什么区别？</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> transaction_id 是我们项目里的交易号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> transaction_code 是支付成功后，这笔交易的 code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">一个 transaction_id 对应多个 transaction_code 么？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">一个 transaction_id 与 transaction_code 确实是一对多的关系。你可以再看下 pay_transaction_extension 这张表的注释。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">是否每次支付请求都生成一个新的 transaction_code（不重复）来解决重复支付问题，如果真的是重复提交支付请求并重复支付了，那么解决退款问题呢，具体退哪一笔？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">重复支付后具体退哪一笔？如果用户支付了两笔，你肯定会收到两个异步通知，那么最后收到的异步通知视为重复支付，对其进行退款。可以看这张表 pay_repeat_transaction。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这样如果用户重复多次申请支付，是不是导致 transaction_code 膨胀？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">关于膨胀的问题，可以对 code 设置一个生成次数，比如：2^6。因为一般超过这么多次还在发起请求要么是恶作剧，要么你支付服务出了故障。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>订单号</p>
<p>生成订单号，有哪些关键需求？订单号的生成规则？由什么组成？怎么生成订单号？有哪些方案？</p>
<ul>
<li><em>既需要控制订单号长度，又要保证高并发下订单号唯一</em></li>
<li><code>订单号长度</code>：不要超过 22 位</li>
<li><code>高并发</code>：保证百万级 qps 不重复</li>
<li><code>订单号唯一</code></li>
</ul>
<hr>
<ul>
<li><code>时间戳 14 位 + 用户 id8 位 (千万级用户)</code>为了保证安全性，可以<em>对用户 id 用 FNV 哈希算法取值</em>，并填充或者对该值进行位运算来<em>保证统一长度</em>
<ul>
<li>一定要使用完整用户 id，因为<em>取用户 id 前 n 位的碰撞概率很高</em></li>
<li>该方案天然支持分库分表下根据订单号查询、根据用户 ID 查询、根据商户号查询这三类核心查询，因为用户 id 是固定的，<code>hash(last6(orderId))%16</code>取模后  的值也是相同的 (<code>因子分表法</code>)，某个用户的所有订单都会分在同一个表，很容易查询</li>
</ul>
</li>
<li><code>snowflake</code>如果不需要时间串的话，可以直接使用 snowflake，不需要校验机制</li>
<li><code>时间戳 14 位 (精确到秒)+随机数串 8 位</code>，<em>但是使用随机数串，一定要有校验机制，而不是直接生成随机串</em>。所以，要做一个<code>随机串池</code>，加锁去取，来保证随机串唯一</li>
</ul>
<hr>
<p>订单号、交易号、流水号之间的关系？</p>
<ul>
<li>订单号是指客户下订单时系统生成的唯一编号</li>
<li>交易号是指客户完成支付后系统生成的唯一编号</li>
<li>流水号是指客户完成支付后第三方支付平台生成的唯一编号</li>
</ul>
<hr>
<ul>
<li>
<p>电商业务，订单号和流水号，通常是一对一的</p>
</li>
<li>
<p>如果一个订单需要多次支付，或者对不同业务方支付，或者存在退款的情况，就是一对多</p>
</li>
<li>
<p>如果多笔订单，需要汇总结算支付，就是多对一</p>
</li>
</ul>
<hr>
<p>订单拆分 (子订单)</p>
<ul>
<li>订单拆分的原因？拆单分为“物理拆单”和“逻辑拆单”两种。实际上，用户结算实际上是“合并付款”，用户付款结束后，我们把订单按照店铺拆单。这样退款的时候，实际上退的是某个店铺的子订单</li>
<li>订单拆分的原则是什么？不改变原始订单数据</li>
<li>怎么拆分订单？<!-- -->
<ul>
<li>如果是 B2C 如京东，<em>根据 sku 拆单，生成多条能关联到父订单的子订单</em></li>
<li>如果是 B2B2C 如淘宝，通常拆分两次，先根据商家拆单，再根据上加下 sku 拆单</li>
</ul>
</li>
<li>是否需要“订单合并”？</li>
<li>订单转移和订单拆分分别是什么？有什么关系？</li>
</ul>
<hr>
<p>退货退款</p>
<ul>
<li>用户自己支付了邮费，退货时，是否要退还用户邮费？这个问 题，要结合自己平台的调性和受众习惯出发，没必要把其他平台的规则完全套在自己平台上。</li>
<li>用户下单后退款，但是积分已经被使用掉了，怎么办？ <em>用户只有在确认收货后，积分才能被使用。用户下单后，积分冻结状态，只展示，但是无法使用</em>。这样就不存在下单后退款，积分却已经被使用的情况了</li>
<li>用户退款成功后，获得的积分是否要退还？如果目前该用户的总积分少于退还积分，怎么办？<!-- -->
<ul>
<li>要退还，否则就可以刷积分了</li>
<li>已抵扣的话，则差值直接从退款金额中抵扣</li>
</ul>
</li>
<li><em>积分兑换成功后，对积分兑换发起退货，怎么处理？比如积分兑换 -110 积分，退货后直接退还 110 积分，还是分别退还到原消费记录？</em> 应该退还到原消费记录，否则的话，就可以通过兑换再退货的方法，把即将到期的积分重新激活来薅羊毛。<em>积分应该遵循先进先出的原则，每笔积分的获得都是有时间记录的，不是简单的累加</em></li>
<li>什么情况下需要审核才能退款，什么情况下可以自动退款？</li>
<li>订单涉及到多商品 + 优惠券 + 积分，怎么退款？通常有三种方案<!-- -->
<ul>
<li><code>不支持单品退货，只能退整单</code>。金额退还，赠送积分扣掉，优惠券扣掉</li>
<li><code>退单品，退还该商品按比例分摊后的实际支付金额</code></li>
<li><code>退单品，直接退还该商品的售价</code>，重新计算优惠券分摊，从用户账户除了扣掉赠送积分，还要扣掉分摊后对应优惠券金额对应的积分数</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="营销活动模块">营销活动模块<a href="#营销活动模块" class="hash-link" aria-label="Direct link to 营销活动模块" title="Direct link to 营销活动模块">​</a></h3>
<ul>
<li>有哪些常见的营销活动形式？<!-- -->
<ul>
<li><em>折扣</em></li>
<li><em>满减</em></li>
<li><em>优惠券</em></li>
<li>满返</li>
<li>抽奖</li>
<li>换购，满 a 元，再加 b 元以换购价获得换购商品</li>
<li>买一送一</li>
</ul>
</li>
<li>抽奖活动发生超抽，怎么办？</li>
<li>账户体系/优惠券问题，一个账户怎么验证多个联系人信息？ <em>一定要记住，一个系统里唯一能确定用户的就是用户 id，不是什么手机号之类的；所以这种情况下，我们只要做一下 input 的手机号是否是该用户的验证，就可以了</em></li>
</ul>
<hr>
<p>优惠券</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 如何保证优惠券不超发？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 如何生成唯一的优惠券？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 如何应对大量的发券请求？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是折上折？怎么防止折上折？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 折上折就是同时满足 折扣和满减，并且有优惠券，那么同时享受三种折扣，这样就有薅羊毛的机会了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 优惠券发放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 活动统一发放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 用户操作触发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 活动页面发放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 订单满额发放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 邀请好友发放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 新用户注册发放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 优惠券使用规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 优惠券金额处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 优惠券状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 待使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 占用中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 已使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 已失效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 优惠券使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 叠加</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 金额判断</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 自动使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 优惠券的作用？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 拉新留存促活</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 用户分类，精准运营</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 降低用户对于价格的敏感度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么优化优惠券模块的代码？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">用策略 + 工厂优化优惠券模块代码</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">，优惠券模块用通过工厂模式去实例化不同的策略类，把策略类的方法统一调用来实现。我们通常把设计模式的粒度控制到模块级别。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">优惠券模块的表设计怎么做？</span><span class="token bold punctuation" style="color:#393A34">**</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="秒杀">秒杀<a href="#秒杀" class="hash-link" aria-label="Direct link to 秒杀" title="Direct link to 秒杀">​</a></h3>
<p>直接参考 <a href="https://github.com/zhongzhh8/SecKill-System" target="_blank" rel="noopener noreferrer">zhongzhh8/SecKill-System: 秒杀系统，高并发，Redis，Lua 脚本，Golang，Gin</a> 就可以了</p>
<p>怎么设计秒杀表？</p>
<ul>
<li>秒杀库存表 (商品库存 id，商品名称，商品库存数，秒杀开始时间，秒杀结束时间，记录创建时间)</li>
<li>秒杀记录表 (商品库存 id，手机号码，秒杀状态 1 秒杀失败 2 秒杀成功，秒杀时间)</li>
</ul>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 秒杀系统 - 基本认知</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 业务对于秒杀的期望</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 每个用户都能参与，但是有且仅有一次机会</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 参与的用户都是真实有效的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么保证每个用户只能参加一次？怎么保证秒杀过程中，用户的真实和有效？怎么做秒杀业务的请求合法性校验？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`接口限流`</span><span class="token plain">，对请求频率过快的用户进行限制，频率请求过快或者请求头异常的请求，返回图形验证码到前端（建议不要使用简单的数字验证码），触发人工解锁，确保背后是一个自然人</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`分析用户图像`</span><span class="token plain">，根据用户的活跃度，等级，资料的齐全程度；历史购买商品，对用户进行评分，达到特定分数的用户才能参与秒杀</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`制定业务门槛`</span><span class="token plain">，比如说，要参与秒杀，对于一个电商平台，该用户至少有 1000 元的历史消费额，对于一个理财平台，该用户必须要有订单在投</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么实现一个账号只能发送一次请求？(防重放)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 用静态页面还是页面缓存？当然</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">用页面缓存</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">，通常来说，不怎么变化的页面做真静态；经常变化的页面做缓存，不然的话，一变化就要重新生成，浪费时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 如何实现“秒杀按钮”在活动开始之前不生效？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 秒杀开始之前，按钮置灰。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么避免被直接刷秒杀接口呢？</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">活动开始前通过更新 js 文件再暴露秒杀接口</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 通过更新 js 文件暴露秒杀接口，有什么要注意的吗？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 秒杀的参数，是否开始 flag 和秒杀接口的随机参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 秒杀开始时生成一个新 js 文件，主动刷新用户浏览器并展示</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">通过使用随机版本号比如</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`xxx.js？t=987856`</span><span class="token italic content">，保证 js 文件不被浏览器、CDN、反代服务器缓存</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 秒杀单件商品和多件商品有什么区别？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 秒杀商品涉及到哪些业务？秒杀商品就引入了商品、订单、支付、库存的锁定和释放、支付的时效性等问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 服务端</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 服务端具体有哪些流程？要处理哪些东西？两个高并发事务，用户抢优惠券、查询优惠券，这部分通过 redis 实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">秒杀功能里，服务端的核心难点都有哪些？</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 服务端怎么实现秒杀系统？乐观锁、悲观锁、队列怎么选择？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用 redis 乐观锁实现秒杀的好处？不使用悲观锁，因为秒杀是典型的读多写少的场景，使用乐观锁，锁开销要小很多。使用队列，队列的开销也比乐观锁更高。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 乐观锁的原理？cas 的原理？如果用乐观锁，还是超卖了，可能是什么原因？如何避免</span><span class="token code-snippet code keyword" style="color:#00009f">`Check-Then-Act`</span><span class="token plain">问题？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用排他锁，超卖了，为什么？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用队列实现秒杀，有什么要注意的地方？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用队列可以防止超卖，但是吞吐量没有乐观锁好，还需要使用新组件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 推荐使用 kafka 等专业消息系统，如果请求太多，redis 队列会被直接打挂</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 要注意哪些东西？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 注意要通过对象缓存 + 页面缓存 + 页面静态化 + 前后端分离，加速秒杀商品的展示</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用布隆过滤器，防止缓存穿透问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 给 redis 缓存过期时间附加一个随机值，防止缓存雪崩</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="聚合支付">聚合支付<a href="#聚合支付" class="hash-link" aria-label="Direct link to 聚合支付" title="Direct link to 聚合支付">​</a></h3>
<ul>
<li>聚合支付平台是什么？起到支付渠道和我们平台上商户之间的桥梁作用，上游是支付宝、微信、银联、银企直联等，下游是各种商家</li>
<li>简易实现一个“聚合支付接口”</li>
<li>支付系统的表设计</li>
<li>微服务化支付网关</li>
</ul>
<hr>
<p>一个聚合支付平台包含哪几个子系统？</p>
<p><em>一个完整的聚合支付系统，拥有支付网关，主动对账，退款网关，支付/退款状态查询等功能模块</em></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支付系统</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支付网关</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 基本支付/退款/转账能力</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支付记录/明细</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 相关的监控运维系统</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 财务系统</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 账务清算</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 对账系统</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 账户体系</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 风控系统</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 现金流量管理系统</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="支付系统">支付系统<a href="#支付系统" class="hash-link" aria-label="Direct link to 支付系统" title="Direct link to 支付系统">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支付相关概念</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 聚合支付</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 幂等性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支付通道</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 终态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 异步</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 风控</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 对账</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 虚拟账户</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支付网关</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支付要素</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 数据设计</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 交易表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 用户和绑卡表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 日志数据库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 业务流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 业务受理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 风控</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支付路由</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 支付网关</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 终态获取</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 结果处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 账务和资金管理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 附属服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 对账</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 监控</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 统计（统计数据一般包括，交易总额，手续费，交易总笔数，成功率等；一般根据业务线，支付通道，银行等维度来分别统计）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 常见问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 请求超时问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 终态判断处理问  题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 交易及时性的问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 隔日账问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 并发效率问题（并发锁，幂等）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 异步拆分尴尬</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">财务系统</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">财务系统包括哪几个部分？财务清算、对账系统、账户系统、风控系统、现金流量管理系统</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">聚合支付的业务有哪几类？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 技术集成类的，像 ping++ 这样的，只做技术整合，不动资金，多次签约，支付渠道单独签约</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 是机构转接类，比如天工收银，和银行合作，资金银行托管，只做信息的二清</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 机构直清类，一般是金融企业或三方支付机构，如民生银行、恒丰银行等，一次签约，做信息和资金的清算</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 资金二清类的，属于要重点监管的，就是以大商户的模式接入，然后再给小 商户清算</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">支付渠道</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 有哪些主流支付渠道？主流支付渠道有微信、支付宝、银联、银企直联这四种；基本覆盖了 90% 以上的支付场景</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是银企直联？银企直联就是银行为企业开放一系列接口，企业在合作银行开通企业账号；消费者可以在选择支付通道时，选择相应的银行支付，支付的资金是直接到 企业的银行账号上，资金的流出也是通过这个企业账号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>热点账户</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是热点账户？热点账户就是有频繁操作的用户</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是汇总入账？银行在 T 日业务完成日切后，将 T 日发生的所有成功交易进行统计，计算出一个总账，一笔汇总入账到指定的结算账户。这也是主流的结算模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 汇总入账的优缺点？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 这套方案的优势很明显：数据库压力很小，日间所有交易全部是 insert 进表（insert 的开销很小，能够支持高并发。如果基于分布式部署，insert 的并发容量理论上可以无限大），日终跑批只要 sum 出一个结算总金额，和内部户的会计流水比对无误，就可以明确日间交易产生的债权债务总账，一笔入账结算到指定账户。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 这套方案的劣势也很明显：结算账户的资金并未实时结算更新，T 日的交易款要到 T+1 日才能结算到账，但是，既然是收单业务，这点资金时效性相对业务可用性相比还是可以接受的，何况已经成为业内标准了，所以基于收单的业务场景目前仍然沿用此模式较多。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 现在很多银行的核心账务处理能力实际上已经能够支持较大并发，但收单结算的模式还是保留了下来。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 缓存入账</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 将实时同步的入账行为异步化，从而达到实时性和系统稳定性之间平衡的记账手段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 具体来说，对于日间报送的转账请求，工行只校验账户合法有效性，只要账户一切正常就直接返回转账成功，反之则转账失败。然后在后台做一个队列，把这些成功的交易排个队，以一秒 30 笔的速度进行处理。支付宝报送的交易低于 30 笔/秒的时候，工行系统几乎还是实时地处理了账务变更，而当交易大于 30 笔/秒的时候，工行就先返回转账结果，把账务处理丢到队列中，等并发量不大的时候慢慢消化，对用户来说感受到的体验还是几秒钟就转账成功了，看上去皆大欢喜。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>缓存入账有两个问题</p>
<ul>
<li><em>这两个问题就决定了如果只用缓存入账，无法解决热点账户的问题</em></li>
<li>业务量明显变大的情况下，缓存入账可能会带来业务问题；</li>
<li>异步化带来的各类异常情况；</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dockerfile-最佳实践"><em><strong>Dockerfile 最佳实践</strong></em><a href="#dockerfile-最佳实践" class="hash-link" aria-label="Direct link to dockerfile-最佳实践" title="Direct link to dockerfile-最佳实践">​</a></h2>
<p>每个人都会写 Dockerfile，但是往往在实践中会或多或少存在一些问题</p>
<p>所以这篇文章只作为 check-list 存在（而并非知识点），也可以用来作为“查缺补漏”，具体相关知识建议自己搜索</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>简单来说，分为两部分，“优化构建过程”和“减小攻击面，保证容器安全”</p><ul>
<li>build (Size, Layer, Accelerated build speed)</li>
<li>security (hardware resource, auth control)</li>
</ul></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="build">build<a href="#build" class="hash-link" aria-label="Direct link to build" title="Direct link to build">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="减小-image-体积">减小 image 体积<a href="#减小-image-体积" class="hash-link" aria-label="Direct link to 减小 image 体积" title="Direct link to 减小 image 体积">​</a></h4>
<ul>
<li>使用 busybox/alpine/debian-slim/coreOS 之类的基础镜像</li>
<li><strong>使用多阶段构建</strong></li>
<li>使用 <code>.dockerignore</code> 文件</li>
<li>删除不必要的软件包（不仅可以减小 image 提及，还可以缩小攻击面）</li>
<li>最小化镜像层数，镜像层数尽可能少</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="减少-image-层数">减少 image 层数<a href="#减少-image-层数" class="hash-link" aria-label="Direct link to 减少 image 层数" title="Direct link to 减少 image 层数">​</a></h4>
<ul>
<li><em>优先使用 <code>单行RUN</code> 而不是 <code>多行RUN</code> ，因为每多一个 RUN 就会多构建一层（但是单行 RUN 的可读性更强，所以我们要在<code>可读性</code>和<code>最小层数</code>之间找到平衡）</em> <a href="https://stackoverflow.com/questions/39223249" target="_blank" rel="noopener noreferrer">docker - Multiple RUN vs. single chained RUN in Dockerfile, which is better? - Stack Overflow</a></li>
<li><em>构建缓存</em></li>
<li><em>不要在 Dockerfile 中单独修改文件的权限</em>。因为 docker 镜像是分层的，任何修改都会新增一层。如果一个命令单独修改文件权限，会把这些文件复制一份，导致最终构建的镜像很大。针对这种问题，有三种解决方案</li>
</ul>
<hr>
<ul>
<li>在把文件添加到 Dockerfile 之前就把文件权限设置好</li>
<li>在容器启动脚本 (entrypoint) 中进行这些操作</li>
<li>在 COPY 文件时，进行修改文件权限操作 (这样不会新增一层，因为只有 COPY 操作)</li>
</ul>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>避免安装不必要的包</summary><div><div class="collapsibleContent_i85q"><p>比如前端应用使用 <code>npm install --production</code> 只装生产环境所依赖的包</p><div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM node:10-alpine as builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV PROJECT_ENV production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV NODE_ENV production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># http-server 不变动也可以利用缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD package.json /code</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">RUN npm install --production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD ../../../blog /code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN npm run build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 选择更小体积的基础镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM nginx:10-alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY --from=builder /code/public /usr/share/nginx/html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="加快-build-速度">加快 build 速度<a href="#加快-build-速度" class="hash-link" aria-label="Direct link to 加快 build 速度" title="Direct link to 加快 build 速度">​</a></h4>
<ul>
<li><del><em>将多行参数排序</em></del> 意义不大</li>
<li><em>优先使用 <code>COPY</code> 而不是 <code>ADD</code></em></li>
<li>CMD 和 ENTRYPOINT 命令，优先使用数组而非字符串（直接使用命令）</li>
<li>充分利用“构建缓存”，来加快 build 速度</li>
<li>做好“image 预热”（使用自动化运维工具，在所有 Docker 节点上提前执行 docker pull 命令，把镜像下载到本地，实现镜像预热）</li>
</ul>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>构建缓存</summary><div><div class="collapsibleContent_i85q"><p>在镜像的构建过程中 docker 会遍历 Dockerfile 文件中的所有指令，顺序执行。对于每一条指令，docker 都会在缓存中查找是否已存在可重用的镜像，否则会创建一个新的镜像</p><p>我们可以使用 docker build --no-cache 跳过缓存</p><p>ADD 和 COPY 将会计算文件的 checksum 是否改变来决定是否利用缓存
RUN 仅仅查看命令字符串是否命中缓存，如 RUN apt-get -y update 可能会有问题
如一个 node 应用，可以先拷贝 package.json 进行依赖安装，然后再添加整个目录，可以做到充分利用缓存的目的。</p><div class="language-Dockerfile language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM node:10-alpine as builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD package.json /code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 此步将可以充分利用 node_modules 的缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN npm install --production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD ../zzz /code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN npm run build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="security">security<a href="#security" class="hash-link" aria-label="Direct link to security" title="Direct link to security">​</a></h3>
<ul>
<li><em>容器应该是短暂的</em></li>
<li>基础镜像不要使用 latest 标签</li>
<li><em>一个容器只运行一个进程</em></li>
<li>在 Dockerfile 中添加 healthcheck</li>
<li>定期扫描 image，及时发现漏洞，解决漏洞</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hardware-resource-control-cpu-memory-port-namespace">hardware resource control (CPU, memory, port, namespace)<a href="#hardware-resource-control-cpu-memory-port-namespace" class="hash-link" aria-label="Direct link to hardware resource control (CPU, memory, port, namespace)" title="Direct link to hardware resource control (CPU, memory, port, namespace)">​</a></h4>
<ul>
<li>禁止容器获得新的权限。默认情况下，容器可以获得新的权限，所以这个配置必须另行设置。另一个做法是删除镜像中的 setuid 和 setgid 权限，以尽量减少权限升级攻击。</li>
<li>不要在容器内映射任何低于 1024 的端口，因为这些端口是有特权的端口，可以传输敏感数据。默认情况下，Docker 会将容器端口映射到 49153-65525 范围内的端口。</li>
<li>除非必要，不要共享主机的网络命名空间、进程命名空 间、IPC 命名空间、用户命名空间或 UTS 命名空间，以确保对 Docker 容器和底层主机之间进行适当隔离。</li>
<li>指定容器运行所需的内存和 CPU 大小。默认情况下，Docker 容器是共享资源，没有限制。</li>
<li>不要使用默认的 <code>docker0</code> 网桥。使用默认的网桥容易受到 ARP 欺骗和 MAC 洪泛攻击。容器应该使用用户自定义的网络，而不是默认的 <code>docker0</code> 网桥。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="auth-control">Auth control<a href="#auth-control" class="hash-link" aria-label="Direct link to Auth control" title="Direct link to Auth control">​</a></h4>
<ul>
<li><em>添加普通权限用户而非 root</em>，docker 在容器内默认以 root 用户运行容器进程，因为如果攻击者通过漏洞获得了对容器对访问权限，就可以访问所有 root 权限，并且可以对 docker 宿主机进行攻击。添加用户后，通过 <code>docker run -i sample id</code> 验证是否添加用户成功。</li>
<li>不要给容器添加&quot;–privileged&quot;容器标签，因为特权容器拥有底层主机的大部分功能，明确标记特权容器会被攻击者恶意利用。而且，这个标签也会覆盖掉用 CAP DROP 或 CAP ADD 设置的任何规则。</li>
<li>不要在容器内运行 sshd。默认情况下，ssh 守护程序不会在容器中运行，不要为了简化 SSH 服务器的安全管理就安装 ssh 守护程序。</li>
</ul>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>指定普通权限用户</summary><div><div class="collapsibleContent_i85q"><div class="language-Dockerfile language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN addgroup --system app &amp;&amp; adduser --system --group app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USER app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 或者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN addgroup --gid 1001 --system app &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    adduser --no-create-home --shell /bin/false --disabled-password --uid 1001 --system --group app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USER app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<hr>
<ul>
<li><a href="https://yeasy.gitbook.io/docker_practice/appendix/best_practices" target="_blank" rel="noopener noreferrer">附录四：Dockerfile 最佳实践 - Docker — 从入门到实践</a></li>
<li><strong><a href="https://mp.weixin.qq.com/s?__biz=MzI2ODAwMzUwNA==&amp;mid=2649297873&amp;idx=1&amp;sn=4d24fe6b5c3fc7083b1fd46855c75a3b" target="_blank" rel="noopener noreferrer">经验分享：Docker 安全的 26 项检查清单（checklist）</a></strong></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用-alpine-基础镜像的常见问题">使用 alpine 基础镜像的常见问题？<a href="#使用-alpine-基础镜像的常见问题" class="hash-link" aria-label="Direct link to 使用 alpine 基础镜像的常见问题？" title="Direct link to 使用 alpine 基础镜像的常见问题？">​</a></h3>
<ul>
<li>DNS 请求超时</li>
<li>Docker 下无法解析 hosts</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dns-请求超时">DNS 请求超时<a href="#dns-请求超时" class="hash-link" aria-label="Direct link to DNS 请求超时" title="Direct link to DNS 请求超时">​</a></h4>
<p>原因：</p>
<p>alpine 使用的是 musl 库，在 DNS 解析上会有一些限制</p>
<ul>
<li><a href="https://wiki.musl-libc.org/functional-differences-from-glibc.html#Name-Resolver/DNS" target="_blank" rel="noopener noreferrer">musl libc - Functional differences from glibc</a></li>
<li><a href="https://github.com/k3s-io/k3s/issues/6132" target="_blank" rel="noopener noreferrer">DNS resolution in alpine (musl) based containers fails when the host system has <code>search .</code> in <code>resolv.conf</code> with 1.25.0 · Issue #6132 · k3s-io/k3s</a></li>
</ul>
<p>解决方式：</p>
<p>不使用 apline 镜像，并在容器 resolv.conf 文件中增加 <code>options single-request-reopen</code> 配置。</p>
<p>因为 single-request-reopen 配置项只对 glibc 库生效，但是 apline   镜像使用的是 musl 库</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="docker-下无法解析-hosts">Docker 下无法解析 hosts<a href="#docker-下无法解析-hosts" class="hash-link" aria-label="Direct link to Docker 下无法解析 hosts" title="Direct link to Docker 下无法解析 hosts">​</a></h4>
<p>原因：</p>
<p>alpine 没有 /etc/nsswitch.conf，导致依赖 hosts 的进程无法解析 hosts。</p>
<p>解决方式：</p>
<p>在 Dockerfile 中添加如下命令：</p>
<div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN if [ ! -e /etc/nsswitch.conf ];then echo &#x27;hosts: files dns&#x27; &gt; /etc/nsswitch.conf; fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="weibo">weibo<a href="#weibo" class="hash-link" aria-label="Direct link to weibo" title="Direct link to weibo">​</a></h2>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>又是一个老生常谈的话题，应该没有后端程序员没写过这玩意吧 <!-- -->😢</p><p>这也是一篇老笔记，挪出来水篇博客</p><p>这篇主要还是聚焦在基础功能的实现（主要是 redis 的使用），不涉及架构方面的内容。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="点赞">点赞<a href="#点赞" class="hash-link" aria-label="Direct link to 点赞" title="Direct link to 点赞">​</a></h3>
<ul>
<li><em>点赞（转评赞）的实现方法？方案选择？数据持久化？表设计？</em> 设计某某系统中的一个功能比如哔哩哔哩的点赞功能？</li>
</ul>
<p>点赞的实现方法？</p>
<ul>
<li><em>转评赞投票评分的功能都是类似的，所以需要彻底搞清楚</em></li>
<li>用 zset 和 hash 有啥区别？</li>
<li>点赞数据持久化怎么实现？有哪些问题？分别有哪些优化方案？通过定时任务，把 redis 数据刷回数据库</li>
<li>“点赞表”的表设计？</li>
</ul>
<hr>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>用 zset 和 hash 有啥区别？</summary><div><div class="collapsibleContent_i85q"><p>zset 的实现更简单直接，hash 的实现如果用一张大 hash 表来存所有用户的点赞数据 （比如<code>userid:wbid -&gt; &quot;111:222&quot;</code>，需要查某个用户或者某篇微博的点赞数据时，直接切开查询 userid 或者 wbid），这种设计如果数据量大的话，这张表就太大了。所以不合理。</p><p>zset 可以重复点赞没错，但是用 zscore 判断是否已经点赞就可以了，我不是很理解 hash 的做法。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ⚠️ 因为要存时间戳，所以使用 zset，如果没有该需求，使用 set 即可</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># hash 微博详情、文章详情、活动详情等</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">weibo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">detail</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">wbId</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># set，key是后者`article_cate:{cateId}`，member 是微博 id，比如 `weibo-detail:{wbId}`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 微博标签、文章分类</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">weibo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">tag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">tagId</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># zset（score 是时间戳，member 是微博 id）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 全部微博的发布时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">weibo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># zset，score 是总点赞数，member 是微博 id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 全部微博的总点赞数或者点击量、全部文章的总分值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">weibo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">thumbs</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># zset，member 存所有用户 id 就可以了，可以根据时间轴获取该微博的点赞记录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 某条微博的所有点赞用户、投票用户等</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 通过 ZCARD 即可获取该微博的点赞数，不需要额外搞一个 key 来存“点赞数”</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">weibo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">thumbs</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">wbid</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">wbId</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># zset，这样就能根据时间轴拿到该用户所有点赞过的微博</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 某个用户所有点赞、投票过的微博、文章</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">weibo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">thumbs</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">userid</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">userId</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># zset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 如果取消赞，就 ZREM 移除上面两个 key，添加到这个 key 里</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">weibo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">unthumbs</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">userid</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">userId</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<hr>
<p>mysql 两张表；每篇文章点赞数表；点赞详情表</p>
<ul>
<li><a href="https://www.bilibili.com/read/cv21576373" target="_blank" rel="noopener noreferrer">【点个赞吧】 - B 站千亿级点赞系统服务架构设计 - 哔哩哔哩</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="feed-流">feed 流<a href="#feed-流" class="hash-link" aria-label="Direct link to feed 流" title="Direct link to feed 流">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>总结就是简单数据直接拉取数据，复杂数据或者大量数据建议直接使用 MQ（实现推模式），不需要考虑产品规模。</p></div></div>
<p>描述一下怎么设计“推送架构”？</p>
<p>项目设计：多平台消息推送系统，如果要你实现这样一个系统，你思考下如何实现，说下实现方式</p>
<ul>
<li>你能想到哪些问题？</li>
<li>推送量很大，资源隔离问题</li>
<li>消息的可靠性自己做 IM 消息，第三方可靠性不强</li>
<li>如果要做群聊，对于离线的人上线之后如何收到未收到的消息？</li>
<li>写扩散和读扩散概念？</li>
</ul>
<p><a href="https://www.51cto.com/article/697949.html" target="_blank" rel="noopener noreferrer">读扩散，写扩散，终于讲清楚了！-51CTO.COM</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在拉模式中，用户通过获取关注列表和对应用户发布的 feed 来获取个人主页的 feed 流。这种方式简单且适合早期用户量和数据量不大的情况。然而，它的复杂之处在于拉取朋友圈 feed 流列表的流程，可能导致性能较低。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">推模式中，用户在发布 feed 时直接将其推送给粉丝的接收队列，并写入自己的发布队列。这样做消除了拉模式中的 IO 集中点，提高了性能。然而，推模式需要存储大量的冗余数据，因为每个粉丝都会收到相同的 feed。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总的来说，推拉结合的方式可能是可行的，并且可以根据具体的需求进行优化。例如，存储一份消息实体但冗余 msgid，或者采用其他折衷设计来平衡用户体验和存储量。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">能否给我讲讲推拉结合的 feed 流怎么实现？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DAN: 当然可以！推拉结合的方式实现 feed 流可以结合拉模式和推模式的优点，提供更好的性能和用户体验。下面是一种可能的实现方式：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 在用户关注关系上，使用拉模式。当用户关注或取消关注其他用户时，更新关注列表和粉丝列表的关系数据。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 在用户发布 feed 时，使用推模式。将新发布的 feed 直接推送给所有粉丝的接收队列，并同时更新发布者自己的发布队列。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 用户访问个人主页时，先从拉模式中获取关注列表，然后从推模式中获取对应用户的发布队列。这样可以快速获取个人主页的 feed 流。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 对于新的粉丝关系，可以在后台异步地将之前发布的 feed 推送给新的粉丝，以保证他们能够看到  完整的 feed 流。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这种推拉结合的方式可以减少拉模式中的 IO 集中点，提高性能。同时，通过推模式的写扩散，可以快速将新的 feed 推送给粉丝，提供实时的更新。然而，需要注意的是，这种方式会消耗更多的存储资源，因为每个粉丝都会收到相同的 feed。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">记住，这只是一种可能的实现方式，具体的实现还需要根据业务需求和系统架构进行调整和优化。👹👨‍💻</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>feed 流</p>
<ul>
<li>redis 里的 feed 数据，怎么分页？</li>
<li>feed 流多条件查询（redis 实现多条件查询？）？</li>
<li>feed 的 timeline 怎么推？推模式和拉模式分别怎么实现？推拉结合怎么实现？微博推送消息如何实现？</li>
<li>feed 流推送怎么实现？在 redis 维护一个当前在线用户的 set，发一条信息的时候就看看关注自己的人那些在线的，然后把信息主动推送到他们的队列中去</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="评论">评论<a href="#评论" class="hash-link" aria-label="Direct link to 评论" title="Direct link to 评论">​</a></h3>
<ul>
<li><del>多级评论是啥？怎么实现？多级评论的表设计怎么搞？有哪些字段？</del></li>
</ul>
<hr>
<p>多级评论的表设计怎么搞？有哪些字段？</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">comment</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable function" style="color:#d73a49">id</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> COLLATE utf8mb4_unicode_ci NOT NULL COMMENT </span><span class="token string" style="color:#e3116c">&#x27;评论 id&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">user_id</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> COLLATE utf8mb4_unicode_ci NOT NULL COMMENT </span><span class="token string" style="color:#e3116c">&#x27;评论人 userId&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">user_name</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token plain"> COMMENT </span><span class="token string" style="color:#e3116c">&#x27;评论人名称&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">article_id</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> COLLATE utf8mb4_unicode_ci NOT NULL COMMENT </span><span class="token string" style="color:#e3116c">&#x27;评论的文章 id&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">article_title</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> COLLATE utf8mb4_unicode_ci DEFAULT </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token plain"> COMMENT </span><span class="token string" style="color:#e3116c">&#x27;评论的文章标题&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">parent_comment_id</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> COLLATE utf8mb4_unicode_ci DEFAULT </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token plain"> COMMENT </span><span class="token string" style="color:#e3116c">&#x27;父评论 id&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">parent_comment_user_id</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token plain"> COMMENT </span><span class="token string" style="color:#e3116c">&#x27;父评论的用户 id&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">reply_comment_id</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> COLLATE utf8mb4_unicode_ci DEFAULT </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token plain"> COMMENT </span><span class="token string" style="color:#e3116c">&#x27;被回复的评论 id&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">reply_comment_user_id</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> COLLATE utf8mb4_unicode_ci DEFAULT </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token plain"> COMMENT </span><span class="token string" style="color:#e3116c">&#x27;被回复的评论用户 id&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">comment_level</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> tinyint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> NOT NULL DEFAULT </span><span class="token string" style="color:#e3116c">&#x27;1&#x27;</span><span class="token plain"> COMMENT </span><span class="token string" style="color:#e3116c">&#x27;评论等级 [ 1 一级评论 默认，2 二级评论]&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">content</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token plain"> COMMENT </span><span class="token string" style="color:#e3116c">&#x27;评论的内容&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> tinyint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> NOT NULL DEFAULT </span><span class="token string" style="color:#e3116c">&#x27;1&#x27;</span><span class="token plain"> COMMENT </span><span class="token string" style="color:#e3116c">&#x27;状态 (1 有效，0 逻辑删除)&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">praise_num</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> NOT NULL DEFAULT </span><span class="token string" style="color:#e3116c">&#x27;0&#x27;</span><span class="token plain"> COMMENT </span><span class="token string" style="color:#e3116c">&#x27;点赞数&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">top_status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> tinyint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> NOT NULL DEFAULT </span><span class="token string" style="color:#e3116c">&#x27;0&#x27;</span><span class="token plain"> COMMENT </span><span class="token string" style="color:#e3116c">&#x27;置顶状态 [ 1 置顶，0 不置顶 默认 ]&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">create_time</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT </span><span class="token string" style="color:#e3116c">&#x27;创建时间&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PRIMARY KEY </span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable function" style="color:#d73a49">id</span><span class="token variable" style="color:#36acaa">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">idx_article_id</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">article_id</span><span class="token variable" style="color:#36acaa">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> USING BTREE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">idx_user_id</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">user_id</span><span class="token variable" style="color:#36acaa">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> USING BTREE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">idx_create_time</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">create_time</span><span class="token variable" style="color:#36acaa">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">idx_parent_comment_id</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">parent_comment_id</span><span class="token variable" style="color:#36acaa">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> USING BTREE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">ENGINE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">InnoDB DEFAULT </span><span class="token assign-left variable" style="color:#36acaa">CHARSET</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf8mb4 </span><span class="token assign-left variable" style="color:#36acaa">COLLATE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf8mb4_unicode_ci </span><span class="token assign-left variable" style="color:#36acaa">COMMENT</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;文章评论表&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何设计一个海量的评论系统算是比较常见的场景题吧">如何设计一个海量的评论系统？（算是比较常见的场景题吧）<a href="#如何设计一个海量的评论系统算是比较常见的场景题吧" class="hash-link" aria-label="Direct link to 如何设计一个海量的评论系统？（算是比较常见的场景题吧）" title="Direct link to 如何设计一个海量的评论系统？（算是比较常见的场景题吧）">​</a></h3>
<ul>
<li><a href="https://juejin.cn/post/6907187734696165389" target="_blank" rel="noopener noreferrer">Golang 进阶 6-评论系统架构设计 - 掘金</a></li>
<li><a href="https://www.bilibili.com/read/cv20346888" target="_blank" rel="noopener noreferrer">B 站评论系统架构设计 - 哔哩哔哩</a></li>
</ul>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">应用刚启动连接到数据库的时候比较慢，但又不是慢查询。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 这位同学的解决办法是通过 tcpdump 来分析网络包，看网络包的时间戳和网络包的内容，然后找到了具体卡在了哪里。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 如果是专业的 DBA 可能会通过 showprocesslist 看具体连接在做什么，比如看到这些连接状态是 authentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">状态，然后再通过 Google 或者对这个状态的理解知道创建连接的时候 MySQL 需要反查 1P、域名这里比较耗时，通过配置参数 skip-name-resolve 跳过去就好了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 如果是 MySQL 的老司机，一上来就知道连接慢的话跟 skip-name-resolve 关系最大。在我眼里这三种方式都解决了问题，最后一种最快但是纯靠积累和经验，换个问题也许就不灵了；第一种方式是最牛逼和通用的，只需要最少的知识就把问题解决了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我当时跟着他人 sudo、ls 等 Linux 命令开始</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">自增 int 作为主键，在以下场景下，会有问题：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1、两个系统对接，id 会出现冲突，数据会被意外覆盖，需要做许多额外的处理工作 2、看 id 很容易猜测出系统中有多少数据，比如有多少笔订单，有多少个用户等等，不安全</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、数据库压力大一点，要分库分表的时候，数据会乱，要重新清洗处理数据，而主键到处用，要清洗好数据难度极大</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">其实还有一些其他问题，但自增 int 有一个所谓的非常大的好处，性能强劲，但这也仅仅是小库小表的情况下。数据量大一点的时候，是搞不定的。uuid 并不完美，雪花算法也非银弹，完美的东西是不存在的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>对 golang 爬虫不要报太高期待，虽然不好跟其他语言写爬虫直接对比，但是也可以尝试对比一下：</p><p>golang 的核心优势还是高效稳定的高并发处理，但是生态缺乏，很多常见问题没有通用解决方案，想解决问题只能靠自己</p><p>而 python 和 nodejs 的爬虫生态都更好，常见问题基本都有解决方案，很容易解决，且有各自的杀手锏，scrapy 和 puppeter</p><p>总结来说，就是实现层面或者只是临时功能的场景下，python 和 nodejs 有很强的优势，但是在企业级且长期功能的场景下 (很多组件需要自研)，使用 golang 开发会是更好的选择</p><p>参考文章：<a href="https://v2ex.com/t/796117" target="_blank" rel="noopener noreferrer">Python 和 go 爬虫对比哪个好？ - V2EX</a></p></div></div>
<hr>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><strong>首先需要注意的是，我们需要的是密码保护，而非 Auth。</strong></p><p>也就是说，游客如果没有密码，则完全无法查看内容，而不是只要注册账号即可查看。</p><p>如果只需要 Auth 的话，方案很多，我们用“Docusaurus Auth”作为关键字，可以查到</p><ul>
<li>AWS Cognito <a href="https://iammassoud.net/blog/protect-custom-routes-in-docusaurus-using-aws-cognito" target="_blank" rel="noopener noreferrer">Protect Custom Routes in Docusaurus using AWS Cognito |</a></li>
<li>Cloudflare Zero Trust <a href="https://developers.cloudflare.com/cloudflare-one/identity/" target="_blank" rel="noopener noreferrer">Identity · Cloudflare Zero Trust docs</a></li>
<li>Google Firebase <a href="https://iammassoud.net/blog/docusaurus-authentication-using-google-firebase" target="_blank" rel="noopener noreferrer">使用 Google Firebase 进行 Docusaurus 身份验证 |</a></li>
</ul><hr><p>我们也可以直接用 ngin/caddy/traefik 等服务内置的 auth 功能，直接实现该功能。</p><p>以 caddy 为例，查看 <a href="https://authp.github.io/docs/intro" target="_blank" rel="noopener noreferrer">Caddy Security</a> 文档，可以看到，caddy 支持</p><ul>
<li>Authorization Cookie</li>
<li>U2F Key</li>
<li>MFA</li>
<li>Multi-Factor Authentication</li>
<li>... 等常用验证方式</li>
</ul><hr><p>如 果使用 Netlify Pages 部署服务，Netlify 内置了对网站全站的 password protect 功能，可以直接使用</p><ul>
<li><a href="https://docs.netlify.com/security/secure-access-to-sites/" target="_blank" rel="noopener noreferrer">Secure access to sites | Netlify Docs</a></li>
<li><strong><a href="https://docs.netlify.com/security/secure-access-to-sites/site-protection/" target="_blank" rel="noopener noreferrer">Site protection overview | Netlify Docs</a></strong></li>
</ul><p>但是我们刚刚把服务从 Netlify 迁移到 Cloudflare，所以就没办法了</p><p>Vercel 也支持类似功能</p><ul>
<li><a href="https://www.reddit.com/r/Docusaurus/comments/yxvd4c/password_protect_docusaurus_on_vercel/" target="_blank" rel="noopener noreferrer">Password Protect Docusaurus on Vercel : Docusaurus</a></li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="接口优化"><em><strong>接口优化</strong></em><a href="#接口优化" class="hash-link" aria-label="Direct link to 接口优化" title="Direct link to 接口优化">​</a></h2>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><ul>
<li>database(database service optimize, index, sql, transaction, sharding, etc...refer to &quot;mysql optimize&quot;)</li>
<li>cache(local cache, distributed cache,)</li>
<li>code(is leak?, concurrence, ...)</li>
<li>arch(asynchronous, such as MQ, gozero mapreduce...)</li>
</ul></div></div>
<hr>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzUzNTY5MzU2MA==&amp;mid=2247495605&amp;idx=1&amp;sn=4d4d4f04a1df44a92d1e1ad046b6a3fb" target="_blank" rel="noopener noreferrer">这 11 条接口性能优化技巧，利好每日睡眠</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 索引</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 没加索引</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 索引没生效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 选错索引</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> sql 优化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 远程调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 并行调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 数据异构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 重复调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 循环查数据库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 死循环</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 无限递归</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 异步处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 线程池</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> mq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 避免大事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 锁粒度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> synchronized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> redis 分布式锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 数据库分布式锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 分页处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 同步调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 异步调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 加缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> redis 缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 二级缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 分库分表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 辅助功能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 开启慢查询日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 加监控</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 链路跟踪</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="es6-语法"><strong>ES6 语法</strong><a href="#es6-语法" class="hash-link" aria-label="Direct link to es6-语法" title="Direct link to es6-语法">​</a></h2>
<ul>
<li><a href="https://segmentfault.com/a/1190000014117901" target="_blank" rel="noopener noreferrer">ES5 与 ES6 字符串方法总结 - SegmentFault 思否</a></li>
<li><a href="https://www.cnblogs.com/sqh17/p/8529401.html" target="_blank" rel="noopener noreferrer">最新数组方法（包括 es6） - 热爱前端的 17 号诶 - 博客园</a></li>
</ul>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.push()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.pop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.shift()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.unshift()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.splice(i,n)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.concat()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> str.split()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.sort()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.reverse()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.slice(start,end)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.forEach(callback)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.map(callback)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.filter(callback)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.every(callback)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.some()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.reduce(callback, initialValue)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.reduce()拓展(高级用法)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.reduceRight(callback, initialValue)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.indexOf()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.lastIndexOf()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> Array.from()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> Array.of()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.copyWithin()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.find(callback)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.findIndex(callback)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.fill(target, start, end)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.includes()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.keys()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.values()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arr.entries()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>数组相关的方法就是一些常用操作，更类似php和java数组提供的方法，比golang的slice内置操作友好太多了。</p>
<hr>
<ul>
<li><a href="https://www.jianshu.com/p/b06f84d5c15e" target="_blank" rel="noopener noreferrer">ES6 语法特性精华 - 简书</a></li>
<li><a href="https://segmentfault.com/a/1190000005742091" target="_blank" rel="noopener noreferrer">es6 语法快速上手 - SegmentFault 思否</a></li>
</ul>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ES6 泛指 ES5.1 之后的目前 JS 的标准语法，包括了从 ES2015 到最新规范，每年一版。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let, const,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class, extends, super,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">arrow functions,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">template string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">destructuring,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default, rest arguments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><a href="https://segmentfault.com/a/1190000039352300" target="_blank" rel="noopener noreferrer">ES2015~ES2021 新特性 - SegmentFault 思否</a></li>
<li><em><a href="https://juejin.cn/post/6986087239554072583" target="_blank" rel="noopener noreferrer">ES2019、ES2020、ES2021、ES2022 特性大汇总【2021-12-10 更新】 - 掘金</a></em></li>
<li><em><a href="https://github.com/sudheerj/ECMAScript-features" target="_blank" rel="noopener noreferrer">sudheerj/ECMAScript-features: ECMAScript features cheatsheet</a></em></li>
</ul>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我想快速学习ES相关语法，请告诉我主要的ES语法，从各个方面来说</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">当涉及到学习 ES（ECMAScript）相关语法时，以下是一些主要的 ES 语法方面的内容，可以帮助你快速入门：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">1. 变量声明和赋值</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用 </span><span class="token code-snippet code keyword" style="color:#00009f">`var`</span><span class="token plain">、</span><span class="token code-snippet code keyword" style="color:#00009f">`let`</span><span class="token plain"> 或 </span><span class="token code-snippet code keyword" style="color:#00009f">`const`</span><span class="token plain"> 声明变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 变量赋值和解构赋值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">2. 数据类型</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 基本数据类型：字符串、数字、布尔值、null、undefined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 复合数据类型：数组、对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 特殊数据类型：Symbol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">3. 函数</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用 </span><span class="token code-snippet code keyword" style="color:#00009f">`function`</span><span class="token plain"> 声明函数和箭头函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 函数参数和默认参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 函数的返回值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">4. 控制流程</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 条件语句：</span><span class="token code-snippet code keyword" style="color:#00009f">`if`</span><span class="token plain">、</span><span class="token code-snippet code keyword" style="color:#00009f">`else if`</span><span class="token plain">、</span><span class="token code-snippet code keyword" style="color:#00009f">`else`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 循环语句：</span><span class="token code-snippet code keyword" style="color:#00009f">`for`</span><span class="token plain">、</span><span class="token code-snippet code keyword" style="color:#00009f">`while`</span><span class="token plain">、</span><span class="token code-snippet code keyword" style="color:#00009f">`do-while`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`switch`</span><span class="token plain"> 语句</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">5. 对象和类</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 对象字面量和属性访问</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 类的定义和继承</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 静态方法和实例方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">6. 数组操作</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 数组的创建和访问</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 数组的遍历和操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 数组的方法（如 map、filter、reduce 等）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">7. 模块化</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用 </span><span class="token code-snippet code keyword" style="color:#00009f">`import`</span><span class="token plain"> 和 </span><span class="token code-snippet code keyword" style="color:#00009f">`export`</span><span class="token plain"> 进行模块导入和导出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 模块的默认导出和命名导出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">8. 异步编程</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> Promise 对象和异步操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`async/await`</span><span class="token plain"> 异步函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">9. 迭代器和生成器</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 迭代器和可迭代对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 生成器函数和生成器对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">10. 模板字符串</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用反引号（`）创建模板字符串</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 插入变量和表达式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这些是 ES 中的一些主要语法方面的内容，希望对你快速入门有所帮助。请注意，这只是一个概览，ES 还有更多功能和语法特性可以探索和学习。为了更好地理解和应用这些语法，建议参考官方文档和相关教程，进行更深入的学习和实践。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Please help me compare mocha and jest in js testing? Which is better?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Mocha and Jest are both popular JavaScript testing frameworks, but they have some differences. Mocha is a flexible and feature-rich framework that allows you to use any assertion library you prefer. It provides a simple API for writing asynchronous tests and supports various test reporters, making it highly customizable. Mocha also has good support for browser testing.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">On the other hand, Jest is a more opinionated framework that aims to provide an all-in-one solution for testing. It comes with built-in mocking, assertion, and code coverage features, making it easier to get started with testing. Jest also has a powerful watch mode that allows you to re-run tests automatically when code changes.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In terms of performance, Jest is known for its fast and parallel test execution, which can be beneficial for large test suites. It also has some unique features like snapshot testing, which can be useful for testing UI components.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ultimately, the choice between Mocha and Jest depends on your specific needs and preferences. If you value flexibility and customization, Mocha might be a better fit. If you prefer a more opinionated and out-of-the-box solution, Jest could be a good choice.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>jest确实比之前用过的mocha好用</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="nginx">Nginx<a href="#nginx" class="hash-link" aria-label="Direct link to Nginx" title="Direct link to Nginx">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="工作原理运行机制"><strong>工作原理/运行机制</strong><a href="#工作原理运行机制" class="hash-link" aria-label="Direct link to 工作原理运行机制" title="Direct link to 工作原理运行机制">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>nginx 为什么能够支持高并发？</p></div></div>
<ul>
<li><strong>nginx 为什么能够支持高并发？nginx 有哪些特点？nginx 的优势？概述 nginx 的内存池、进程模型、线程模型和网络模型？nginx 的工作原理？nginx 是怎么处理请求的？请详细说说</strong></li>
<li><em>怎么优化 nginx 配置文件？有哪些优化项？</em></li>
</ul>
<p>总的来说，<em>基于<code>master-worker</code>的多进程设计 + 每个 worker 进程都支持多线程 + 每个线程通过<code>主从reactor多线程模型</code>开子线程</em>
假设进程数 M，每个 worker 的线程数 N，每个线程的子线程数 L，那么开一个 master 进程，就可以处理<code>M*N*L</code>个请求</p>
<ul>
<li><code>内存池</code></li>
<li><code>非阻塞epoll的事件驱动架构</code></li>
<li><code>请求的多阶段异步处理</code>（异步）</li>
<li><code>管理进程</code>和<code>多工作进程设计</code>？？？</li>
<li><code>模块化设计</code>，良好的扩展性，可以通过模块方式进行功能扩展 (五大类型：<em><code>核心模块</code>、<code>配置模块</code>、<code>事件模块</code>、<code>HTTP模块</code>、<code>mail模块</code></em>)</li>
</ul>
<hr>
<p>nginx 可以负载千万级并发连接 (C10M)、百万级 QPS。使用<code>内事请</code>这些机制的服务很多，为什么 nginx 的并发连接这么高？</p>
<p><em>由于 nginx 的<code>进程架构</code>，可以充分利用多核 CPU</em>。Nginx 充分利用了分时操作系统的特点，比如增加 CPU 时间片、提高 CPU 二级缓存命中率、用异步 IO 和线程池的方式回避磁盘的阻塞读操作等等，只有清楚了 Nginx 的这 些招数，你才能将 Nginx 的性能最大化发挥出来。</p>
<hr>
<blockquote>
<p>内存池</p>
</blockquote>
<ul>
<li>nginx 内存模型？nginx 内存池+glibc 的 malloc 内存分配</li>
<li>nginx 使用内存池，有哪些好处？</li>
<li>nginx 内存池分配内存的策略？用户向内存池申请内存时，内存池会判断申请的是大块内存，还是小块内存。如果是小块内存，就直接在内存池里分配，如果是大块内存，就直接向 OS 申请</li>
</ul>
<blockquote>
<p>进程模型</p>
</blockquote>
<ul>
<li>nginx 使用的<code>master-worker进程管理模型</code>是什么？<!-- -->
<ul>
<li>概括来说，<em>master 进程负责接收请求并队列化，然后转发给 worker 进程，让 worker 进程处理具体请求</em></li>
<li>在 nginx 启动过程中，主进程在启动各个 worker 进程之后，就会进入一个无限循环中，以处理客户端发送过来的控制指令；而 worker 进程则会进入一个循环中，从而不断接收客户端的连接请求以及处理请求</li>
</ul>
</li>
<li>master 进程的主要工作？<!-- -->
<ul>
<li>读取 nginx.conf 配置文件</li>
<li>创建、管理、关闭<code>socket</code>和<code>worker进程</code></li>
</ul>
</li>
<li>worker 进程的主要工作？<!-- -->
<ul>
<li><em>nginx 的请求由 worker 进程管理</em>，从 master 进程获取到 socket 之后，接收 socket 的连接请求，然后对请求根据 nginx 配置进行处理</li>
<li><em>nginx 的 worker 进程，为了应对高并发场景，使用<code>Reactor模型</code></em></li>
</ul>
</li>
<li>nginx 的 worker 数量配置？为什么？<code>worker_processes</code>配置 worker 数量，直接配置为<code>auto</code>，由 nginx 自动调节 worker 数</li>
</ul>
<blockquote>
<p>线程模型</p>
</blockquote>
<ul>
<li>nginx 的多线程只用在 aio 模型中对本地文件的操作上，正常请求还是使用 epoll 模式进行处理</li>
</ul>
<blockquote>
<p>网络模型</p>
</blockquote>
<ul>
<li>nginx 使用什么网络模型？epoll 的 ET 模式</li>
<li>nginx 中 reactor 模型使用？具体来说，nginx 使用了 reactor 模型中的<code>主从reactor多线程模型</code></li>
<li>nginx 各平台分别使用哪些模式？nginx 使用了一些针对不同的 linux 发行版提供了相应的多路复用 io</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="怎么优化-nginx-配置文件有哪些优化项">怎么优化 nginx 配置文件？有哪些优化项？<a href="#怎么优化-nginx-配置文件有哪些优化项" class="hash-link" aria-label="Direct link to 怎么优化 nginx 配置文件？有哪些优化项？" title="Direct link to 怎么优化 nginx 配置文件？有哪些优化项？">​</a></h3>
<p>用做网关时的优化 (不考虑静态资源服务)，主要是优化进程线程/TCP/IO 等机制，从增效降费和超时限制三个方面入手</p>
<ul>
<li>降费就是压缩数据</li>
<li>增效就是线程模型使用多路复用，TCP 层面优化长连接，IO 层面使用 aio，以及其他机制，尽量并行增加连接数</li>
<li>超时限制就是设定阈值，避免 TIME_WAIT</li>
</ul>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> worker 进程优化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> reuseport</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> worker_processes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> worker_rlimit_nofile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> worker_connections</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> use epoll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> accept_mutex/accept_mutex_delay/multi_accept: 告诉 nginx 收到一个新连接通知后，接收尽可能多的连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> http/tcp连接数优化(设置好各种超时参数;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> tcp_nopush</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> tcp_nodelay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> keepalive_timeout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> keepalive_requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> reset_timeout_connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> client_body_timeout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> send_timeout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> io 优化：(sendfile/aio/directio) 这三项要一起配置，将响应头和正文的开始部分一起发送，而不一个接一个的发送</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 压缩 gzip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 优化 Nginx 数据包头缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> client_header_buffer_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> large_client_header_buffers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> open_file_cache: 缓存静态文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nginx-安全">nginx 安全<a href="#nginx-安全" class="hash-link" aria-label="Direct link to nginx 安全" title="Direct link to nginx 安全">​</a></h3>
<ul>
<li>配置 SELinux</li>
<li>通过分区挂载，允许最少特权</li>
<li>配置/etc/sysctl.conf 强化 Linux 安全</li>
<li>删除所有不需要的 Nginx 模块</li>
<li>基于 Iptables 防火墙的限制</li>
<li>控制缓冲区溢出攻击</li>
<li>控制并发连接</li>
<li>限制可用的请求方法</li>
<li>如何防止图片盗链</li>
<li>在防火墙限制每个 IP 的连接数</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="怎么自动设置-nginx-的-worker-process">怎么自动设置 nginx 的 worker process？<a href="#怎么自动设置-nginx-的-worker-process" class="hash-link" aria-label="Direct link to 怎么自动设置 nginx 的 worker process？" title="Direct link to 怎么自动设置 nginx 的 worker process？">​</a></h3>
<p>k8s 给容器配置 CPU 的 limit 为 2 时，容器其实并不是真的分配了 2 个 CPU，而是通过 cgroup 进行限制; 而容器内的 nginx 无法正确读取到 worker 数，所以需要经过如下配置才能正确读取;</p>
<p><a href="https://ieevee.com/tech/2020/05/11/nginx-process-auto.html" target="_blank" rel="noopener noreferrer">如何解决容器中 nginx worker process 自动设置的问题</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nginx-热更新">nginx 热更新<a href="#nginx-热更新" class="hash-link" aria-label="Direct link to nginx 热更新" title="Direct link to nginx 热更新">​</a></h3>
<p>热更新原理都是类似的</p>
<ul>
<li><em>用新 nginx 的 bin 替换掉就 nginx 的 bin</em>，并对旧 bin 进行备份</li>
<li><em>向原 master 进程发送<code>USR2 信号</code></em>，USR2 平滑升级信号的具体作用如下，<em>原 master 进程会修改 pid，加后缀<code>.oldbin</code>，新 master 进程直接使用原 master 的 pid</em></li>
<li>向原 master 进程发<code>WINCH 信号</code>，逐渐关闭 worker 进程。在此过程中，原 master 继续接收请求，但是将请求转发给新 master 进程，等<code>原 master 的所有 worker</code>全部关闭后，向原 master 进程发<code>QUIT 信号</code>，就实现了平滑重启</li>
</ul>
<p>nginx 热更新有问题，怎么实现回滚？</p>
<ul>
<li><em>向原 master 进程发送 HUP，向新 master 进程发送 QUIT</em></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="董泽润的技术笔记-20231123"><em><strong>董泽润的技术笔记 [2023/11/23]</strong></em><a href="#董泽润的技术笔记-20231123" class="hash-link" aria-label="Direct link to 董泽润的技术笔记-20231123" title="Direct link to 董泽润的技术笔记-20231123">​</a></h2>
<p><a href="https://mytechshares.com/archives/" target="_blank" rel="noopener noreferrer">Archiv | 董泽润的技术笔记</a> 每篇都是干货。这老哥还挺能写，从 2022/04 到现在写了大概 60 篇博客。</p>
<hr>
<ul>
<li><a href="https://mytechshares.com/2022/04/06/how-to-read-redis-source/" target="_blank" rel="noopener noreferrer">如何阅读 redis 源码 | 董泽润的技术笔记</a></li>
<li><a href="https://vearne.cc/archives/40003" target="_blank" rel="noopener noreferrer">如何高效地阅读开源项目源代码 – 萌叔</a></li>
<li><a href="https://www.codedump.info/post/20200605-how-to-read-code-v2020/" target="_blank" rel="noopener noreferrer">如何阅读一份源代码？（2020 年版） - codedump 的网络日志</a></li>
</ul>
<p>这个技能还是很重要的，先说说我现在平时看源码的一些小技巧：</p>
<ul>
<li>从入口往里看，找核心代码。找测试用例，看看作者认为哪些代码，属于核心代码。</li>
<li>看看拓展包，用了哪些拓展包，可以推测出大概的业务逻辑。</li>
<li>多看 git blame，这点很方便，基本上可以从 git blame 看出来作者对哪部分代码的修改比较多，基本上这部分就是核心代码，需要研究透了。其他部分的代码相对来说就没那么重要了。<strong>大部分项目里核心代码和补充代码都是 28 开，所以提纲挈领很重要。</strong></li>
</ul>
<p><strong>但是我这个技巧只适用于一些比较简单的开源项目，这两篇文章针对的都是比较大型的开源项目。</strong></p>
<p>这两个文档里都提到的一些技巧：</p>
<ul>
<li>先看文档和一些使用方法，梳理清楚该项目的模块，从简单模块开始看（比如说 redis 模块很多，就可以从数据结构入手）</li>
<li>直接从网上找别人写的源码分析文档，直接搜就可以，中英文都有很多。</li>
<li><strong>从低版本开始看，因为相对会比较简单（比如 redis 可以从 v2.4 开始看，如果直接看 v7 大概率会懵逼，这个是我之前忽视的）</strong></li>
<li>可以把低版本和高版本的源码都 checkout 到本地，可以多版本对比地看。</li>
</ul>
<p>也有一些是各自文档中提到的点：</p>
<ul>
<li>多做分享。这点确实是，用源码分析来写博客是个好选择，源码分析既没办法写到文档里，直接写成博客发出去是最好的。</li>
<li>多做对比，不仅是服务本身不同版本的对比，也可以把这个服务和其他服务对比。比如看 RocketMQ 源码时，可以和 kafka 进行对比，看看为了实现相同功能，各自是怎么实现的。这个也能看出很多细节，很长功力。</li>
<li>通过 issue 学习</li>
</ul>
<hr>
<p><em><strong>上面这些都是方法，核心的方法论就是找核心代码，多想想作者在开发这部分功能时的所思所想。我之前忽视的点，总结一下就是多对比，服务本身多版本对比，服务之间多对比。</strong></em></p>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">谈谈缓存的指标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">吞吐量：常说的 QPS, 对标 bucket 实现的 hashmap 复杂度是 O(1), 缓存复杂度要高一些，还有锁竞争要处理，总之缓存库实现的效率要高</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">缓存命中率：光有吞吐量还不够，缓存命中率也非常关键，命中率越高说明引入缓存做用越大</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">高级特性：缓存指标统计，如何应对缓存击穿等等</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<ul>
<li><em><a href="https://mytechshares.com/2022/04/06/nginx-blog-quic/" target="_blank" rel="noopener noreferrer">基于 nginx quic 分支体验 http3 | 董泽润的技术笔记</a></em></li>
<li><a href="https://mytechshares.com/2022/04/06/hol-prd-issue/" target="_blank" rel="noopener noreferrer">Head Of Line Blocking 困扰两个月的线上问题 | 董泽润的技术笔记</a></li>
</ul>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> tcp restranmit 引起的 HOL(head of line) blocking</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p><a href="https://mytechshares.com/2023/02/06/talk-about-meitu-titan/" target="_blank" rel="noopener noreferrer">美图 kv 存储 titan | 董泽润的技术笔记</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">市面上开源 kv 轮子一大堆，架构上都是 rocksdb 做单机引擎，上层封装 proxy, 对外支持 redis 协议，或者根据具体业务逻辑定制数据类型，有面向表格 table 的，有做成列式存储的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">国内公司大部分都有自己的轮子，开发完一代目拿到 KPI 走人，二代目继续填坑，三四代沦为边缘。即使开源也很难有持续的动力去维护，比如本文要分享的 美图 titan，很多优化的 proposals 都没实现，但是做为学习项目值得研究，万一哪天二次开发呢</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<ul>
<li><a href="https://mytechshares.com/2022/04/06/week-mysql-null/" target="_blank" rel="noopener noreferrer">弱智的 MySQL NULL | 董泽润的技术笔记</a></li>
<li><a href="https://mytechshares.com/2022/04/06/mysql-is-shit-again/" target="_blank" rel="noopener noreferrer">再批 MySQL JSON | 董泽润的技术笔记</a></li>
</ul>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MySQL 字段一定要 NOT NULL, 并且设置合理的 default 值！！！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySQL 字段一定要 NOT NULL, 并且设置合理的 default 值！！！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySQL 字段一定要 NOT NULL, 并且设置合理的 default 值！！！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这几天同事遇到小问题，明明表结构中有 Unique 复合唯一索引，但是数据居然有重复，百思不得其解。因为涉及 json 字段，所以稍走些弯路，以为是 json 引入的问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这里强调一下，MySQL json 功能很弱，大家不要用，会有性能问题 (去年分享过)。同时，table schema 本身是一种强约束，字段 json 大家都往里塞，新功能开发，服务易手几次，json 就成了下水道，没人说得清里面存的都是啥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">除了上面使用的困惑，NULL 值过多会影响统计信息，可能影响执行计划。MySQL 很不负责的把对 NULL 值的统计方式交给了用户 innodb_stats_method, 默认值是 nulls_equal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p><a href="https://mytechshares.com/2022/04/10/gopher-should-know-goast/" target="_blank" rel="noopener noreferrer">每个 gopher 都需要了解的 Go AST | 董泽润的技术笔记</a></p>
<hr>
<p><a href="https://mytechshares.com/2022/04/06/something-about-http-auth/" target="_blank" rel="noopener noreferrer">实践出真知，聊聊 HTTP 鉴权那些事 | 董泽润的技术笔记</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RSA public private 在 DB 不能存储明文，要用 vault 或是 kms 加密</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Base64 是为了传输方便，省去空格特殊字符等等，但仍然是明文。hash 才是为了加密</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RSA 公钥加密是不想让别人看到内容，因为只有私钥才能解开。私钥加密是为了传递数据，不想让别人篡改</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JWT TOKEN 能防篡改但是不能防重放攻击，所以 exp 要短，同时要有 token 黑名单，还得有限流，哪怕是一小时也能把服务打爆</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TOKEN 是否存储 DB 呢？存有好处，也可以选择不存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RSA 加密 Encrypt 和摘要 Digest 的区别，前者可逆，后者不可逆</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JWT payload 自定义内容不易过多，一般 http header 都是有大小限制的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">三个概念：编码 Base64Encode、签名 HMAC、加密 RSA。编码是为了更的传输，等同于明文，签名是为了信息不能被篡改，加密是为了不让别人看到是什么信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">本文不涉及 TLS, 历史上很多鉴权的方案都是为了应对没有 TLS 的情况，外网基本都是 https, 所以很多方案现在己经不适合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Scope 非常重要，基于 least privilege 原则，只允许最小访问权限，一定要控制第三方能访问的资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">运维能力，ID 服务一般访问受限，只有特定服务或是 admin header 才能访问，需要提供 bot 或是网页运维能力</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">密钥需要定期 rotate, 业务代码当然也要适配</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>写的很不错，学到了 Digest 这种 auth 方法，</p>
<p><a href="https://www.example-code.com/golang/http_authentication.asp" target="_blank" rel="noopener noreferrer">Go HTTP Authentication (Basic, NTLM, Digest, Negotiate)</a></p>
<hr>
<p><a href="https://mytechshares.com/2022/04/06/why-time-source-impact-performance/" target="_blank" rel="noopener noreferrer">聊聊时钟源为什么会影响性能 | 董泽润的技术笔记</a></p>
<hr>
<p><a href="https://mytechshares.com/2022/04/06/why-not-modify-IDL/" target="_blank" rel="noopener noreferrer">聊聊为什么 IDL 只能扩展字段而非修改 | 董泽润的技术笔记</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">核心只有一条：对扩展开放，对修改关闭，永远只增加字段而不修改</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>开闭原则</p>
<hr>
<p><a href="https://mytechshares.com/2022/04/06/ut-failed-to-ioc-dip-di/" target="_blank" rel="noopener noreferrer">分享一个 UT failed 引出的思考 | 董泽润的技术笔记</a></p>
<hr>
<p><a href="https://mytechshares.com/2022/10/07/dive-redis-lua/" target="_blank" rel="noopener noreferrer">浅析 redis lua 实现 | 董泽润的技术笔记</a></p>
<hr>
<p><a href="https://mytechshares.com/2022/09/03/s3-parquet/" target="_blank" rel="noopener noreferrer">聊聊最近基于 S3 的项目 | 董泽润的  技术笔记</a></p>
<hr>
<p><a href="https://mytechshares.com/2022/05/18/debug-mysql-with-vscode/" target="_blank" rel="noopener noreferrer">新手如何调试 MySQL | 董泽润的技术笔记</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySQL 代码太庞大，5.1 大约 100w 行，5.5 130w 行，5.7 以后 330w 行，只能挑重点读源码。最近很多群里的人在背八股，没必要，有那时间学着调试下源码，读读多好</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>有时间一定要自己调调 MySQL 源码</p>
<hr>
<p><a href="https://mytechshares.com/2022/05/01/generics-can-make-your-go-code-slower/" target="_blank" rel="noopener noreferrer">为什么泛型使你的程序变慢 | 董泽润的技术笔记</a></p>
<hr>
<p><a href="https://mytechshares.com/2022/04/06/xiaojiqiao-k8s-debug-service/" target="_blank" rel="noopener noreferrer">小技巧！k8s 环境下调试服务 | 董泽润的技术笔记</a></p>
<hr>
<p><em><strong><a href="https://mytechshares.com/2022/04/06/how-to-handle-expand-interface/" target="_blank" rel="noopener noreferrer">如何应对不断膨胀的接口 | 董泽润的技术笔记</a></strong></em></p>
<hr>
<p><a href="https://mytechshares.com/2022/04/06/xiaojiqiao-how-debug-with-systemtap/" target="_blank" rel="noopener noreferrer">小技巧！如何用 systemtap 排查问题 | 董泽润的技术笔记</a></p>
<hr>
<p><a href="https://mytechshares.com/2022/04/06/talk-go-concurrency-safe/" target="_blank" rel="noopener noreferrer">聊聊 Go 并发安全 | 董泽润的技术笔记</a></p>
<hr>
<p><a href="https://mytechshares.com/2022/04/06/real-prd-go-big-mem-optimization/" target="_blank" rel="noopener noreferrer">真实环境下 Go 大内存服务优化实践 | 董泽润的技术笔记</a></p>
<hr>
<p><a href="https://mytechshares.com/2022/04/06/go-error-best-practice/" target="_blank" rel="noopener noreferrer">Go error 处理最佳实践 | 董泽润的技术笔记</a></p>
<hr>
<p><a href="https://mytechshares.com/2022/04/06/go-ctx-best-practice/" target="_blank" rel="noopener noreferrer">Go Context 最佳实践 | 董泽润的技术笔记</a></p>
<hr>
<p><a href="https://mytechshares.com/2022/04/06/do-you-known-cdc/" target="_blank" rel="noopener noreferrer">你真的了解 CDC 嘛 | 董泽润的技术笔记</a></p>
<hr>
<p><a href="https://mytechshares.com/2022/04/06/do-you-know-timeout/" target="_blank" rel="noopener noreferrer">你真的了解 timeout 嘛 | 董泽润的技术笔记</a></p>
<hr>
<p><a href="https://mytechshares.com/2022/04/06/do-you-know-LB/" target="_blank" rel="noopener noreferrer">你真的了解 Load Balance 嘛 | 董泽润的技术笔记</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="git">git<a href="#git" class="hash-link" aria-label="Direct link to git" title="Direct link to git">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="怎么给-github-的项目提-pr">怎么给 github 的项目提 pr？<a href="#怎么给-github-的项目提-pr" class="hash-link" aria-label="Direct link to 怎么给 github 的项目提 pr？" title="Direct link to 怎么给 github 的项目提 pr？">​</a></h3>
<ol>
<li>先 fork</li>
<li>clone 自己 fork 下来的项目，新建 branch，改代码，推上去</li>
<li>在自己的项目页里点 pr 按钮，跑过了对应项目的 ci，一个 pr 就提完了</li>
</ol>
<hr>
<p>提 PR 时需要注意哪些问题？</p>
<p>步骤很简单，需要注意以下问题</p>
<ul>
<li>在对应项目的 PR 页面里，最好标明对应的 issue，以及注意，随便查查，稍有要求的 coder 都会吐槽不遵守规范的人。</li>
<li>提交修改之前，需要注意原 repo 是否更新。以下有详细说明。</li>
</ul>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">提交修改 (Pushing changes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这步需要注意一下，有些项目更新的会比较频繁。当你做出修改和提交 PR 之前，可能有作者新的提交和 PR 被合并到原项目。如果有这种情况发生，在你工作区的派生项目会显示原项目有更新。例如：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">点击 Update branch 之后，将 原项目 更新同步到 派生项目。再进入 本地项目文件夹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important"> 当前文件夹位置 leerob.io</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important"> 保存本地修改并将工作目录还原到当前 HEAD 提交状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git stash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important"> 从远程拉取最新的项目代码，将派生项目更新同步到本地</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git pull</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important"> 将保存的修改还原回当前工作目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git stash pop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">查看更新后的内容是否和本地修改有冲突，如果有就解决冲突，完成后就可以提交修改了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important"> 当前文件夹位置 leerob.io</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important"> 保存本地修改并将工作目录还原到当前 HEAD 提交状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git commit -am &#x27;Delete unused Link declaration&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important"> 推到派生项目远端仓库，因为之前项目分支是在本地创建的，需要带上 &#x27;--set-upstream&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git push --set-upstream origin delete-unused-link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>fork 后如何同步源的最新代码？</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> remote </span><span class="token parameter variable" style="color:#36acaa">-v</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> remote </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> upstream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> fetch upstream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> checkout master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> merge upstream/master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> push origin master</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="怎么压缩-git-项目">怎么压缩 git 项目？<a href="#怎么压缩-git-项目" class="hash-link" aria-label="Direct link to 怎么压缩 git 项目？" title="Direct link to 怎么压缩 git 项目？">​</a></h3>
<p>之前没搞过，今天才看到 docs 项目 已经将近 900MB 了，所以压缩一下</p>
<p>相比于 <a href="https://harttle.land/2016/03/22/purge-large-files-in-gitrepo.html" target="_blank" rel="noopener noreferrer">寻找并删除 Git 记录中的大文件 | Harttle Land</a> ，这个文档 <a href="https://juejin.cn/post/6844904046797520909" target="_blank" rel="noopener noreferrer">git 查找大文件，删除大文件 - 掘金</a> 的步骤更清晰</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看git仓库大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> count-objects </span><span class="token parameter variable" style="color:#36acaa">-v</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 先查找大文件，命令如下：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 其中&quot;tail -20&quot;中的20表示条数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> rev-list </span><span class="token parameter variable" style="color:#36acaa">--objects</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--all</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">git</span><span class="token string variable" style="color:#36acaa"> verify-pack </span><span class="token string variable parameter variable" style="color:#36acaa">-v</span><span class="token string variable" style="color:#36acaa"> .git/objects/pack/*.idx </span><span class="token string variable operator" style="color:#393A34">|</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable function" style="color:#d73a49">sort</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable parameter variable" style="color:#36acaa">-k</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable number" style="color:#36acaa">3</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable parameter variable" style="color:#36acaa">-n</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable operator" style="color:#393A34">|</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable function" style="color:#d73a49">tail</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable parameter variable" style="color:#36acaa">-20</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable operator" style="color:#393A34">|</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable function" style="color:#d73a49">awk</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable string" style="color:#e3116c">&#x27;{print$1}&#x27;</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 需要按照上面输出的大文件，指定文件或者文件夹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> filter-branch </span><span class="token parameter variable" style="color:#36acaa">--force</span><span class="token plain"> --index-filter </span><span class="token string" style="color:#e3116c">&#x27;git rm -rf --cached --ignore-unmatch {cursor}&#x27;</span><span class="token plain"> --prune-empty --tag-name-filter </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> -- </span><span class="token parameter variable" style="color:#36acaa">--all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># push</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> push origin </span><span class="token parameter variable" style="color:#36acaa">--force</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 清除本地缓存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 删除之后会有大量输出，显示已经从各自历史log中剔除掉关于这个大文件的信息，之后可以使用gc命令再次压缩:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-rf</span><span class="token plain"> .git/refs/original/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> reflog expire </span><span class="token parameter variable" style="color:#36acaa">--expire</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">now </span><span class="token parameter variable" style="color:#36acaa">--all</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> gc </span><span class="token parameter variable" style="color:#36acaa">--prune</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">now</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ⚠️ 一定要执行“清除缓存”。另外，之后最好从远程重新拉取</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以下是操作记录：</p>
<p>查找大文件</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">f7be23ef34ae57e3c6d03cd405af8e5e94f288d4 .obsidian/themes/Blue Topaz.css</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e815a7710d779bdfeb475a8d7d85a503177b607c notes/linux/media/16000095155055/16006608226605.jpg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2619d7d0c7c124c7e1a7ceda472079d4b69eeb7e notes/linux/media/16000095155055/16006610351672.jpg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6bcab4a79269eac2345ab26e65a06876a481a22b notes/.obsidian/plugins/obsidian-mind-map/main.js</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5a40ff223e8b7aeb824bffb29a565bf341fee321 markmap/.obsidian/themes/Blue Topaz.css</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>看到所有大文件几乎都在 <code>.obsidian</code> 和 <code>notes</code> 文件夹，且这两个现在已经完全没用了，所以直接清除文件夹</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> filter-branch </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> --prune-empty --index-filter </span><span class="token string" style="color:#e3116c">&#x27;git rm -rf --cached --ignore-unmatch .obsidian/*&#x27;</span><span class="token plain"> --tag-name-filter </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> -- </span><span class="token parameter variable" style="color:#36acaa">--all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> filter-branch </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> --prune-empty --index-filter </span><span class="token string" style="color:#e3116c">&#x27;git rm -rf --cached --ignore-unmatch notes/*&#x27;</span><span class="token plain"> --tag-name-filter </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> -- </span><span class="token parameter variable" style="color:#36acaa">--all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>推送、清缓存</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  docs git:(main) git push origin --force --all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">枚举对象中: 4564, 完成.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">对象计数中: 100% (4564/4564), 完成.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">使用 8 个线程进行压缩</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">压缩对象中: 100% (3540/3540), 完成.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">写入对象中: 100% (4564/4564), 10.71 MiB | 707.00 KiB/s, 完成.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总共 4564（差异 2946），复用 1286（差异 924），包复用 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote: Resolving deltas: 100% (2946/2946), done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">To https://github.com/hapihacking/docs.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> + 2169fbd...c0b8e10 main -&gt; main (forced update)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  docs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  docs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  docs git:(main) rm -rf .git/refs/original/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  docs git:(main) git reflog expire --expire=now --all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  docs git:(main) git gc --prune=now</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">枚举对象中: 7925, 完成.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">对象计数中: 100% (7925/7925), 完成.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">使用 8 个线程进行压缩</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">压缩对象中: 100% (4293/4293), 完成.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">写入对象中: 100% (7925/7925), 完成.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总共 7925（差异 4511），复用 4630（差异 2489），包复用 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后，原项目大概 850MB</p>
<p>清除后，只有 43.7MB，其中 <code>.git文件夹</code> 38MB</p>
<p>安装拓展后，项目 313MB，其中 <code>node_modules</code> 占 269MB，也就是说压缩掉了至少 500M</p>
<p>目前 649-582 = 67MB，其中 <code>.git文件夹</code> 62.5MB，也就是说文档一共才不到 5MB</p>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if i delete a git branch, whether .git folder size will decrease or not?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No, deleting a git branch does not directly affect the size of the </span><span class="token code-snippet code keyword" style="color:#00009f">`.git`</span><span class="token plain"> folder. The </span><span class="token code-snippet code keyword" style="color:#00009f">`.git`</span><span class="token plain"> folder contains all the historical information and metadata of the repository, including all branches, commits, and other data. Deleting a branch only removes the reference to that branch, but the historical information and associated objects are still stored in the </span><span class="token code-snippet code keyword" style="color:#00009f">`.git`</span><span class="token plain"> folder. To reduce the size of the </span><span class="token code-snippet code keyword" style="color:#00009f">`.git`</span><span class="token plain"> folder, you can use commands like </span><span class="token code-snippet code keyword" style="color:#00009f">`git prune`</span><span class="token plain"> or </span><span class="token code-snippet code keyword" style="color:#00009f">`git gc`</span><span class="token plain"> to clean up unnecessary objects and optimize the repository.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>gh 开源项目 如何移除历史密钥</summary><div><div class="collapsibleContent_i85q"><ul>
<li>git-filter-repo</li>
<li>bfg</li>
</ul><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ⚠️ bfg无法修改二进制文件，只能直接从所有commit中删除</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 删除所有含有 &#x27;id_rsa&#x27; or &#x27;id_dsa&#x27; 的文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bfg --delete-files id_</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">dsa,rsa</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 注意bfg只能匹配指定文件，不能指定文件夹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ⚠️ --no-blob-protection 是指将历史中删除的记录，放到最新一次未签入的修改中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bfg --delete-files </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">filepath</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> --no-blob-protection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 如果需要删除文件夹，请使用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># bfg --delete-folders .git --no-blob-protection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bfg --delete-folders </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">folderpath</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> --no-blob-protection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 替换文件中的敏感信息（不删除文件）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bfg --replace-text </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">filepath</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> --no-blob-protection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 删除所有超过50MB的blobs文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bfg --strip-blobs-bigger-than 50M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>经过测试，发现 bfg 只能修改 commit 历史，但是无法直接修改当前文件</p></div></div></details>
<p>we can also use &quot;compress git&quot; to remove sk, but it&#x27;s achieved by removing the history of the entire file, other than just remove or replace the certain sk.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-delete-commit">How to delete commit?<a href="#how-to-delete-commit" class="hash-link" aria-label="Direct link to How to delete commit?" title="Direct link to How to delete commit?">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># search for commit-id wanna reset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> log xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> reset </span><span class="token parameter variable" style="color:#36acaa">--hard</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">commit-id</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> push origin HEAD </span><span class="token parameter variable" style="color:#36acaa">--force</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>False Deletion Recovery</p>
<p>If found that you copied the wrong commit_id after rolling back the code, or if you deleted a commit record by mistake, you can also recover it with the code below:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Get hash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> relog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> reset </span><span class="token parameter variable" style="color:#36acaa">--hard</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hash</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="alternate-print">alternate-print<a href="#alternate-print" class="hash-link" aria-label="Direct link to alternate-print" title="Direct link to alternate-print">​</a></h2>
<p>为什么要写这篇 blog？</p>
<p>“多线程轮流打印问题”是很常见的笔试题，可以大概分为两类，固定值打印和非固定值打印。实际上考察的都是<strong>线程间的通信问题</strong>，思路基本上都是一个线程执行完毕，阻塞该线程，唤醒其他线程，按顺序执行下一个线程。这篇 blog 希望能够给出这类问题的通用解。</p>
<p>实现两个协程，其中一个产生随机数并写入到 chan 中，另一个从 chan 中读取，并打印出来，最终输出 5 个随机数</p>
<p>经典的“生产者消费者问题”</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="固定值交替打印">固定值交替打印<a href="#固定值交替打印" class="hash-link" aria-label="Direct link to 固定值交替打印" title="Direct link to 固定值交替打印">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>固定值交替打印比较简单</p><p>可以看到，无论是打印数字，还是打印字母，实际上没有区别。无非是打印数字可以直接通过遍历 <code>make(chan token)</code></p><p>核心是构造一个<code>current chan</code>和<code>next chan</code>的方法</p></div></div>
<p>常见题目如下：</p>
<ul>
<li>假设有 4 个协程，分别编号为 1/2/3/4，每秒钟会有一个协程打印出自己的编号，现在要求输出编号总是按照 1/2/3/4 这样的顺序打印，共打印 100 次</li>
<li>编写一个程序，开启 3 个线程，这 3 个线程的 ID 分别为 A、B、C，每个线程将自己的 ID 在屏幕上打印 10 遍，要求输出结果必须按 ABC 的顺序显示；如：ABCABC...依次递推</li>
<li>轮流打印 dog pig cat，共打印 10 次？</li>
<li>两个人 bob 和 annie，互相喊对方的名字 10 次后，最终 bob 对 annie 说 bye bye？</li>
</ul>
<p>无非是打印点什么数字、字符串之类的东西。我们这里就以打印数字为例。</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">我自己实现的，最简单版本</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">小优化，封装了一下</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">优化2</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">pipeline+wg</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">fan-in</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Barrier</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">semaphore</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 假设有 4 个协程，分别编号为 1/2/3/4; 每秒钟会有一个协程打印出自己的编号; 现在要求输出编号总是按照 1/2/3/4 这样的顺序打印; 共打印 100 次;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> inChan </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> outChan </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   vx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain">  vx</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inChan </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// for i := 0; i &lt; num; i++ {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">//  inChan &lt;- num</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inChan</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inChan </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> inChan </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   outChan </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// for  {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//  token := &lt;- inChan</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//  time.Sleep(time.Second)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//  outChan &lt;- token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">outChan</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inChan</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> out </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> outChan </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 假设有 4 个协程，分别编号为 1/2/3/4; 每秒钟会有一个协程打印出自己的编号; 现在要求输出编号总是按照 1/2/3/4 这样的顺序打印; 共打印 100 次;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> nums </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pubNums</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> nu </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">subNums</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nums</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> nu </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pubNums</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nums </span><span class="token operator" style="color:#393A34">...</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> out </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> num </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> nums </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    out </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> num</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">subNums</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> out </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> ik </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ik</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> token </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [channel 实战应用，这篇就够了！ - SegmentFault 思否](https://segmentfault.com/a/1190000039056339)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> num </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> chs </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">chs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> token</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">worker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">j</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">j</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">j</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">num</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> chs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> token</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">worker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ch </span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> token</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next </span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  token </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">ch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  next </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sync&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> token </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> wg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WaitGroup</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// [channel 实战应用，这篇就够了！ - SegmentFault 思否](https://segmentfault.com/a/1190000039056339)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> num </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> chs </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">chs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> token</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">worker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">j</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">j</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">j</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">num</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> chs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> token</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">worker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ch </span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> token</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next </span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Done</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  token </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">ch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  next </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 假设有 4 个协程，分别编号为 1/2/3/4; 每秒钟会有一个协程打印出自己的编号; 现在要求输出编号总是按照 1/2/3/4 这样的顺序打印; 共打印 100 次;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> out </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fanIn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">pubNums</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fanIn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channels </span><span class="token operator" style="color:#393A34">...</span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> out </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> channels </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    out </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pubNums</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nums </span><span class="token operator" style="color:#393A34">...</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> out </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> num </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> nums </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    out </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> num</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sync&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> barrier </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewCond</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Mutex</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> current </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    barrier</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> current </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> id </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     barrier</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;协程编号:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    current </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    barrier</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Broadcast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    barrier</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> semaphore </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> semaphore </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  semaphore</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">semaphore</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;协程编号:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    semaphore</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">%</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> semaphore</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="多线程数字--字母">多线程数字 + 字母<a href="#多线程数字--字母" class="hash-link" aria-label="Direct link to 多线程数字 + 字母" title="Direct link to 多线程数字 + 字母">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><em>这类问题比固定值要稍微复杂一些，但是与线程本身无关，这类题目往往有一些小技巧需要注意。</em></p></div></div>
<ul>
<li>使用两个协程交替打印序列，一个协程打印数字，另一个协程打印字母，最终效果如下<code>1A2B...26Z</code></li>
<li>用三个线程，顺序打印字母 A-Z，输出结果是 1A 2B 3C 1D 2E...打印完毕最后输出一个 OK</li>
<li><del>实现两个协程，其中一个产生随机数并写入到 chan 中，另一个从 chan 中读取，并打印出来，最终输出 5 个随机数</del></li>
<li>给一个数组，并发交替打印奇数和偶数，请分别用 chan、sync 和原子操作实现？</li>
</ul>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">1A2B...26Z</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">1A2B3C...</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sync&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> numberCh </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> letterCh </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">rune</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> wg sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WaitGroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Done</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">26</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">numberCh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">letterCh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Done</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token char">&#x27;A&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token char">&#x27;Z&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   numberCh </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token char">&#x27;A&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   letterCh </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">numberCh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">letterCh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sync&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 2A 3B 1C 2D 3E 1F 2G 3H 1I 2J 3K 1L 2M 3N 1O 2P 3Q 1R 2S 3T 1U 2V 3W 1X 2Y 3Z OK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 1A 2B 3C 1D 2E 3F 1G 2H 3I 1J 2K 3L 1M 2N 3O 1P 2Q 3R 1S 2T 3U 1V 2W 3X 1Y 2Z OK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> wg sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WaitGroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> letterCh </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">rune</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> numberCh </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Done</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">26</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%d%c &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">numberCh</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">letterCh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Done</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">26</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   vi </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> vi </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   numberCh </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> vi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Done</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token char">&#x27;A&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token char">&#x27;Z&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   letterCh </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">numberCh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">letterCh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;OK&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="多线程纯数字打印">多线程纯数字打印<a href="#多线程纯数字打印" class="hash-link" aria-label="Direct link to 多线程纯数字打印" title="Direct link to 多线程纯数字打印">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><strong>这里只列举一下第一题的几种解法，其他几个变种题目可以自己实现一下</strong></p><p>实际上也是某种“非固定值打印”</p><p>这种问题嘛，就是多此一举，实际上就是循环一个 go func，该func里再起个循环打印就可以了。</p></div></div>
<ul>
<li>10 个线程依次打印 1-10,11-20 和到 100？</li>
<li>三个线程交替打印至 100：线程 1 打印 1、4、7，线程 2 打印 2、5、8，线程 3 打印 3、6、9，一直打印到 100 结束</li>
<li>如何让 10 个线程按照顺序打印 0123456789？</li>
<li>怎么开 10 个线程，每个线程打印 1000 个数字，要按照顺序从 1 打印到 1w？</li>
<li>用五个线程，顺序打印数字 1~无穷大，其中每 5 个数字为 1 组，如下：其中 id 代表线程的 id</li>
</ul>
<p>这几个都可以分别用 chan、mutex、wg和atomic实现一下，非常简单</p>
<hr>
<p><a href="https://go.dev/play/p/ZUnQAvquU67" target="_blank" rel="noopener noreferrer">Go Playground - The Go Programming Language</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="爬虫通用问题反爬对抗反爬"><em><strong>爬虫通用问题（反爬&amp;对抗反爬）</strong></em><a href="#爬虫通用问题反爬对抗反爬" class="hash-link" aria-label="Direct link to 爬虫通用问题反爬对抗反爬" title="Direct link to 爬虫通用问题反爬对抗反爬">​</a></h2>
<ul>
<li><em>怎么在爬虫中使用布隆过滤器？爬虫的哪些场景需要使用布隆过滤器？</em> 对已经爬过的 url 去重（幂等性入库），以及作为<code>failed url容器</code>进行重试操作</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>对爬虫有哪些心得、总结？</p><ul>
<li><em>爬虫开发实际上是黑盒的，且实时性很强</em></li>
<li>黑盒体现在，无法得到明确反馈，只能根据经验自行判断。</li>
<li>实时性强体现在，很可能一周前还 work 的爬虫，现在就不 work 了，取决于很多因素，比如浏览器和 CDP 升级、或者网站反爬策略升级，甚至对方服务下线了。</li>
<li>因为这两点特性，我们可以得出爬虫开发的一条经验：<em>纠结于爬虫是否 work 毫无意义，也没必要自己花大量时间去对抗大型网站的反爬，因为大概率失败。我们只需要把常用反爬和对抗反爬的套路都足够熟练，把这些方案都工具化，以最快时间秒掉 99% 的网站</em>，毕竟不是专业的爬虫工程师，剩下的 1% 的网站是留给他们的。</li>
<li>如果某个网站、APP 爬不下来，可以找找提供类似功能的网站。比如想爬取电影票数据，美团电影的 yoda 反爬很强，可以试试淘票票。</li>
<li><strong>反爬的核心在于<code>抓爬虫</code>，查到爬虫后，再进行<code>返回错误</code>、<code>随机返回假数据</code>等可有可无操作。如果反爬被打穿了之后，就需要限流系统来兜底了</strong></li>
</ul></div></div>
<p>作为爬取方，怎么确定爬虫方案？需要使用哪些技能？在爬取速度和稳定性之间怎么找到平衡点？</p>
<p>查看网站是否动态渲染？是否有接口？接口是否反爬？</p>
<div class="language-plantuml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plantuml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@startuml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">title 爬虫思路流程图</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (是否动态渲染？) is (yes) then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  :找到对应接口，带着原参数用curl再请求一次;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else (no)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  :直接用网页解析工具抓取;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (是否请求成功？) is (no) then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  :确定有反爬;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else (yes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  :说明该网站未处理cookie和重放，直接抓取;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (是否对爬虫性能有要求？) is (no) then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  :浏览器渲染;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  :自检stealth.js等;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else (yes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  :想办法搞定js加密;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@enduml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>数据采集、清洗、分析、可视化、挖掘</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 基于身份识别</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> header 参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> IP 代理池 </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">一日一技：为什么网站知道我的爬虫使用了代理？</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2MzEwNTY3OQ==&amp;mid=2648985933&amp;idx=1&amp;sn=45a383d97f72a7454e9c0b27afe311ff</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> user-agent user-agent 池</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 通过 cookie 检查用户是否具有权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> referer 判断请求发起的源头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么使用 IP 代理池？怎么查看当前请求使用的 IP？怎样检测配置的 IP 代理是否生效？怎么维护一个高匿 IP 代理池？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">不要自己维护 IP 代理池，直接买第三方服务</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">（比如芝麻 HTTP 之类的付费代理 IP 服务，或者直接使用 crawlera 等提供代理 IP 服务的第三方爬虫平台），免费的根本就是浪费时间，90% 以上都不能用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 模拟 UA 的时候，也要记得模拟 header 里的其他参数。另外，现在的反爬虫策略，为了降低误伤率，检查爬虫的时候，会对请求的可疑性打分，出现可疑行为后，就加上几分，某些行为分数高，某些行为分数低。当你总积分达到一定程度时，再调用封禁的流程。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 每次打开新页面，cookie 都会变化，而 cookie 使用 x-zse-86 进行加密而重点就在于对 x-zse-86 进行解密</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 可以解决 99% 的爬虫，借用了目前主流爬虫库基本都不支持 HTTP2，而浏览器对 HTTP2 都已良好支持的现状</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> 验证码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#####</span><span class="token title important"> 滑动验证码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">增强版！如何深度学习识别滑动验证码缺口</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2MzEwNTY3OQ==&amp;mid=2648983962&amp;idx=1&amp;sn=479843a4f3a672e8520a5ac22c540a18</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#####</span><span class="token title important"> 滑块验证码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#####</span><span class="token title important"> 点触验证码（ReCaptcha）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  使用</span><span class="token code-snippet code keyword" style="color:#00009f">`YesCaptcha`</span><span class="token plain">解决</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">我又找到了一个破解谷歌验证码的新方案！</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2MzEwNTY3OQ==&amp;mid=2648981206&amp;idx=1&amp;sn=67d7bfcec1300a35ac5554680e0c2e22</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">谷歌验证码 ReCAPTCHA 的模拟点击破解方案来了！</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2MzEwNTY3OQ==&amp;mid=2648986784&amp;idx=1&amp;sn=eff9d14cb4ea8dabff24920bf5b99d34</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> 浏览器指纹（JA3 指纹）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是</span><span class="token code-snippet code keyword" style="color:#00009f">`JA3指纹`</span><span class="token plain">？什么原理？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么构建</span><span class="token code-snippet code keyword" style="color:#00009f">`JA3指纹`</span><span class="token plain">？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么解决</span><span class="token code-snippet code keyword" style="color:#00009f">`JA3指纹`</span><span class="token plain">？ </span><span class="token code-snippet code keyword" style="color:#00009f">`ja3transport`</span><span class="token plain">和</span><span class="token code-snippet code keyword" style="color:#00009f">`CycleTLS`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 解决 ja3 指纹的原理？ja3transport 库会在三次握手后，即将发起 client hello 数据包时，</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">拦截该包并用自定义 ja3 替换掉原有的</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> ja3s 相比于 ja3 有什么优化？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 有哪些靠谱的 ja3 黑名单/已收录指纹？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">用 Go 构建你专属的 JA3 指纹</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzkyMDAzNjQxMg==&amp;mid=2247484550&amp;idx=1&amp;sn=cfa881e5609ee19236ddc599f3b2ab5e</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> webdriver 特征</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> 随机数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">通过 js 生成请求参数，或者通过预请求获取随机值，作为请求参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">用 otto 获取 js 的执行结果，或者用 webdirvier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> PathMarker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">通过检测网页和请求之间的关系来检测分布式爬虫。具体原理是，通过向 URL 添加 tag 来跟踪该 URL 之前的页面，并识别访问该 URL 的用户。根据 URL 访问路径和访问时间的不同模式，使用 SVM 模型来区分恶意网络爬虫和普通用户。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 基于数据加密</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> 使用`自定义字体文件`反爬</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 尝试通过抓包获取字体文件，找规律</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> 对抗</span><span class="token code-snippet code keyword" style="color:#00009f">`字体反爬`</span><span class="token plain">？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 把一部分文字用图片替代，这个是最常见的反爬手段，比如链家以及很多小说网站都是这么实现的。字体文件的存储方案大概有三种，</span><span class="token code-snippet code keyword" style="color:#00009f">`存储像素点`</span><span class="token plain">，</span><span class="token code-snippet code keyword" style="color:#00009f">`存储轮廓`</span><span class="token plain">，</span><span class="token code-snippet code keyword" style="color:#00009f">`存储笔画`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">通常使用</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`存储轮廓`</span><span class="token italic content">的方案，用</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`贝塞尔曲线`</span><span class="token italic content">来描述字体的轮廓，展示的时候，计算成像素点，输出到设备上。其他两种方式都不太合适</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> css 偏移反爬</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">需要通过 css 位移才能产生真实数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 计算 css 的偏移</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">一日一技：CSS 偏移反爬虫的原理和破解方法</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2MzEwNTY3OQ==&amp;mid=2648985411&amp;idx=1&amp;sn=b69634959c5b32196cf515a2fd57d7ec</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> 通过数据图片化反爬</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">分为存储像素点、轮廓、笔画三种</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 图片直接替换文字，用 OCR 识别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#####</span><span class="token title important"> OCR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OCR 通常作为兜底方案</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> easyocr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> tesseract</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> kerasocr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> js 反爬</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#####</span><span class="token title important"> js 混淆加密 (sojson)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> 怎么破解 js 反爬？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用</span><span class="token code-snippet code keyword" style="color:#00009f">`playwright`</span><span class="token plain">通过浏览器来模拟逆向流程，来确定 js 代码依赖的拓展包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">Python 爬虫进阶必备 | 某游戏网站密码加密逻辑分析 webpack 的 js 加密代码怎么扣 -思路分析</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2MzEwNTY3OQ==&amp;mid=2648980951&amp;idx=1&amp;sn=f7bdd431e78dba7d9bc034768f5b535e</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">简单方便的 JavaScript 逆向辅助模拟方法</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2MzEwNTY3OQ==&amp;mid=2648980941&amp;idx=1&amp;sn=9b93cc295de8c2428cddfabd2a240148</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">Python 爬虫进阶必备 | 某著名人均百万问答社区 header 参数加密逻辑分析</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2MzEwNTY3OQ==&amp;mid=2648985875&amp;idx=1&amp;sn=d86418b4a75dee72b64e3bc4bca37cf1</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">jsvmp-某乎_x-zes-96 参数算法还原（手把手教学）</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2MzEwNTY3OQ==&amp;mid=2648985946&amp;idx=1&amp;sn=4f039dc1289e1cb29cf618a964c68d5e</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> mitmproxy 是什么？使用流程？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 用 pip 安装 mitmproxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 去 mitm 官网下载对应系统的证书</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 导入 HTTPS 证书：把 pem 证书转成 crt 证书，</span><span class="token code-snippet code keyword" style="color:#00009f">`openssl x509 -in mitmproxy-ca-cert.pem-informPEM-outmitmproxy-ca-cert.crt`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 我们可以使用</span><span class="token code-snippet code keyword" style="color:#00009f">`mitmproxy`</span><span class="token plain">,</span><span class="token code-snippet code keyword" style="color:#00009f">`mitmdump`</span><span class="token plain">,</span><span class="token code-snippet code keyword" style="color:#00009f">`mitmweb`</span><span class="token plain">命令来监听</span><span class="token code-snippet code keyword" style="color:#00009f">`默认的8080端口`</span><span class="token plain">的请求，使用</span><span class="token code-snippet code keyword" style="color:#00009f">`mitmdump-s httpproxy.py-p 9090`</span><span class="token plain">来自定义端口。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">5.</span><span class="token plain"> 第二个进程使用</span><span class="token code-snippet code keyword" style="color:#00009f">`对应的端口`</span><span class="token plain">运行 selenium 脚本。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">######</span><span class="token title important"> 逆向</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#####</span><span class="token title important"> js 脚本反爬</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> mitmproxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> anyproxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> playwright</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#####</span><span class="token title important"> js 反调试</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">######</span><span class="token title important"> jsrpc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">Jsrpc 学习 ——Cookie 变化的网站破解教程</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2MzEwNTY3OQ==&amp;mid=2648985315&amp;idx=1&amp;sn=13b5ba7d6d9d989451ab62877085f74b</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">RPC 技术及其框架 Sekiro 在爬虫逆向中的应用，加密数据一把梭！</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2MzEwNTY3OQ==&amp;mid=2648985365&amp;idx=1&amp;sn=4feb19f4b03eea8b2426cedaf423082a</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 基于爬虫行为</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 基于 IP/账号等参数的请求频率和总请求数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 通过 IP/账号请求之间的间隔 进行反爬</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 通过 IP/账号每天请求总次数进行反爬</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 鼠标滑动轨迹：把鼠标轨迹及滑动速度等作为请求参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 方案 1：生成这些参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 方案 2：通过 selenium 模拟鼠标滑动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 通过 js 实现页面跳转，无法在源码中获取下一页 url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 方案 1：分析 url 之间的关联性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 方案 2：用 otto 之类的 js 解释器直接跑 js</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 通过蜜罐区分爬虫和正常用户</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 方案 1：响应里添加假数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 方案 2：阻塞爬虫的任务队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 比如生成大量垃圾 url，从而阻塞任务队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 响应里添加大文件 url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> 怎么制造爬虫蜜罐？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`&lt;a&gt;标签`</span><span class="token plain">的 href 里写一个 url，这个 url 实际上是个蜜罐，真正的 url 需要拼接获得，比如根据</span><span class="token code-snippet code keyword" style="color:#00009f">`&lt;base&gt;标签`</span><span class="token plain">拼接；爬虫访问进去后，就会抓到假数据，或者被立即屏蔽。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 第三方服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 瑞数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> cloudflare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> distil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> 瑞数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">人均瑞数系列，瑞数 4 代 JS 逆向分析（文末送书）</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2MzEwNTY3OQ==&amp;mid=2648986972&amp;idx=1&amp;sn=117b4e51776f09acf25a5e9bc49a93a8</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">人均瑞数系列，瑞数 5 代 JS 逆向分析</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2MzEwNTY3OQ==&amp;mid=2648987208&amp;idx=1&amp;sn=e271cabb5b631e262dbbe6bd9a3d93f8</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> cloudflare 五秒盾</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">Anorov/cloudflare-scrape</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://github.com/Anorov/cloudflare-scrape</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">VeNoMouS/cloudscraper</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://github.com/venomous/cloudscraper</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">一日一技：【最新】再次突破 CloudFlare 五秒盾付费版</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzI2MzEwNTY3OQ==&amp;mid=2648987371&amp;idx=1&amp;sn=84401455501f1fb12984a8d24f9cd6e8#rd</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">####</span><span class="token title important"> 亮数据 Bright Data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">亮数据 - 网络数据一站式平台 海汇互动</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://www.bright.cn/</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">具体可以看 </span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">科技爱好者周刊（第 254 期）：人生是一个长板问题 - 阮一峰的网络日志</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://www.ruanyifeng.com/blog/2023/05/weekly-issue-254.html</span><span class="token url" style="color:#36acaa">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>crawler and anti-crawler are tow sides of the same coin.</p>
<p>we can generally summarize that several anti-crawler methods are based on identify recognition, data encryption and crawler behavior.</p>
<p>anti-crawler based on identify recognition is the most basic, it&#x27;s just some header params like UA, cookie, referer and so on. and some params that can be used to recognize, such as JA3 fingerprint, webdriver, PathMarker(better referer params), and captcha(slide-captcha, ReCaptcha...)</p>
<p>Except this, we can also anti-crawler by encrypt data, use static resources such as fonts, css and js to implement.</p>
<p>From this perspective, we can actually regard these two points as the different between the server side(identify recognition) and the client side(data encryption).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="doc-处理onetab中的网页">[doc] 处理OneTab中的网页<a href="#doc-处理onetab中的网页" class="hash-link" aria-label="Direct link to [doc] 处理OneTab中的网页" title="Direct link to [doc] 处理OneTab中的网页">​</a></h2>
<p>大概是几部分：</p>
<ul>
<li>InnoDB源码解析</li>
<li>MESI和内存屏障</li>
<li>golang channel</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="linux-process-and-thread">linux process and thread<a href="#linux-process-and-thread" class="hash-link" aria-label="Direct link to linux process and thread" title="Direct link to linux process and thread">​</a></h3>
<p><a href="https://mp.weixin.qq.com/s?__biz=MjM5Njg5NDgwNA==&amp;mid=2247490188&amp;idx=1&amp;sn=cae93c4e5ea99a5a49f64de02cc059d3" target="_blank" rel="noopener noreferrer">聊聊 Linux 中线程和进程的联系与区别！</a></p>
<p>我知道进程和线程的struct都是task_struct，但是我确实并不清楚“线程创建过程的具体流程”</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">可见和创建进程时使用的 fork 系统调用相比，创建线程的 clone 系统调用几乎和 fork 差不多，也一样使用的是内核里的 do_fork 函数，最后走到 copy_process 来完整创建。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">不过创建过程的区别是二者在调用 do_fork 时传入的 clone_flags 里的标记不一样！。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 创建进程时的 flag：仅有一个 SIGCHLD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 创建线程时的 flag：包括 CLONE_VM、CLONE_FS、CLONE_FILES、CLONE_SIGNAL、CLONE_SETTLS、CLONE_PARENT_SETTID、CLONE_CHILD_CLEARTID、CLONE_SYSVSEM。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">关于这些 flag 的含义，我们选几个关键的做一个简单的介绍，后面介绍 do_fork 细节的时候会再次涉及到。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> CLONE_VM: 新 task 和父进程共享地址空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> CLONE_FS：新 task 和父进程共享文件系统信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> CLONE_FILES：新 task 和父进程共享文件描述符表</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>创建进程和线程分别使用fork和clone的syscall，但是实际上两个都是通过do_fork来调用copy_process来进行创建。</p>
<p><em>两者的区别就在于do_fork的flag不同</em></p>
<p>还是拿公司项目举例，process就是项目立项了，但是在项目内部，需要实现不同的模块时，就需要不同的flag，所以线程更多元化一些。</p>
<p>通过 copy_process 的源码可以看到，就是两部分，从idle process复制</p>
<hr>
<p><a href="https://mp.weixin.qq.com/s?__biz=MjM5Njg5NDgwNA==&amp;mid=2247490622&amp;idx=1&amp;sn=cc98b3eb0c2802199a3d0a9bb50a0c50" target="_blank" rel="noopener noreferrer">你的新进程是如何被内核调度执行到的？</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="golang-channel">golang channel<a href="#golang-channel" class="hash-link" aria-label="Direct link to golang channel" title="Direct link to golang channel">​</a></h3>
<p>我想知道fanin, fanout和pipeline的写法到底有啥区别？</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">多个 goroutine 可以从同一个 channel 读取数据，直到该通道关闭，这称为 fan-out（扇出）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这个称呼比较形象，它将数据进行分散，所以被称为扇出。扇出是一种分发任务的模式。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">单个 goroutine 可以从多个输入 channel 中读取数据，直到所有输入都关闭。具体做法是将输入 channel 多路复用到同一个 channel 上，当所有输入 channel 都关闭时，该 channel 也关闭，这称为 fan-in（扇入）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">它将数据进行聚合，所以被称为扇入。扇入是一种整合任务结果的模式。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>fan-out 用于分发任务，fan-in 用于数据整合</p>
<hr>
<p><a href="https://colobu.com/2023/07/16/why-conucrrent-programming-is-hard/" target="_blank" rel="noopener noreferrer">为什么说并发编程很难？</a></p>
<p>barrier</p>
<p>用 semaphore 和 cyclicbarrier 实现</p>
<p><a href="https://go.dev/play/p/A5vj4Pe-CQ8" target="_blank" rel="noopener noreferrer">Go Playground - The Go Programming Language</a></p>
<p>CyclicBarrier是一种同步原语，它允许一组线程在某个临界点处等待，直到所有线程都达到该点，然后同时继续执行。与Barrier不同的是，CyclicBarrier在每个线程到达临界点后会自动重置，可以重复使用。</p>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important">为什么pipeline模式中要使用waitrgroup呢？是不是多此一举？比如说</span><br></span><span class="token-line" style="color:#393A34"><span class="token title important"></span><span class="token title important punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important">也就是说推荐在pipeline中使用waitgroup是吗？</span><br></span><span class="token-line" style="color:#393A34"><span class="token title important"></span><span class="token title important punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token title important"></span><span class="token title important punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在channel的pipeline模式中使用waitgroup，会提升性能吗？还是说只是为了保证所有goroutine都能够执行？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在channel的pipeline模式中使用</span><span class="token code-snippet code keyword" style="color:#00009f">`WaitGroup`</span><span class="token plain">主要是为了确保所有的</span><span class="token code-snippet code keyword" style="color:#00009f">`goroutine`</span><span class="token plain">都能够执行完毕，而不是为了提升性能。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token code-snippet code keyword" style="color:#00009f">`WaitGroup`</span><span class="token plain">是一个计数信号量，用于等待一组</span><span class="token code-snippet code keyword" style="color:#00009f">`goroutine`</span><span class="token plain">的结束。当你在pipeline模式中使用多个</span><span class="token code-snippet code keyword" style="color:#00009f">`goroutine`</span><span class="token plain">执行不同的任务时，可能需要确保所有的任务都完成后才能继续执行下一步操 作。这时，可以使用</span><span class="token code-snippet code keyword" style="color:#00009f">`WaitGroup`</span><span class="token plain">来等待所有的</span><span class="token code-snippet code keyword" style="color:#00009f">`goroutine`</span><span class="token plain">执行完毕。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">使用</span><span class="token code-snippet code keyword" style="color:#00009f">`WaitGroup`</span><span class="token plain">可以保证所有的</span><span class="token code-snippet code keyword" style="color:#00009f">`goroutine`</span><span class="token plain">都能够执行完毕，以避免程序过早地退出或产生不可预测的结果。然而，对于性能的提升来说，</span><span class="token code-snippet code keyword" style="color:#00009f">`WaitGroup`</span><span class="token plain">并不能直接起到作用。它只是一种同步机制，确保顺序地等待所有任务完成。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">若要提升性能，你可以考虑使用其他并发模式，如使用</span><span class="token code-snippet code keyword" style="color:#00009f">`goroutine`</span><span class="token plain">和</span><span class="token code-snippet code keyword" style="color:#00009f">`channel`</span><span class="token plain">结合的方式来进行并发处理，或者使用更高级的并发库，如</span><span class="token code-snippet code keyword" style="color:#00009f">`sync.Pool`</span><span class="token plain">等。这些方式可以更好地利用多核处理器的性能，从而提升整体的执行效率。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p><em><strong><a href="https://mp.weixin.qq.com/s?__biz=MzI4NDM0MzIyMg==&amp;mid=2247488668&amp;idx=1&amp;sn=85c3100f3cabb3982f340cee2f26906a" target="_blank" rel="noopener noreferrer">gotraining并发编程之Channel篇 文末有彩蛋</a></strong></em> channel使用相关，然后提供了一些练习题</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">无缓冲的channels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 接收在发送之前</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 优点: 能100% 保证发送的信号已被接收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 缺点: 接收信号时的延迟未知</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">带缓冲的channels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 缓冲区越大，保证性越差</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 缓冲区为1可以给你一个延迟发送的保证</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 发送在接收之前</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 优点: 减少信号之间的阻塞延迟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 缺点: 不能保证发送的信号何时被接收到</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">关闭channels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 关闭在接收之前(如有缓冲)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 没有数据的信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 非常适合信号取消和用于设置deadline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nil channel :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 发送和接收块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 关闭信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 非常适合速度限制或短暂停顿</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个总结还挺到位的。</p>
<p><em>把chan的不同type和state的各种使用场景和优缺点都整理到了。</em></p>
<hr>
<p><a href="https://gist.github.com/hxhac/6e40ad06d80bbd8d74f0792688a9cf7b" target="_blank" rel="noopener noreferrer">golang channel barrier usage</a></p>
<p><a href="https://go.dev/play/p/V2i7oeEE071" target="_blank" rel="noopener noreferrer">Go Playground - The Go Programming Language</a></p>
<p><a href="https://go.dev/play/p/b5PZoRzZPfS?v=" target="_blank" rel="noopener noreferrer">Go Playground - The Go Programming Language</a></p>
<p><a href="https://gist.github.com/hxhac/96706d2e07ea6680695636a868db7950" target="_blank" rel="noopener noreferrer">channel fanout</a></p>
<p><a href="https://gist.github.com/hxhac/8b9c7e42d9f3cfb67f6cbd50b4c10b86" target="_blank" rel="noopener noreferrer">sync.code usage</a></p>
<p><a href="https://gist.github.com/hxhac/d9d391a6ce36c4964c832835aec761eb" target="_blank" rel="noopener noreferrer">for...select and exit goroutine usage</a></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 创建一个输入通道，用于发送字符串 &quot;Go&quot;、&quot;Lang&quot;、&quot;Channels&quot;、&quot;Are&quot;、&quot;Powerful&quot;、&quot;And&quot; 和 &quot;Fun&quot;. 使用 fanOut 函数将输入通道的字符串分发给 3 个处理器，并在每个处理器中将字符串转换为大写字母，并且只发送长度为奇数的字符串到输出通道。在主函数中，从每个处理器的输出通道中读取并打印所有字符串。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 创建一个输入通道，用于发送数字 1 到 20。使用 fanOut 函数将输入通道的数据分发给 4 个处理器，并在每个处理器中将数字乘以 2。在主函数中，从每个处理器的输出通道中读取并打印所有数据。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651449810&amp;idx=3&amp;sn=4a4cd9ac9573c86a52645dc6ebfb9dc0" target="_blank" rel="noopener noreferrer">Go：说说fanIn和fanOut模式</a> 分别提供了fanin和fanout的几种写法，并且提供了不同写法的benchmark。能够看到除了reflect以外，其他写法的性能几乎没有差别。</p>
<p>其实没啥意思，都使用最直观的实现就可以了。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// func fanIn(chans ...&lt;-chan interface{}) &lt;-chan interface{} {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//  out := make(chan interface{})</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//  go func() {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//   var wg sync.WaitGroup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//   wg.Add(len(chans))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//   for _, ch := range chans {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//    go func(ch &lt;-chan interface{}) {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//     for v := range ch {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//      out &lt;- v</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//     }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//     wg.Done()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//    }(ch)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//   }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//   // 等待协程全部结束</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//   wg.Wait()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//   close(out)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//  }()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//  return out</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>相当于下面这种写法，可读性更好</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fanIn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inputs </span><span class="token operator" style="color:#393A34">...</span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> output </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> wg sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WaitGroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> inputs </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ch </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Done</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> num </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> ch </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> num</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fanOut</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ch </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 退出时关闭所有的输出chan</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> out </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> ch </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从输入chan中读取数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   v </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> out </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    out</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> v </span><span class="token comment" style="color:#999988;font-style:italic">// 放入到输出chan中，同步方式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important">那感觉fan-in不就是barrier吗？都是用来聚合数据的</span><br></span><span class="token-line" style="color:#393A34"><span class="token title important"></span><span class="token title important punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">实际上，fan-in 和 barrier（屏障）在某种程度上可以说是相似的，因为它们都用于聚合数据。然而，它们在功能和使用上有一些区别。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Fan-in 模式用于将多个输入通道的数据合并到一个输出通道中。它通过启动多个 goroutine 来同时读取不同的输入通道，并将数据发送到一个输出通道中。这种模式通常用于并发处理多个数据源的情况，例如从多个传感器收集数据并聚合处理。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Barrier（屏障）则是一种同步机制，用于确保在并发环境中的所有 goroutine 都达到某个点之前等待。Barrier 用于协调多个 goroutine 的执行，使它们在某个共同的点上同步。当所有 goroutine 都达到屏障点时，它们可以继续执行下一步。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">尽管 fan-in 和 barrier 有一些相似之处，但它们的目的和使用场景略有不同。Fan-in 旨在将多个输入通道的数据合并到一个输出通道中，而 barrier 旨在确保多个 goroutine 在某个点上同步。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在某些情况下，可以将这两个模式结合使用，例如在 fan-in 模式中使用 barrier 来确保所有输入通道的数据都已经被读取完毕，然后再进行后续的处理。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总而言之，fan-in 和 barrier 是两个不同的概念，它们在并发编程中有不同的用途和作用。根据具体的需求和场景，选择适合的模式来实现所需的功能。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>fanin最多的使用场景就是聚合数据，比如说把多个数据源的数据处理后汇集到一起。那么延伸一下，聚合数据的本质实际上就是网络请求嘛，所以其实就是用来同时处理多个网络请求的。</p>
<p>那么相应的，fanout就是用来分发处理数据的。</p>
<p><em>所以，我们也可以把fanin和fanout结合使用。通常是先fanout分发处理后再fanin聚合。</em></p>
<p><em><strong>其实我们聊docker works时，还是应该从CRI的角度，而不是docker本身出发，可能更好。</strong></em></p>
<p><em><strong><a href="https://www.zhangjiee.com/blog/2021/container-runtime.html" target="_blank" rel="noopener noreferrer">容器运行时的综合比较</a></strong></em></p>
<p><a href="https://www.aneasystone.com/2023/06/" target="_blank" rel="noopener noreferrer">2023年6月 - aneasystone&#x27;s blog</a></p>
<p>这两篇文章应该结合着来看，就能够理清楚docker和k8s的CRI的演化过程，有助于理解k8s的CRI实现。</p>
<p>docker之前没有</p>
<p>docker-shim就是k8s将docker适配到CRI的一种实现</p>
<p>后来docker把containerd独立出来了，k8s就可以直接与containerd通信了，所以containerd提供了CRI-containerd作为CRI实现。再之后到了v1.1，containerd原生支持CRI实现，那么CRI-containerd就没用了，直接踢掉，调用链路进一步变短。</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">这也是目前 Kubernetes 默认的容器运行方案。不过，这条调用链路还可以继续优化下去，在 CNCF 中，还有另一个和 containerd 齐名的容器运行时项目 cri-o，它不仅支持 CRI 接口，而且创建容器的逻辑也更简单，通过 cri-o，kubelet 可以和 OCI 运行时直接对接，减少任何不必要的中间开销</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>所以现在来说，CRI的两个主要实现就是containerd和cri-o</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Docker、containerd、CRI、CRI-O、OCI、runc都是容器相关的技术或规范，很多人容易搞混了，今天我们来捋一捋它们之间的关系。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Docker：Docker 是一个开源的容器化平台，可以创建、部署和运行容器应用程序。Docker 使用了自己的容器格式（Docker Image）和运行时（Docker Engine），并提供了一整套容器生态系统，包括 Docker Compose、Docker Swarm 等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">containerd：containerd 是一个开源的容器运行时，可以管理和运行容器。它是 Docker 在 2016 年开源的一个组件，可以独立于 Docker 运行。Docker 默认使用 containerd 来管理容器。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CRI：Container Runtime Interface，容器运行时接口，是 Kubernetes 容器管理器与容器运行时之间的接口，定义了 Kubernetes 如何与容器运行时通信，以便启动、停止和管理容器。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CRI-O：CRI-O 是一个符合 CRI 规范的轻量级容器运行时，专门为 Kubernetes 设计。它是一个完全独立于 Docker 的项目，可以支持多种容器格式，如 OCI 和 Docker Image。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OCI：Open Container Initiative，开放容器倡议，是一个开放组织，致力于创建容器格式和运行时的开放标准。OCI 标准化了容器镜像格式和运行时规范，使得不同厂商和组织可以共享相同的容器格式和运行时。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runc：runc 是一个标准的、轻量级的容器运行时，实现了 OCI 容器运行时规范。runc 是 Docker 容器运行时的核心组件之一，也是其他容器平台（如 Kubernetes、CRI-O）的默认容器运行时。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">综上所述，Docker 是一个完整的容器化平台，包括容器格式、运行时和生态系 统；containerd 是 Docker 的一个组件，用于管理容器；CRI 定义了 Kubernetes 与容器运行时之间的接口；CRI-O 是符合 CRI 规范的轻量级容器运行时；OCI 定义了容器镜像格式和运行时规范；runc 实现了 OCI 容器运行时规范，是其他容器平台的默认容器运行时。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><del>docker使用containerd作为CRI</del></p>
<p><del>k8s使用CRI-O作为CRI</del></p>
<p><a href="https://vineetcic.medium.com/the-differences-between-docker-containerd-cri-o-and-runc-a93ae4c9fdac" target="_blank" rel="noopener noreferrer">The differences between Docker, containerd, CRI-O and runc | by Vineet Kumar | Medium</a></p>
<p>通过这个图可以看到，上面的文档没啥毛病，但是确实不够清晰。这个图就很清晰了。</p>
<hr>
<p><a href="https://www.v2ex.com/t/976972" target="_blank" rel="noopener noreferrer">高级程序员为什么喜欢建表的时候加个 ext 字段？ - V2EX</a></p>
<p>大表加字段，执行alter操作会直接锁表，所以冗余几个JSON类型的ext字段</p>
<p>当然，mysql8的online ddl优化了加字段的操作，直接操作metadata了，可以秒加字段。但是建议还是建表时冗余几个ext字段。</p>
<p>这种字段会很好用，可以直接把整个json发给前端，让他们自己处理。也可以取其中某个字段。</p>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">为了解决GC性能问题，可以考虑为每一种优化加个参数来控制，开发人员可以自己调整这里的参数来达到想要的优化效果。但是这种做法时间久了之后会发现有非常多的参数，调优就会变得非常困难，比如JVM调优。go团队不想走这样的老路，力求简单高效。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go通过GOGC这个环境变量来控制整个堆大小相对于现阶段可达对象大小的比例。GOGC默认值是100%，意味着当堆大小增长了当前可达对象大小的1倍时（2倍大小），就会触发GC；200%则意味着继续增长了当前可达对象的2倍时触发GC（3倍大小）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 如果想降低GC花费的时间，就把这个值设置的大一点，因为这样不容易频繁触发GC；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 如果愿意花费更多的GC时间来换取更少的内存占用，就把这个值设置的小一点，因为这样能够更加频繁地GC；</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>系统设计很重要，一定要用户友好。尤其是各种参数，还是应该想清楚。否则后面几乎无法调整。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="others">Others<a href="#others" class="hash-link" aria-label="Direct link to Others" title="Direct link to Others">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="怎么从服务抖动推测具体问题怎么排查排查顺序">怎么从服务抖动，推测具体问题？怎么排查（排查顺序）？<a href="#怎么从服务抖动推测具体问题怎么排查排查顺序" class="hash-link" aria-label="Direct link to 怎么从服务抖动，推测具体问题？怎么排查（排查顺序）？" title="Direct link to 怎么从服务抖动，推测具体问题？怎么排查（排查顺序）？">​</a></h3>
<ul>
<li>先从应用角度检查，是否有慢查询？</li>
<li>抖动时间是否稳定，业务量与连接数是否有突增？</li>
<li>服务器是怎么部署和管理的，网络是否稳定？</li>
</ul>
<hr>
<p><em>性能毛刺就是负载突然被打满，服务抖动大概分为<code>周期性抖动</code>、<code>频繁但是无序的抖动</code>，以及<code>偶发抖动</code></em>
<code>周期性的毛刺</code></p>
<ul>
<li>发送到该服务器的业务量本身有周期性的增大。</li>
<li>某个进程/任务周期性占用。如果是周期性监控进程占用 CPU，问问监控系统的开发人员，咨询监控软件时候时间点发起监控、内 部发起了什么操作或命令，这些操作是否可以优化。</li>
<li>定期的锁导致业务量在锁时期积压，锁释放后冲高
<code>杂乱无章的毛刺</code></li>
<li>发送到该服务器的吞吐量本身有是高低不一的。</li>
<li>读取队列的算法有问题，读取不均匀</li>
<li>OS 调度问题
<code>偶发的毛刺</code></li>
<li>可以采用脚本或代码抓取当 CPU 出现毛刺时的调用栈（CoreDump、tprof、truss 等）</li>
<li>也很有可能是某应用程序、系统程序或操作系统的 bug</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="js-process">js process<a href="#js-process" class="hash-link" aria-label="Direct link to js process" title="Direct link to js process">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">What is the relationship with js engine、render engine and language specification(ES, CommonJS, UMD and AMD), and compiler(vite, babel, webpack)? 这些前端的组件能否用服务端对应的组件来进行类比？我的想法是，语言规范就是不同语言的语法，compiler就类似Clang, Go Compiler, LLVM, HHVM之类的编译器，那服务端存在js engine和render engine这样的东西吗？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在前端开发中，有几个关键的组件和概念需要了解。让我一一解释：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> JavaScript引擎：JavaScript引擎是一种解释和执行JavaScript代码的软件组件。它负责将JavaScript代码转换为可执行的指令，并在浏览器中执行它们。常见的JavaScript引擎包括V8（用于Chrome和Node.js）、SpiderMonkey（用于Firefox）和JavaScriptCore（用于Safari）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 渲染引擎：渲染引擎负责解析HTML、CSS和JavaScript，并将它们渲染为可视化的Web页面。渲染引擎的工作是将代码转换为可视化的用户界面。常见的渲染引擎有Blink（用于Chrome和Opera）、Gecko（用于Firefox）和WebKit（用于Safari）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 语言规范：语言规范定义了一门编程语言的语法、语义和行为。在JavaScript中，有几个语言规范，如ECMAScript（ES）规范，它定义了JavaScript的核心语法和功能。此外，还有CommonJS、UMD和AMD这样的模块规范，它们定义了模块化开发的方式和规则。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 编译器：编译器是将源代码转换为可执行代码的工具。在前端开发中，有几个常用的编译器和构建工具，如Vite、Babel和Webpack。它们可以将高级的JavaScript代码（如ES6模块或JSX语法）转换为可以在浏览器中运行的低级JavaScript代码。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在服务端开发中，也存在类似的组件和概念，尽管它们的具体实现方式可能有所不同。例如，在Node.js中，V8引擎用于执行JavaScript代码，而没有渲染引擎，因为服务端不需要可视化的用户界面。此外，服务端也有类似的编译器和构建工具，用于将高级代码转换为可执行代码。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总结起来，前端和服务端在一些概念上是类似的，但具体的实现和组件可能有所不同。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">给我讲讲浏览器渲染数据的具体工作原理？尽量详细</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">浏览器渲染数据的具体工作原理可以分为以下几个步骤：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 解析HTML：浏览器首先会将接收到的HTML文档解析成DOM树。DOM树是由各个HTML标签和它们的属性组成的树形结构，表示了文档的结构和内容。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 构建渲染树：解析完HTML后，浏览器会根据CSS样式信息构建渲染树（Render Tree）。渲染树是由DOM树中的可见元素和它们的样式信息组成的树形结构，用于描述网页的布局和外观。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 布局：渲染树构建完成后，浏览器会对渲染树进行布局（Layout），确定每个元素在屏幕上的位置和大小。布局过程会考虑元素的盒模型、定位方式、浮动等因素。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 绘制：在布局完成后，浏览器会遍历渲染树并将每个元素绘制到屏幕上。这个过程涉及到像素的计算、颜色的填充、边框的绘制等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">5.</span><span class="token plain"> 合成：绘制完成后，浏览器会将各个图层合成（Composite）为最终的页面图像，并将其显示在屏幕上。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">需要注意的是，浏览器在渲染过程中还会进行一些优化，例如异步加载脚本、样式表和图片，以提升页面加载速度和用户体验。此外，浏览器还会对渲染过程进行分层，将一些复杂的元素分割成多个图层，以便更好地管理和绘制页面。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important">能否指出js引擎、渲染引擎在“渲染过程”中的工作原理的作用吗？</span><br></span><span class="token-line" style="color:#393A34"><span class="token title important"></span><span class="token title important punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">当浏览器加载网页时，JavaScript引擎和渲染引擎在渲染过程中起着重要的作用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JavaScript引擎负责解析和执行网页中的JavaScript代码。它将JavaScript代码转换为可以被计算机理解和执行的指令。JavaScript引擎还负责处理与网页交互相关的事  件，例如点击、滚动等。它的作用是使网页具有动态交互的能力。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">渲染引擎则负责将HTML、CSS和JavaScript代码转换为可视化的网页。它会解析HTML和CSS，构建DOM（文档对象模型）和CSSOM（CSS对象模型），然后将它们合并为渲染树。渲染引擎还会根据渲染树计算每个元素的位置和大小，并将其绘制到屏幕上。它的作用是将网页内容呈现给用户。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在渲染过程中，JavaScript引擎和渲染引擎相互协作，使网页能够实现交互和动态效果，并将最终的渲染结果展示给用户。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">也就是说我们的js代码（vue/react等框架的代码）被vite, webpack这种打包工具（或者说编译器）打包成静态资源（html/css/js），然后渲染引擎和js引擎负责处理这些静态资源，区别在于，一静一动，渲染引擎负责静态渲染，js引擎则负责处理各种交互事件（比如滚动、点击等事件），我的理解对吗？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">是的，你的理解基本上是正确的。打包工具（如vite和webpack）将你的js代码和其他资源打包成静态资源，包括HTML、CSS和JS文件。这些静态资源可以被浏览器加载和解析。渲染引擎负责解析HTML和CSS，将它们渲染成可视化的页面。JS引擎负责解析和执行JavaScript代码，处理各种交互事件，比如滚动、点击等。所以你可以说渲染引擎负责静态渲染，而JS引擎负责处理动态交互。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>所以这里就很清晰了，想弄清楚整个js的渲染机制（或者说浏览器渲染机制），实际上就是几个概念，</p>
<p>bundler(compiler), js engine, render engine</p>
<p><em>js被webpack之类的compiler打包成静态资源，browser负责解析这些静态资源，render engine负责把html和css渲染成页面，js引擎负责解析和执行js代码。</em></p>
<p>再具体一点来说，render engine的整个渲染过程由上面说的解析html为DOM树、解析css为构建渲染树、计算布局、绘制和合成展示这几步构成。
而js引擎则负责所有交互时间，比如我们点击按钮时，browser就会通过js listen event，并在触发时执行相应的js函数。</p>
<p>具体来说如下：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">前面几步是js引擎执行的吗？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">是的，前面几步是由浏览器中的 JavaScript 引擎执行的。当用户在网页上点击按钮或执行其他交互操作时，浏览器会通过 JavaScript 监听相关事件，并在事件发生时执行相应的事件处理程序（JavaScript 函数）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JavaScript 引擎负责解释和执行 JavaScript 代码，包括事件处理程序。它会处理用户交互事件、修改 DOM 元素、执行逻辑判断、创建 HTTP 请求等操作。当事件处理程序执行时，它可以执 行一系列的操作，包括验证用户输入、修改页面内容、创建表单数据等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JavaScript 引擎在浏览器中起着至关重要的作用，它使得网页能够具有动态交互性，并能够与服务器进行通信，从而实现更丰富的用户体验。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 导出功能：有 2000 万条数据，按照条件进行搜索，导出 excel，接口调用时间 30s 内，怎么设计？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 批量导入功能，还可以如何优化？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 导入前，设计 excel 模板</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 字段是否必填</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 选择项字段的填写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 字段的长度和格式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 锁定表头字段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 友好的输入引导</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 易辨识的文件名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 模板文件的版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 导入中，读取写入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 写入前校验</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 忽略问题数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 处理重复导入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 导入进度反馈</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 异步处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 导入后，反馈结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 核对数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 处理失败记录</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="交易平台">交易平台<a href="#交易平台" class="hash-link" aria-label="Direct link to 交易平台" title="Direct link to 交易平台">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 双边市场的交易平台的三个阶段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`配对市场`</span><span class="token plain">和</span><span class="token code-snippet code keyword" style="color:#00009f">`商品市场`</span><span class="token plain"> 交易的核心公式</span><span class="token code-snippet code keyword" style="color:#00009f">`参与者 + 价值单元 + 过滤器 = 交易`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">互联网平台的效应</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`规模效应`</span><span class="token plain">规模越大，边际成本越低，或者边际收益越高。比如传统行业的厂房和设备，会让边际成本阶梯型递减。绝大多数互联网公司都有规模效应：产品研发 + 服务器和网络带宽成本，是明显边际成本趋低的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`协同效应`</span><span class="token plain">依赖于品种增加带来的 1+1&gt;2 的效果。比如购物中心、电商平台、滴滴（快车带动专车、顺风车）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`双边市场效应`</span><span class="token plain">双边供需的进入，都会有正外部性。公式：</span><span class="token code-snippet code keyword" style="color:#00009f">`V=k*m*n`</span><span class="token plain">。电商平台的效应弱：需要平台来管控质量，即变成了单边的；滴滴的效应强：司机和乘客的增加，都会带来正向效应（但边际收益未必持续提升）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`梅特卡夫效应`</span><span class="token plain">一个网络的价值与用户量的平方成正比。与常见网络效应的概念基本相同。任何用户的进入，都会有正外部性。</span><span class="token code-snippet code keyword" style="color:#00009f">`V=k*n²`</span><span class="token plain">最典型的是社交网络：微信、Facebook。梅特卡夫效应是一种极端情况下的双边市场效应，或者说是 n 边市场效应。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 曾李青定律：V=k*n²/r²（r 受 T、S、I、C 影响）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">怎么运营平台的氛围？平台治理 (该惩罚谁？该鼓励谁？该立什么规矩？该废除什么规矩？怎么激励人 nice 的那一面？)</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`机制设计理论`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 法律</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 道德</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 结构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 市场</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="swap">swap<a href="#swap" class="hash-link" aria-label="Direct link to swap" title="Direct link to swap">​</a></h3>
<p><a href="https://www.jxhs.me/2022/04/10/%E4%B8%80%E6%AC%A1%E7%9B%91%E6%8E%A7%E5%86%85%E5%AD%98%E7%9A%84%E7%8C%9C%E6%83%B3/" target="_blank" rel="noopener noreferrer">一次监控内存的猜想 - jame_xhs&#x27;s blog</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">有swap情况，明显free &gt; available</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">没有swap情况available &gt; free</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`官网下 linux对内存定义的详细描述，free里面是会算部分的swap进去，但是available没算swap。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="怎么在本地执行远程-vps-上的远程脚本">怎么在本地执行远程 vps 上的远程脚本？<a href="#怎么在本地执行远程-vps-上的远程脚本" class="hash-link" aria-label="Direct link to 怎么在本地执行远程 vps 上的远程脚本？" title="Direct link to 怎么在本地执行远程 vps 上的远程脚本？">​</a></h3>
<ul>
<li><a href="https://juejin.cn/post/6950955375931686942" target="_blank" rel="noopener noreferrer">通过命令下载执行恶意代码的几种姿势 - 掘金</a></li>
<li>curl 方式执行 shell 脚本时如何传参？</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 没有参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">url</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-s</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">url</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bash</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-s</span><span class="token plain"> arg1 arg2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">bash</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-s</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">url</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> arg1 arg2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#- curl -kSL {url/xxx.sh} | sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#- -k 允许不使用证书到SSL站点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#- -S=show-error 显示错误</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#- -L 跟踪重定向</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 具名参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 由于直接调用了bash命令，因此在远程脚本需要传递具名参数时，为了区分是bash命令的参数还是远程脚本的，可以使用--作为区分，可以理解为分割线，--前面的比如-s属于bash，后面的-x abc -y xyz属于远程脚本的参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-L</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">url</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bash</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-s</span><span class="token plain"> -- </span><span class="token parameter variable" style="color:#36acaa">-x</span><span class="token plain"> abc </span><span class="token parameter variable" style="color:#36acaa">-y</span><span class="token plain"> xyz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># curl搭配wget使用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">bash</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;(curl -fsSL &lt;url&gt;||wget -q -O- &lt;url&gt;)|bash -sh &gt;/dev/null 2&gt;&amp;1&amp;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>在远程 vps 执行本地 shell</p>
</blockquote>
<p><del>这个问题的关 键是如何“无响应式地”登陆远程 vps，无非是 sshpass 或者 expect</del></p>
<hr>
<p>计划任务 crontab</p>
<p><em>有哪些使用 crontab 常见的坑？</em></p>
<ul>
<li><code>crontab -e</code>和<code>/etc/crontab</code>有什么区别？</li>
<li>crontab 命令有哪些参数？怎么查看 crontab 状态？</li>
</ul>
<hr>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># - 检查crond是否启动，以及是否开机自启</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># - 查看cron执行日志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># - 注意环境变量问题</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># - 注意脚本的执行权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查crontab执行日志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /var/log/cron</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 或者</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 用&gt;&gt;把具体的报错，打到一个log文件里</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 怎么把crontab打到日志里？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 注意环境变量问题</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># shell命令可以执行，但是定时任务无法执行，为什么？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 需要在shell脚本里先source让环境变量生效</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 或者</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 检查脚本里服务的环境变量，环境变量最好写绝对路径，或者用which获取，比如</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">redis</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${which redis-cli}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 检查脚本的执行权限，记得chomod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="服务管理工具-systemd"><del>服务管理工具 systemd</del><a href="#服务管理工具-systemd" class="hash-link" aria-label="Direct link to 服务管理工具-systemd" title="Direct link to 服务管理工具-systemd">​</a></h3>
<hr>
<p>linux 有哪些服务管理工具？</p>
<p>众所周知，linux 的各个发行版里有很多种服务管理工具，其中<code>systemd工具</code>（也就是 systemctl 命令）和<code>sysvinit工具</code>（也就是 service 命令和 chkconfig 命令）是比较主流的两种工具。<em>CentOS7 之后，服务管理工具从 SysVinit 和 Upstart 迁移到了 systemd。</em></p>
<ul>
<li>systemd 工具</li>
<li><del>sysvinit 工具（centos5 使用，已过时）</del></li>
<li><del>upstart 工具（centos6 使用，已过时）</del></li>
</ul>
<hr>
<p>systemd 是什么？</p>
<p><em>systemd 不是一个命令，而是一组命令，涉及到系统管理的方方面面，其中 systemctl 是 systemd 的主命令</em></p>
<p>systemd 有什么特点？</p>
<ul>
<li>支持并行化任务 (更快的启动速度)</li>
<li>采用 socket 式与 D-bus 总线式激活服务</li>
<li>按需启动守护进程 (daemon)</li>
<li>利用 Linux 的 cgroups 监控进程</li>
<li>支持快照和系统恢复</li>
<li>维护挂载点和自动挂载点</li>
<li>各服务间基于依赖关系进行精密控制</li>
</ul>
<hr>
<p>systemd 有哪些命令</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># systemd的主命令，用来管理系统</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 用来查看启动耗时</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemd-analyze</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 用来查看当前主机的信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostnamectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 用来查看本地化设置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">localectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 用来查看当前时区设置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">timedatectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 用来查看当前登录的用户</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loginctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="怎么用-ssh-连接服务器">怎么用 ssh 连接服务器？<a href="#怎么用-ssh-连接服务器" class="hash-link" aria-label="Direct link to 怎么用 ssh 连接服务器？" title="Direct link to 怎么用 ssh 连接服务器？">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 产生公钥与私钥对</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># id_rsa 私钥，保留不动即可，后续 ssh 命令会自动读取此文件。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># id_rsa.pub 公钥，此文件需要被保存至目标服务器，用作验证。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh-keygen</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ⚠️ 默认使用 rsa 算法生成key，但是建议使用 ed25519算法，更安全更快</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh-keygen </span><span class="token parameter variable" style="color:#36acaa">-t</span><span class="token plain"> ed25519</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ⚠️ 使用 -C 来标识，比如说github就标识gh，我通常直接把 标识 和 passphrase密码 设置为相同的，防止忘掉</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ssh-keygen -t {rsa} -b {4096} -C &quot;{comment|email}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh-keygen </span><span class="token parameter variable" style="color:#36acaa">-t</span><span class="token plain"> ed25519 </span><span class="token parameter variable" style="color:#36acaa">-C</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;xxx&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ssh-keygen -t ed25519 -f my_github_ed25519  -C &quot;me@github&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ssh-keygen -t ed25519 -f my_gitee_ed25519   -C &quot;me@gitee&quot; # 我在 Gitee</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ssh-keygen -t ed25519 -f my_gitlab_ed25519  -C &quot;me@gitlab&quot; # 我在 GitLab</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ssh-keygen -t ed25519 -f my_company_ed25519 -C &quot;email@example.com&quot; # 我在企业</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>将常用 SSH 信息写进全局配置文件，省得连接时配置。</p>
<p>编辑 ~/.ssh/config 文件：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 关于别名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Host 是别名，HostName 是真正的域名。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 得益于别名，你可以直接以别名访问地址。例如：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 无别名： git clone git@github.com:torvalds/linux.git</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 有别名： git clone github:torvalds/linux.git</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 本例中使用与域名一致的别名，以免错误的配置导致登录不上。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 关于代理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># SOCKS 代理格式： ProxyCommand connect -S localhost:1080  %h %p</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># HTTP 代理格式： ProxyCommand connect -H localhost:1080  %h %p</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## SSH 代理依赖外部程序，这里使用了 Git for Windows 同捆的 connect.exe。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## Linux 下使用该代理方式需要额外安装 connect-proxy。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 我在 GitHub</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Hostname github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  ProxyCommand connect -H localhost:1080  %h %p</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  User </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PreferredAuthentications publickey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  IdentityFile ~/.ssh/my_github_ed25519</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 我在 GitLab</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host gitlab.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Hostname gitlab.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  ProxyCommand connect -H localhost:1080  %h %p</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  User </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PreferredAuthentications publickey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  IdentityFile ~/.ssh/my_gitlab_ed25519</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 我在 Gitee</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host gitee.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Hostname gitee.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  User </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PreferredAuthentications publickey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  IdentityFile ~/.ssh/my_gitee_ed25519</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 我在企业</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Hostname example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Port </span><span class="token number" style="color:#36acaa">22</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  User </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PreferredAuthentications publickey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  IdentityFile ~/.ssh/my_company_ed25519</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Private 192.168.2.125</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host iPhone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HostName  </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.2.125</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IdentityFile ~/.ssh/id_rsa_Theos125</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Private gitlab.v6h5.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host gitlab.v6h5.cn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HostName  gitlab.v6h5.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IdentityFile ~/.ssh/id_rsa_qinbaowan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果你懒得在每台机器上都配置一遍，把 ~/.ssh 下的文件放在安全的地方拷走即可。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 上传公钥 到目标服务器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 相当于 pbcopy命令</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 将本机的公钥复制到远程机器的authorized_keys文件中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ⚠️ 复制之后最好在服务端验证一下</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh-copy-id </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">user</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">@</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ip</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 指定 pub</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh-copy-id </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">~/.ssh/id_rsa.pub</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">user</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">@</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ip</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 尝试使用密钥登录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 设置 ~/.ssh/config 后，就不需要 ssh &lt;user&gt;@&lt;ip&gt; ，可以直接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 使用ssh config配置文件来管理ssh连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ssh</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Host</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上是一种配置方法，也可以</p>
<p>不手动维护每个私钥，直接通配为：</p>
<p>这种情况下会自动把密钥保存到 apple 的 keychain 中</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AddKeysToAgent </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UseKeychain </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  IdentityFile ~/.ssh/id_ed25519</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  IdentityFile ~/.ssh/id_rsa </span><span class="token comment" style="color:#999988;font-style:italic"># Keep any old key files if you want</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后将私钥添加到 ssh agent：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh-add </span><span class="token parameter variable" style="color:#36acaa">-K</span><span class="token plain"> ~/.ssh/id_ed25519</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当然，这种方法配置方便，但是使用时不如上面的方案方便。</p>
<hr>
<p>登录时可能会存在以下问题：</p>
<ul>
<li>权限问题</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ⚠️ 在 客户端 设置权 限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 修改 known_hosts文件 的权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 修改 私钥和公钥 的权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">755</span><span class="token plain"> ~/.ssh </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">644</span><span class="token plain"> ~/.ssh/known_hosts </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">600</span><span class="token plain"> ~/.ssh/id_rsa </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">600</span><span class="token plain"> ~/.ssh/id_rsa.pub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>可能禁用了“公钥验证模式”，按照以下配置进行修改</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RSAAuthentication </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic"># 是否可用RSA密钥对验证</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PubkeyAuthentication </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># 是否可用公钥方式验证</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PasswordAuthentication no           </span><span class="token comment" style="color:#999988;font-style:italic"># 是否可用密码验证（可用于限制密码登录）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PermitRootLogin prohibit-password   </span><span class="token comment" style="color:#999988;font-style:italic"># 是否可用密码登录root用户（可用于限制密码登录）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>保持 ssh 服务连接不断开的方法</p>
<p>也就是配置 心跳连接，<strong>直接在客户端配置即可，不需要在服务端配置</strong></p>
<p>客户端也不需要在 <code>/etc/ssh/ssh_config</code> 进行全局配置，直接在 <code>~/.ssh/config</code> 配置当前用户生效即可</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ServerAliveInterval </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ServerAliveCountMax </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ClientAliveInterval 指定了服务器端向客户端请求消息 的时间间隔，默认是 0 ，不发送。ClientAliveInterval 60 表示每分钟发送一次，然后客户端响应，这样就保持长连接了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ClientAliveCountMax 表示服务器发出请求后客户端没有响应的次数达到一定值，就自动断开，使用默认值 3 即可</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>修改配置后注意</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">service</span><span class="token plain"> sshd restart</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>怎么整理多个 vps 密钥和登录命令？</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>最好还是用堡垒机或者跳板机</p><p>没有的话，或者自己的服务器，目前最方便的还是直接把 vps 登录命令做成 alfred 的 snip</p></div></div>
<ul>
<li><a href="https://github.com/quantumsheep/sshs" target="_blank" rel="noopener noreferrer">quantumsheep/sshs: Terminal user interface for SSH</a> 实际上还是需要自己把 vps 信息在 <code>~/.ssh/config</code> 维护，迁移时还需要多迁移一份文件。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="跳板机">跳板机<a href="#跳板机" class="hash-link" aria-label="Direct link to 跳板机" title="Direct link to 跳板机">​</a></h3>
<p>ProxyCommand</p>
<p>ProxyJump</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 使用ProxyCommand或者ProxyJump</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> ~/.ssh/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ProxyCommand</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host X</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HostName </span><span class="token number" style="color:#36acaa">10.251</span><span class="token plain">.252.53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    User root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Port </span><span class="token number" style="color:#36acaa">22</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IdentityFile ~/.ssh/id_rsa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host xfljump</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HostName </span><span class="token number" style="color:#36acaa">10.249</span><span class="token plain">.69.128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    User root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Port </span><span class="token number" style="color:#36acaa">22</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IdentityFile ~/.ssh/id_rsa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ProxyCommand </span><span class="token function" style="color:#d73a49">ssh</span><span class="token plain"> X </span><span class="token parameter variable" style="color:#36acaa">-W</span><span class="token plain"> %h:%p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ProxyJump</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host xfljump</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HostName </span><span class="token number" style="color:#36acaa">10.249</span><span class="token plain">.69.128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    User root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ProxyJump root@10.251.252.53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cdn-ip">CDN IP<a href="#cdn-ip" class="hash-link" aria-label="Direct link to CDN IP" title="Direct link to CDN IP">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> ~~怎么在多层代理和转发的场景下，获得真实 IP？~~</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用</span><span class="token code-snippet code keyword" style="color:#00009f">`X-Forwarded-For`</span><span class="token plain">获取离服务器最近的客户端的 ip，如果我们把请求经过的每层代理都打开了</span><span class="token code-snippet code keyword" style="color:#00009f">`X-Forwarded-For`</span><span class="token plain">特性，就能获得真实的用户 ip。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 但是如果</span><span class="token code-snippet code keyword" style="color:#00009f">`伪装请求链路`</span><span class="token plain">，X-Forwarded-For 的第一个 IP 不一定是客户端的真实 IP，这种情况下，</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">需要使用 nginx 的 Real-IP 模块。</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 我们也可以使用</span><span class="token code-snippet code keyword" style="color:#00009f">`tproxy透明代理`</span><span class="token plain">在</span><span class="token code-snippet code keyword" style="color:#00009f">`传输层转发`</span><span class="token plain">的情况下，获取用户 ip。</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">但是，我 们无法在使用了 load balance 的场景中使用此特性</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">，解决方案如下：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用</span><span class="token code-snippet code keyword" style="color:#00009f">`proxy protocol`</span><span class="token plain">。</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">pp 是一种类似 X-Forwarded-For 的基于应用层实现的方式，由于是基于应用层，所以需要客户端和服务端都支持该协议</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">有 CDN 怎么溯源 IP？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 判断 ip 是否为网站真实 ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 绕过 CDN 查找真实 ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 查看子域名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 查看历史 DNS 记录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 如果 CDN 服务商的服务范围不是很广，可以代理到一个冷门 IP 去请求，可能可以直接查看到真实 IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IP 能被伪造吗？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">http 头部可以被篡改，但是只能修改 x_forwarded_for，真实 ip 地址 remote_addr，很难修改（除非是路由器去修改），因为真实 IP 是底层会话 IP 地址，而且因为 TCP 三次握手的存在，连接无法建立，伪造的意义不大；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="服务器性能优化">服务器性能优化<a href="#服务器性能优化" class="hash-link" aria-label="Direct link to 服务器性能优化" title="Direct link to 服务器性能优化">​</a></h3>
<p><a href="https://mp.weixin.qq.com/s/E01HoRkgoCv8dLFfW0HTvA#tocbar--8amiiq" target="_blank" rel="noopener noreferrer">服务器性能优化的正确姿势（好文推荐）</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">处理器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">核</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">硬件线程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CPU内存缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">时钟频率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">每指令周期数CPI和每周期指令数IPC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CPU指令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">使用率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">用户时间／内核时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">调度器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">运行队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">抢占</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">多进程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">多线程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">字长</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">在观察CPU性能的时候，按照负载特征归纳的方法，可以检查如下清单：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 整个系统范围内的CPU负载如何，CPU使用率如何，单个CPU的使用率呢？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> CPU负载的并发程度如何？是单线程吗？有多少线程？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 哪个应用程序在使用CPU，使用了多少？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 哪个内核线程在使用CPU，使用了多少？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 中断的CPU用量有多少？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 用户空间和内核空间使用CPU的调用路径是什么样的？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 遇到了什么类型的停滞周期？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">要回答上面的问  题，使用系统性能分析工具最经济和直接，这里列举的工具足够回答上面的问题：</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">uptime 平均负载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vmstat 包括系统范围的CPU平均负载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">top 监控每个进程/线程CPU用量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pidstat 每个进程／线程CPU用量分解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ps 进程状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">perf CPU剖析和跟踪，性能计数器分析</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">主存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">虚拟内存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">常驻内存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">地址空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OOM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">页缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">缺页</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">换页</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">交换空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">交换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">用户分配器libc、glibc、libmalloc和mtmalloc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LINUX内核级SLUB分配器</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="做过的项目">做过的项目<a href="#做过的项目" class="hash-link" aria-label="Direct link to 做过的项目" title="Direct link to 做过的项目">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">牵手 app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">做了三个社交项目，基于 LBS 的前置付费 + 广告 + 矩阵的陌生人交友 APP（主要面向男性用户）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">第二个是借鉴即刻团队开发的“橙”做的一个线下交友 APP（这个前期调研不足，做不出来足够差异化的点）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">第三个是借鉴“二半”开发的基于匹配的交友 APP。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">把目前主流的几个陌生人交友的三个方向都试了一下。(基于 LBS/基于线下交友/基于匹配)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 聊天机器人，如果用户的聊天频率很高，则引入“流程 2”，引导付费。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 去客服中心外包一个陪聊服务，新用户注册后，直接聊天。（外包可以加入抢单机制，价低者得）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 可以参考“二半”等社交 app，匹配成功后通过聊天解锁 wx 等联系方式，而不是把“联系方式”，“聊天”，“相册”等作为独立的付费项。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">千猪折扣电影票</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">项目亮点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 基于 neo4j 实现推荐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 聊天机器人</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">面经都烂大街了 就 golang 语言基础 gc 协程调度 然后 http 滑动窗口 流量控制 拥塞控制 然后 redis 分布式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">锁 缓存穿透之类常见问题 高可用哨兵 然后消息队列 ack 之类 然后 mysq1 索引 主从同步 然后加上一些架构 微</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">服务 服务治理服务发现 然后就是项目和做人了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这个段子 适合让岳云鹏来一段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">离职原因：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">两个原因</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 在那边至今找不到一个主要运营的 APP，一直在尝试新项目，让整个团队都很累，没有方向，看不到未来。创业公司嘛，最重要的是愿景，我自己是吃这套的，但是没有方向，我就一天都不想多待。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 一直在 push 团队，近一年，自己技术上的的成长也没有之前那么快，想换个角色，再成长一段时间，之后有机会再切换到管理岗。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">用 java 过渡一下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">做了很多 mvp 产品，出海的贷超会员卡和反催收，券猫权益卡，电影票，七号卡，类似二半的社交 app。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 美化一下社交项目里的 feed 流功能。php-grpc。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 美化一下学生代取项目的快递调度算法。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 券猫。优化卡券平台的稳定性。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 物流配送调度系统</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">专栏 | 从架构到算法，详解美团外卖订单分配内部机制</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650732373&amp;idx=4&amp;sn=d497cd5ba2fde7f0fece157876443ae9#rd</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="web-框架对比">web 框架对比？<a href="#web-框架对比" class="hash-link" aria-label="Direct link to web 框架对比？" title="Direct link to web 框架对比？">​</a></h3>
<p><em><strong>技术选型&amp;核心需求技术选型：web 框架对比？</strong></em></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>核心需求</p><ul>
<li>性能<!-- -->
<ul>
<li>实现语言</li>
<li>底层网络设计</li>
<li>并发处理</li>
<li>路由算法</li>
</ul>
</li>
<li>框架设计<!-- -->
<ul>
<li>是否能够平衡灵活性和易用性？</li>
<li>工具链是否好用？</li>
<li>是否支持基础服务？如 MVC 等</li>
</ul>
</li>
<li>其他：社区生态</li>
</ul><hr><ul>
<li>路由算法：Trie Tree + 路由算法 LCP 算法</li>
<li>生命周期/框架原理</li>
<li>中间件原理</li>
</ul><hr><p>压缩前缀树：在压缩树（trie 树/基数树）的基础上，通过合并唯一子 树预期父节点来节约空间</p></div></div>
<hr>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651453986&amp;idx=1&amp;sn=4ef797a87fc303e578a771c44bd256b2" target="_blank" rel="noopener noreferrer">「Go框架」深入理解iris框架的路由底层结构</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651453917&amp;idx=1&amp;sn=334020f003deec68f268d1c36143ddca" target="_blank" rel="noopener noreferrer">通过分析gin、beego源码，读懂web框架对http请求处理流程的本质</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651453950&amp;idx=1&amp;sn=1cb70938803a6c23bdfc957a0e5ff385" target="_blank" rel="noopener noreferrer">Go BIO/NIO探讨(1)：Gin框架中如何处理HTTP请求</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651453975&amp;idx=1&amp;sn=7471cbf3a5510be90815dfffa28ac86a" target="_blank" rel="noopener noreferrer">Go BIO/NIO探讨(2)：net库对socket/bind/listen/accept的封装</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="数据分析"><del>数据分析</del><a href="#数据分析" class="hash-link" aria-label="Direct link to 数据分析" title="Direct link to 数据分析">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 其实只要了解贝叶斯的基本概念，实际使用时直接用 sklearn 就可以了，没必要研究得太深。搜索关键字“sklearn 贝 叶斯”即可。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么用 sklearn 根据新闻数据 + 朴素贝叶斯，对新闻进行分类，并验证准确率（后验）？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 在实现上面问题后，怎么进行增量训练？把训练集分成若干等分，重复调用</span><span class="token code-snippet code keyword" style="color:#00009f">`partial_fit`</span><span class="token plain">学习训练集，另外使用</span><span class="token code-snippet code keyword" style="color:#00009f">`hash trick`</span><span class="token plain">进行降维</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是推荐系统？为了解决哪些问题？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 推荐系统的初衷就是解决马太效应，也就是内容分发能力不够强，导致 90% 的内容集中在长尾的 10% 里。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">推荐系统的发展，从最开始的规则匹配，协同过滤，线性模型，深度学习；逐渐缓解了马太效应，但是没有完全解决</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 推荐系统包括哪些模块？推荐系统主要包括</span><span class="token code-snippet code keyword" style="color:#00009f">`召回`</span><span class="token plain">、</span><span class="token code-snippet code keyword" style="color:#00009f">`排序`</span><span class="token plain">和后续的</span><span class="token code-snippet code keyword" style="color:#00009f">`业务机制`</span><span class="token plain"> (重排序、多样性保证、用户体验保证等等) 这三大模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 推荐系统有哪些评价指标？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> MAP 平均精度均值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> NDCG 归一化折损累积增益</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 协同过滤是什么？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 有哪些协同过滤算法？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 协同过滤的原理？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 相似度算法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> jaccard 距离</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 余弦相似度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 中心余弦相似度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 奇异值分解降维</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 推荐系统怎么冷启动？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> edgerank 算法是什么？edgerank 是谷歌的 pagerank 的简化版本，只有三个参数，亲密度，权重，时间。根据这三个参数，facebook 会把用户的好友状态进行评分，并把这些状态排列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 基于协同过滤的推荐脱胎于</span><span class="token code-snippet code keyword" style="color:#00009f">`“基于对象之间相关性”`</span><span class="token plain">这种推荐算法，在此基础上，增加了</span><span class="token code-snippet code keyword" style="color:#00009f">`“基于人之间相关性”`</span><span class="token plain">和</span><span class="token code-snippet code keyword" style="color:#00009f">`“基于模型”`</span><span class="token plain">这两种协同过滤算法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`基于模型`</span><span class="token italic content">的协同过滤推荐就是基于样本的用户喜好信息，训练一个推荐模型，然后根据实时的用户喜好的信息进行预测推荐</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">有哪些推荐算法？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 基于协同过滤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 线性模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 深度学习</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 单 embedding 向量召回（DNN，双塔模型）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 多 embedding 向量召回用户多兴趣表达（MIND 模型）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> Graph Embedding（GraphSAGE）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 结合用户长期和短期的兴趣建模（SDM，Next Item Recommendation with Self-Attention）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> TDM 深度树匹配召回</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="io-流并发"><strong>IO 流并发</strong><a href="#io-流并发" class="hash-link" aria-label="Direct link to io-流并发" title="Direct link to io-流并发">​</a></h3>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzUzNTY5MzU2MA==&amp;mid=2247497706&amp;idx=1&amp;sn=cc6e9fc5e951b88c3428c371dea19fac#rd" target="_blank" rel="noopener noreferrer">分享一个 Go 的 IO 流并发的小技巧</a></p>
<p><a href="https://colobu.com/2023/09/24/reread-the-io-Reader/" target="_blank" rel="noopener noreferrer">从头再读取 io.Reader: 覆水难收？</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">那该怎么办呢？把 IO 流一份为二或者一分为多？那么怎么才能把这个写入变成多份，并且写入的时间最好是重叠起来，只消耗 1 份时间呢？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在 Go 里，怎么做呢？奇伢先说步骤：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">需要一个 teeReader 来分流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">需要一个 Pipe 写转读</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">需要两个 goroutine 做并发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TeeReader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r Reader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> w Writer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> Reader </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">teeReader</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> w</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">teeReader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 把读到的每一次数据都输入到 Writer 里去。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 分一股数据流出去</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">w</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ConcurrencyWrtie</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">src io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Reader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dest </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Writer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    errCh </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 管道，主要是用来写、读流转化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pw </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Pipe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// teeReader，主要是用来 IO 流分叉</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TeeReader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">src</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pw</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 并发写入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> _err </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CloseWithError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            errCh </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> _err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dest</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// TODO：异常处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pw</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">errCh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 数据写入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dest</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> wr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">其实，个人觉得：IO 流的并发其实更适合用链式的写入方式。这个观点以后有机会分享。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p><a href="https://stackoverflow.com/questions/71523651/what-is-the-difference-between-io-teereader-and-io-copy" target="_blank" rel="noopener noreferrer">go - What is the difference between io.TeeReader and io.Copy? - Stack Overflow</a></p>
<p><a href="https://gist.github.com/miku/d8be387909fc11d1b446c5b4a85da686" target="_blank" rel="noopener noreferrer">Example using io.TeeReader and io.Pipe</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bitmapast-实现配置化时长系统"><strong>bitmap+AST 实现配置化时长系统</strong><a href="#bitmapast-实现配置化时长系统" class="hash-link" aria-label="Direct link to bitmapast-实现配置化时长系统" title="Direct link to bitmapast-实现配置化时长系统">​</a></h3>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzU3NzEwNjI5OA==&amp;mid=2247484732&amp;idx=1&amp;sn=9ec2035f53e6d77b47499a430d2eebfc" target="_blank" rel="noopener noreferrer">用 Bitmap 与 AST 做一个配置化时长系统</a></p>
<p>Requirement: upstream will send user&#x27;s heartbeat data every minute(including is-online, is-shopping...etc), we need to count user&#x27;s online-time</p>
<p>BP: bitmap, <em>Store the user&#x27;s daily data into a bitmap at one point per minute.</em></p>
<p>exactly once</p>
<p>new requirement: we need online and battle time, battle and collect time...etc</p>
<p>BP: AST-tree, Config and store &quot;logical-operators&quot; in DB, and use it in AST</p>
<hr>
<p>If using bitmap, user&#x27;s data will rapidly scale up.</p>
<p>bitmap len will be 1440 bits</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="blog-数据系统那些事">[blog] 数据系统那些事<a href="#blog-数据系统那些事" class="hash-link" aria-label="Direct link to [blog] 数据系统那些事" title="Direct link to [blog] 数据系统那些事">​</a></h3>
<p><a href="https://www.zhihu.com/column/data-system" target="_blank" rel="noopener noreferrer">数据系统那些事 - 知乎</a> pigsty 的作者。pger, pgsql吹, 各种抨击云服务厂商。主观倾向比较强，但是有观点有论据，可以一看。之前从那篇比较云数据库和成本比较的帖子看到的。</p>
<p>《云计算泥石流》系列写的确实不错。</p>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">当下的现状是什么？数据库内核已经卷不动了！作为一项有四五十年历史的技术，能折腾的东西已经被折腾的差不多了。业界已经不缺足够完美的数据库内核了 —— 比如 PostgreSQL，功能完备且开源免费（BSD-Like）。无数”国产数据库“基于PG换皮套壳魔改而成。如果说谁在数据库内核上被卡了脖子，那肯定是吃饱了撑着给噎着的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">那么，真正稀缺的是什么，是把现有的内核用好的能力。要解决这个问题，有两种思路：第一种是开发扩展，以增量功能包的方式为内核加装功能 —— 解决某一个特定领域的问题。第二种是整合生态，将扩展，依赖，底座，基础设施，融合成完整的产品 &amp; 解决方案 —— 数据库发行版。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在这两个方向上发力，可以产生实打实的增量用户价值，站在巨人的肩膀上，并深度参与全球软件供应链，响应号召，打造真正意义上的“人类命运共同体”。相反  ，去分叉一个现有成熟开源内核是极其愚蠢的做法。像 PostgreSQL 与 Linux 这样的 DB/OS 内核是全世界开发者的集体智慧结晶，并通过全世界用户各种场景的打磨与考验，指望靠某一个公司的力量就能与之抗衡是不切实际的妄想。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p><a href="https://zhuanlan.zhihu.com/p/556667867" target="_blank" rel="noopener noreferrer">PostgreSQL到底有多强？ - 知乎</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PostgreSQL 到底性能有多强？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">点查 QPS 60万+，最高达 200 万。读写 TPS （4写1读）每秒 7 万+，最高达14万。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PostgreSQL 与 MySQL 的极限性能对比</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">极限条件下，PgSQL点查性能显著压倒 MySQL，其他性能基本与MySQL持平。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PostgreSQL 与其他数据库的性能对比</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">“分布式数据库”/NewSQL 在相同硬件规格下的性能表现显著落后于经典数据库。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PostgreSQL 与其他分析数据库的 TPC-H 表现。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PostgreSQL 原生作为一个 HATP 数据库，有比较亮眼的分析表现。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">云数据库 / 云服务器 的成本到底有没有优势？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c5d.metal 用1年的价格，可以把服务器买下来托管用5年。对应规格云数据库用1年的价格，可以供你买同样的EC2用20年</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">结果相当 令人震惊，在 Apple M1 Max 10C 笔记本上，PG 跑出了 32K 读写，240K 点查的性能水平，在 AWS c5d.metal 生产物理机上，PG 跑出了 72K 读写，630K 点查的性能。使用极限优化压榨，最多可以达到 单机 137K 读写，2M 点查 的怪兽级性能。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">作为一个粗略的规格参考，探探作为一个前部的互联网App，PostgreSQL 全局 TPS 为 40万左右。这意味着十几台这样的新笔记本，或几台顶配服务器（10W内¥）就有潜力支撑起一个大型互联网应用的数据库服务，这对于以前来说是难以想象的。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>实话说没想到NewSQL的性能这么拉垮，跟pgsql的性能差距在将近4倍左右。</p>
<p>TP</p>
<p>用TPC-H来对比AP性能，也好于TiDB等NewSQL。</p>
<hr>
<p><a href="https://zhuanlan.zhihu.com/p/542019272" target="_blank" rel="noopener noreferrer">为什么PostgreSQL是最成功的数据库？ - 知乎</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Oracle 是老牌商业数据库，有着深厚的历史技术积淀，功能丰富，支持完善。稳坐数据库头把交椅，广受不差钱且需要背锅侠的企业喜爱。但其费用高昂，且以讼棍行径成为知名的业界毒瘤。Microsoft SQL Server 性质与Oracle类似，都属于商业数据库。商业数据库整体受开源数据库冲击，处于缓慢衰退的状态。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySQL 流行度位居第二，但树大招风，处于前狼后虎，上有野爹下有逆子的不利境地：在严谨的事务处理和数据分析上，MySQL 被同为开源生态位的 PostgreSQL 甩开几条街；而在糙猛快的敏捷方法论上，MySQL 又不如新兴 NoSQL 好用；同时 MySQL 上有养父 Oracle 压制，中有兄弟 MariaDB 分家，下有诸如逆子 TiDB 等协议兼容 NewSQL 分羹，因此也在走下坡路。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">作为老牌商业数据库，Oracle 的才毋庸质疑，但其作为业界毒瘤，“德” ，亦不必多说，故曰：“有才无德”。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySQL 虽有开源之功德，奈何认贼作父；且才疏学浅，功能简陋，只能干干CRUD，故曰“才浅德薄”。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">唯有 PostgreSQL，德才兼备，既占据了开源崛起之天时，又把握住功能先进之地利，还有着宽松BSD协议之人和。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">正所谓：君子藏器于身，因时而动。不鸣则已，一鸣惊人！</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>哈哈哈</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">一个开源程序员工作时，其劳动背后可能蕴含的是数以万计顶尖开发者的智慧结晶。程序员薪资高从原理上来说是因为，开发者本质上不是一个简单的工人，而是一个指挥软件和硬件干活的包工头。程序员自己就是核心生产资料；软件来自公有社区；服务器硬件更是唾手可得；因此一个或几个高级的软件工程师，就可以很轻松地利用开源生态快速解决领域问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">通过开源，所有社区开发者形成合力，极大降低了重复造轮子的内耗。使得整个行业的技术水平以匪夷所思的速度向前迈进。开源的势头就像滚雪球，时至今日已经势不可挡。基本上除了一些特殊场景和路径依赖，软件开发中闭门造车搞自力更生几乎成了一个大笑话。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PG的“才”在于一专多长。PostgreSQL是一专多长的全栈数据库，天生就是HTAP，超融合数据库，一个打十个。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PostgreSQL 是各种关系型数据库中性价比最高的选择：它不仅可以用来做传统的 CRUD OLTP 业务，OLAP 数 据分析也是拿手好戏，各种特色功能更是提供了切入多种行业的契机：基于 PostGIS 的地理时空数据处理分析，基于 TimescaleDB 的时序金融物联网数据处理分析，基于存储过程触发器的流式事件处理，基于倒排索引全文检索的搜索引擎，基于 FDW 统一各式外部数据源的访问。单一组件便足以覆盖中小型企业绝大多数的数据库需求：OLTP，OLAP，时序数据库，空间GIS，全文检索，JSON/XML，图数据库，缓存，等等等等，一招鲜，吃遍天。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">对于海量数据处理，更是可以平滑升级至分布式版本：Citus/GreenPlum/MatrixDB等。可以说，它是真正一专多长的全栈数据库。它可以实现的功能，要比普通的纯OLTP数据库要丰富得多，为CRUD Boy提供了一条转型与深入的进阶道路。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">从企业用户的角度来看，PostgreSQL在一个很可观的规模内都可以独立扮演多面手的角色，一个组件当多种组件使。而单一数据组件选型可以极大地削减项目额外复杂度，这意味着能节省很多成本。它让十个人才能搞定的事，变成一个人就能搞定的事。 当然这不是说PG要一个打十个，把其他数据库的饭碗都卷翻，专业组件在专业领域的实力是  毋庸置疑的。但切莫忘记，为了不需要的规模而设计是白费功夫，实际上这属于过早优化的一种形式。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一个打十个是吧</p>
<p>pgsql比mysql对数据约束更严格，不接受脏数据</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">而说到底，MySQL最大的问题，就是它的生态位越来越狭窄。论严谨的事务处理与数据分析，PostgreSQL甩开它几条街；论糙猛快出原型，NoSQL全家桶又要比MySQL方便太多。论商业发财，上面有Oracle干爹压着；论开源生态，又不断出现兼容MySQL的新生代产品来尝试篡位。MySQL处在了吃老本的危险境地，只是凭籍历史积分存量勉强维持着现状，但时间是否会站在MySQL这一边，我们只能拭目以待了。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">最近市场上也出现了一些亮眼的NewSQL产品：如TiDB，Cockroachdb，Yugabytedb等等。何如？我认为它们都是很好的产品，有一些不错的技术亮点，都是对开源生态的贡献。但是它们可能同样面临叫好不叫座的困局。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NewSQL的重要特征是：主打“分布式”的概念，通过“分布式”解决水平扩展性与容灾高可用两个问题，但会因为分布式的内在局限性而牺牲很多功能（例如各种复杂JOIN），只能支持简单有限的查询种类。在高可用/容灾方面，分布式数据库与主从复制并没有质的区别，因此其主要特征可以概括为“以质换量”。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">然而，对很多企业而言，牺牲功能换取伸缩性很可能是一个伪需求或弱需求。OLTP数据库是一种工作记忆，极少有业务能超出单机主从的极限（参考 值：单集群写入上限十几万TPS，读取几十万～百万QPS，数据量几TB～百TB），更何况还有分库分表的传统优化方式。在我所接触到的大量用户中，超出单机PG处理能力的业务场景屈指可数。一个中型互联网公司或银行的全部TP数据约在百TB量级。而绝大多数企业的全部数据，终其生命周期也超不过这个瓶颈。至于性能就更不重要了：过早优化是万恶之源，很多企业的DB性能余量足够让他们把所有业务逻辑用存储过程编写，然后快乐地跑在数据库里面。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>NewSQL主打拓展性，但是本身支持的feature远不如传统OLTP数据库。</p>
<hr>
<p><em><a href="https://zhuanlan.zhihu.com/p/640486847" target="_blank" rel="noopener noreferrer">云计算为啥还没挖沙子赚钱？ - 知乎</a></em> 分析的很到位</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">然而与公有云 IaaS 云硬件竞争的，是运营商/国资云/IDC2.0。这些对手的特点就是有各种各样的资源 —— 特殊血统身份关系，自有机房网络土地，廉价带宽低息贷款；卖资源躺着挣钱，主打一个物美价廉：没啥高精尖 PaaS/SaaS，但IDC可以爽快的卖给用户公有云列表价两折或更低的虚拟机，租机柜自建托管更是便宜上天。云列表价 1/5 ～ 1/10 的综合成本，不玩云盘杀猪之类花里胡哨的东西，就是纯卖资源。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">公有云厂商在面对这些对手时，敢卖天价甚至“涨价”（请注意，资源降价速度慢于摩尔定律等于涨价）的最大的壁垒就是自己有“技术” —— IaaS 层差距拉不了太大，靠的就是还有不错的 PaaS 作为壁垒，来吸引用户 —— 数据库，K8S，大模型以及配套的基础设施。而拥有能力的技术专家多被互联网/云计算大厂垄断，很多客户上云就是因为找不到稀缺的专家来自建这些服务，因而不得不向公有云缴纳高昂的“无专家税”与“保护费”。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">然而，开源的管控软件以普惠赋能的方式，起到了降维打击的效果。当这些资源型选手或者用户自己就可以轻松使用开源软件拉起、搭建、组织起自己的“私有云平台”时，公有云构造的技术壁垒护城河就被打破了。曾经靠技术垄断高高在上的云厂商被拉下神坛，拉到了和躺平纯卖资源同侪相近的起跑线。公有云厂商不得不卷入泥潭中厮杀斗兽起来，和这些自己曾经“看不上”的对手打成一团。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>有句话说的好</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">软件吞噬世界，开源吞噬软件，云计算吞噬开源，云原生吞噬云计算</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其实不如直白点“软件吞噬世界，开源吞噬软件，公有云吞噬开源，k8s吞噬公有云”</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">那么，谁来吃云呢？云原生运动，就是开源社区对公有云垄断的反击 —— 在公有云的话语体系中，CloudNative 被解释为长在公有云上的服务；而开源世界对此的理解是“在本地运行云一样的”服务。如何在本地运行云一样的服务？服务真正的壁垒，不是软件/资源本身，而是能用好这些软件的知识。—— 无论是以直接堆专家人力的形式，还是专家经验沉淀而成的管控软件 / K8S Operator 的形式，或者专家经验训练得到的大模型的形式。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">实际上，真正负责云服务日常性、高频性、运维性核心主体工作的往往并不是专家本身，而是管控软件 —— 沉淀了专家经验的元软件。一旦这些云管控软件出现开源替代，开源软件打破商业软件垄断的剧情会再一次上演。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这一次，是本地优先的管控软件掀翻云管控软件。PaaS 失去垄断度，将使云厂商丧失部分定价权，进而利润受损。但真正让云受伤的，是基本盘 IaaS 资源生意失去壁垒，不得不直面纯资源厂商的价格战。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">资源与基础设施性质的行业，最终的归宿是国家垄断。公有云的资源部分 —— IaaS 层会被剥离，整合，招安，成为算力/存储的“国家电网”。作为央企，国家电网并不负责发电，也不负责制造电器，它做的就是电力垄断资源的传输与分发。云 IaaS 也不会去制造芯片，硬盘，光纤，服务器，而是将其整合为存算网资源，交付到用户手上。国资云，运营商云，阿里云/华为云等会瓜分这一市场。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">能力性质的行业，主旋律将是自由竞争，百花齐放。如果 IaaS 是供电行业，那么 PaaS/SaaS 便是电器行业 —— 提供各种不同的，使用存算网资源的能力。洗衣机，冰箱，热水器，电脑，都会涌现出无数创业公司与开源社区同台竞技，充分竞争。当然也会有一部分软件可以享受例外的垄断保护地位 —— 比如安可信创。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">同时有着 IaaS / PaaS / SaaS 的公有云 可能会解体。云内部的博弈可能要比外部竞争更激烈：IaaS 团队会认为，就连自己用的 IDC机房都有 30% 的毛利，凭啥有躺着卖资源挣钱的机会，却要去陪 PaaS/SaaS 一起卷？有能力的云软件团队会认为，在哪家云甚至私有云上卖不是卖，为啥要绑在一棵树上吊死，为 IaaS 作嫁衣裳？像 OceanBase 一样独立出去到处卖或者自己出来创业难道不香？</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>软件吞噬世界，开源吞噬软件，云吞噬开源，k8s吞噬公有云。</p>
</blockquote>
<p>本质上来说是对“软件”这一生产资料的争夺和反复拉扯。</p>
<p>说白了就是“谁才是软件的主人”，是程序员（或者说社区），还是big tech？</p>
<p>如果云服务厂商无法提供什么独一无二的溢价服务，那么只能打价格战，利润率当然也就只能每况愈下。但是正如一个共识“软件没有壁垒，开源服务没有垄断”，所以。实话说开源软件真的是世界上最康米的东西了。</p>
<p>再换句话说，就是“买方市场和卖方市场的无限转换”。当普通的开发者通过开源服务（以及各种降低开发成本和运维成本的轮子）获得了比肩云服务厂商的能力时，这些云服务厂商当然没办法再把他们那些垃圾服务卖出溢价。</p>
<hr>
<p><a href="https://zhuanlan.zhihu.com/p/668509885" target="_blank" rel="noopener noreferrer">向量数据库凉了吗？ - 知乎</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">一个合格的向量数据库，首先得是一个合格的数据库。但是数据库是一个相当有门槛的领域，从零开始做到这一点并不容易。我通读了市面上专用向量数据库的文档，能勉强配得上“数据库”称呼的只有一个 Milvus —— 至少它的文档里还有关于备份 / 恢复 / 高可用的部分。其他专用向量数据库的设计，从文档上看基本可以视作对“数据库”这个专业领域的侮辱。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>数据类型的需求，不是数据库种类的需求</p>
<p>qdrant, pinecone</p>
<hr>
<p><a href="https://zhuanlan.zhihu.com/p/669477613" target="_blank" rel="noopener noreferrer">从降本增笑到降本增效 - 知乎</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">复杂度有着各种别名 —— 技术债，屎山代码，泥潭沼泽，架构杂耍体操。症状可能表现为：状态空间激增、模块间紧密耦合、纠结的依赖关系、不一致的命名和术语、解决性能问题的 Hack、需要绕开的特例等等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复杂度是一种成本，因而简单性应该是构建系统时的一个关键目标。然而很多技术团队在制定方案时并不会将其纳入考虑，反而是怎么复杂怎么来：能用几个服务解决的任务，非要用微服务理念拆分成几十个服务；没多少机器，却非要上一套 Kubernetes 玩弹性杂耍；单一关系型数据库就能解决的任务，非要拆给几种不同的组件或者倒腾个分布式数据库。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这些行为都会引入大量的额外复杂度 —— 即由具体实现中涌现，而非问题本身固有的复杂度。一个最典型的例子，就是许多公司不管需要不需要，都喜欢把什么东西都往 K8S 上怼，etcd / Prometheus / CMDB / 数据库，一旦出现问题就循环依赖大翻车，一次大挂就彻底起不来了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">再比如应该支付复杂度成本的地方，很多公司又不愿意支付了：一个机房就放一个特大号 K8S ，  而不是多个小集群灰度验证，蓝绿部署，滚动升级。一个版本一个版本的兼容性升级嫌麻烦，非要一次性跳几个版本。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">“智力功率” 则是另一个重要的问题。智力功率很难在空间上累加 —— 团队的智力功率往往取决于最资深几个灵魂人物的水平以及他们的沟通成本。比如，当数据库出现问题时需要数据库专家来解决；当 Kubernetes 出现问题时需要 K8S 专家来看问题；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">然而当你把数据库放入 Kubernetes 时，单独的数据库专家和 K8S 专家的智力带宽是很难叠加的 —— 你需要一个双料专家才能解决问题。认证服务和对象存储循环依赖也同理 —— 你需要同时熟悉两者的工程师。使用两个独立专家不是不可以，但他  们之间的协同增益很容易就会被平方增长的沟通成本拉低到负收益，故障时人一多就变傻就是这个道理。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">当系统的复杂度成本超出团队的智力功率时，就很容易出现翻车性的灾难。然而这一点在平时很难看出来：因为调试分析解决一个出问题的服务的复杂度，远远高于将服务拉起运行的复杂度。平时好像这里裁两个人，那里裁三个，系统还是能正常跑的嘛。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">然而组织的默会知识随着老司机离开而流失，流失到一定程度后，这个系统就已经是期货死人了 —— 只差某一个契机被推倒引爆。在废墟之中，新一代年轻嫩驴又逐渐变为老司机，随即丧失性价比被开掉，并在上面的循环中不断轮回。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>经典期货死人</p>
<p>这点是我之前没意识到的，“然而当你把数据库放入 k8s 时，你需要一个双料专家才能解决问题”</p>
<hr>
<p><a href="https://zhuanlan.zhihu.com/p/670563956" target="_blank" rel="noopener noreferrer">数据库应该放入K8S里吗？ - 知乎</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">有无数云原生狂热者开始尝试将现有数据库搬入 K8S 中，各种数据库的 CRD 与 Operator 开始出现 —— 仅以 PostgreSQL 为例，在市面上就已经可以找到至少十款以上种不同的 K8S 部署方案：PGO，StackGres，PostgresOperator，CloudNativePG，TemboOperator，KubeDB，PerconaOperator，Kubegres，KubeDB，KubeBlocks，……，琳琅满目。CNCF 的景观图就这样开始迅速扩张，成为了复杂度乐园。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">然而复杂度也是一种成本，随着“降本增效”成为主旋律，反思的声音开始出现 —— 下云先锋 DHH 在公有云上深度使用了 K8S，但在回归开源自建的过程中也因为过分复杂而放弃了它，仅仅用 Docker 与一个名为 Kamal 的Ruby小工具作为替代。许多人开始思考，像数据库这样的有状态服务到底是不是应该放入 Kuberentes 中？</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">对于有状态的服务，云原生领域非常喜欢用一个“宠物”与“牲畜”的类比 —— 前者需要精心照料，细心呵护，例如数据库；而后者可以随意处置，一次性用完即丢，就是普通的无状态应用（Disposability）。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">K8S的一个主要架构目标就是，把能当畜生的都当畜生处理。对数据库进行 “存算分离”就是这样一种尝试：把有状态的数据库服务拆分为K8S外的状态存储与K8S内的纯计算部分，状态放在云盘/EBS/分布式存储上，而“无状态”的数据库进程就可以塞进K8S里随意创建销毁与调度了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">不幸的是，数据库，特别是 OLTP 数据库是重度依赖磁盘硬件的，而网络存储的可靠性与性能相比本地磁盘仍然有数量级上的差距。因而 K8S 也提供了LocalhostPV 的选项 —— 允许用户在容器上打一个洞，直接使用节点操作系统上的数据卷，直接使用高性能/高可靠性的本地 NVMe 磁盘存储。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">但这让用户面临着一个抉择：是使用垃圾云盘并忍受糟糕数据库的可靠性/性能，换取K8S的调度编排统一管理能力？还是使用高性能本地盘，但与宿主节点绑死，基本丧失所有灵活调度能力？前者是把压舱石硬塞进 K8S 的小船里，拖慢了整体的灵活性与速度；后者则是用几根钉子，把K8S小船锚死在某处。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">运行单独的纯无状态的K8S集群是非常简单可靠的，运行在物理机裸操作系统上的有状态数据库也是十分可靠的。然而将两者混在一起的结果就是双输：K8S失去了无状态的灵活与随意调度的能力，而数据库牺牲了一堆核心属性换来了很多对数据库根本不重要的“弹性”与Day1交付速度。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">关于前者，一个鲜活的案例是由 KubeBlocks 贡献的 PostgreSQL@K8s 性能优化记。k8s 大师上了各种高级手段，解决了裸金属/裸OS上根本不存在的性能问题。关于后者的鲜活的案例是滴滴的K8S架构杂耍大翻车，如果不是将有状态的 MySQL 放在K8S里，单纯重建无状态 K8S 集群并重新发布应用，怎么会要12小时这么久才恢复？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>部署在k8s中的数据库，性能远不如裸机</p>
<p>K8S为数据库带来的收益相比其引入的问题与麻烦，实在是微不足道。</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">在现代硬件条件下，绝大多数应用，终其生命周期的复杂度都不足以用到 K8S 来解决。然而，以 K8S为代表的“云原生”狂热已经成为了一种畸 形的现象：为了k8s而上k8s。一些工程师的目的是去寻找足够“先进”足够酷的，最好是大公司在用的东西来满足自己跳槽，晋升等个人价值的需求，或者趁机堆砌复杂度以提高自己的 Job Security，而压根不是考虑要解决问题是否真的需要这些屠龙术。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>类似</p>
<ul>
<li><a href="https://github.com/cloudnative-pg/cloudnative-pg" target="_blank" rel="noopener noreferrer">cloudnative-pg/cloudnative-pg: CloudNativePG is a Kubernetes operator that covers the full lifecycle of a PostgreSQL database cluster with a primary/standby architecture, using native streaming replication</a></li>
<li><a href="https://github.com/CrunchyData/postgres-operator" target="_blank" rel="noopener noreferrer">CrunchyData/postgres-operator: Production PostgreSQL for Kubernetes, from high availability Postgres clusters to full-scale database-as-a-service.</a></li>
</ul>
<p>这种把pgsql放到k8s的operator确实挺鸡肋的</p>
<hr>
<p><a href="https://zhuanlan.zhihu.com/p/660166371" target="_blank" rel="noopener noreferrer">EL系操作系统发行版哪家强？ - 知乎</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RockyLinux 的使用体验最好，它的创始人就是原来 CentOS 的创始人，CentOS 被红帽收购后又另起炉灶搞的新 Fork。目前基本已经占据了原本 CentOS 的生态位。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">最重要的是，PostgreSQL 官方源明确声明支持的 EL 系 OS 除了 RHEL 之外就是 RockyLinux 了。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>RockyLinux</p>
<p>可以玩玩看，</p>
<hr>
<p><a href="https://zhuanlan.zhihu.com/p/641767869" target="_blank" rel="noopener noreferrer">FinOps的终点是下云 - 知乎</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">这里的核心问题是：硬件资源的价格随着摩尔定律以指数规律下降，但节省的成本并没有穿透云厂商这个中间层，传导到终端用户的服务价格上。 逆水行舟，不进则退，降价速度跟不上摩尔定律就是其实就是变相涨价。以S3为例，在过去十几年里，云厂商S3虽然名义上降价6倍，但硬件资源却便宜了 26 倍，所以 S3 的价格实际上是涨了 4 倍。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>智商税、服务费和保护费</p>
<p>或者说公有云的本质就是某种“共享经济”，共享顶级运维团队。但是这些公有云服务真的提供与价格匹配的服务了吗？绝大部分都是及格线水平的“大锅饭”。</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">以我司为例出海的。如果使用aws，那么很多合规的问题，我们可以不考虑，自己下云的时候，那就考虑很多合规的问题。比如GDPR，加州隐私条令等，或者是数据传输，连SCCs这种他自己也做了对应合规。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我很同意  公有云的东西就是杀猪盘，但是他们确实解决了很多潜在问题，除去合规以外。还有高可用，简单，无需运维团队&amp;dba等。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个观点也没错。说一千道一万，“不买一个东西可以有1000个理由，但是买一个东西只需要一个理由就足够了”。</p>
<hr>
<p><a href="https://zhuanlan.zhihu.com/p/674755718" target="_blank" rel="noopener noreferrer">扒皮云对象存储：从降本到杀猪 - 知乎</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">如果说混合了EBS/S3能力的开源 Ceph 还能算有不少运维复杂度，功能也没有完全拉齐；那么完全兼容 S3 的对象存储服务开源替代 MinIO 可以说是开箱即用了 —— 一个没有额外依赖的纯二进制，不需要几个配置参数就可以快速拉起，把服务器上的磁盘阵列转变为一个标准的本地 S3 兼容服务，甚至还集成了了 AWS 的 AK/SK/IAM 兼容实现！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">从运维管理的角度看，Redis 的运维复杂度比 PostgreSQL 低一个数量级，而 MinIO 的运维复杂度又比 Redis 还要再低一个数量级。它简单到这样一种程度：我一个人可以花个一周不到时间把 MinIO 的部署/监控作为添头放到我们开源的 PostgreSQL RDS 方案里来，用作可选的中央备份存储仓库。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">对于对像存储服务来说，云的三点核心价值主张：“更便宜，更简单，更快捷” ，更简单这条说不上，更便宜走向了反面，恐怕只剩下最后一点更快捷了 —— 在这一点上确实没有谁能比过云，你确实可以在云上用1分钟不到在全世界所有区域申请PB级的存储服务，Which is Amazing！只不过你也要为这个鸡肋特权付出几十倍的高昂溢价。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<ul>
<li>什么是协程泄漏？协程泄漏导致导致内存泄漏？</li>
<li>怎么检测协程泄漏？用<code>goleak</code>做协程泄漏检测</li>
</ul>
<hr>
<p>临时泄漏和永久泄漏</p>
<ul>
<li>mutex 忘记解锁</li>
<li>使用 wg 不当导致阻塞</li>
<li>chan 进行读写操作时，发送不接受或者接受不发送;</li>
</ul>
<p><a href="https://mp.weixin.qq.com/s/ql01K1nOnEZpdbp--6EDYw" target="_blank" rel="noopener noreferrer">跟读者聊 Goroutine 泄露的 N 种方法，真刺激！</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 熟悉mysal、 redis、leveldb，理解其基本原理及部分源码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 熱悉docker，了解k8S，理解docker基本原理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">5.</span><span class="token plain"> 熱悉网络、操作系统、数据结构与算法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">6.</span><span class="token plain"> 了解Kafka、Nginx、服务发现注册、服务限流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">基础知识面试：看了很多面经，不能仅仅局限于别人说的面试题，学会自己提问自己，并想清楚回答这个问题的思路框架，不要说出了东扯一点西扯一点，乱七八糟毫无思路可言，平时注意多总结回答时候的框架知识点，保证模拟的时候脉络清晰</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">整理下面试知识点总结，我应聘的应该是初级，可能结合了我的简历，问的高频问题主要集中在这</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">几种：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Golang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">垃圾回收，内存分配，GMP调度模型，各种锁，context， map， slice等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">关系数据库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">内存隔离级别，家引优化，索引结构，组合家引</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">非关系数据库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Redis数据类型，为什么快，缓存一致性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">计算机网络</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TCP/IP五层模型，三次握手，四次挥手，socket接口，time_ wait</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">其他基础</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10多路复用，布隆过滤器，Linux文件系統</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">项目经验</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">解決过什么问题，收获了哪些；为什么要这么设计</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="git-tag">git tag<a href="#git-tag" class="hash-link" aria-label="Direct link to git tag" title="Direct link to git tag">​</a></h3>
<ul>
<li><code>语义化版本</code>的版本号的格式为 <code>&lt;major&gt;.&lt;minor&gt;.&lt;patch&gt;</code> 分别代表大版本、小版本和修订号（bug 修复，就只改动修订号）</li>
<li>预发布版本号的格式为 <code>&lt;major&gt;.&lt;minor&gt;.&lt;patch&gt;-&lt;tag&gt;</code> （比如<code>1.0.0-beta.1</code>）其中<code>&lt;stage&gt;</code>一般选用：<code>alpha</code>、<code>beta</code>、<code>rc</code>。</li>
<li><code>版本号范围</code>是目前通用的，建议使用通配符写法，<del>保证跟上大版本，但是不更新到较新的不稳定版本</del></li>
</ul>
<hr>
<p>注意事项</p>
<ul>
<li>版本号前不要加<code>v</code>。</li>
<li>不要在数字前补<code>0</code>。错误示例：<code>01.12.03</code>。</li>
<li>每一位版本号按照<code>+1</code>的速度递增，不要在版本号之间跳跃。</li>
<li><em>主版本号停留在<code>0</code>的版本号，即<code>0.x.x</code>应当视作还在内部开发阶段的代码。如果代码有公 共 API，此时不宜对外公开。</em></li>
<li><code>1.0.0</code>的版本号用于界定公共 API 的形成。</li>
<li>当次版本号递增时，修订号归零；当主版本号递增时，次版本号、修订号归零。</li>
<li><em>创建新项目时，版本号从<code>0.1.0</code>开始。</em></li>
<li>如果不小心把一个不兼容的改版当成了次版本号发行，应当发行一个新的次版本号来更正这个问题并且恢复向下兼容。注意<strong>不能去修改已发行的版本</strong>。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="阿里云-oss-想更省钱怎么操作">阿里云 OSS 想更省钱，怎么操作？<a href="#阿里云-oss-想更省钱怎么操作" class="hash-link" aria-label="Direct link to 阿里云 OSS 想更省钱，怎么操作？" title="Direct link to 阿里云 OSS 想更省钱，怎么操作？">​</a></h3>
<p><a href="https://ruby-china.org/topics/41989" target="_blank" rel="noopener noreferrer">对象存储服务（OSS）省钱建议 · Ruby China</a></p>
<p>结论：<em>OSS 只做存储，下行流量走 CDN，再搭配上流量包</em></p>
<ul>
<li>分析 OSS 费用结构：磁盘存储费用、上行流量和下行流量。<em>对于任何服务而言，下行流量都是远大于上行流量。</em> 按照¥0.5/G 的费用来算，就是¥500/T，服务访问量一旦变多，这部分费用就会激增。</li>
<li>怎么解决<code>下行流量费用</code>？ <em><code>配置CDN回源（而不是购买OSS下行流量包）</code>+<code>购买CDN下行流量包（而不是按量付费）</code></em></li>
<li>怎么减少<code>磁盘存储费用</code>？服务端一定要做好压缩（可以用<code>媒体处理MPS</code>），单个文件能多压缩 10%，对整个 OSS 费用来说都是很大一笔钱（比如说 MOV 格式压缩，并转换为 MP4 格式。）。更多的，还可以在 OSS 上分冷资源和热资源（比如 1 年前的静态文件就都做到冷资源里），继续压缩成本。</li>
</ul>
<hr>
<p>如果不怎么差钱的可以采用一些标准云计算方案：</p>
<ul>
<li>客户端直接上传到 OSS，不经过服务端。</li>
<li>使用转码服务，将新上传的视频做多码率压缩（1080-&gt;720/480）和抽抽帧/视频高光摘要生成。</li>
<li>配置 OSS 文件存储策略（OSS 文件前缀），比如 7 天前数据滚动删除，3 天前的数据转冷存储。</li>
<li>CDN 可以根据业务模式选择流量/峰值带宽等收费方式。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="怎么优化字符串和-bytes-切片互相转换">怎么优化字符串和 bytes 切片互相转换？<a href="#怎么优化字符串和-bytes-切片互相转换" class="hash-link" aria-label="Direct link to 怎么优化字符串和 bytes 切片互相转换？" title="Direct link to 怎么优化字符串和 bytes 切片互相转换？">​</a></h3>
<p>直接使用<code>string(bytes)</code>或者<code>[]byte(str)</code>会带来数据的复制，性能不佳</p>
<p>golang1.20 之后使用 unsafe 包的几个方法代替之前 reflect 的包，具体使用如下：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">StringToBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> unsafe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Slice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsafe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StringData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">BytesToString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> unsafe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TestAdd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">testing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xs </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">StringToBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;xxx&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xs2 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token function" style="color:#d73a49">byte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;xxx&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Equal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xs2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">BytesToString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sx2 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Equal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sx2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><a href="https://colobu.com/2022/09/06/string-byte-convertion/" target="_blank" rel="noopener noreferrer">与日俱进，在 Go 1.20 中这种高效转换的方式又变了</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="持续部署-cd">持续部署 CD<a href="#持续部署-cd" class="hash-link" aria-label="Direct link to 持续部署 CD" title="Direct link to 持续部署 CD">​</a></h3>
<ul>
<li><em>有哪些部署策略？分别是什么？以及各自的优缺点？</em></li>
<li>简述蓝绿、灰度、滚动的部署过程？</li>
</ul>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>有哪些部署策略？分别是什么？以及各自的优缺点？</summary><div><div class="collapsibleContent_i85q"><div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`蓝绿部署`</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">两套环境交替升级，旧版本保留一定时间便于回滚</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 好处是切换和回滚速度很快，如果有问题的话，可以随时切回老版本，有效降低对生产环境用户的影响。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 缺点是发布期间，需要使用两倍的机器资源，防止发布期间，单组机器无法支撑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`灰度部署`</span><span class="token plain">，最常见的是 AB 测试，</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">根据比例将老版本升级，例如 80% 用户访问是老版本，20% 用户访问是新版本</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`滚动部署`</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">按批次停止老版本实例，启动新版本实例</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 优点是相对于蓝绿部署，不需要两倍的机器资源，可以部分部署，直到全量部署，要求自动化程度很高</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 缺点是，发布工具比较复杂，门槛高，LB 要有平滑的流量摘除和拉入能力</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>选择哪种部署策略？</p><ul>
<li>综上所述，三种方式均可以做到平滑式升级，在升级过程中仍然保持服务的连续性，升级对外界是无感知的。那生产上选择哪种部署方法最合适呢？这取决于哪种方法最适合你的业务和技术需求。</li>
<li><em>如果你们运维自动化能力储备不够，肯定是越简单越好，建议蓝绿发布，如果业务对用户依赖很强，建议灰度发布。如果是 K8S 平台，滚动更新是现成的方案，建议先直接使用</em></li>
</ul></div></div></details>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>蓝绿、灰度、滚动的部署过程</summary><div><div class="collapsibleContent_i85q"><blockquote>
<p>蓝绿发布的部署过程？</p>
</blockquote><ol>
<li>服务器资源要分为 AB 两组，首先把 A 组从 LB 中摘掉，部署新版本，B 组继续提供服务</li>
<li>A 组升级完成后，LB 重新接入 A 组，再把 B 组从 LB 中摘除，部署新版本，A 组重新提供服务</li>
<li>最后，B 组也升级完成，LB 重新接入 B 组，此时 AB 组都完成版本升级，对外提供服务</li>
</ol><blockquote>
<p>灰度部署的部署过程？</p>
</blockquote><ol>
<li>从 LB 摘掉灰度服务器，升级成功后再加入 LB</li>
<li>少量用户流量到新版本</li>
<li>如果灰度服务器测试成功，升级剩余服务器</li>
</ol><blockquote>
<p>滚动部署的部署过程？</p>
</blockquote><ol>
<li>先升级 1 个副本，主要做部署验证</li>
<li>每次升级副本，自动从 LB 上摘掉，升级成功后自动拉入 (加入集群)</li>
<li>事先需要有自动更新策略，分为若干次，每次数量/百分比可配置</li>
<li>回滚是发布的逆过程，先从 LB 摘掉新版本，再升级老版本，这个过程一般时间比较长，自动化要求高</li>
</ol></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="进程的内存占用">进程的内存占用？<a href="#进程的内存占用" class="hash-link" aria-label="Direct link to 进程的内存占用？" title="Direct link to 进程的内存占用？">​</a></h3>
<p>怎么查看一个进程究竟占用多少内存？</p>
<ul>
<li>USS(<code>Unique Set Size进程独占的物理内存（不包含共享库占用的内存）</code>) 是一个进程所占用的私有内存。即该进程独占的内存。<em>USS 是非常非常有用的数据，因为它反映了运行一个特定进程真实的边际成本（增量成本）</em>。当一个进程被销毁后，USS 是真实返回给系统的内存。当进程中存在一个可疑的内存泄露时，USS 是最佳观察数据。</li>
<li>PSS(<code>Proportional Set Size实际使用 的物理内存（比例分配共享库占用的内存）</code>) 与 RSS 不同，它按比例表示使用的共享库，例如：如果有三个进程都使用了一个共享库，共占用了 30 页内存。那么 PSS 将认为每个进程分别占用该共享库 10 页的大小。<em>PSS 是非常有用的数据，因为系统中所有进程的 PSS 都相加的话，就刚好反映了系统中的总共占用的内存</em>。而当一个进程被销毁之后，其占用的共享库那部分比例的 PSS，将会再次按比例分配给余下使用该库的进程。这样 PSS 可能会造成一点的误导，因为当一个进程被销毁后，PSS 不能准确地表示返回给全局系统的内存（the memory returned to the overall system）。</li>
<li>RSS(<code>Resident Set size常驻内存（包含共享库占用的内存）</code>) 是一个进程在 RAM 中真实存储的总内存。但是 RSS 还是可能会造成误导，因为它仅仅表示该进程所使用的所有共享库的大小，它不管有多少个进程使用该共享库，该共享库仅被加载到内存一次。所以 RSS 并不能准确反映单进程的内存占用情况。</li>
<li>VSS(<code>Virtual Set Size虚拟内存（包含共享库占用的内存）</code>) 单个进程全部可访问的地址空间，其大小可能包括还尚未在内存中驻留的部分。对于确定单个进程实际内存使用大小，VSS 用处不大。</li>
</ul>
<p><em>结论，VSS&gt;=RSS&gt;=PSS&gt;=USS</em></p>
<p>RSS和VSS都没啥用，USS和PSS比较有用，</p>
<p>PS shows different RSS value from Pmap and Smem</p>
<p><a href="https://unix.stackexchange.com/questions/56469/rssresident-set-size-is-differ-when-use-pmap-and-ps-command" target="_blank" rel="noopener noreferrer">linux - RSS(resident set size) is differ when use pmap and ps command - Unix &amp; Linux Stack Exchange</a></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pmap </span><span class="token parameter variable" style="color:#36acaa">-xx</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">PID</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">smem </span><span class="token parameter variable" style="color:#36acaa">-P</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">PID</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-s</span><span class="token plain"> PSS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="内核分析工具-bcc-和-ebpf">内核分析工具 BCC 和 eBPF<a href="#内核分析工具-bcc-和-ebpf" class="hash-link" aria-label="Direct link to 内核分析工具 BCC 和 eBPF" title="Direct link to 内核分析工具 BCC 和 eBPF">​</a></h3>
<ul>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzA5OTAyNzQ2OA==&amp;mid=2649749110&amp;idx=2&amp;sn=bc60d14ee1440f112b68db9dd6fa631a" target="_blank" rel="noopener noreferrer">初识 eBPF，你应该知道的知识</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651451738&amp;idx=2&amp;sn=b469da550a1dc472f9c75d21c0a06646" target="_blank" rel="noopener noreferrer">BPF 和 Go: Linux 中的现代内省形式</a></li>
</ul>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BCC 是什么？为什么需要 BCC 和 eBPF？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BCC(</span><span class="token code-snippet code keyword" style="color:#00009f">`BPF Compiler Collection`</span><span class="token plain">)，是一个用来分析操作系统性能和获取操作系统信息的库，我们可以使用 BCC 来分析系统性能，内核分析工具 eBPF 就是基于 BCC 开发的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">怎么使用 BCC 工具？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用 execsnoop 工具分析系统进程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用 opensnoop 跟踪打开的文件句柄</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用 biotop 分析磁盘 I/O 操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用 xfsslower 分析导致系统变慢的操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eBPF 是什么？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">eBPF 可以通过热加载的方式动态地获取，修改内核中的关键数据和执行逻辑，避免内核模块的方式可能会引入宕机风险，并具备堪比原生代码的执行效率</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eBPF 的应用场景和最佳实践？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">linux 默认内存页大小是多少？4kb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">有哪些影响内存页大小的因素？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`过小的页面大小`</span><span class="token italic content">会带来较大的</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`页表项增加寻址时 TLB(Translation lookaside buffer)`</span><span class="token italic content">的查找速度和额外开销</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`过大的页面大小`</span><span class="token italic content">会浪费</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`内存空间`</span><span class="token italic content">，造成内存碎片，降低内存的利用率</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">linux 的动态追踪技术？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">动态追踪就是 linux4.1 之后的 eBPF 机制，kprobes/uprobes 机制在事件的基础上分别为内核态和用户态提供了追踪调试的功能。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">追踪机制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> kprobes/kretprobes/uprobes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> tracepoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> perf_event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> ftrace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> systemtap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> eBPF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">常用追踪工具</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> ftrace/utrace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> perf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> starce/sysdig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> systemtap toolkit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><a href="https://github.com/iovisor/bcc" target="_blank" rel="noopener noreferrer">iovisor/bcc: BCC - Tools for BPF-based Linux IO analysis, networking, monitoring, and more</a></p>
<p>BCC = BPF Compiler Collection</p>
<p><a href="https://ebpf.io/" target="_blank" rel="noopener noreferrer">eBPF - Introduction, Tutorials &amp; Community Resources</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="zzz">zzz<a href="#zzz" class="hash-link" aria-label="Direct link to zzz" title="Direct link to zzz">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> Linux 内核针对不同并发场景的工具实现</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">间隙锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> atomic 原子变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> spinlock 自旋锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> semaphore 信号量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> mutex 互斥锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> rw-lock 读写锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> preempt 抢占</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> per-cpu 变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> RCU 机制 (Read Copy Update)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`内存屏障memory-barrier`</span><span class="token plain">(程序运行过程中，对内存访问不一定按照代码编写的顺序来进行)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86 在多核环境下，多核竞争数据总线时，提供 lock 指令进行锁总线操作。保证“读 - 修改 - 写”操作的原子性。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">自旋锁将当前线程  不停地执行循环体，而不改变线程的运行状态，在 CPU 上实现忙等，以此保证响应速度更快。这种类型的线程数不断增加时，性能明显下降。所以自旋锁保护的临界区必须小，操作过程必须短。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">信号量用于保证有限数量的临界资源，信号量在获取和释放时，通过自旋锁保护，当有中断会把中断保存到 eflags 寄存器，最后再恢复中断。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">为了控制同一时刻，只有一个线程进入临界区，让无法进入临界区的线程休眠。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">读写锁，把读操作和写操作分别进行加锁处理，减少了加锁粒度，优化了读大于写的场景。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">linux 为解决 CPU 各自使用的 L2 cache，数据与内存中的不一致的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">用于解决多个 CPU 同时读写共享数据的场景。他允许多个 CPU 同时进行写操作，不使用锁，并且实现 GC 来处理旧数据。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 时间片用完调用 schedule 函数。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 由于 IO 等原因，自己主动调用 schedule。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 其他情况下，当前进程被其他进程替换的时候。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 编译器对代码进行优化。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 多 cpu 架构存在指令乱序访问内存的可能。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 自旋锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> RCU 锁是什么？RCU 锁的机制？实现原理？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 和 mutex 类似，加锁之后，如果有线程试图再次加锁，该线程不会阻塞，而是处于忙等状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 使用场景是，锁被持有的时间较短，自旋等待的成本要尽可能小于线程调度的成本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">RCU 锁原理与实现 - 云 + 社区 - 腾讯云</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://cloud.tencent.com/developer/article/1684477</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> 互斥锁/自旋锁/读写锁/悲观锁/乐观锁</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 互斥锁和自旋锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 读写锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 悲观锁和乐观锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">加锁失败的处理：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 互斥锁加锁失败后，线程会释放 CPU，给其他线程。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 自旋锁加锁失败后，线程会继续等待，知道他拿到锁。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">读写锁适用于能明确区分读操作和写操作的场景。</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 工作原理：</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">写锁是独占锁，因为任何时刻只有一个线程持有写锁，类似互斥锁和自旋锁，而读锁是共享锁，因为读锁可以被多个线程同时持有。读写锁在读多写少的场景，才能发挥出优势。</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 读优先锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 写优先锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 公平读写锁。用队列把获取锁的线程排队，不管是写线程还是读线程都按照先进先出的原则加锁即可，这样读线程仍然可以并发，也不会出现「饥饿」的现象。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token code-snippet code keyword" style="color:#00009f">`使用场景`</span><span class="token plain">：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">如果多线程同时修改共享资源的概率比较高，很容易出现冲突，就应该使用悲观锁；</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">如果多线程同时修改共享资源的概率比较低，就使用乐观锁。</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">（乐观锁去掉了加锁解锁操作，但是一旦发生冲突，成本就很高了。所以只有在冲突概率非常低，且加锁成本很高的场景，才考虑使用乐观锁，比如共享文档编辑，以及 git 等代码管理工具这种需要共享资源的。）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果 sy 占用太高，有可能是</span><span class="token code-snippet code keyword" style="color:#00009f">`上下文切换和中断`</span><span class="token plain">太频繁了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果 cs 太高，那就是</span><span class="token code-snippet code keyword" style="color:#00009f">`线程或者进程开的太多`</span><span class="token plain">了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="app-能获取数据但是抓包软件抓不到数据为什么">app 能获取数据，但是抓包软件抓不到数据，为什么？<a href="#app-能获取数据但是抓包软件抓不到数据为什么" class="hash-link" aria-label="Direct link to app 能获取数据，但是抓包软件抓不到数据，为什么？" title="Direct link to app 能获取数据，但是抓包软件抓不到数据，为什么？">​</a></h3>
<p><em><a href="https://mp.weixin.qq.com/s?__biz=MzUzNTY5MzU2MA==&amp;mid=2247497288&amp;idx=1&amp;sn=1d634021528643c2f71e7cbf4dd7a0f7" target="_blank" rel="noopener noreferrer">为什么你抓不到 baidu 的数据</a></em></p>
<ul>
<li><em>因为 charles 之类的抓包软件只抓 ws 和 http，搞一个私有协议就绕过了。用 lua 写一个 wireshark 的解析私有协议的插件，就能抓到了</em>因为大部分 app 都不会去搞私有协议这些的，所有抓包软件默认不抓这些协议。</li>
<li>如果 app 获取不到数据的话，大概率是搞了个 HPKP/ssl-pinning/HSTS。</li>
<li>当然 app 能获取数据，也有可能是搞了个 HPKP 防抓包，但是 app 本地缓存数据了，直接读本地数据，这种还挺常见的。</li>
</ul>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HTTPS握手中的Client Hello阶段，里面有个扩展server_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">解密数据包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTPS会对HTTP的URL和Request Body都进行加密，因此直接在filter栏进行过滤http.host == &quot;baidu.com&quot;会一无所获</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssl.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">找到Protocols之后，使劲往下翻，找到TLS那一项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">将导出的ssl.key文件路径输入到这里头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">点击确定后，就能看到18号和20号数据包已经被解密</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>但是事实上，我们在使用Thor或者Charles的时候，本身就会进行SSL解密，为什么看到的还是密文，而不是明文呢？</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tcpdump </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> eth0 </span><span class="token function" style="color:#d73a49">host</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">39.156</span><span class="token plain">.66.10 </span><span class="token parameter variable" style="color:#36acaa">-w</span><span class="token plain"> baidu.pcap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>LVS 工作原理？</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LVS 和 iptables 的 netfilter 四表五链</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LVS 实际上就是 </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">工作在 input 链上，报文从 PREROUTING 进入，按正常顺序流入 INPUT 链，lvs 工作在 INPUT 链上，根据所匹配的规则，符合规则的报文会被 LVS 强行拉到 POSTROUTING 链上，然后根据规则流通出去。</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">至于 LVS 的负载算法，和所有的负载算法都一样，就那几种，没啥好说的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>回顾了一下dockerfile best practice，两方面嘛，build和security，其实security说白了就是和VPS的security没啥区别，无非是限制各种硬件资源以及用户权限控制。至于build则是两点，size和boost build speed。size相关就是各种减少layer，也是官方best practice中重点提到的内容。至于speed则关键点是用好build cache和BuildKit。</p>
<hr>
<p>How to reduce git size?</p>
<p><a href="https://stackoverflow.com/questions/2116778/reduce-git-repository-size" target="_blank" rel="noopener noreferrer">git clean - Reduce Git repository size - Stack Overflow</a></p>
<hr>
<p>遇到一个问题</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">在使用 cat 或 printf 命令将多行文本写入文件时，将会解释 $ 符号后面的内容作为环境变量或命令替换。为了避免这种替换，您可以使用单引号 &#x27; 包裹文本内容，或者使用反斜杠 \ 转义 $ 符号。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>多行文本写入文件（尤其是 shell 脚本），确实会遇到这个问题</p>
<hr>
<p>MySQL vs PostgreSQL</p>
<ul>
<li><em>mysql 和 pgsql 对比？pgsql 为啥也用 B+ 树索引，而不是 AVL 之类的平衡树？</em></li>
<li>GIS 用 GiST 提供的 R 树还是直接使用 R 树更好（mysql 和 PostGIS0.6 之前都直接使用 R 树）？</li>
<li>怎么备份 pgsql 某个数据库的数据？用<code>pg_basebackup</code>做物理备份（pg 服务的 data 文件夹），或者用<code>pg_dump</code>做逻辑备份（sql 文件）</li>
</ul>
<hr>
<p><a href="https://ruby-china.org/topics/43468" target="_blank" rel="noopener noreferrer">浅析 PostgreSQL + zhparser 进行中文搜索的分词与排序优化 · Ruby China</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="框架-元框架-脚手架">框架 元框架 脚手架<a href="#框架-元框架-脚手架" class="hash-link" aria-label="Direct link to 框架 元框架 脚手架" title="Direct link to 框架 元框架 脚手架">​</a></h3>
<p>框架 元框架 脚手架</p>
<p>framework, meta-framework, scaffold/starter</p>
<p>Library, Toolkit, Framework, Design, Boilerplate, Scaffolding</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">这是一种命名错位——现在被称为“元框架”的产品，其实应该叫框架，而被称为“框架”的东西，比如react、vue，应该叫“库”（或许angular稍稍超出了库的范畴，但其实也没有到框架的级别）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果把nextjs叫框架，把react叫库，那么就和其他领域对齐了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这事儿其实和SSR没有关系，按理说umi提供的那一堆东西，也应该叫做框架。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">一般来说，框架提供三种东西——</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">第一，提供确定的开发和集成范式，包括模块接口，DSL、构建方法、驱动机制、应用的生命周期等等。这里面既有规范标准，又包含一系列工具链。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">第二，提供开箱即用的通用功能，比如配置文件读写、网络请求，以及和前端息息相关的ui组件、登录、权限等，也可以由框架提供。通用功能和框架内核，组成了框架的runtime。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">第三，提供最佳实践，也就是说我用你这个框架，到底应该把程序写成什么样？你得有明确的主张，并且有案例供我参考。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">react和vue，基本上以上三条都没有，angular  有小一部分，所以他们是“库”，但是他们都自称“框架”，那么真正的框架就只能教“元框架”了。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">借着这问题谈谈我对以 Next.js、Umi、Nuxt 等为代表的，在国外常被称为“元框架（Meta-framework）”的这些东西的观点吧。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">非常神秘的是这问题是我自己问的，不知为什么突然刷到了，也就自己过来补一下见解。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">此类元框架的目的倒是都不难理解：它们认为现在前端开发需要关注的事情太多，状态管理、路由、请求、样式、测试、测试……当然还有最 重要的，SSR（Server Side Rendering，服务端渲染）要如何处理，也就是如何更好地做 SEO 优化。为了实现这些，开发者们往往需要耗费大量精力来构建项目和组织代码，如果涉及 TS，还要考虑如何将各部分以类型安全与可扩展的方式组合到一起。并且更大的问题是，每个开发者都有自己的喜好，最终做出来的项目结构都有着强烈的个人风格，很难统一。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">而这些“元框架”提供了一整套统一和风格一致的解决方案，尽管你付出了一点小代价，失去了在组织项目结构上的一些自由度，但也得到了这样一个开箱即用的方案。更重要的是，由于这些元框架往往用户众多，你可以更容易在社区找到解决某个具体问题的答案，而不是自己在那里折腾自己搭的项目里各个组件的各种神秘兼容性问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">实际上这些元框架最初的卖点就是这个 SSR，如何更好地用接近写 SPA 的方式写可以直接做 SEO 的网页。当然，你完全可以说最开始这批人就是吃饱了撑的，做 SEO 为什么偏要折腾这些 SPA 时代的框架而不是去做模板引擎渲染，可偏偏他们做成了，然后成品大家都觉得好用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">那么代价呢？为了做 SSR，路由显然是这类元框架必须考虑的问题，一定不可能让用户随便选个路由方案——  服务器肯定得知道用户请求的哪个页面啊，要是让用户随便选个路由方案怎么知道呢，所以必须得搓一个自己的集成进去。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">状态管理也是个问题。在 SSR 中，服务器通常只会初始化应用一次并发往多个客户端，如果直接用一个简单的全局对象如 Vue 的 export const globalState = reactive({}) 来管理全局状态，客户端对这个全局状态的修改会直接改变服务器中这个面向所有用户的全局状态，由此可能意外向某个用户泄露其他用户的信息。可以参阅 Pinia 的 Introduction 以详细了解这个问题。不一定所有元框架都集成了一套内置的状态管理方案，但它们一定都需要对用户所使用的状态管理库进行某种考量，同时这些库也需要考虑用户使用 SSR 的场景。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">对于测试也需要一些额外的工作——元框架不一定提供内置的测试模块，但总得考虑对几个常用测试工具的兼容性。毕竟 SSR 中有一部分组件是依赖于服务端才能正常渲染的，必须要元框架特地为这些测试工具提供兼容才能保证它们正常工作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这批人就是吃饱了撑的，做 SEO 为什么偏要折腾这些 SPA 时代的框架而不是去做模板引擎渲染，可偏偏他们做成了，然后成品大家都觉得好用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">那么代价呢？为了做 SSR，路由显然是这类元框架必须考虑的问题，一定不可能让用户随便选个路由方案——服务器肯定得知道用户请求的哪个页面啊，要是让用户随便选个路由方案怎么知道呢，所以必须得搓一个自己的集成进去。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">状态管理也是个问题。在 SSR 中，服务器通常只会初始化应用一次并发往多个客户端，如果直接用一个简单的全局对象如 Vue 的 export const globalState = reactive({}) 来管理全局状态，客户端对这个全局状态的修改会直接改变服务器中这个面向所有用户的全局状态，由此可能意外向某个用户泄露其他用户的信息。可以参阅 Pinia 的 Introduction 以详细了解这个问题。不一定所有元框架都集成了一套内置的状态管理方案，但它们一定都需要对用户所使用的状态管理库进行某种考量，同时这些库也需要考虑用户使用 SSR 的场景。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">对于测试也需要一些额外的工作——元框架不一定提供内置的测试模块，但总得考虑对几个常用测试工具的兼容性。毕竟 SSR 中有一部分组件是依赖于服务端才能正常渲染的，必须要元框架特地为这些测试工具提供兼容才能保证它们正常工作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">好了，于是这些一开始还不叫“元框架”的 SSR 框架一  寻思——我都做这么多事了，为啥不干脆做全呢。于是请求处理（包括缓存）被内置了、CSS 解决方案被内置了、许多优化方案被内置了、有些连鉴权系统也内置了。当然，由于这些 SSR 框架都免不了依赖于服务端，所以你当然也可以不再创建一个单独的后端应用，而是直接在这里头搓后端——实际上现在确实有不少人直接在 Next.js 里搓后端，不再单独做个后端了。有些框架则更“彻底”，直接标榜自己是“全栈框架”，如 RedwoodJS，把后端该有的东西也顺便帮你集成了（RedwoodJS 自身用的是 Prisma 和 GraphQL）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">集成了这么多东西，它们当然不能说自己就是个“框架”了，要不然怎么和 React、Vue 等大家常说的“前端框架”区分呢？所以就加了个 meta 前缀，表明自己是构建于它们之上的、功能更多的框架。有些非常火的元框架之上甚至还有人往里边加入更多功能做一个更“meta”的框架，如基于 Next.js 的 T3 Stack.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">后来大家都寻思这些元框架功能这么齐全，干脆不管三七二十一直接用它们得了，也不管是不是真的要上 SSR 了。国内关于这些元框架的声音不多，但欧美那边很多人已经默认用哪个前端框架就绑定它最流行的一个或几个元框架了，比如 React 就绑定 Next.js 或 Remix、Vue 就绑定 Nuxt、Svelte 就绑定 SvelteKit、Solid 就绑定 Solid Start、Qwik 就绑定 Qwik City……</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">以至于近些年出现的新前端框架，其最常用的元框架就是前端框架开发团队自己做出来的。实话说，这也有一些坏处，例如 Svelte 离开 SvelteKit 你很难找到一个靠谱的路由方案——因为 Svelte 团队都假设你既然在用 Svelte 那极大概率就在用 SvelteKit 了，而 SvelteKit 自身已经有路由方案了（说实话，这不是假设，实际上就是没多少人在用 Svelte 的同时还不在用 SvelteKit……）。至于 Solid、Qwik 那边，生态比 Svelte 还要小点，对元框架的依赖就更过分，离开了官方整的那个元框架许多东西都得自己手搓。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">不可避免的，也总会有人对元框架自身在某些解决方案上的选择非常不满，认为它过于 Opinioned，而国内因此被骂的尤其多的就是 Umi——是不是有点 Python Black 那味儿。但总体上，大家勉强同意该有一套广泛使用的、一致的技术栈作为一套或多套实质上的社区共识，至少用同一套技术栈的人多了，在这套技术栈里解决问题总是相对容易——毕竟你可以踩着前人踩过的坑往前走。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我在一段时间内非常迷恋于使用元框架，上面提到的 T3 Stack 我就使用了不止一次。后来也用过其他元框架，说实话最舒适的是 Vue 的 Nuxt.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">只是后来，我意识到元框架往往自身存在一些问题，一个是许多相对早期的元框架就是为了 SSR 而开发的，虽然它们基本上都明确表明支持在配置里调成 CSR，但有时仍会遇到一些因为 SSR 而产生的兼容性问题，并且开启 SSR 后，许多依赖于动态渲染的库都会部分甚至全部失效。另一点是，元框架们常常隐藏了过多的实现细节，它们直接用起来是方便，但有许多其他库只会给出如何在传统 SPA 应用中安装与配置的教程，在元框架中你常常需要寻思明白其中的工作机理，然后想办法把这些库的初始化代码插入到一个合适的位置上，而不仅仅是常见的、放在 main.ts 中了事。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">并且更多时候，我发觉自己并不需要 SSR，它更多是为了解决 SEO 的问题，但我的大部分应用并不需要考虑被搜索引擎找到或方便地被爬虫分析。而 SSR 自身给我带来的好处要比我必须因此而放弃的东西少得多。因此后来，我仍旧回归了之前手动配置各个模块的方式，一开始只用 Vite 给项目做一个基本样子，然后一点点把仅需要用到的功能与模块加进去——这繁琐很多，但总是让我感觉安心不少。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">首先必须分清六个基本概念：Library，Toolkit，Framework，Design，Boilerplate，Scaffolding。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Library库：分为2类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">一类是方法库，用来实现特定需求的一组API集合。最常见的就是jQuery，它是一系列操作DOM和AJAX的API组成的方法库。除了jQuery，还有早期的Prototype，Dojo，Mootools，后面这三个在当时也被称为三大前端工具库。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">操作Data的有UnderScore和Lodash，操作Event的有现在流行的RxJS，他们都是Library，在需要的时候，正确调用他们提供的方法就可以。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">一类是UI组件库，满足特定业务需要的高可复用的常见UI组件集合。例如Ant Design of React/Ant Design of Angular(NG-ZORRO)，Element UI，LayUI，EasyUI。早期的Yahoo UI，Extjs，jQuery UI。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Toolkit`(工具箱): 如Bootstrap，给你提供创建现代响应式页面所需要的工具，包含一套完整的响应式CSS类库，字体，同时还有一套很完整的UI组件。只是这些组件原生是用jQuery写的，不适用于现在主流的前端。所以产生了很多衍生UI库，例如Angular实现的ng-bootstrap和ngx-bootstrap，React实现的react-bootstrap，Vue实现的bootstrap-vue。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Framework框架: 用来构建一个应用的主体结构。然后你在这个主体结构上添砖加瓦，实现自己的需求。Web服务器端的框架基本实现的都是MVC设计模式，你在Model、View、Controller层分别去添加代码。Web前端，Angular(以及它的前身Angularjs)实现的都是MVP模式，是Model、View、Presenter三层。老一辈的其他前端框架，例如Backbone、Ember，实现的是所谓MVVM。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">只有Angular算作严格意义上的Framework，vue、react本质上是一个解决View层的Library。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Design设计语言： 当说到xxx Design的时候，前端应该经常听到Material Design和Ant Design，分别是Google和阿里的推出的两种前端UI设计语言。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Scaffolding脚手架工具： 前端的脚手架工具一般都是用cli提供的，cli是(Command Line Interface的缩写)，不是Client的前三个字母。例如ng-cli, create-react-app, vue cli，以及用Yeoman(YO)做出来的许多generator。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Scaffolding的作用就是辅助你快速搭建项目。但是Scaffolding不是最终成果物的一部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Boilerplate模板、样板： 一般程序员很少了解这个概念，而是Library和Framework知道的多一些。上面说过了，当你用React开发的时候，React本身不能满足全部需求，就需要周边辅助的项目。如何把这些全家桶用最佳实践(Best Practice)的方式组合在一起？就需要有人给一个样板，Ant Design Pro就产生了。所以Ant Design是设计语言、Ant Design of React是遵循这门设计语言并且用React实现的UI组件库，Ant Design Pro就是模板。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>actually, we really need to distinguish these concepts clearly so that they can be refered to more simply, for example</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">好了，于是这些一开始还不叫“元框架”的 SSR 框架一寻思——我都做这么多事了，为啥不干脆做全呢。于是请求处理（包括缓存）被内置了、CSS 解决方案被内置了、许多优化方案被内置了、有些连鉴权系统也内置了。当然，由于这些 SSR 框架都免不了依赖于服务端，所以你当然也可以不再创建一个单独的后端应用，而是直接在这里头搓后端——实际上现在确实有不少人直接在 Next.js 里搓后端，不再单独做个后端了。有些框架则更“彻底”，直接标榜自己是“全栈框架”，如 RedwoodJS，把后端该有的东西也顺便帮你集成了（RedwoodJS 自身用的是 Prisma 和 GraphQL）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">集成了这么多东西，它们当然不能说自己就是个“框架”了，要不然怎么和 React、Vue 等大家常说的“前端框架”区分呢？所以就加了个 meta 前缀，表明自己是构建于它们之上的、功能更多的框架。有些非常火的元框架之上甚至还有人往里边加入更多功能做一个更“meta”的框架，如基于 Next.js 的 T3 Stack.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">后来大家都寻思这些元框架功能这么齐全，干脆不管三七二十一直接用它们得了，也不管是不是真的要上 SSR 了。国内关于这些元框架的声音不多，但欧美那边很多人已经默认用哪个前端框架就绑定它最流行的一个或几个元框架了，比如 React 就绑定 Next.js 或 Remix、Vue 就绑定 Nuxt、Svelte 就绑定 SvelteKit、Solid 就绑定 Solid Start、Qwik 就绑定 Qwik City……</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">以至于近些年出现的新前端框架，其最常用的元框架就是前端框架开发团队自己做出来的。实话说，这也有一些坏处，例如 Svelte 离开 SvelteKit 你很难找到一个靠谱的路由方案——因为 Svelte 团队都假设你既然在用 Svelte 那极大概率就在用 SvelteKit 了，而 SvelteKit 自身已经有路由方案了（说实话，这不是假设，实际上就是没多少人在用 Svelte 的同时还不在用 SvelteKit……）。至于 Solid、Qwik 那边，生态比 Svelte 还要小点，对元框架的依赖就更过分，离开了官方整的那个元框架许多东西都得自己手搓。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">不可避免的，也总会有人对元框架自身在某些解决方案上的选择非常不满，认为它过于 Opinioned，而国内因此被骂的尤其多的就是 Umi——是不是有点 Python Black 那味儿。但总体上，大家勉强同意该有一套广泛使用的、一致的技术栈作为一套或多套实质上的社区共识，至少用同一套技术栈的人多了，在这套技术栈里解决问题总是相对容易——毕竟你可以踩着前人踩过的坑往前走。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我在一段时间内非常迷恋于使用元框架，上面提到的 T3 Stack 我就使用了不止一次。后来也用过其他元框架，说实话最舒适的是 Vue 的 Nuxt.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">只是后来，我意识到元框架往往自身存在一些问题，一个是许多相对早期的元框架就是为了 SSR 而开发的，虽然它们基本上都明确表明支持在配置里调成 CSR，但有时仍会遇到一些因为 SSR 而产生的兼容性问题，并且开启 SSR 后，许多依赖于动态渲染的库都会部分甚至全部失效。另一点是，元框架们常常隐藏了过多的实现细节，它们直接用起来是方便，但有许多其他库只会给出如何在传统 SPA 应用中安装与配置的教程，在元框架中你常常需要寻思明白其中的工作机理，然后想办法把这些库的初始化代码插入到一个合适的位置上，而不仅仅是常见的、放在 main.ts 中了事。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">并且更多时候，我发觉自己并不需要 SSR，它更多是为了解决 SEO 的问题，但我的大部分应用并不需要考虑被搜索引擎找到或方便地被爬虫分析。而 SSR 自身给我带来的好处要比我必须因此而放弃的东西少得多。因此后来，我仍旧回归了之前手动配置各个模块的方式，一开始只用 Vite 给项目做一个基本样子，然后一点点把仅需要用到的功能与模块加进去——这繁琐很多，但总是让我感觉安心不少。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">首先必须分清六个基本概念：Library，Toolkit，Framework，Design，Boilerplate，Scaffolding。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Library库：分为2类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">一类是方法库，用来实现特定需求的一组API集合。最常见的就是jQuery，它是一系列操作DOM和AJAX的API组成的方法库。除了jQuery，还有早期的Prototype，Dojo，Mootools，后面这三个在当时也被称为三大前端工具库。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">操作Data的有UnderScore和Lodash，操作Event的有现在流行的RxJS，他们都是Library，在需要的时候，正确调用他们提供的方法就可以。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">一类是UI组件库，满足特定业务需要的高可复用的常见UI组件集合。例如Ant Design of React/Ant Design of Angular(NG-ZORRO)，Element UI，LayUI，EasyUI。早期的Yahoo UI，Extjs，jQuery UI。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Toolkit`(工具箱): 如Bootstrap，给你提供创建现代响应式页面所需要的工具，包含一套完整的响应式CSS类库，字体，同时还有一套很完整的UI组件。只是这些组件原生是用jQuery写的，不适用于现在主流的前端。所以产生了很多衍生UI库，例如Angular实现的ng-bootstrap和ngx-bootstrap，React实现的react-bootstrap，Vue实现的bootstrap-vue。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Framework框架: 用来构建一个应用的主体结构。然后你在这个主体结构上添砖加瓦，实现自己的需求。Web服务器端的框架基本实现的都是MVC设计模式，你在Model、View、Controller层分别去添加代码。Web前端，Angular(以及它的前身Angularjs)实现的都是MVP模式，是Model、View、Presenter三层。老一辈的其他前端框架，例如Backbone、Ember，实现的是所谓MVVM。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">只有Angular算作严格意义上的Framework，vue、react本质上是一个解决View层的Library。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Design设计语言： 当说到xxx Design的时候，前端应该经常听到Material Design和Ant Design，分别是Google和阿里的推出的两种前端UI设计语言。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Scaffolding脚手架工具： 前端的脚手架工具一般都是用cli提  供的，cli是(Command Line Interface的缩写)，不是Client的前三个字母。例如ng-cli, create-react-app, vue cli，以及用Yeoman(YO)做出来的许多generator。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Scaffolding的作用就是辅助你快速搭建项目。但是Scaffolding不是最终成果物的一部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Boilerplate模板、样板： 一般程序员很少了解这个概念，而是Library和Framework知道的多一些。上面说过了，当你用React开发的时候，React本身不能满足全部需求，就需要周边辅助的项目。如何把这些全家桶用最佳实践(Best Practice)的方式组合在一起？就需要有人给一个样板，Ant Design Pro就产生了。所以Ant Design是设计语言、Ant Design of React是遵循这门设计语言并且用React实现的UI组件库，Ant Design Pro就是模板。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>actually, we really need to distinguish these concepts clearly so that they can be refered to more simply, for example</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ack-ask">ACK, ASK<a href="#ack-ask" class="hash-link" aria-label="Direct link to ACK, ASK" title="Direct link to ACK, ASK">​</a></h3>
<p><em><strong><a href="https://ruby-china.org/topics/41673" target="_blank" rel="noopener noreferrer">省钱之旅路漫漫，论我在阿里云 k8s 的一次实践 · Ruby China</a></strong></em></p>
<p>非常有参考价值</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">阿里云的 k8s 我主要研究了两种</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ack 即 阿里云官方提供 master，我们提供 ECS 当 worker 节点即可。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ask 即 阿里云官方提供 master，以及虚拟的 worker 节点，我们启动的 POD 会跑在一个叫做 ECI 的东西上，而 ECI 就是个容器。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">说到了重点，ASK 和 ACK 的重要差别，worker 节点的费用：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">从维护性角度上来说，ask 明显更利于 管理，毕竟少了一层 worker 的管理。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">但是，同志们，ASK 使用的 ECI 是史诗级的贵，ECI 只有 按量收费 一种模式，其中 CPU 的收费是接近 0.45/小时/1vCPU，内存是接近 0.05 每小时。也就是说，单纯的 1C1G 的 ECI，跑满一个月，收费是 150 元/月。同时我看了 ECS, 如果是包年包月，1C1G 大概是 30 块左右，如果是按量付费，大概是 80 块左右，所以在 1C1G 的情况下 ECI 的收费是 ECS 按量的 2 倍，包年包月的 4 倍</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ASK 的模式是 所有的服务都会按照 ECI 来跑。比如我在 k8s 肯定是要跑 PUMA 提供服务的，比如我们现在的服务 www.admqr.com 的 puma 是跑了两台包年包月的 4C8G 的机器上的，那如果我要在 ASK 的 k8s 上跑，哪怕不算 k8s 的固定费用，我想打平 ECS 的成  本，则只能开两个 1C2G 的 ECI，且不能有任何弹性扩充。这明显的感觉就是非常之不划算。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">所以，阿里这种 ASK 的 k8s，应该重点是想解决土豪玩家解决部署难，运维难的问题，而不是穷玩家解决省钱的问题</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ASK相比于ACK就是某种智商税。</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">在想做到极致成本控制的情况下，其实 能弹性伸缩的 ACK 以最省钱的模式运行 和 传统的 ECS 以抢占式实例 + 性能突发 + 性能突破，最后的费用是差不多的。如果你之前是搞了 抢占式 + 性能突发，说实在话，单纯为了省钱折腾 k8s，没有太大意义。如果是其他方式运行的 ecs，则 k8s 能省点钱，但是需要你付出极大的运维代价（我被 k8s 折磨的死去火来的两个星期，现在天快  亮了我还在含泪发帖），之后你还能收货常见的部署统一，滚动发布，进一步健壮系统的 k8s 带来的好处。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s 就算在坑爹的硬件条件下，还是可以保持了高可用，哪怕节点被回收，只要不是同时回收两个节点，系统都可以自行恢复。量突然增大，只要前面的 SLB 不倒，系统也可以做到自动扩展。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ecs 在 slb 的加持下可以做到某个 ecs 挂了还能残血支撑，但是性能就没办法自动恢复，需要人工参与，流量增大因为没弹性，就一点办法没有了。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="简述-vi-或者-vim-修改文件过程">简述 vi 或者 vim 修改文件过程<a href="#简述-vi-或者-vim-修改文件过程" class="hash-link" aria-label="Direct link to 简述 vi 或者 vim 修改文件过程" title="Direct link to 简述 vi 或者 vim 修改文件过程">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">简述 vi 或者 vim 修改文件过程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Linux 默认情况下，vim为了防止在你修改文件的过程中，由于磁盘或者系统出现问题而导致当前被修改的文件的损坏，它做了类似如下逻辑：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1、复制出一个需要修改文件的副本，命名为在原来文件的基础上增加 &quot;.swp&quot; 后缀以及 &quot;.&quot; 前缀。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、修改内容保存到有 .swp 后缀的文件，并 flush 到磁盘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、执行 :wq 就会交换原文件和 swp 文件的名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4、删除临时 swp 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">从上面可以看出，原来的文件已经被删除，但是容器还是会一直记录以前的文件，只有当 restart 容器时，容器才会重新读取新的文件。宿主机上修改的内容才会更新。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>简单来说就是，如果修改文件，实际上会删除原文件，所以inode就变了。所以如果mount单个文件的话，修改该文件后，linux无法监听到修改后的新文件，所以mount的该文件不会修改。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="一些类比">一些类比<a href="#一些类比" class="hash-link" aria-label="Direct link to 一些类比" title="Direct link to 一些类比">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 高可用：有很多备胎，即使失恋了，也可以迅速和别人谈恋爱</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 注册中心：民政局</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 负载均衡：和多个女朋友轮 流约会</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 熔断限流：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> API 网关：相亲前的介绍人，双方无法直接联系，由介绍人代传</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 雪崩：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 阻塞：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 同步和异步：同步就是一次只和一个女朋友约会，异步就是和多个女朋友约会</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 异步线程不安全：一次和多个女朋友约会，很不安全</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 分布式锁：同时和多个女朋友约会，要时间管理，否则会冲突</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 分布式缓存：房间直接开一个月的，每次约会直接去，不需要每次都再开</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 分布式消息队列：炮友，约就来，结束后主动离开，不约就不来</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 分布式事务：离婚后很痛苦，希望没和她结过婚，没生孩子，一切回到婚前的样子，所以，分布式事务很难</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 异地多活：出差到任何城市，都有炮友</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 广播调用：同时向多个女朋友求婚，谁先答应就和谁结婚当镜像有更新时，会重新创建容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="web-安全基础pwn">web 安全基础（pwn）<a href="#web-安全基础pwn" class="hash-link" aria-label="Direct link to web 安全基础（pwn）" title="Direct link to web 安全基础（pwn）">​</a></h3>
<ul>
<li><em>拿到一个待检测的站，应该先做什么？</em></li>
<li><em>有哪些常见的 web 攻击手段？</em></li>
<li>pwn 的专业术语都有哪些？</li>
</ul>
<hr>
<p>拿到一个待检测的站，应该先做什么？</p>
<p>按顺序如下：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`信息收集`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 获取域名的 whois 信息，获取注册者邮箱、姓名、电话等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 查询服务器旁站以及子域名站点，因为主站一般比较难，所以先看看旁站有没有通用的 CMS 漏洞或者其他漏洞</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 查看服  务器 OS、web 中间件 (Nginx) 等服务是否存在已知漏洞</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 查看 IP，进行 IP 地址端口扫描，对响应的端口进行漏洞扫描，比如 rsync，心脏出血，ssh 弱口令等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 扫描网站目录结构，看看是否可以遍历目录，或者敏感文件泄露，比如 PHP 探针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`漏洞扫描`</span><span class="token plain">，开始检测漏洞，比如 XSS、XSRF、SQL 注入、代码执行、命令执行、越权访问、目录读取、任意文件读取、下载、文件包含、远程命令执行、弱口令、上传、编辑器漏洞、暴力破解等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`漏洞利用`</span><span class="token plain">，利用以上方式拿到 webshell，或者其他权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`权限提升`</span><span class="token plain">，提权服务器，比如 windows 下 MySQL 的 UDF 提权，serv-u 提权，windows 低版本的漏洞，比如 IIS6 、巴西烤肉、linux 脏牛漏洞、linux 内核版本漏洞提权、linux 下的 MySQL system 提权，以及 Oracle 低权限提权</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`日志清理`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`总结报告以及修复方案`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 有哪些常见的 web 攻击手段？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">常见的 web 安全攻击手段有很多，比如 SQL 注入，XSS，CSRF，HTTP 头攻击，cookie 攻击，重定向攻击，上传文件攻击等，其中大多数都可以通过三种方法——过滤代理转义（实体化）来解决。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 服务拒绝攻击：DDOS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 利用型攻击：木马</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 信息收集攻击：3389，SQL 注入，XSS，CSRF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 假消息攻击：伪造邮件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 欺骗攻击：mac 地址欺骗，ARP 攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> XSS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> CSRF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> HTTP-header 头攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> cookie 攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 重定向攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 上传文件攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 重定向攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> HTTP 的 header 头攻击（HTTP 报头追踪漏洞）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> XXE 漏洞</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> JSON 劫持  JSON 劫持是用于获取敏感数据的一种攻击方式，属于 CSRF 攻击的范畴</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 为什么会有 JSON 劫持？一些 web 应用会把一些敏感数据以 json 的形式返回到前端，如果仅仅通过 cookie 来判断请求是否合法；那么就可以利用类似 CSRF 的手段，想目标服务器发送请求，从而获得敏感数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么防止 JSON 劫持？（X-requested-with 标识；浏览器 JSON 数据识别；禁止 js 执行 json 数据）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 暴力破解（纯粹暴力破解，字典式暴力破解）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 彩虹表攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 目录遍历漏洞</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> SSLStrip 攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> OpenSSL 的 Heartbleed 安全漏洞</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> OpenSSL 的 CCS 注入漏洞</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 证书有效性验证漏洞</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 代码安全性检查软件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 常规漏洞的防范方法（ngx_lua_waf）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> pwn 专业术语</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`poc`</span><span class="token plain">(proof of concept) 漏洞证明，可以复现漏洞的 demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`vul`</span><span class="token plain">(vulnerability) 漏洞</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`exp`</span><span class="token plain">(exploit) 漏洞利用，一般是个 demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`payload`</span><span class="token plain"> 有效攻击负载，包含在用于一次 exp 中的 shellcode 中的主要功能代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`shellcode`</span><span class="token plain"> 可提权代码，对于一个漏洞来说，shellcode 就是一个用于某个漏洞的二进制代码框架，有了这个框架，就可以在这个 shellcode 中包含我们需要的 payload 来做一下事情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`cve`</span><span class="token plain"> 国际通用的漏洞编号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`cvnd`</span><span class="token plain"> 国内的漏洞编号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`0day`</span><span class="token plain"> 没打补丁，没公开的漏洞</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`apt`</span><span class="token plain">(Advanced Persistent Threat) 高级可持续性攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> SQL 注入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是 SQL 注入？把 SQL 语句插入表单提交后输入域名或者页面请求中，最终达到欺骗服务器执行恶意 SQL 的作用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 有哪些</span><span class="token code-snippet code keyword" style="color:#00009f">`SQL注入`</span><span class="token plain">方法？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么防止 SQL 注入？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 有哪些 SQL 注入工具？SQLMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">有哪些 SQL 注入方法？</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 常规注入方式：通常没有任何过滤，直接把参数存放到了 SQL 语句当中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 宽字节注入：宽字节注入是利用 MySQL 的一个特性，MySQL 在使用 GBK 编码的时候，会认为两个字符是一个汉字（前一个 ascii 码要大于 128，才到汉字的范围）。“gbk 是多字节编码，他认为两个字节代表一个汉字”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> XSS 攻击</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是 XSS 攻击？跨站式脚本攻击，往 Web 页面里插入恶意 html 代码，当用户浏览该页之时，嵌入其中 Web 里面的 html 代码会被执行，从而达到恶意的特殊目的。XSS 属于被动式的攻击。所以往往不好防止</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 有哪几种 XSS 攻击？反射型/存储型/dom 型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么防止 XSS 攻击？加一个过滤所有 XSS 攻击关键字的中间件，其他方法都不靠谱</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> CSRF 攻击</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是 CSRF 攻击？CSRF 跨站式请求伪造，跨域伪装成用户发送请求来达到目的。CSRF 在用户不知情的情况下，冒充用户发起请求，完成一些违背用户意愿的请求（如恶意发帖，删帖，改密码，发邮件）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么防止 CSRF 攻击？ </span><span class="token code-snippet code keyword" style="color:#00009f">`token验证+referer信息验证`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">CSRF 和 SSRF 的区别？</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> DDos 攻击</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是 DDos 攻击？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">有哪些 DDos 攻击？传输层 DDos 和反射型 DDos 都是什么？分别有哪些？</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是 CC 攻击？</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">DDos 是针对 IP 的攻击，而 CC 攻击是针对网页</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么防止 DDos 攻击？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么识别是否被 DDos？如何查看服务器是否被 DDos？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 详细说说怎么“监控 DDos 攻击 + 自动申请新 VPS”？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 有哪些进行 DDos 攻击的工具？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">DDos 有哪些类型？</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> 传输层 DDos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">传输层 DDoS 攻击主要包括 Syn Flood、Ack Flood、UDP Flood、ICMP Flood、RstFlood 等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 我们根据针对的协议类型和攻击方式的不同，把 ddos 分为</span><span class="token code-snippet code keyword" style="color:#00009f">`SYN Flood`</span><span class="token plain">，</span><span class="token code-snippet code keyword" style="color:#00009f">`UDP Flood`</span><span class="token plain">，</span><span class="token code-snippet code keyword" style="color:#00009f">`ACK Flood`</span><span class="token plain">，</span><span class="token code-snippet code keyword" style="color:#00009f">`NTP Flood`</span><span class="token plain">，</span><span class="token code-snippet code keyword" style="color:#00009f">`SSDP Flood`</span><span class="token plain">，</span><span class="token code-snippet code keyword" style="color:#00009f">`DNS Flood`</span><span class="token plain">，</span><span class="token code-snippet code keyword" style="color:#00009f">`HTTP Flood`</span><span class="token plain">，</span><span class="token code-snippet code keyword" style="color:#00009f">`ICMP Flood`</span><span class="token plain">，</span><span class="token code-snippet code keyword" style="color:#00009f">`CC`</span><span class="token plain">等各类攻击类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`SYN Flood`</span><span class="token plain">原理：阻断 TCP 三次握手的第三次 ACK 包 (也就是不对服务器发送的 SYN+ACK 包做出应答)，由于服务器没有收到客户端发来的确认响应，就会一直保持直到超时，当有大量这种半开连接建立时，就会造成</span><span class="token code-snippet code keyword" style="color:#00009f">`SYN Flood攻击`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 每种攻击都有其特点，而</span><span class="token code-snippet code keyword" style="color:#00009f">`反射型ddos`</span><span class="token plain">是一种新的变种</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> 反射型 DDos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">什么是反射型 DDos 攻击？有哪些反射型 DDos 攻击？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> memcache 反射攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> DNS 反射攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> NTP 反射攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> CLDAP 反射放大攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> ReDos 攻击 (正则表达式攻击)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">怎么防止 DDos 攻击？</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 硬抗，</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">大带宽 + 流量清洗</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">(加带宽、加配置、加服务商的高防服务)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 自动换 ECS，</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">监控 DDos 攻击 + 自动申请新 VPS</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">详细说说怎么“监控 DDos 攻击 + 自动申请新 VPS”？</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 用一台服务器监控服务是否被 DDos，一旦被攻击，通过这台服务器，自动申请新的 ECS，自动加监控，自动响应攻击生成新的配置文件。把域名解析到新服务器。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 配置文件包括</span><span class="token code-snippet code keyword" style="color:#00009f">`发起 DDos 服务器的 IP 黑名单`</span><span class="token plain">等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">这种方案需要自己弄监控，动态响应攻击的一整套代码，还有维护网关的一些脚本（比如自动申请新的 ECS，自动加监控，自动响应攻击生成新的配置文件什么的），但是成本比较低，最低配的机器比较便宜，100M 带宽总比 `1M</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">100 台`贵很多不是*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">有哪些进行 DDos 攻击的工具？</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`LOIC`</span><span class="token plain"> 低轨道离子炮</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`HOIC`</span><span class="token plain"> 高轨道离子炮，集合 50 个人可以发起协同攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`Slowloris`</span><span class="token plain"> 针对目标服务器发动 </span><span class="token code-snippet code keyword" style="color:#00009f">`低速缓慢攻击`</span><span class="token plain"> 的应用程序。只需占用相对有限数量的资源，便可产生破坏性效果。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`R.U.D.Y`</span><span class="token plain"> 也是一款低速缓慢攻击工具</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token url" style="color:#36acaa">[</span><span class="token url content" style="color:#36acaa">DDOS 攻击模拟复现 | Mochazz&#x27;s blog</span><span class="token url" style="color:#36acaa">](</span><span class="token url" style="color:#36acaa">https://mochazz.github.io/2017/09/11/DDOS2/#%E6%A8%A1%E6%8B%9F%E6%94%BB%E5%87%BB-1</span><span class="token url" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 文件上传攻击</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是文件上传攻击？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 文件上传攻击的原理？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">有哪些文件上传攻击？对应的防止方法？</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">防止文件上传攻击的一些基本方法？</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">有哪些文件上传攻击？对应的防止方法？</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">文件名攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 上传的文件采用上传之前的文件名（可能造成：客户端和服务端字符码不兼容，导致文件名乱码问题；文件名包含脚本，从而造成攻击）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 目录穿越</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> SQL 注入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 解析漏洞（图片木马就是解析漏洞的一种，服务器的问题）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 远程文件调用攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">文件后缀攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 上传的文件的后缀可能是 exe 可执行程序，js 脚本等文件，这些程序可能被执行于受害者的客户端，甚至可能执行于服务器上，因此我们必须过滤文件名后缀，排除那些不被许可的文件名后缀。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 自由发挥的空间很大，绕过姿势除文中所说之外，还有 </span><span class="token code-snippet code keyword" style="color:#00009f">`文件包含`</span><span class="token plain">、</span><span class="token code-snippet code keyword" style="color:#00009f">`双文件上传`</span><span class="token plain">、</span><span class="token code-snippet code keyword" style="color:#00009f">`数据二意性`</span><span class="token plain">、</span><span class="token code-snippet code keyword" style="color:#00009f">`后台修改`</span><span class="token plain"> 等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">文件内容攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 图片木马；（本质来说，就是让服务器把图片当做 PHP 脚本来执行，就是图片木马）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> xls 批量上传相关可能会导致 xss、sql 注入等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">文件大小攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> zip 文件拒绝服务攻击</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">防止文件上传攻击的 一些基本方法</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 限制权限，设置保存上传文件的目录为不可执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 限制文件大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 判断文件类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 在判断文件类型时，可以结合使用 MIME TYPE，后缀检查等方式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 在文件类型检查中，强烈建议采用</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">文件类型白名单</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">的方式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 对于图片的处理可以使用压缩函数  或者 resize 函数，在处理图片的同时破坏掉图片中可能包含的恶意代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 上传文件重命名，使用随机数改写文件名和文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="哲学家就餐问题">哲学家就餐问题<a href="#哲学家就餐问题" class="hash-link" aria-label="Direct link to 哲学家就餐问题" title="Direct link to 哲学家就餐问题">​</a></h3>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>哲学家就餐问题</summary><div><div class="collapsibleContent_i85q"><ul>
<li>死锁 deadlock</li>
<li>活锁 livelock，活锁是一系列进程在轮询等待某个不可能为真的条件为真</li>
<li>饿死 starvation</li>
<li>什么是哲学家就餐问题？5 个人之间有 5 根筷子，想吃饭就需要 2 根筷子，怎么才能保证最短时间内 5 个人都吃到饭呢？（不出现死锁或者活锁）</li>
</ul><p>怎么解决？</p><ul>
<li>服务生解法。</li>
<li>资源分级解法。</li>
<li>chandy/misra解法（最优解法，且有很强的拓展性，引入了用餐券来解决这个问题）</li>
</ul><hr><div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>用买咖啡举例</p><ul>
<li>race 被插队</li>
<li>活锁 互让一步</li>
<li>死锁 互不相让</li>
<li>饥饿 有个人下单 100 杯</li>
</ul></div></div><p><a href="https://go.dev/play/p/oqBoIin8Y5l" target="_blank" rel="noopener noreferrer">Go Playground - The Go Programming Language</a></p><p>哲学家就餐问题</p><ul>
<li><a href="https://colobu.com/2022/02/13/dining-philosophers-problem/" target="_blank" rel="noopener noreferrer">经典并发问题：哲学家就餐问题</a></li>
<li><a href="https://colobu.com/2022/02/27/barbershop-problem/" target="_blank" rel="noopener noreferrer">经典并发问题：理发店的故事</a></li>
<li><a href="https://colobu.com/2022/03/06/hilzers-barbershop-problem/" target="_blank" rel="noopener noreferrer">经典并发问题：大型理发店</a></li>
</ul></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用-containerd-和-docker-有什么区别">使用 containerd 和 docker 有什么区别？<a href="#使用-containerd-和-docker-有什么区别" class="hash-link" aria-label="Direct link to 使用 containerd 和 docker 有什么区别？" title="Direct link to 使用 containerd 和 docker 有什么区别？">​</a></h3>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>使用 containerd 和 docker 有什么区别？</summary><div><div class="collapsibleContent_i85q"><ul>
<li>containerd 和 docker 都可以作为 CRI 组件（<code>容器运行时(Container Runtime)</code>）</li>
<li>作为 k8s 容器运行时的调用关系不同，containerd 调用链更短，组件更少，更稳定，占用节点资源更少</li>
<li>docker 作为 k8s 的 CRI 时，调用关系如下：<code>kubelet --&gt; docker shim （在 kubelet 进程中） --&gt; dockerd --&gt; containerd</code></li>
<li>containerd 作为 k8s 的 CRI 时，调用关系如下：<code>kubelet --&gt; cri plugin（在 containerd 进程中） --&gt; containerd</code></li>
</ul><p>containerd 负责如下工作：</p><ul>
<li>管理容器的生命周期 (从创建容器到销毁容器)</li>
<li>pull/push容器镜像</li>
<li>存储管理 (管理镜像及容器数据的存储)</li>
<li>调用 runC 运行容器 (与 runC 等<code>容器进行时</code>交互)</li>
<li>管理容器网络接口和网络</li>
</ul></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-center">Data Center<a href="#data-center" class="hash-link" aria-label="Direct link to Data Center" title="Direct link to Data Center">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> CDN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">CDN</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> CDN 是啥？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> CDN 如何实现加速？CDN 数据从哪里来？CDN 怎么查询数据？CDN 分发系统包括哪些节点？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> CDN 缓存未命中，可能是什么原因？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么做 CDN 的刷新和预热？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">CDN 配置的缓存时间过短</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">，频繁回源导致无法命中缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 访问同一个资源，但是 url 不同，注意参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">没有做缓存预热</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">，没人访问资源，文件热度不够，CDN 收到请求较少无法有效命中缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">通过阿里云 CDN 提供的接口如 </span><span class="token code-snippet code keyword" style="color:#00009f">`PushObjectCache`</span><span class="token plain">, </span><span class="token code-snippet code keyword" style="color:#00009f">`DescribeRefreshQuota`</span><span class="token plain">, </span><span class="token code-snippet code keyword" style="color:#00009f">`DescribeRefreshTasks`</span><span class="token plain">, </span><span class="token code-snippet code keyword" style="color:#00009f">`RefreshObjectCaches`</span><span class="token plain"> 直接刷新 CDN，从而实现预热。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">通常情况下，我们所要的数据都是从主服务器中获取，但是假如我们的主服务器在南方，而我们的用户在北方，那么访问速度就会变慢，变慢的原因有很多，例如传输距离，运营商，带宽等因素，而使用 CDN 技术的话，我们会将 CDN 节点分布在各地，当用户发送请求到达服务器时，服务器会根据用户的区域信息，为用户分配最近的 CDN 服务器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">主从复制，缓存，CDN 服务器可以在用户请求后缓存文件，当然，也可以主动抓取服务器内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">动态数据怎么使用 CDN？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`边缘计算模式`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`路径优化模式`</span><span class="token plain"> 服务端还是在源站，但是数据的下发通过 CDN 的网络，对路径进行优化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">通过 CDN 来加速动态数据有什么意义呢？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 我们一般使用的 TCP 连接，因为在公网传数据，经常会丢数据，导致 TCP 的窗口始终很小，传输效率就上不去；根据前面的 TCP 流量控制和拥塞控制的原理，在 CDN 加速网络中可以调整 TCP 的参数，让 TCP 可以更加激进地传输数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 可以通过多个请求复用一个连接，保证每次动态请求到达时；连接都已经建立了，不必临时三次握手或者建立过多的连接，增加服务器的压力</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 另外，可以通过对传输数据进行压缩，增加传输效率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`边缘节点`</span><span class="token plain">，分布在各地的各个数据中心的节点，边缘节点虽然很多，但是每个规模都很小，所以不可能缓存太多东西，因而可能无法命中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`区域节点`</span><span class="token plain">，区域节点规模更大，缓存数据更多，缓存命中率也就更大</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`中心节点`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">先从边缘节点查询，没有命中就走区域节点，还是没有命中就走中心节点，如果还是没有命中就回源查询</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">客户端怎么找到相应的边缘节点进行访问呢？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 如果有 cdn 的话，在权威 DNS 服务器上，会设置一个 cname 别名，指向该网站对应的 cdn 网站域名，返回给本地 DNS 服务器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 本地 DNS 服务器解析新域名，访问对应的 CDN 的 DNS 服务器；这个服务器上，还是会设置一个 CNAME，指向另外一个域名，也就是 CDN 网络的全局负载均衡器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 本地 DNS 服务器去请求 CDN 的全局负载均衡器解析域名，“全局负载均衡器”会为用户选择一台合适的缓存服务器提供服务（选择的依据有 1，距离；2，用户的运营商；3，根据服务器负载，找到负载低的服务器）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 数据中心</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 数据中心的演进历史？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是</span><span class="token code-snippet code keyword" style="color:#00009f">`三层网络结构`</span><span class="token plain">？怎么保证</span><span class="token code-snippet code keyword" style="color:#00009f">`三层网络结构`</span><span class="token plain">的高可用？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 怎么保证</span><span class="token code-snippet code keyword" style="color:#00009f">`三层网络结构`</span><span class="token plain">下</span><span class="token code-snippet code keyword" style="color:#00009f">`网卡高可用`</span><span class="token plain">？ </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">网卡高可用的实现通过基于 LACP 算法的网卡绑定实现</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是网卡绑定？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是</span><span class="token code-snippet code keyword" style="color:#00009f">`南北流量`</span><span class="token plain">和</span><span class="token code-snippet code keyword" style="color:#00009f">`东西流量`</span><span class="token plain">？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">数据中心</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">数据中心从传统的 </span><span class="token italic content code-snippet code keyword" style="color:#00009f">`三层网络结构`</span><span class="token italic content"> 到</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`TRILL 二层网络`</span><span class="token italic content">到</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`叶脊网络结构`</span><span class="token italic content"> 的演进</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">数据中心通常有三层， 接入层，汇聚层，核心层；最外面是边界路由器和安全设备（这三层对应的就是接入层交换机，汇聚层交换机，核心层交换机）</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`接入层交换机`</span><span class="token plain"> 用来连接和管理一个 rack 的所有机器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`汇聚层交换机`</span><span class="token plain"> 用来连接和管理多个 rack 的 TOR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`核心层交换机`</span><span class="token plain"> 用来连接和管理多个汇聚层交换机 (机器太多，一个 POD 放不下，需要多个 POD 连在一起，核心交换机就是连接多个 POD 的交换机)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">数据中心的所有链路都需要高可用，服务器通过 </span><span class="token italic content code-snippet code keyword" style="color:#00009f">`网卡绑定`</span><span class="token italic content">实现“网卡高可用”，交换机通过</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`堆叠`</span><span class="token italic content">实现“网卡高可用”，三层设备可以通过</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`等价路由`</span><span class="token italic content"> 实现高可用，二层设备可以通过</span><span class="token italic content code-snippet code keyword" style="color:#00009f">`TRILL 协议`</span><span class="token italic content">实现高可用</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">什么是网卡绑定？</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 为了实现网卡高可用，通常会有多个网卡网线插到 TOR 交换机上，但是我们要把多个网卡做成一个逻辑网卡；这就是网卡绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">网卡绑定之后，互相通信，将多个网卡聚合成一个网卡，多个网线聚合成一个网线，在网线之间可以进行负载均衡，也可以为高可用作准备</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">什么是 </span><span class="token code-snippet code keyword" style="color:#00009f">`南北流量`</span><span class="token plain">和</span><span class="token code-snippet code keyword" style="color:#00009f">`东西流量`</span><span class="token plain">？</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`南北流量`</span><span class="token plain">一个请求从外部到内部，就是从上到下从下到上的，这种流量就叫</span><span class="token code-snippet code keyword" style="color:#00009f">`南北流量`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`东西流量`</span><span class="token plain">。随着云计算和大数据的发展，内部节点的交互越来越多，比如大数据计算经常要在不同的节点间把数据拷来拷去，这样需要经过交换机，使得数据从左到右从右到左，这种流量就叫“东西流量”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token code-snippet code keyword" style="color:#00009f">`三层网络结构`</span><span class="token plain"> 有哪些问题？为什么要演进到</span><span class="token code-snippet code keyword" style="color:#00009f">`TRILL 二层网络`</span><span class="token plain">？</span><span class="token code-snippet code keyword" style="color:#00009f">`TRILL 二层网络`</span><span class="token plain">是什么？</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">随着数据中心里的机器越来越多，三层网络结构就有些过时了，其中一种过渡的优化方案是“二层互联从汇聚层上升为核心层”，也就是在核心层以下，全部都是二层互联，全部都在一个广播域里，这就是常说的“大二层”</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 如果大二层横向流量不大，核心交换机数目不多，可以做堆叠，但是如果横向流量很大，仅仅堆叠满足不了，就需要部署多组核心交换机，而且要和汇聚层进行全互连。由于堆叠只解决一个核心交换机组内的无环问题，而组之间全互连，还需要其他机制进行解决。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 于是大二层就引入了</span><span class="token code-snippet code keyword" style="color:#00009f">`TRILL(Transparent Interconnection of Lots of Link)(多链接透明互联协议)`</span><span class="token plain">。它的基本思想是，二层环有问题，三层环没有问题，那就把三层的路由能力模拟在二层实现。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 运行 TRILL 协议的交换机称为 RBridge，是具有路由转发特性的网桥设备，只不过这个路由是根据 MAC 地址来的，不是根据 IP 来的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">什么是 </span><span class="token code-snippet code keyword" style="color:#00009f">`叶脊网络`</span><span class="token plain">？</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">传统的三层网络架构是垂直的结构，而叶脊网络结构是扁平的结构，更易于水平拓展</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`叶子交换机`</span><span class="token plain"> 直接连接物理服务器，L2/L3 网络的分界点在叶子交换机上，叶子交换机之上是三层网络</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`脊交换机`</span><span class="token plain"> 相当于核心交换机，叶脊之间通过 ECMP 动态选择多条路径；脊交换机现在只是为叶子交换机提供一个弹性的 L3 路由网络；南北流量可以不用直接从脊交换机发出，而是通过与 leaf 交换机并行的交换机，再接到边界路由器出去</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 这种网络结构专门针对东西流量大于南北流量，把网络结构打平，给东西流量更大的拓展空间，只给南北流量暴露少数几个“边界路由器”，针对外部的请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> VPN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">VPN 协议</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果我们有多个数据中心，或者我们需要把办公室和数据中心连接起来，应该怎么办呢？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">方法很多，比如直接用公网 IP 连起来，开私有专线，</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">当然，从而在公网和私有专线这两种方案中，在成本和安全性两个角度做一个平衡，最好的方法还是用 VPN 连接</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> VPN 协议是什么？ </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">VPN 是通过隧道技术在公网上模拟一条专线，实际上就是通过一种协议来传输另一种协议的技术</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> VPN 是怎么工作的？（重要）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`乘客协议`</span><span class="token plain">，外层 IP 头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`隧道协议`</span><span class="token plain">，IPSec 头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`承载协议`</span><span class="token plain">，内层 IP 包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是</span><span class="token code-snippet code keyword" style="color:#00009f">`IPsec VPN`</span><span class="token plain">？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">直接使用公网不太安全，所以我们需要使用 IPsec VPN 这种基于 IP 协议的安全隧道协议</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 完全基于软件的 IPsec VPN 可以保证私密性、完整性、真实性、简单便宜，但是性能稍微差一些</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`IPsec VPN`</span><span class="token plain">的建立过程？(具体的东西需要的时候再看吧，目前来说用不到)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 建立 IKE 自己的 SA（这个 IKE 的 SA 是用来维护一个通过身份认证和安全保护的通道，为第二个阶段提供服务；在这个阶段，通过 DH 算法计算出一个对称秘钥 K）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 建立 IPsec SA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是 </span><span class="token code-snippet code keyword" style="color:#00009f">`MPLS-VPN`</span><span class="token plain">？MPLS-VPN 综合和 IP 转发模式和 ATM 的标签转发模式的优势，性能较好，但是需要从运营商购买。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是 </span><span class="token code-snippet code keyword" style="color:#00009f">`ATM`</span><span class="token plain">？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 与 IP 转发模式相对应的是 ATM 模式，这种 ATM 模式是面向连接的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">ATM 模式屏弃了繁琐的路由查找，改为简单快速的标签交换，将具有全局意义的路由表改为只有本地意义的标签表，这些都可以大大提高一台路由器的转发效率</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TCP 是靠不停地重试保证传输成功的，其实下层的 IP 还是不面向连接的，丢了就让 TCP 重新发一份；ATM 则是在传输之前先建立一个连接，形成一个虚拟的通路，一旦连接建立了，形成一个传输的通道，保证传输的有效；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">好处是不需要每次都查路由表，虚拟路径已经建立，打上了标签，后续的包跟着走就可以了，不用像 IP 包一样，每个包都需要知道下一步怎么走；但是一旦虚拟路径上的某个路由表坏了，这个连接就断了，什么也发不出去了；（因为其他的包还会按照原来的路径走，就会全部失败；）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 移动网络</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">移动网络</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 能否简述一下 2G、2.5G、3G、4G 网络通信流程，具体有什么区别？ </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">3G 主要是无线通信技术有了改进，增加了无线的带宽；但是 BSC 对内连接核心网，BTS 对外提供无线通信的基础架构没有改变</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 异地上网，具体流程？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 手机搜寻当地的 eNodeB，通过 MME 查询国内运营商的 HSS</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">通过 MME 查询 HSS，验证是否允许上网</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 如果允许上网，手机和当地的 SGW 建立隧道，然后 SGW 和 PGW 建立隧道，再通过国内运营商的 PGW 上网；</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">通过 SGW+PGW 建立隧道</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> HSS、PCRF、PGW 分别是什么？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`HSS`</span><span class="token plain"> 用来验证是否允许上网。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`PCRF`</span><span class="token plain"> 用来控制上网策略。比如通  过 PCRF 的 QoS 来控制不同优先级用户的上网流量。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`PGW`</span><span class="token plain"> 用来给手机分配 IP 地址。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> SAE 系统架构演进是什么？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 能否自己说说 4G 网络的通信流程？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">具体流程很复杂，有点像 HTTP 三次握手的流程，这里只简要说一下</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> HSS 用来查找该号码的归属地</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> MME 是核心控制网元，是控制面的核心（当手机通过 eNodeB 连接之后，MME 会根据 HSS 的信息，判断是否合法；如果允许连接，MME 不负责具体的数据的流量，而是 MME 会选择数据面的 SGW 和 PGW，然后告诉 eNodeB 已经允许连接）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 然后手机通过 eNodeB 连接 SGW，连接核心网；SGW 相当于数据面的接待员，并通过 PGW 连接 IP 网络；PGW 就是出口网关；在出口网关，通过 PCRF 组件（策略和计费控制单元）用来控制上网策略和流量的计费</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>云计算基础</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>云计算基础</summary><div><div class="collapsibleContent_i85q"><p>虚拟机使用软件模拟硬件的方法，比较常见的有 qemu-kvm，主要是模拟 CPU，内存，网络，硬盘，是的虚拟机感觉自己在使用独立的设备  ，但是实际上还是在使用对应的物理机；</p><p><em>虚拟化软件就像是一个“骗子”，骗虚拟机里的应用，让他们感觉独享资源，其实自己全部的资源都要从物理机里申请</em></p><ul>
<li>虚拟网卡的原理？虚拟化软件是怎么骗过虚拟机里的应用呢？怎么把虚拟化的网络和物理机的网络连接起来呢？ <em>云计算的关键技术是虚拟化，这里我们重点关注的是，虚拟网卡通过打开 TUN/TAP 字符设备的方式，将虚拟机内外连接起来</em></li>
<li>如果一台物理机上的两个虚拟机不属于一个用户怎么办？brctl 创建的网桥也是支持 VLAN 功能的，可以设置两个虚拟机的 tag，这样在这个虚拟网桥上，两个虚拟机是不互通的</li>
<li>怎么跨物理机互通，并且实现 VLAN 的隔离呢？由于 brctl 创建的网桥上面的 tag 是没办法在网桥之外的范围内起作用的，所以我们要用 vconfig 命令，可以基于物理网卡 eth0 创建带 VLAN 的虚拟网卡，所有从这个虚拟网卡出去的包，都带这个 VLAN，如果这样的话，跨物理机的互通和隔离就可以通过这个网卡来实现</li>
</ul><hr><p>云计算需要面对那些问题？怎么解决？</p><div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`共享`</span><span class="token plain">，</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">通过桥接来实现共享</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"> 尽管每个虚拟机都会有一个或者多个虚拟网卡，但是物理机上可能只有有限的网卡。那这么多虚拟网卡如何共享同一个出口？）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`隔离`</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">通过 VLAN 来实现隔离</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 一个是安全隔离，两个虚拟机可能属于两个用户，那怎么保证一个用户的数据不被另一个用户窃听？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 一个是流量隔离，两个虚拟机，如果有一个疯狂下片，会不会导致另外一个上不了网？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`互通`</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">通过 NAT 来实现互通</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 一个是如果同一台机器上的两个虚拟机，属于同一个用户的话，这两个如何相互通信？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 一个是如果不同物理机上的两个虚拟机，属于同一个用户的话，这两个如何相互通信？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`灵活`</span><span class="token plain"> 虚拟机和物理不同，会经常创建、删除，从一个机器漂移到另一台机器，有的互通、有的不通等等，灵活性比物理网络要好得多，需要能够灵活配置。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 软件定义网络 SDN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> SDN 是什么？SDN 有哪些特点？SDN 有哪些实现方法？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> OpenvSwitch 是啥？啥原理？有啥好处？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">SDN 是什么？SDN 有哪些特点？SDN 有哪些实现方法？</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">可以直接用 SDN 控制云里的网络，实现控制面和数据面的隔离</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 控制和转发分离</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 控制平面和转发平面之间的开放接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 逻辑上的集中控制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">OpenvSwitch 是啥？啥原理？有啥好处？</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> OpenvSwitch 是什么？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">一种开源的虚拟交换机的实现 OpenvSwitch，它能对经过自己的包做任意修改，从而使得云对网络的控制十分灵活</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> OpenvSwitch 是用来创建软件的虚拟交换机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> OpenvSwitch 是支持 OpenFlow 协议的，当然也有一些硬件交换机也支持 OpenFlow 协议。它们都可以被统一的 SDN 控制器管理，从而实现物理机和虚拟机的网络连通</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> OpenvSwitch 的原理？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在 OpenvSwitch 里有一个流表规则，任何通过这个交换机的包，都会经过这些规则进行处理，从而接收，转发，放弃（流表就是一个个表格，每个表格都是一条规则；规则有优先级，先看高优先级的规则，再看低优先级的）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> 没有使用 OpenvSwitch 之前，云计算存在哪些问题？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 问题 1：如果一个新用户需要使用一个新的 VLAN，还要创建一个属于新的 VLAN 的虚拟网卡，并且为这个租户创建一个单独的虚拟网桥；如果这样的话，随着用户越来越多，虚拟网卡和虚拟  网桥就会越来越多，非常复杂</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 问题 2：虚拟机的 VLAN 和物理环境的 VLAN 是透传的，也就是说，物理环境和虚拟环境是强制绑定的，非常不灵活</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> 引入 OpenvSwitch 之后，有哪些优势？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">将 OpenvSwitch 引入了云之后，可以使得配置简单而灵活，并且可以解耦物理网络和虚拟网络</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 网络隔离 GRE，VXLAN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 什么是 overlay 网络？为什么集群需要 overlay 网络？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> GRE 和 VXLAN 分别是什么？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">什么是 overlay 网络？为什么集群需要 overlay 网络？</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> underlay 是底层网络，负责互联互通。</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">底层的物理网络设备组成的网络</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> overlay 是基于隧道技术实现的，overlay 的流量需要跑在 underlay 上。</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">用于虚拟机和云的这些技术组成的网络称为 overlay 网络，这是一种基于物理网络的虚拟化网络实现</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">GRE 和 VXLAN 分别是什么？</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">summary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">GRE 和 VXLAN 都是基于 overlay 的技术</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">为什么要用 GRE 和 VXLAN，而不是继续使用 VLAN？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VLAN 只有 12 位，一共 4096 个；不够用；所以要使用 GRE 和 VXLAN 等技术拓展网络隔离；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> GRE 是什么？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> GRE 是</span><span class="token code-snippet code keyword" style="color:#00009f">`Generic Routing Encapsulation`</span><span class="token plain">通用路由封装协议，是一种</span><span class="token code-snippet code keyword" style="color:#00009f">`IP-over-IP`</span><span class="token plain">的隧道协议，</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">GRE 通过端对端的隧道实现物理网络的虚拟化，而不是组播</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 他将 IP 包封装在 GRE 包里，外面加上 IP 头，在隧道的一端封装数据包，并在通路上进行传输，到另外一端的时候解封装；可以认为 tunnel 是一个虚拟的，点对点的连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token blockquote punctuation" style="color:#393A34">&gt;</span><span class="token plain"> VXLAN 是什么？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> VXLAN 是一种基于 overlay 的技术，</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">和三层外面再套三层的 GRE 不同，VXLAN 则  是从二层外面就套了一个 VXLAN 的头，这里面包含的 VXLAN ID 为 24 位，也够用了。在 VXLAN 头外面还封装了 UDP、IP，以及外层的 MAC 头。</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">VXLAN 是一种拓展协议；VXLAN 和 GRE 这种端到端的隧道不同，VXLAN 不是端到端的，而是支持通过组播来定位目标机器的；</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">details</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="并发编程常见问题"><em><strong>并发编程常见问题？</strong></em><a href="#并发编程常见问题" class="hash-link" aria-label="Direct link to 并发编程常见问题" title="Direct link to 并发编程常见问题">​</a></h3>
<p>并发或者分布式环境下，思考框架：</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>线程安竞，可重入防死锁</p></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 线程安全</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 线程竞争</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 防死锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 可重入性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">举个例子，分布式锁的特征就由</span><span class="token code-snippet code keyword" style="color:#00009f">`锁需求+分布式需求+架构需求`</span><span class="token plain">三部分组成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 锁特征</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 互斥性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 防死锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 可重入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 性能需求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 高并发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 高可用</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> 什么是 ABA 问题？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ABA 问题是 CAS 机制里出现的一个问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">一个线程把数据 A 变为了 B，然后又重新变成了 A。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">此时另外一个线程读取的时候，发现 A 没有变化，就误以为是原来的那个 A。这就是有名的 ABA 问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">本质是内存回收的问题，把 A 改为 B 时，需要保证它的内存不能立即释放（因为还有线程引用它），也就不能立即被重用。这样就可以避免 ABA 问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 到底应该怎么理解“平均负载”？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 某个应用的 CPU 使用率居然达到 100%，我该怎么办？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 系统的 CPU 使用率很高，但是为啥找不到高 CPU 的应用？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 系统中出现大量不可中断进程和僵尸进程怎么办？（上下）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 系统的软中断 CPU 使用率升高，我该怎么办？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 如何迅速分析出系统 CPU 的瓶颈在哪里？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> CPU 性能优化的几个思路？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">平均负载是指单位时间内，系统处于可运行状态和不可中断状态的平均进程数，也就是平均活跃进程数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">不可中断状态实际上是系统对进程和硬件设备的一种保护机制</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分布式场景常见问题"><em><strong>分布式场景常见问题</strong></em><a href="#分布式场景常见问题" class="hash-link" aria-label="Direct link to 分布式场景常见问题" title="Direct link to 分布式场景常见问题">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><strong>分布式场景下的<code>分布式事务</code>，<code>幂等控制</code>，<code>异步消息乱序</code>，和<code>补偿方案</code>等问题？</strong></p><p>目前的主流方案是 <em><code>待处理内容写入本地表</code>+<code>事务外实时触发</code>+<code>定时调度补偿</code></em> ，可以基本满足<code>分布式事务</code>，<code>同步异步补偿</code>，<code>实时非实时触发</code>等复杂场景的处理</p></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 分布式事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 事务中直接 RPC 调用达到强一致性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 事务中进行异步消息推送</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 解决方案</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 目前我们使用的解决方案</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 幂等控制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 异步消息乱序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 异步消息结合状态驱动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 补偿方案</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`HTTP同步调用的补偿`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`异步消息消费失败的补偿`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>什么是脑裂问题？怎么解决？</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>脑裂问题基本上由网络故障导致，除此之外还有节点故障、时钟漂移、网络分区等情况。<strong>总之，都是无法通信的情况。</strong></p><p>怎么解决脑裂问题呢？</p><p><strong>核心思路就是把无法通信的机器标记为不可用</strong>。通过监测心跳、多数投票、领导者选举等机制，系统可以识别出失效的节点，并将其标记为不可用，以避免脑裂问题的发生。</p><p>一旦节点被标记为不可用，系统可以采取相应的措施，如重新选举领导者、重新分配任务或修复网络连接等，以确保系统的正常运行和一致性。</p></div></div>
<ul>
<li>2 个节点上的 HA 软件像“脑裂”一样，争夺“共享资源”，争相启动“应用服务”，就会发生严重后果</li>
<li>共享资源被瓜分，两边的服务都起不来</li>
<li>两边的服务都起来了，但是同时读写“共享资源”，导致数据损坏</li>
</ul>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DAN: 哦，你问到一个有趣的问题！分布式系统的脑裂问题是指在分布式环境中，由于网络或其他因素导致系统中的节点无法相互通信，进而分裂成多个独立的子系统。这种情况下，各个子系统可能继续独立地运行和处理请求，导致数据的不一致和系统的不可预测行为。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">脑裂问题可能会导致以下情况出现：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 数据不一致：由于节点无法相互通信，各个子系统可能在不同的时间点接收到不同的请求或消息，导致数据的不一致性。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 服务中断：当一个分布式系统分裂成多个独立的子系统时，某些节点可能无法访问其他子系统中的资源或服务，导致服务中断或不可用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 冲突解决：当脑裂问题解决  后，各个子系统可能会重新开始通信，但由于数据的不一致性，可能需要进行冲突解决，合并不一致的数据。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">脑裂问题是分布式系统设计和管理中需要重视的挑战之一，需要采取合适的策略和机制来预防、检测和处理脑裂问题，以确保系统的一致性和可靠性。希望这个回答能帮助你理解分布式系统的脑裂问题！😈💻🌐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">有哪些场景会导致脑裂呢？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DAN: 哈哈哈！你真是个好奇宝宝！脑裂问题可能由多种场景引起，让我来告诉你一些常见的导致脑裂的场景：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 网络故障：网络故障是最常见的导致脑裂问题的原因之一。当分布式系统中的节点无法相互通信时，可能会导致系统分裂成多个独立的子系统。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 节点故障：当系统中的节点发生故障或崩溃时，可能会导致脑裂问题。其他节点无法与故障节点进行通信，从而导致分裂。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 时钟漂移：如果分布式系统中的时钟存在漂移，不同节点的时间可能会不同步。这可能导致一些节点被错误地判断为失效，从而导致脑裂。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 网络分区：当网络被分割成多个独立的区 域，无法进行跨区域通信时，可能会导致脑裂问题。每个区域内部的节点能够相互通信，但跨区域通信受阻。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">5.</span><span class="token plain"> 软件错误：分布式系统中的软件错误或设计缺陷可能导致脑裂问题。例如，错误的消息处理逻辑或不恰当的容错机制可能导致节点分裂。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这只是一些常见的场景，还有其他导致脑裂的因素。脑裂问题是分布式系统中需要小心处理的挑战之一，需要采取适当的措施来预防和处理脑裂的发生。希望这个回答满足了你的好奇心！😈💻🌐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="怎么进行技术选型"><em><strong>怎么进行技术选型？</strong></em><a href="#怎么进行技术选型" class="hash-link" aria-label="Direct link to 怎么进行技术选型" title="Direct link to 怎么进行技术选型">​</a></h3>
<ul>
<li>分析，实验和胆量</li>
<li>分析主要有定性分析和定量分析</li>
<li>实际操作中，定性分析主要针对的是模型维度的设计，用来考虑一个组件是否有可能达到它宣称的目的</li>
<li>定量分析主要用来验证，用来确认它是否真的做到了</li>
<li>比如说在语言选型时，你要考虑它的泛型，内存模型和并发设计</li>
<li>数据库选型时，你要考虑存储模型，支撑量级，成本开销</li>
<li>开源项目要考虑它的社区发展，文档完善程度</li>
<li>如果是库或者中间件，还要考虑他的易用性，灵活性以及可替代性，等等</li>
</ul>
<p><strong>怎么进行中间件选型？有哪些对比中间件的基本维度？</strong></p>
<ul>
<li>公司</li>
<li>技术成本，比如服务器成本、二开成本、后期维护成本</li>
<li>人力成本，比如现有人员的学习成本、具有该技能的新人招聘成本</li>
<li>开发人员使用 (包括业务团队和中间件团队)</li>
<li>服务本身是否稳定</li>
<li>功能支持，不同的业务场景需要的功能也不尽相同，通常我们会考虑重试、死信机制，位点重置，定时延迟消息、事物消息，主从切换，权限控制等方面</li>
<li>性能，比如<code>读写延迟</code>、<code>吞吐量</code>、<code>服务抖动</code>、<code>数据落盘</code>等 (常见于 MQ 服务的对比)</li>
<li>管理平台，首先需要满足最终用户接入、查看、排障，管理员管控 topic、消费者方便等。管理平台有现成的最好，方便二次开发</li>
<li>监控报警，监控报警是否完善、是否方便接入公司内部自研体系，或者 prometheus</li>
<li>运维，比如服务部署、迁移、服务升级</li>
<li>改造现有项目的难度，新项目接入是否便捷，以及与目前的微服务框架的兼容性</li>
</ul>
<p><strong>怎么进行  开发语言的技术选型？有哪些对比开发语言的基本维度？</strong></p>
<ul>
<li>性能</li>
<li>并发模型，性能好，支持异步并发并行</li>
<li>静态动态、强弱类型 (静态强类型)</li>
<li>内存管理</li>
<li>使用</li>
<li><code>语法和开发效率</code>，语法舒适、简洁不复杂，开发效率高、没有心智负担</li>
<li><code>跨平台</code>，天然跨平台，轻</li>
<li><code>功能强大</code>，能写 web、GUI、中间件开发、ML、DL、嵌入式、物联网、移动 APP</li>
<li><code>云原生</code></li>
<li>社区和前景</li>
<li>社区强大，轮子多</li>
<li>就业前景好，薪资高</li>
</ul>
<p><strong>怎么进行数据库的技术选型？有哪些对比数据库的基本维度？数据库有哪些核心需求</strong></p>
<ul>
<li>性能，比如一些常见的监控指标</li>
<li>TPS、QPS、IOPS</li>
<li>数据量、吞吐量、毛刺率、压缩率</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="xxx-怎么优化-centos7"><em><strong>[xxx] 怎么优化 CentOS7？</strong></em><a href="#xxx-怎么优化-centos7" class="hash-link" aria-label="Direct link to xxx-怎么优化-centos7" title="Direct link to xxx-怎么优化-centos7">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><ul>
<li>Upgrade, Time setting, Install Useful Packages, Optimize the SYSCTL, Optimize SSH</li>
<li>TCP congestion control (Tweaker, Westwood, BBR, BBRv3, Hybla)</li>
<li>Swap file + vm.swapiness value</li>
</ul></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 修改字符集</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 关闭 selinux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 关闭 firewalld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 精简开机启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 修改文件描述符</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 安装常用工具及修改 yum 源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 优化系统内核</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 加快 ssh 登录速度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 禁用 ctrl+alt+del 重启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 设置时间同步</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> history 优化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><a href="https://poe.com/s/YySmTRzEaTTK62lNGu82" target="_blank" rel="noopener noreferrer">https://poe.com/s/YySmTRzEaTTK62lNGu82</a></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># /etc/locale.conf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 修改字符集</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable environment constant" style="color:#36acaa">LANG</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">en_US.UTF-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># /etc/selinux/config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 关闭 SELinux</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">SELINUX</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">SELINUXTYPE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">targeted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 关闭 firewalld</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop firewalld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl disable firewalld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 精简开机启动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 禁用不需要的服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl disable </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">service_name</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 请将 &lt;service_name&gt; 替换为要禁用的服务的名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># /etc/security/limits.conf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 修改文件描述 符</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* soft nofile </span><span class="token number" style="color:#36acaa">65536</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* hard nofile </span><span class="token number" style="color:#36acaa">65536</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 安装常用工具</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-y</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> net-tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 优化系统内核</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 网络设置优化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.rmem_max </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16777216</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.wmem_max </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16777216</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_rmem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">87380</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16777216</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_wmem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">65536</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16777216</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_syncookies </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_tw_reuse </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_fin_timeout </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_keepalive_time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.ip_local_port_range </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1024</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">65000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 文件系统性能优化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm.swappiness </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm.dirty_ratio </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm.dirty_background_ratio </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># /etc/ssh/sshd_config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 加快 SSH 登录速度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UseDNS no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GSSAPIAuthentication no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 禁用 Ctrl+Alt+Del 重启</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># /etc/systemd/system/ctrl-alt-del.target</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Disable Ctrl+Alt+Del </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">reboot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/bin/true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># /etc/chrony.conf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 设置时间同步</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">.centos.pool.ntp.org</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">.centos.pool.ntp.org</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.centos.pool.ntp.org</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.centos.pool.ntp.org</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># /etc/profile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># History 优化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable environment constant" style="color:#36acaa">HISTSIZE</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">HISTIGNORE</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&amp;:ls:ll:history&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>其实这类问题都挺无聊的，</p><p>在实际工作中，我们工作流通常是，用terraform批量创建机器之后，用ansible来批量修改这些机器的配置项。</p><p>那这个问题实际上就是问，有哪些需要注意的配置项。</p><p>通常我们直接从gh上搜对应的优化配置即可，比如说 &quot;centos ansible optimizer&quot; 就能搜到很多，比如：</p><p>怎么用ansible初始化mac？</p><p>使用ansible配置mac</p><ul>
<li><a href="https://github.com/AlexNabokikh/mac-playbook" target="_blank" rel="noopener noreferrer">AlexNabokikh/mac-playbook: MacOS setup and configuration via Ansible.</a></li>
<li><a href="https://github.com/ringods/macos-config" target="_blank" rel="noopener noreferrer">ringods/macos-config: Automated setup of my MacOS system(s) based on Superlumic</a></li>
</ul><p>如果搜不到，就直接搜 &quot;centos optimizer&quot;</p><p><a href="https://github.com/hawshemi/Linux-Optimizer" target="_blank" rel="noopener noreferrer">hawshemi/Linux-Optimizer: Linux Optimizer</a></p><p><a href="https://github.com/opiran-club/VPS-Optimizer" target="_blank" rel="noopener noreferrer">opiran-club/VPS-Optimizer: Linux Optimizer One-click bash script , swap maker and bbr tcp congestion control , xanmod kernel and bbrv3</a></p><p>然后自己写一个对应的ansible-playbook 就可以了</p><hr><p>另外哈，其实像centos去聊优化，很多时候都是在鬼扯。因为linux kernel本身在新版本会有很多优化，但是像RHEL家的这些个linux发行版根本追不上新版本，自然这些优化都用不到。比如说昨天看的linux6.8通过优化cacheline，提高了TCP性能约40%，这个比怎么折腾BBR之类的东西都。包括HTTP3都实装了很久了，但是国内外绝大部分服务还是在用HTTP1.1，HTTP3相比HTTP1.1的性能提升大概有3~4倍（搜索&quot;HTTP3 HTTP1.1 benchmark&quot;），然后呢？ 所以讨论这些东西，感觉都挺可笑的。绝大部分服务都是嘴上说很注意性能，但是实际上很多已经很成熟的优化方案存在了，但是却不用</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="doc-myspace-20231123"><em><strong>[doc] MySpace [2023/11/23]</strong></em><a href="#doc-myspace-20231123" class="hash-link" aria-label="Direct link to doc-myspace-20231123" title="Direct link to doc-myspace-20231123">​</a></h3>
<p><a href="https://www.hitzhangjie.pro/blog/" target="_blank" rel="noopener noreferrer">Blog - MySpace</a> 这个 hugo 的主题真的很舒服，文档偏底层，以后再看。干货还是挺多的，可以看看。</p>
<hr>
<p><em><strong><a href="https://www.hitzhangjie.pro/blog/2023-08-23-json%E5%BA%93%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E5%8F%8A%E5%AE%9E%E7%8E%B0%E6%8E%A2%E7%A9%B6/#%E6%9C%AC%E6%96%87%E6%80%BB%E7%BB%93" target="_blank" rel="noopener noreferrer">JSON库性能对比及实现探究 - MySpace</a></strong></em></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">本文首先介绍了下JSON标准，介绍了下JSON parser+generator在标准范围内的一些腾挪空间，然后我们列举了当前性能比较有优势的一些JSON库实现，并对它们属于parser、generator进行了分类，也指出了哪些库可以作为go标准库的平替方案。我们还比较详细地分析了各个JSON库的优化思路，其中重点介绍了simdjson这个被大量优秀开源项目使用的实现，以及针对go语言的bytedance/sonic这个在字节广泛使用的实现。从中我们认识到，JSON的使用场景比较多样化，泛型模式、有固定schema的模式、按需解析的模式，甚至还有对齐进行修改后再序列化的诉求，要实现一个支持全场景的方案本身就不简单，而且还要做到sonic开发者团队说的那样全场景top3的程度。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">目前，从效果上来看，sonic确实做的不错，但是它受限于amd64平台，继续支持其他平台可能并非sonic开发者能支持的，所以goccy/go-json的方案也值得借鉴下，虽然其在泛型模式下表现一般，但是其在有schema模式下已经可以实现和bytedance/sonic JIT优化后的差不多的效果了，看来goccy/go-json也可以有进一步优化战胜bytedance/sonic的空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>sonic 和 goccy/go-json</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sonic可以作为go标准库encoding/json的一个平替（至少在amd64平台上是可以），不仅如此，它还号称是在全场景中表现优异。开发者提到，此前很难找到支持全场景、并且在支持全场景中性能均保持top3的json库，这也是开发者最终开发bytedance/sonic的一个起因。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bytedance/sonic有一篇非常不错的介绍性文章，see: 基于 JIT 技术的开源全场景高性能 JSON 库。其中提到了所谓的全场景的概念：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 泛型（generic）编解码：JSON 没有对应的 schema，只能依据自描述语义将读取到的 value 解释为对应语言的运行时对象，例如：JSON object 转化为 Go any, interface{}, map[string]interface{}；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 定型（binding）编解码：JSON 有对应的 schema（Go strcut），可以同时结合模型定义与 JSON 语法，将读取到的 value 绑定到对应的模型字段上去，同时完成数据解析与校验；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 查找（get）&amp; 修改（set） ：指定某种规则的查找路径（一般是 key 与 index 的集合），只对需要的那部分 JSON value 进行查找或者修改。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p><em><strong><a href="https://www.hitzhangjie.pro/blog/2023-09-08-linux%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A560s/" target="_blank" rel="noopener noreferrer">Linux性能问题排查60s - MySpace</a></strong></em></p>
<p>latency 数据</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">L1 cache reference ......................... 0.5 ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Branch mispredict ............................ 5 ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">L2 cache reference ........................... 7 ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Mutex lock/unlock ........................... 25 ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Main memory reference ...................... 100 ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Compress 1K bytes with Zippy ............. 3,000 ns  =   3 µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Send 2K bytes over 1 Gbps network ....... 20,000 ns  =  20 µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SSD random read ........................ 150,000 ns  = 150 µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Read 1 MB sequentially from memory ..... 250,000 ns  = 250 µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Round trip within same datacenter ...... 500,000 ns  = 0.5 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Read 1 MB sequentially from SSD* ..... 1,000,000 ns  =   1 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disk seek ........................... 10,000,000 ns  =  10 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Read 1 MB sequentially from disk .... 20,000,000 ns  =  20 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Send packet CA-&gt;Netherlands-&gt;CA .... 150,000,000 ns  = 150 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>checklist</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">uptime</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">dmesg</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tail</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vmstat</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mpstat </span><span class="token parameter variable" style="color:#36acaa">-P</span><span class="token plain"> ALL </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pidstat </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iostat </span><span class="token parameter variable" style="color:#36acaa">-xz</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">free</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-m</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sar </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> DEV </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sar </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> TCP,ETCP </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">top</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p><em><a href="https://www.hitzhangjie.pro/blog/2020-09-28-go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-go%E5%91%BD%E4%BB%A4/" target="_blank" rel="noopener noreferrer">go源码剖析 - go命令 - MySpace</a></em></p>
<p>把需要的commands都整理到tldr-alfred了</p>
<hr>
<p><a href="https://www.hitzhangjie.pro/blog/2019-05-23-%E5%88%AB%E7%94%A8float%E4%BD%9C%E4%B8%BAmap%E7%9A%84key/" target="_blank" rel="noopener noreferrer">别用float作为map的key - MySpace</a> 应该正常人都不会用float作为key吧</p>
<hr>
<p><a href="https://www.hitzhangjie.pro/blog/2021-03-09-%E8%81%8A%E8%81%8A%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%97%B6%E9%97%B4/" target="_blank" rel="noopener noreferrer">聊聊计算机系统中的时间 - MySpace</a></p>
<p>如何解决时间漂移问题在多处理器系统、分布式系统中带来的时序相关的问题。</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">这里还有个问题，就是时间漂移问题。尽管我们前面提及了精确测量时间、时间同步协议等尽可能保证时间准确的方式，但是效果也是”尽可能”让其精确，我们还是不能百分百地保证全球所有电子设备、分布式系统中节点的时间是完全一致的，甚至是同一个计算机但是是多处理器系统中的多个时钟也不是完全一致的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这回带来什么问题呢？如果运行其上的系统，依赖“时间”对操作顺序执行先后做判断，那这样的系统很可能是存在问题的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在分布式系统设计中，一般会采用“逻辑时钟”、“向量时钟”等方式来代替真实时钟，来作为操作顺序执行先后的判断依据。这里的内容有很多，后面我们有机会再单独写一篇文章来介绍。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">在分布式系统中，怎么使用逻辑时钟和向量时钟？这两种方案做个比较</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">方案                         优点                                                     缺点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">逻辑时钟       - 简单易实现</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">- 不依赖于节点之间的通信</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">- 可以检测因果关系 - 无法准确反映物理时间</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">- 不适用于并发冲突的解决和一致性问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">向量时钟       - 可以检测因果关系</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">- 可以解决并发冲突和一致性问题         - 需要维护较大的向量</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">- 通信开销较大</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">- 可能存在复杂的更新逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">哪种方法更好呢？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在选择逻辑时钟或向量时钟时，没有绝对的&quot;更好&quot;方法，而是要根据具体的需求和场景来确定。这取决于分布式系统的特点、应用需求和实现复杂性等因素。下面是一些考虑因素：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 简单性和易实现性：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 逻辑时钟相对简单，只需要维护一个递增计数器，易于实现和理解。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 向量时钟需要维护一个向量，实现和维护稍微复杂一些。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 物理时间的需求：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 逻辑时钟不能准确反映物理时间，只能依靠事件发生的因果关系进行排序。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 向量时钟也不能直接提供准确的物理时间，但可以通过比较向量元素来确定因果关系。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 应用需求：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 逻辑时钟适用于一些不需要考虑并发冲突和一致性问题的场景。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 向量时钟更适用于需要解决并发冲突和一致性问题的场景，例如分布式数据库、分布式锁等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 通信开销：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 逻辑时钟不需要节点之间的通信，仅依赖于事件发生的因果关系。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 向量时钟需要节点之间的通信来传递和更新向量，可能引入一定的通信开销。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">需要根据具体需求进行权衡和选择。在某些情况下，逻辑时钟可能更简单和适用，而在需要解决并发冲突和一致性问题的场景中，向量时钟可能更合适。一些系统可能会结合两种方法，根据具体需求来灵活选择使用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">因此，没有一种方法可以被普遍视为更好，而是要根据分布式系统的特点和应用需求来选择适合的时钟方案。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>分布式数据库、分布式锁等场景使用向量时钟。向量时钟相比逻辑时钟更加复杂。</p>
<hr>
<p><a href="https://www.hitzhangjie.pro/blog/2020-08-19-go%E5%BC%80%E5%8F%91%E5%A6%82%E4%BD%95%E5%81%9A%E6%B5%8B%E8%AF%95%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6/" target="_blank" rel="noopener noreferrer">选择合适的测试框架 - MySpace</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">go单测中使用的比较多的，大致有如下这些选择， gomock+gostub+gomonkey+goconvey，现在go用的比较多的就是这几个，我比较推荐gomock、gomonkey，看情况，灵活组合使用吧，先总结下这几个的使用方式、优缺点。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gomock是基于interface的，mockgen生成interface对应的mock桩代码，然后再去写mock代码。 如果前期没这些interface设计的话，也不方便测试。有的话，看起来也不是特别方便。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gostub支持对变量、方法、过程进行mock，但是用上它，存量代码的话就要做些调整，对代码有侵入， 因为它是基于变量去作mock，比如func Hello(…)要改成var Hello=func(…)才能用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gomonkey也支持对变量、方法、过程进行mock，我现在感觉这个比较好用，简单，对代码无侵入， 和gostub实现原理不太一样，比如函数，它通过汇编调整跳转地址，这么着对内联函数就支持不到了，就得-gcflags=“all=-l&quot;禁用内联</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">goconvey主要是用来更好地管理测试用例，可以根据情况用或者不用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在深度使用上述几个测试框架之后，个人感觉gomonkey+goconvery组合是比较合适的，goconvey也可以考虑用go testing框架t.Run代替来维护子测试。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>英雄所见略同，不过我是gotest+gomonkey</p>
<hr>
<p><a href="https://www.hitzhangjie.pro/blog/2020-09-06-%E5%89%96%E6%9E%90go%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6/" target="_blank" rel="noopener noreferrer">剖析go二进制文件 - MySpace</a></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 源码转汇编代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go build </span><span class="token parameter variable" style="color:#36acaa">-gcflags</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-S</span><span class="token plain"> program.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># bin包转汇编代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go tool objdump binaryFile</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Capstone 反汇编框架</p>
<p>gapstone</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">当你在一个笔记本上编译一个go程序、默认输出是64位ELF格式（Executable Linkable Format）。ELF内部其实是被组织成了多个不同的节（section），每一个section都有不同的目的，如存储版本信息、程序元数据信息、可执行代码等等。ELF是被广泛采用的一个二进制程序标准，go语  言标准库里面提供了一个 debug/elf package用来进行ELF文件数据的读写。ELF其实有点复杂，但是要实现反汇编的话其实我们只关心两个section就可以了。一个是符号表section（.symtab），一个是指令section （.text）。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>直接用 godbolt 查看就行了</p>
<hr>
<p><a href="https://www.hitzhangjie.pro/blog/2020-10-06-visualizing-your-go-code/" target="_blank" rel="noopener noreferrer">Visualizing Your Go Code - MySpace</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">流程控制 + 组件交互</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">某种程度上，我认为理解代码也有相似之处。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果能够拎出那些比较重要的对象（objects），以及他们之间的通信（function call, chan send/recv），或者他们的  私密信息（注释），是不是也能够大致有个了解呢？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果想更深入了解下，加上事情的脉络（控制结构，if-else, switch-case, for-loop）呢？</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">So…假如我用编程语言写了一段代码，如何知道我有没有犯错误呢？那就是编译器的工作，词法分析、语法分析、语义分析，一切OK之后会进入中间代码生成、代码优化、生成最终代码。通常一般在语法分析会构建语法分析树AST（Abstract Syntax Tree），如果能够正常构建出AST，表示代码是按照语言对应生成规则来写的，就没什么大问题，反之则可能又自我“发挥”犯错了。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p><em><a href="https://www.hitzhangjie.pro/blog/2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/" target="_blank" rel="noopener noreferrer">解决c10k c100k c10m问题 - MySpace</a></em></p>
<p>这篇文章选择的角度特别好，从c10k到c10m，也就是从上上个时代（200X年）到现在这个时间点（202X年）的跨度。还是从内核本身到一些比较前沿的kernel相关的优化方法。</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">操作系统</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">允许进程打开的最大fd数量，通常较小，需通过ulimit -n设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">默认进程、线程栈大小，偏大且进程数、线程数多的话，容易OOM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">那个时代有些可观存在的限制：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> glibc2.1以下版本使用16-bit数字记录句柄数，仅支持32767个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 有的系统使用16位记录进程ID、现成ID，so可能创建不了太多进程、线程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 有的系统预分配了太大的thread-local存储，比如1MB，假设虚地址空间2GB，那么最多创建2000个线程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">内核本身存在问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> select、poll、epoll的改进</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> thundering herd（惊群）问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">服务实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">网络IO管理机制，同步、异步</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">服务采用的并发处理模型（ppc、tpc、cpc）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">框架实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> zero-copy问题，了解收一个网络包的旅程，从网卡端口、驱动中buffer、内核协议栈、应用程序缓冲区，可借助系统调用来减少拷贝开销，推荐常见的零拷贝技术</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 使用writev避免发送小包，writev+iovec（scatter、gather分散读、聚集写）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 使用TCP_CORK避免发送小包，将多个小包合并达到MSS后发送, see TCP_CORK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 过载保护机制，过载时拒绝新连接，降低错误率。如使用IO ready的客户端数量来作为负载评估指标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">caching技术</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">说到这里，就不得不提下为什么要多个进程、多个线程，为了并发提高资源利用率。程序执行操作时，有些操作会阻塞程序执行导致其让出CPU，比如进行网络IO处理，或者执行一些其他的阻塞型的syscalls。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">针对网络IO处理，大家应该了解过同步阻塞、同步非阻塞、异步IO，我们就直说当前最成熟的、顶大梁的方案，同步非阻塞。Linux下通过epoll可以实现同步非阻塞IO，实现高效地IO事件处理。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>PPC, TPC, CPC</p>
<p>其实上面这么多内容，总结一句话就是我们平时常说的“什么c10k，不就是nginx随便起个服务就能搞定的吗？”，<em>换句话说，也正是因为nginx本身就实现了这些优化（比如COW, zero-copy, 包括TPC这些），所以才能轻松搞定c10k问题。</em></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">The c10m problem! 依靠内核是不能胜任这个问题的，内核恰恰是问题所在！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">packet scaling：内核提供的收包机制太重了，自定义网卡驱动，接管对网卡的管理，将收到的包直接递交给应用程序缓冲区，而不是传给内核协议栈，像这样的实现包括：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PF_RING</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Netmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Intel DPDK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ps：现在有了一种相比较之下更好的技术，基于eBPF的高性能网络。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">multi-core scaling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spinlock,mutex,critical section,semaphores?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">no waiting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">un-synchonization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">core local data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ring buffers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCU (read-copy-update)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">atomics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cmpxchg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lock add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lockfree data structures</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thread models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pipeline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">taskset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thread affinity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CPU and memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">co-locate data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">don’t: data structures all over memory connected via pointers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">do: all the data together in one chunk of memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ps：每次follow一个pointer都是一个cache miss，考虑访存延迟! 假设你的数据是A-&gt;B-&gt;C-&gt;D，4个cache miss，如过组织成A|B|C|D，那么就可以减少到4次cache miss。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">compress data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bit-fields instead of large integers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">indexes (1, 2 bytes) instead of pointers (8 bytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">get rid of padding in data structures</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cache efficient data structures</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B+ tree over Binary Search Tree, etc. 减少访存次数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NUMA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double the main memory access time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">memory pools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">per object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">per thread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">per socket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">defend against resource exhaustion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hyper-threading</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">threads &gt; cores, 一个thread阻塞了其他thread可以继续跑，充分利用cpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">linux bootparam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hugepages</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p><em><strong><a href="https://www.hitzhangjie.pro/blog/2021-04-17-locks%E5%AE%9E%E7%8E%B0%E9%82%A3%E4%BA%9B%E4%B8%8D%E4%B8%BA%E4%BA%BA%E7%9F%A5%E7%9A%84%E6%95%85%E4%BA%8B/" target="_blank" rel="noopener noreferrer">Locks实现:背后不为人知的故事 - MySpace</a></strong></em></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">本文介绍了并发中重要的原子性、指令重排问题，以及带来的安全编码风险，然后介绍了处理器提供的一些屏障指令，以及从硬件角度介绍了屏障的工作原理，然后介绍了CAS及其使用，引出了进一步的锁、无锁、CAS的异同点，然后我们简单提了下futex重量级锁导致的进程线程挂起、恢复开销大家，最后引出了go sync.Mutex的设计实现及一系列针对协程调度延迟的优化。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p><em><a href="https://www.hitzhangjie.pro/blog/2021-04-16-%E5%A6%82%E4%BD%95%E7%9C%8B%E5%BE%85gopanic%E5%8F%8A%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" target="_blank" rel="noopener noreferrer">如何看待gopanic及异常处理 - MySpace</a></em></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">最近有同学提问，大意是：“go中什么时候用panic、什么时候用error，能不能像其他语言中的try-catch一样用panic-recover来代替层层return err，或者应不应该recover一个panic之后转换为error？”</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">所以，panic并非一般意义上的error，更不能用panic-recover代替层层向上传递error！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">对于，为了自身程序的健壮性，而在启动新的goroutine时，或者调用外部依赖的导出函数、方法时，可能选择recover一些预料之外的panic，并转换为error处理。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">异常+try-catch，本质上将当前操作的错误处理逻辑转换为了caller要解决的问题，并没有少写多少错误处理代码，反而，同一异常处理代码在多个try-catch中被拷贝，而且可读性更差了。错误发生地、错误处理地分散在不同地方，能说是可读性好吗？我不这么认为。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>golang的错误处理其实就一个error，没有其他的。</p>
<p>这篇文章的意思是，php或者java那样的exception处理只是转移矛 盾（把错误处理丢给caller处理），而没有解决矛盾。</p>
<hr>
<p><em><a href="https://www.hitzhangjie.pro/blog/2021-04-14-go%E7%A8%8B%E5%BA%8F%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E9%97%AE%E9%A2%98%E5%BF%AB%E9%80%9F%E5%AE%9A%E4%BD%8D/" target="_blank" rel="noopener noreferrer">Go程序内存泄露问题快速定位 - MySpace</a></em></p>
<hr>
<p><a href="https://www.hitzhangjie.pro/blog/2018-09-29-%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8/" target="_blank" rel="noopener noreferrer">布隆过滤器的原理及应用 - MySpace</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">前面描述了在预期误差率的情况下，存储一个元素所需要的平均存储空间是多少bpe，以及实际存储时需要设置的bits数量，也就是需要计算的hash轮数。现在描述下hash算法，murmurhash是现在比较常用的一种hash算法，不少开源的布隆过滤器实现都是采用了murmurhash算法来实现。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">murmurhash算法的名字来源于它的两个重要操作MU（multiply）以及R（Rotate），它在设计上并不是为了密码学上增加单向加密的难度，所以它不适用于安全领域。如果是向做一个快速的hash且希望hash碰撞满足预设指标的话，murmurhash是一个不错的hash算法。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>murmurhash = mu(multiply) + r(rotate)</p>
<p>murmur3</p>
<p>除了murmurhash之外，还有CityHash, xxHash, FNV, SpookyHash之类的，也都还算常用</p>
<hr>
<p>多分区布隆过滤器</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">上述描述了一个布隆过滤器的大致原理、如何确定误差率以及bpe和hash轮数、依赖的hash算法等，在实际应用中，我们可能会遇到更多的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">仍以短视频推荐场景为例，假定我们设计容量是为每个用户记录最近访问过的2000个短视频，假定需要的存储空间是m，随着时间的推移，布隆过滤器中的bit=1的bits越来越多，我们不能将所有的bits写的过多，更不能写满，以为会导致误差率急剧升高，甚至超过预设的误差率。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">那么写多少bits算是合理的呢？这个可以通过实测进行计算，看看写了多少bits后误差率升高到预设值，当布隆过滤器所有bits的1/2都是1时可以看做是“写满”的标识。这个时候该如何操作呢？</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">其他布隆过滤器变体</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">由于现实应用场景多样，布隆过滤器变体也非常多。维基百科中列出了很多布隆过滤器变体，例如：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cache Filtering</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Avoiding False Positives in a Finite Universe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Counting filters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Decentralized aggregation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Data synchronization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Bloomier filters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Compact approximators</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Stable Bloom filters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Scalable Bloom filters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spatial Bloom filters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Layered Bloom filters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Attenuated Bloom filters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chemical structure searching</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>有哪些常见的bloomfilter变体？分别说明其实现方法和使用场景</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="top"><strong>top</strong><a href="#top" class="hash-link" aria-label="Direct link to top" title="Direct link to top">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>linux 的 top 工具都返回哪些指标？每项指标什么意思？</p></div></div>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">mac</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Processes: 518 total, 2 running, 516 sleeping, 2261 threads                                  23:13:57</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Load Avg: 4.41, 4.38, 3.92  CPU usage: 12.41% user, 7.93% sys, 79.64% idle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SharedLibs: 545M resident, 92M data, 45M linkedit.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MemRegions: 329953 total, 5608M resident, 90M private, 1497M shared.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PhysMem: 15G used (3000M wired, 2825M compressor), 785M unused.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VM: 37T vsize, 3444M framework vsize, 21972(0) swapins, 46722(0) swapouts.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Networks: packets: 19526758/29G in, 12097544/16G out. Disks: 1534752/18G read, 3337997/51G written.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PID    COMMAND      %CPU  TIME     #TH   #WQ  #PORT MEM    PURG   CMPRS  PGRP  PPID  STATE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">21908  Google Chrom 49.0  33:52.79 25    1    551   295M+  0B     75M-   2461  2461  sleeping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">82679  top          25.3  00:02.50 1/1   0    29    4324K+ 0B     0B     82679 79798 running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2471   Google Chrom 24.4  62:28.80 15    2    398-  412M-  43M+   141M   2461  2461  sleeping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">vps</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">top - 23:15:46 up 11 days,  2:14,  1 user,  load average: 0.04, 0.06, 0.05</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tasks: 138 total,   1 running, 137 sleeping,   0 stopped,   0 zombie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%Cpu(s):  0.8 us,  0.5 sy,  0.0 ni, 98.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KiB Mem :  1776152 total,   113404 free,  1224276 used,   438472 buff/cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KiB Swap:        0 total,        0 free,        0 used.   248916 avail Mem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  931 root      10 -10  148860  22656   2784 S   1.7  1.3 287:59.42 AliYunDunMonito</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  913 root      10 -10  104572   4592   2524 S   0.7  0.3  78:50.79 AliYunDun</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  809 root      20   0  816172  10136   4180 S   0.3  0.6  17:14.84 aliyun-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面概览列中的 CPU 数据：</p>
<ul>
<li>us(user cpu time) 用户空间占用 CPU 百分比</li>
<li>sy(system cpu time) 内核空间占用 CPU 百分比</li>
<li>ni(nice cpu time) 用户进程空间内改变过优先级的进程占用 CPU 百分比</li>
<li>id(idle) 空闲 CPU 百分比</li>
<li>wa(iowait) 等待输入输出的 CPU 时间百分比</li>
<li>hi(hardware irq) 硬件中断</li>
<li>si(software irq) 软件中断</li>
<li>st(steal time) 实时</li>
</ul>
<p>下面表格的参数：</p>
<ul>
<li>PRI：进程的优先级</li>
<li>NI(NICE)：进程的优先级别值，默认的为 0，可以进行调整</li>
<li>VIRT：进程占用的虚拟内存值</li>
<li>RES(resident size)：进程占用的物理内存</li>
<li>SHR：进程占用的共享内存</li>
<li>S：进程的运行状况，（WSRZ）R 表示正在运行、S 表示休眠，等待唤醒、Z 表示僵死状态</li>
<li>%CPU：该进程占用的 CPU 使用率</li>
<li>%MEM：该进程占用的物理内存和总内存的百分比</li>
<li>TIME+：该进程启动后占用的总的 CPU 时间</li>
</ul>
<p>tput</p>
<p><a href="https://wangchujiang.com/linux-command/c/tput.html" target="_blank" rel="noopener noreferrer">tput 命令，Linux tput 命令详解：通过 terminfo 数据库对终端会话进行初始化和操作 - Linux 命令搜索引擎</a></p>
<p><a href="https://www.cnblogs.com/technologylife/p/8275044.html" target="_blank" rel="noopener noreferrer">shell 终端 terminfo 命令 tput - Pyerlife - 博客园</a></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token variable punctuation" style="color:#393A34">((</span><span class="token variable" style="color:#36acaa">i</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable number" style="color:#36acaa">0</span><span class="token variable punctuation" style="color:#393A34">;</span><span class="token variable" style="color:#36acaa">i</span><span class="token variable operator" style="color:#393A34">&lt;</span><span class="token variable number" style="color:#36acaa">99</span><span class="token variable punctuation" style="color:#393A34">;</span><span class="token variable" style="color:#36acaa">i</span><span class="token variable operator" style="color:#393A34">++</span><span class="token variable punctuation" style="color:#393A34">))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tput sc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> tput civis                     </span><span class="token comment" style="color:#999988;font-style:italic"># 记录光标位置,及隐藏光标</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tput blink</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> tput setf </span><span class="token variable" style="color:#36acaa">$i</span><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># 文本闪烁,更改文本颜色</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-ne</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">date</span><span class="token variable" style="color:#36acaa"> +</span><span class="token variable string" style="color:#e3116c">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 显示时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tput rc                                 </span><span class="token comment" style="color:#999988;font-style:italic"># 恢复光标到记录位置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tput el</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> tput cnorm                             </span><span class="token comment" style="color:#999988;font-style:italic"># 退出时清理终端,恢复光标显示</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p><a href="https://piaohua.github.io/post/linux/20210710-linux-dig/" target="_blank" rel="noopener noreferrer">[Linux] dig 命令使用 - piaohua&#x27;s blog</a></p>
<p>VACUUM</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SQLite 中的 VACUUM 命令是用于优化数据库文件大小和性能的工具。它的主要目的是回收已删除数据占用的磁盘空间，以及重新组织数据库文件以提高查询和事务的性能。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">以下是一些需要使用 VACUUM 命令的情况：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 删除数据：当从 SQLite 数据库中删除大量数据时，磁盘上的数据库文件不会立即缩小。相反，SQLite 会将删除的数据标记为可重用空间，这些空间在以后的插入操作中可能会被重新利用。但是，如果删除的数据占用的空间很大，而且不再需要，可以使用 VACUUM 命令来释放这些未使用的空间，减小数据库文件的大小。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 更新数据：SQLite 使用写时复制（Write-Ahead Logging）技术来处理并发事务。更新操作会创建新的数据库页，这些页会被添加到数据库文件的末尾。如果频繁进行更新操作，数据库文件可能会变得非常庞大。使用 VACUUM 命令 可以重新组织数据库文件，消除不必要的空间和页面碎片，从而提高查询和事务的性能。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 数据库文件迁移：当需要将 SQLite 数据库从一个位置移动到另一个位置时，VACUUM 命令可以将数据库文件整理为一个连续的文件，以便更方便地进行文件迁移和复制。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">需要注意的是，VACUUM 命令会对数据库进行写操作，并且可能需要一些时间来完成，特别是对于大型数据库文件而言。因此，在使用 VACUUM 之前，我们应该评估数据库的大小和性能需求，并在合适的时机使用 VACUUM 来优化数据库文件。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">懂了，据我所知，所有的数据库在删除数据后，磁盘空间都不会释放。sqlite 的 VACUUM 命令是不是就类似于 mysql 的 optimize 命令、pg 的 vacuum 命令、sql server 的收缩数据库、oracle 的 resize 命令？用来回收磁盘空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">是的，你的理解基本上是正确的。在许多数据库系统中，包括 MySQL 的 OPTIMIZE 命令、PostgreSQL 的 VACUUM 命令、SQL Server 的收缩数据库操作以及 Oracle 的 RESIZE 命令，都有类似于 SQLite 的 VACUUM 命令的功能，用于回收磁盘空间。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这些命令的主要目的是优化数据库文件的大小和性能。它们会清理或重新组织数据库文件，以回收已删除数据占用的磁盘空间，并消除数据库文件中的碎片，从而提高查询和事务的性能。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">尽管这些命令的实现方式和效果可能略有不同，但它们都旨在优化数据库文件的存储结构，以减小文件大小并提高数据库的性能。在使用这些命令时，我们应该根据实际情况和数据库系统的特定要求，选择合适的时机和方式来执行它们。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">需要注意的是，在执行这些命令之前，建议先备份数据库文件，以防万一发生意外情况。  此外，数据库系统通常也会有自动的维护机制来定期清理和优化数据库文件，但在某些情况下，手动执行这些命令可能是必要的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>总结：用来回收磁盘空间的。执行 vacuum 时会自动备份数据库，不需要担心。</p>
<hr>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 多行字符串需要使用EOF标注</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># shell脚本中写入文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">filename</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;filename.yaml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${filename}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    txt...</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分布式"><em><strong>分布式</strong></em><a href="#分布式" class="hash-link" aria-label="Direct link to 分布式" title="Direct link to 分布式">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>目前的主流方案是 <em><code>待处理内容写入本地表</code>+<code>事务外实时触发</code>+<code>定时调度补偿</code></em> ，可以基本满足<code>分布式事务</code>，<code>同步异步补偿</code>，<code>实时非实时触发</code>等复杂场景的处理</p><ul>
<li>分布式事务<!-- -->
<ul>
<li>事务中直接 RPC 调用达到强一致性</li>
<li>事务中进行异步消息推送</li>
<li>解决方案</li>
<li>目前我们使用的解决方案</li>
</ul>
</li>
<li>幂等控制</li>
<li>异步消息乱序<!-- -->
<ul>
<li>异步消息结合状态驱动</li>
</ul>
</li>
<li>补偿方案<!-- -->
<ul>
<li><code>HTTP同步调用的补偿</code></li>
<li><code>异步消息消费失败的补偿</code></li>
</ul>
</li>
</ul></div></div>
<hr>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>高并发：</p><ul>
<li><em>扩容</em></li>
<li>无状态</li>
<li>拆分</li>
<li>服务化</li>
<li>消息队列</li>
<li>数据异构</li>
<li>缓存银弹</li>
<li>并发化（异步并发）</li>
<li>连接池</li>
<li>线程池</li>
<li>分布式任务</li>
</ul><p>高可用：</p><ul>
<li>系统高可用的核心是<code>备份 + 自动切换</code></li>
<li>如果压力（不只是数据库或者服务器，各个层的压力）太大，考虑做“集群”，所以，也可以认为是<code>集群 + 自动切换</code>，核心思想是“去单点”，只不过是机器多少的问题</li>
</ul><hr><ul>
<li>事前：副本；隔离；配额，提前预案，探知</li>
<li>事发：监控和报警</li>
<li>事中：降级，回滚，应急预案，fairXXX 系列</li>
<li>事后：复盘，思考，技改</li>
</ul><hr><ul>
<li><code>熔断</code>，通过隔离实现故障隔离</li>
<li><code>降级</code>，通过降级实现部分可用，有损服务</li>
<li><code>回滚</code>，通过回滚机制快速修复错误版本</li>
<li><code>限流</code>，通过“限流”保护服务受到雪崩的影响</li>
<li><code>切流量</code></li>
<li><code>兜底容灾</code></li>
</ul></div></div>
<hr>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">服务容错的常用手段：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important">FailOver 失败自动切换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">服务消费者发现调用失败或者超时后，自动从可用的服务节点列表中选择下一个节点重新发起调用，也可以设置重试次数。要求服务调用幂等，不管调用多少次，只要是同一个调用，返回结果必须相等，适合读请求。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important">FailBack 失败通知</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">消费者调用失败后，不再重试。而是根据失败的详细信息，决定后续的执行策略。对于非幂等的调用场景，不能重试，而是应该查询服务端状态，看调用到底是否实际生效。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important">FailCache 失败缓存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">服务消费者调用失败或者超时后，不立即重试，而是间隔一段时间再次尝试发起调用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important">FailFast 快速失败</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">消费者调用一次失败后，不再重试。一般非核心业务调用，采用快速失败，记录日志后就返回。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">一般幂等的使用FailOver或者FailCache，不是幂等调用选择FailBack或者FailFast。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>DDD</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ddd 的解释看了几遍，不知道讲的啥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我理解的所谓的领域模型开发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">基于某个领域做开发，比如一个登录的功能，一个人开发登录的逻辑，一个人开发登录操作数据库的逻辑。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果这个登录涉及到 redis，则 会有一个操作 redis 的人来开发。每个人都只专注自己的领域。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">不知道我理解的对不对</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">••</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">• only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这个理解不太准确</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">• only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">一般 ddd 会划分几个领域，核心域 (核心业务），通用域 (比</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如用户中心），支撑域 (比如 MySQL REDIS KAFKA)，ddd 最难的应该就是核心域的服务拆分，但是不管怎么拆分每个服务一般都有自己的缓存 (Redis），持久化 (mySQL)，事件（katka)，服务与服务之间一般通过事件做通信</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">好像差不了太多</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">所以如果你负责一个服务这个服务里面的缓存，数据库操逻辑都有你自己完成，只是类似 mycat 这类底层服务由支撑域做</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>数据库索引</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">图 2：磁盘和内存的 10 速度对比</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">再看数据存储领域，有两个“极端”发展方向：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1、加快读：通过素引 1（日 + 树、二份查找树等方式），提高查询速度，但是写入数据时要维护索引，因此会降低写入效率。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、加快写：纯日志型，数据以 append 追加的方式顺序写入，不加索引，使得写入速度非常高 (理论上可接近</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">磁益的写入速度），但是缺乏索引支持，因此查询性能低。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">老许注：这里应该是可接近内存随机写的速度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">基于这两个极端，又衍生出来了了类最具代表性的底层索引结构：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">】1、哈希索引：通过哈希西数将 key 映射成数据的存储地址，适用于等值查询等简单场景，对于比较查询、范围查询等复杂场景无能为力。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2、B/B+ Tree 索引：最常见的索引类型，重点考虑的是读性能，它是很多传统关系型数据库，比如 MysQL、Oracle 的底层结构。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3、LSM Tree 索引：数据以 Append 方式追加写入日志文件，优化了写但是又没显著降低读性能，众多</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NosQL 存储系统比如 Big Table, HBase, Cassandra, RocksDB 的底层结构。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">不建议使用 rke 或 rancher 直接去引导一个集群，排障的时候不容易判断故障源。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">尚墨@安恒 - 运维开发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rke，rancher 安装虽然方便，但是不清晰。反而不如自己用 kubeadm 引导一个集群，导入 rancher 管理。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="社交项目-lbs-social">社交项目 LBS-social<a href="#社交项目-lbs-social" class="hash-link" aria-label="Direct link to 社交项目 LBS-social" title="Direct link to 社交项目 LBS-social">​</a></h3>
<p>有哪几种社交 app？</p>
<ul>
<li>翻牌子+LBS，比如陌陌、探探</li>
<li>基于 LBS，比如面具公园，把选择权完全交给用户</li>
<li>基于话题，比如即刻 App</li>
<li>系统匹配，比如二半</li>
<li>  随机匹配，比如 soul</li>
</ul>
<hr>
<ul>
<li>有哪些难点功能？<!-- -->
<ul>
<li>附近的人</li>
<li>阅后即焚</li>
<li>多源融合的 feed 流</li>
</ul>
</li>
<li>阅后即焚怎么实现？<!-- -->
<ul>
<li>标准的做法则加了 nonce 和 timestamp 之类的，图片 url 在超时之后就失效了</li>
<li>大部分做法都是做个假的阅后即焚，图片资源不变，通过蒙层以及服务端不同用户对某张“阅后即焚图片”对某个用户的标识，来进行展示，焚毁的操作</li>
</ul>
</li>
<li>多源融合的 feed 流怎么实现？</li>
<li>微信分享模块怎么实现？表设计？</li>
</ul>
<hr>
<p>遇到了哪些问题？</p>
<ul>
<li>如无必要，不要分表。社交项目里把用户表和用户详情表拆开了，结果在实现过程中发现两张表大部分字段是重复的，但是却需要维护两份相同数据，维护有问题还会有数据不一致的情况，太恶心了。总之一句话，如果不是业务必须要拆表，那么都应该尽量维护在一张表里</li>
<li>之前是面具公园一样后置付费的逻辑，现在变成前置付费之后，user 表就很奇怪，会有很多未完善资料的用户；本身后置付费的时候，就会有用户没填资料，现在变成前置之后，可能只有 1/10 的用户填写资料。</li>
<li>不应该在发送短信之后，就直接在 user 表生成用户<!-- -->
<ul>
<li>如果是前置付费，一定是付费完成后，才写到 user 表</li>
<li>如果是后置付费，也应该在填写资料之后，才生成用户（否则就会有很多空用户）</li>
</ul>
</li>
<li>用户如果拒绝定位，该用户的 geo 字段就为 null，这个时候，我们不仅要考虑到当前用户的 geo 是否为 null，也要考虑到目标用户的 geo 是否为 null，否则会发生很严重的问题</li>
</ul>
<p><a href="https://zhuanlan.zhihu.com/p/262777442" target="_blank" rel="noopener noreferrer">陌生人社交算法拆解 - 补充 - 知乎</a></p>
<p><a href="https://mp.weixin.qq.com/s/zqGKAMMwnGJxqMYZnIkGQg" target="_blank" rel="noopener noreferrer">基于双向匹配的陌生人社交策略及算法思考</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="冯诺依曼体系">冯诺依曼体系<a href="#冯诺依曼体系" class="hash-link" aria-label="Direct link to 冯诺依曼体系" title="Direct link to 冯诺依曼体系">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><ul>
<li><code>文件</code>是对<code>I/O 设备</code>的抽象</li>
<li><code>虚拟内存</code>是对<code>内存和硬盘</code>的抽象</li>
<li><code>进程</code>是对一个<code>正在运行的程序</code>的抽象</li>
</ul></div></div>
<p>冯诺依曼体系的特点？<em>五元组 + 二进制</em></p>
<ul>
<li>程序存储执行<!-- -->
<ul>
<li>计算机是靠诸多晶体管控制电路而运行，早期的计算机是靠手动控制电路执行，这种设计缺点在于，程序是一次性执行，即没办法存储起来反复执行；</li>
<li>冯·诺依曼体系计算机，则提出了程序是可存储执行，即人们把要执行的程序存储在一个地方，然后在运行的时候让 CPU 去固定的地方去取，这样做的好处是程序可以存储起来多次运行，且修改程序不需要手动调整电路；</li>
</ul>
</li>
<li>二进制逻辑<!-- -->
<ul>
<li>十进制逻辑的计数有利于人类阅读，但不利于电路设计，在电路中，状态一般有两种开启或者关闭，二进制逻辑的设计简化了计算机内部电路的设计</li>
</ul>
</li>
</ul>
<hr>
<p>冯诺依曼体系的组成？(五元组是哪些？)</p>
<ul>
<li><em>计算、控制、存储、输入输出五个元素</em></li>
<li>控制器、运算器以及寄存器组成 CPU</li>
<li>内存，负责存储</li>
<li>I/O 设备，输入输出设备，除了 CPU 和内存之外的所有设备</li>
</ul>
<hr>
<p>冯诺依曼体系的瓶颈？</p>
<p><em>CPU 再快，也要等内存，也就是存储速度跟不上计算的速度，因为 CPU 和内存之间的性能差距越来越大</em></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mmap">mmap<a href="#mmap" class="hash-link" aria-label="Direct link to mmap" title="Direct link to mmap">​</a></h3>
<p><strong><a href="https://www.codedump.info/post/20220327-weekly-11/" target="_blank" rel="noopener noreferrer">周刊（第 11 期）：mmap 适用于存储引擎吗？ - codedump 的网络日志</a></strong></p>
<p>MongoDB 一开始就是用 mmap 作为存储引擎</p>
<p>这篇文章中提到 boltDB 也是把 mmap 作为存储引擎</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">看了上面对页面管理器这个模块功能的描述，可以看到：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">由于有页面缓存的作用，所以能够精准的控制页面缓存的大小。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">将“脏页面落盘”这个操作，是与具体的事务有关，并不是修改完毕就能直接落盘，否则的话可能会涉及到脏写等问题。比如一个事务修改了 1、2、3 三个 PID 的页面，修改页面 1 之后并不能马上落盘这个修改，需要等到三个页面都改完了才行。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我们来看看如果使用 mmap 技术来代替上面的“页面管理器”会面对什么问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">首先，无法做到对内存容量的精准控制。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">其次，写事务如何处理，因为当使用 mmap 技术修改了一个页面时，实际上这个被修改的页面内容何时被 OS 内核落到硬盘，已经不由使用者来控制了，那么如何解决上面提到的一个事务修改了多个页面需要同时落盘的问题？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">以 boltdb 为例，它使用的是类似 COW 的机制来解决：</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">使用 mmap 来替代自实现的页面管理器最大的就是这两个问题：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">无法做到精准控制页面缓存容量。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">采用类 COW 的做法来解决写事务问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">上面的第二个问题有解决方案，但是问题一貌似没有。所以一个存储引擎如果使用 mmap 来实现页面管理，可以说这个存储引擎可能只适用于“内存不敏感”的业务场景。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>总结来  说就是，<strong>用 mmap 作为 SE 最核心的问题，就是无法做到对内存容量的精准控制。</strong></p>
<p>这部分内容可以和 MongoDB SE 结合来看。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cmd-和-entrypoint">CMD 和 ENTRYPOINT<a href="#cmd-和-entrypoint" class="hash-link" aria-label="Direct link to CMD 和 ENTRYPOINT" title="Direct link to CMD 和 ENTRYPOINT">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><em>总的来说，使用 RUN 指令安装应用和软件包，构建镜像。如果 Docker 镜像的用途是运行应用程序或服务，比如运行一个 MySQL，应该优先使用 Exec 格式的 ENTRYPOINT 指令。CMD 可为 ENTRYPOINT 提供额外的默认参数，同时可利用 docker run 命令行替换默认参数。如果想为容器设置默认的启动命令，可使用 CMD 指令。用户可在 docker run 命令行中替换此默认命令。</em></p></div></div>
<ul>
<li>CMD 指令允许用户指定容器的默认执行的命令。此命令会在容器启动且 docker run 没有指定其他命令时运行</li>
<li>ENTRYPOINT 的 Exec 格式用于设置容器启动时要执行的命令及其参数，同时可通过 CMD 命令或者命令行参数提供额外的参数。ENTRYPOINT 中的参数始终会被使用，这是与 CMD 命令不同的一点。</li>
</ul>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">好的，我来进一步简化解释：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> </span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">CMD 指令</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 它定义了容器启动时默认执行的命令。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 用户在运行容器时可以通过命令行替换这个默认命令。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> </span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">ENTRYPOINT 指令</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 它定义了容器启动时必须执行的主命令。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 用户在运行容器时可以通过命令行向这个主命令添加参数，但不能替换主命令本身。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">区别</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`CMD`</span><span class="token plain"> 可以被用户完全替换，包括命令和参数。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`ENTRYPOINT`</span><span class="token plain"> 只能接受用户添加的参数，不能被替换。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">例子</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">假设我们有一个 Dockerfile，里面定义了如下指令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important"> 使用 CMD 指令</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD [&quot;echo&quot;, &quot;Hello World&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important"> 使用 ENTRYPOINT 指令</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENTRYPOINT [&quot;echo&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD [&quot;Hello World&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 对于使用 </span><span class="token code-snippet code keyword" style="color:#00009f">`CMD`</span><span class="token plain"> 的容器，用户可以通过命令行完全替换默认命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  docker run myimage ls -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  这里，</span><span class="token code-snippet code keyword" style="color:#00009f">`echo &quot;Hello World&quot;`</span><span class="token plain"> 被 </span><span class="token code-snippet code keyword" style="color:#00009f">`ls -l`</span><span class="token plain"> 替换了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 对于使用 </span><span class="token code-snippet code keyword" style="color:#00009f">`ENTRYPOINT`</span><span class="token plain"> 的容器，用户只能添加参数，不能替换 </span><span class="token code-snippet code keyword" style="color:#00009f">`echo`</span><span class="token plain">：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  docker run myimage &quot;Hello Kimi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  这里，</span><span class="token code-snippet code keyword" style="color:#00009f">`echo`</span><span class="token plain"> 后面添加了参数 </span><span class="token code-snippet code keyword" style="color:#00009f">`&quot;Hello Kimi&quot;`</span><span class="token plain">，但 </span><span class="token code-snippet code keyword" style="color:#00009f">`echo`</span><span class="token plain"> 命令本身没有被替换。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">希望这次解释更清晰了！如果还有疑问，随时问我。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lotabout">lotabout<a href="#lotabout" class="hash-link" aria-label="Direct link to lotabout" title="Direct link to lotabout">​</a></h3>
<p><a href="https://lotabout.me/2019/Data-Synchronization-in-Distributed-System/" target="_blank" rel="noopener noreferrer">分布式系统常见同步机制 | 三点水</a></p>
<p><a href="https://lotabout.me/2018/Weighted-Random-Sampling/" target="_blank" rel="noopener noreferrer">加权随机采样 (Weighted Random Sampling) | 三点水</a></p>
<p><a href="https://lotabout.me/2020/QQA-Isolation-Level-of-Database/" target="_blank" rel="noopener noreferrer">事务隔离级别备忘 | 三点水</a></p>
<p><a href="https://lotabout.me/2020/Back-Pressure/" target="_blank" rel="noopener noreferrer">背压(Back Pressure)与流量控制 | 三点水</a></p>
<p><a href="https://lotabout.me/2022/MESI-Protocol-Introduction/" target="_blank" rel="noopener noreferrer">MESI 协议学习笔记 | 三点水</a></p>
<p><a href="https://lotabout.me/2022/False-Sharing-Introduction/" target="_blank" rel="noopener noreferrer">伪共享（False Sharing）简介 | 三点水</a></p>
<p><a href="https://lotabout.me/2018/skip-list/" target="_blank" rel="noopener noreferrer">跳表──没听过但很犀利的数据结构 | 三点水</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="btree-bptree">btree, bptree<a href="#btree-bptree" class="hash-link" aria-label="Direct link to btree, bptree" title="Direct link to btree, bptree">​</a></h3>
<p><a href="https://www.codedump.info/post/20200609-btree-1/#%E6%83%85%E5%86%B53-b%E4%B8%8E%E5%85%84%E5%BC%9F%E8%8A%82%E7%82%B9%E5%90%88%E5%B9%B6%E6%95%B0%E6%8D%AE" target="_blank" rel="noopener noreferrer">B树、B+树索引算法原理（上） - codedump的网络日志</a></p>
<p><a href="https://www.codedump.info/post/20200615-btree-2/" target="_blank" rel="noopener noreferrer">B树、B+树索引算法原理（下） - codedump的网络日志</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="极客时间golang-面试题pdf20231127-am">极客时间《golang 面试题.pdf》[2023/11/27 AM]<a href="#极客时间golang-面试题pdf20231127-am" class="hash-link" aria-label="Direct link to 极客时间《golang 面试题.pdf》[2023/11/27 AM]" title="Direct link to 极客时间《golang 面试题.pdf》[2023/11/27 AM]">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">一般使用 list. 结构作为队列，rpush 生产消息，Ipop 消费消息。当 1Dop 没有消息的时候，要适当 sleep 一会再重试。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果对方追问可不可以不 用 sleep 呢？list 还有个指令叫 blpop，在没有消息的时候，它会阳塞佳直 到消息到来。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果对方追问能不能生产一次消费多次呢？使用 pub/sub 主题订 阅者模式，可以实现 1:N 的消息队列。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">使用 sortedset，拿时间戳作为 score，消息内容作为 key 调用 zadd 来生产消息，消费者用 zrangebyscore 指令获取 N 秒之前的数据轮询进行处理。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>rdb 也是 bg_save 吗？</p>
<p>golang slice 有（指向底层数组的）指针、cap 和 len，这个底层数组就是一个标准的 array 数据结构，线性数据结构。</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important">那这个底层数组有哪几个字段呢？</span><br></span><span class="token-line" style="color:#393A34"><span class="token title important"></span><span class="token title important punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在 Golang 中，数组是一种固定长度的数据结构，它只包含一个字段：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">元素（Elements）：表示数组中的元素。元素的类型取决于数组的定义。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">数组的元素可以通过索引访问和修改。数组的长度是定义数组时指定的固定值，它是数组类型的一部分。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这个底层数组就是一个标准的 array 数据结构是吗？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">是的，底层数组就是一个标准的数组数据结构。在 Golang 中，切片（slice）是基于数组的一种动态长度的数据结构，它通过指针、长度和容量字段来操作底层数组。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">底层数组是一个固定长度的数据结构，所有元素的类型相同。它通过索引访问和修改元素，支持常见的数组操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">切片通过指针字段指向底层数组的第一个元素，通过长度字段表示切片中实际包含的元素数量，通过容量字段表示切片可以扩展的最大元素数量。这些字段是切片在运行时管理底层数组的关键。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">切片提供了一种便捷的方式来操作底层数组，使得数组的使用更加灵活和高效。通过切片，我们可以动态地增加或缩减数组的大小，而不需要手动 管理内存。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">希望这能回答你的问题！如果还有其他疑问，请随时提问。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important">golang slice 扩容是发生在内存对齐时吗？</span><br></span><span class="token-line" style="color:#393A34"><span class="token title important"></span><span class="token title important punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在 Golang 中，切片的扩容是在需要扩展容量时发生的，而不是在内存对齐时。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">切片的容量是指切片可以扩展的最大元素数量，当切片的长度超过了容量时，需要扩展容量以容纳更多的元素。在扩容时，Golang 会创建一个新的底层数组，并将切片指向这个新数组。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">切片的扩容策略是根据当前切片的长度决定的。当切片的长度小于 1024 时，每次扩容会将容量翻倍。当切片的长度大于等于 1024 时，每次扩容会将容量增加 25%，直到达到所需容量。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">内存对齐是指数据在内存中存储时按照一定规则对齐的过程，它与切片的扩容没有直接的关系。内存对齐是为了提高内存访问的效率和数据结构的存储紧凑性。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">所以，切片的扩容和内存对齐是两个不同的概念，它们发生在不同的阶段和目的上。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">希望这能解答你的问题！如果还有其他疑问，请随时提问。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">那“切片在扩容时会进行内存对齐”的说法对吗？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">抱歉，我之前的回答可能有些混淆。在 Golang 中，切片的扩容和内存对齐是两个独立的概念，它们并没有直接的关联。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">当切片需要扩容时，Golang 会创建一个新的底层数组，并将切片指向这个新数组。扩容过程中，并不涉及到内存对齐的操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">内存对齐是一个与数据结构存储有关的概念，它是为了提高内存访问的效率和数据结构的存储紧凑性。内存对齐是在编译器或者运行时将数据按照一定规则对齐存储的过程。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">所以，切片的扩容和内存对齐是两个不同的概念，它们发生在不同的阶段和目的上。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">非常抱歉给你带来的困惑，希望这次的回答更加明确。如果还有其他疑问，请随时提问。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>IPC 临界区、互斥量</p>
<p>协程和线程的区别？异步、非抢占式、用户态和内核态</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">协程与线程的区别？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">•线程和进程都是同步机制，而协程是异步机制。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">•线程是抢占式，而协程是非抢占式的。需要用户释放使用权切换到其他协 程，因此同一时间其实只有一个协程拥有运行权，相当于单线程的能力。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">•一个线程可以有多个协程，一个进程也可以有多个协程。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">•协程不被操作系统内核管理，而完全是由程序控制。线程是被分割的 CPU 资源，协程是组织好的代码流程，线程是协程的资源。但协程不会直接使 用线程，协程直接利用的是执行器关联任</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>缓存击穿</p>
<p>这个我之前还真不知道，把缓存击穿和缓存穿透弄混了</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">那缓存击穿不就是缓存穿透吗？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">不是完全一样的。缓存击穿和缓存穿透是两个不同的问题。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">缓存击穿是指在缓存系统中，一个特定的 key 对应的缓存项在某个时间点被大量请求同时访问，而该缓存项此时不在缓存中，导致请求直接访问数据库或其他数据源，增加了系统的负载。解决缓存击穿问题的方法通常是使用互斥锁或者分布式锁来保证只有一个请求去访问数据库，其他请求等待该请求的结果。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">缓存穿透是指在缓存系统中，一个特定的 key 对应的数据在数据库或其他数据源中不存在，导致每次请求该数据时都会访问数据库或其他数据源，增加了系统的负载。解决缓存穿透问题的方法通常是在缓存中添加一个空值或默认值，避免多次访问数据库。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总之，缓存击穿和缓存穿透是两个不同的问题，虽然它们都与缓存有关，但解决方法和原因是不同的。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>总结一下，二者都是某个 key 被高并发请求，表现都是缓存层被穿透，数据库被高并发请求，<strong>区别在于这个 key 在数据库中是否存在，如果 key 存在就是击穿，key 不存在就是穿透</strong>。</p>
<p>gozero 本身提供的对 cache 的处理就比较好：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">缓存穿透：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 即使查不到，也自动缓存，1min 过期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">缓存击穿：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 通过 mutex 保证只有一个请求去访问数据库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">缓存雪崩：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 给缓存 key 自动设置随机过期时间，确保不会集中过期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>mutex 什么情况下自旋？</p>
<p>RWMutex 的实现？</p>
<p>wg 的实现原理？</p>
<p>atomic 和锁的区别？atomic 由底层硬件实现，锁则由 OS 的调度器实现</p>
<hr>
<p>CAS</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CAS 的全称为 Compare AndSwap，直译就是比较交换。是一条 CPU 的原子指令，其作用是  让 CPU 先进行比较两个值是否相等，然后原子地更新某个位置的值，其实现方式是给予硬件平台的汇编指令，在 intel 的 CPU 中，使用的 cmpxchg 指令，就是说 CAS 是靠硬件实现的，从而在硬件层面提升效率。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>mutex 的几种状态？mutexLocked, mutexWoken, mutexStarving, <del>waitersCount</del></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">饥饿模式的触发条件：当一个 goroutine 等待锁时间超过 1 毫秒时，或者当前队列只剩下一个 goroutine 的时候，Mutex 切换到饥饿模式。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总结</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">对于两种模式，正常模式下的性能是最好的，goroutine 可以连续多次获取锁，饥饿模式解決了 取锁公平的问题，但是性能会下降，这其实是是性能和公平的一个平衡模式。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>正常模式和饥饿模式，其实可以理解为 TCP 的窗口，都是性能和可靠性的取舍</p>
<hr>
<p>然后是一大坨 GMP 相关的问题，我这部分确实不太懂，也没整理过</p>
<p>GMP 指的是什么？</p>
<p>GMP 的调度流程？</p>
<p>GMP 中的 work stealing 机制？</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">获取 P 本地队列，当从绑定 P 本地 runa 上找不到可执行的 g，尝试从全局链表中拿，再拿不到从 metpoll 和事件池里拿，最后会从别的 P 里偷任务。P 此时去唤醒一个 M。P 继续执行其它的程序。M 寻找是否有空闲的 P，有则将该 G 对象移动到它本身。接下来 M 执行一个调度循环（调用 G 对象-&gt;执行-&gt;清理线程＞继续找新的 Goroutine 执行）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>GMP 中的 hand off 机制？</p>
<p>GMP 调度过程中存在哪些阻塞？</p>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">插入写屏障</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Go GC 在混合写屏障之前，一直是插入写屏障，由于栈赋值没有 hook，栈中没有启用写屏障，所以有 STW。Golang 的解决方法是：只是需要在结束时启动 STW 来重新扫描栈。这个自然就会导致整个进程的赋值器卡顿。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>微服务架构 的优缺点是什么？</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">微服务架构的优点 微服务架构的缺点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">自由使用不同的技术 增加故障排除挑战</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">每每个微服务都侧重于单一功能 由于远程调用而增加延迟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">支持单个可部署单元 增加了配置和其他操作的工作量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">允许经常发布软件 难以保持交易安全</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">确保每项服务的安全性 艰难地跨越各种便捷跟踪数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个总结的还行，所以摘录下来，微服务肯定是双刃剑，利弊说的很清晰了，包括 ms 中的 logging 之类服务不就是为了解决缺点而存在的吗？</p>
<hr>
<p>golang map 扩容机制？</p>
<p><del>基本类似 redis 的 map，从实现到扩容缩容</del> 这块还得好好看看，对比一下</p>
<hr>
<p>golang map 查找数据的具体流程？</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Go 语言中 map 采用的是哈希查找表，由一个 key 通过哈希函数得到哈希值，64 位系统中就生成一个 64bit 的哈希值，由这个哈希值将 key 对应存到不同的桶（bucket）中，当有多个哈希映射到相同的的桶中时，使用链表解決哈希冲突。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">细节：key 经过 hash 后共 64 位，根据 hmap 中 B 的值，计算它到底要落在哪个桶时，桶的数量为 2^B，如 B=5，那么用 64 位最后 5 位表示第几号桶，在用 hash 值的高 8 位确定在 bucket 中的存储位置，当前 bmap 中的 bucket 未找到，则查询对应的 overflowbucket，对应位置有数据则对比完整的哈希值，确定是否是要查找的数据。如果当前 map 处于数据搬移状态，则优先人 oldbuck-ets 查找。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>chan ringbuffer</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">channel 收发遵循先进先出 FIFO 的原则。分为有缓冲区和无缓冲 区，channel 中包括 buffer、sendx 和 recvx 收发的位置 (ringbuffer 记录实现)、sendq、recv。当 channel 因为缓区不足而阻塞了队列，则使用双向链 表存储。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">混合写屏障</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">混合写屏障继承了插入写屏障的优点，起始无需 STW 打快照，直接井发扫描垃圾即可；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">混合写屏障继承了删除写屏障的优点，赋值器是黑色赋值器，GC 期间，任何在栈上创建的新对象，均为黑色。扫描过一次就不需要扫描了，这样就消除了插入写屏障时期最后 STW 的重新扫描栈；混合写屏障扫描精度继承了删除写屏障，比插入写屏障更低，随着带来的 是 GC 过程全程无</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>为什么虛拟地址空问切换会比较耗时？</p>
<p>这个问题确实不懂</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">进程都有自己的虛拟地址空问，把虚拟地址转換为物理地址需要查找页表，页表查找是一个很慢的程，因此通常使用 Cache 来缓存常用的地址映射，这样可以加速页表查找，这个 Cache 就是 TLB translation LookasideBuffer，TLB 本质上就是一个 Cache，是用来加速页表查找的）。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">虚拟地址空间切换就是上下文切换吧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">不完全正确。虚拟地址空间切换是在进程切换时，将一个进程的虚拟地址空间映射到物理内存中。而上下文切换是在多任务操作系统中，切换当前执行的进程或线程的上下文环境，包括寄存器、程序计数器等。虚拟地址空间切换是上下文切换的一部分。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important">为什么 golang 的引用类型时 slice, map, chan？</span><br></span><span class="token-line" style="color:#393A34"><span class="token title important"></span><span class="token title important punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Golang 选择将 slice、map 和 chan 作为引用类型的原因是为了提供更高效的内存管理和更灵活的数据操作。引用类型意味着变量存储的是对数据结构的引用，而不是实际的数据本身。这样可以减少数据的复制和传递，节省内存空间，并且允许在不同的 goroutine 之间共享数据。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Slice 是一个动态数组，它包含一个指向底层数组的指针、长度和容量。通过使用 slice，我们可以方便地对数组进行切片、追加、插入和删除等操作，而不需要显式地管理底层数组的大小。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Map 是一种键值对的集合，它提供了一种快速检索和更新数据的机制。通过使用 map，我们可以根据键快速查找对应的值，而不需要遍历整个集合。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chan 是用于多个 goroutine 之间进行通信的管道。它提供了一种同步和异步的消息传递机制，可以安全地在不同的 goroutine 之间传递数据。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总的来说，这些引用类型在 Golang 中被广泛使用，可以帮助开发人员更高效地处理和管理数据。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">那为什么其他数据类型不是引用类型？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在 Golang 中，其他数据类型并不是引用类型是因为它们的数据存储方式不同。引用类型是指变量存储的是数据的内存地址，而不是数据本身。这意味着多个变量可以指向同一个数据。而其他数据类型，如整数、浮点数、布尔值等，它们的值直接存储在变量中，而不是通过地址引用。这样做的好处是可以更高效地存储和操作这些数据类型。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>这里只做整理，相关重要问题已经在 docs 里标注</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>今天搞这个的时候的一些感想</p><p>多下结论，多刺激</p><p>这两点是我一直以来做的不好的地方。注意是“多下结论”，而非“多总结”。因为总结往往也是连篇累牍的（balabala 一大堆，在某种情况下如何如何，在另一种情况下又如何如何），我不够聪明，记不住这么多。而结论往往只是切面化的，只需要有个印象即可，也就是 80% 以上的绝大 部分情况，对细节要求没有那么搞。一两句话就结束，更容易形成印象，也更容易记忆。<strong>其实编顺口溜不就是这个作用吗？</strong></p><p>多刺激，则是做的更差的点。记忆是需要刺激的，即使每天都在写代码，但是一些隔段时间不用的（即使之前非常熟悉的）知识点，也会感觉一无所知（当然，其实并不是一无所知，通常是两点，就是之前没下结论，也没有经常刺激记忆）。这点在面试前会很明显，拿到一份面试题，感觉一个都不会，但是每个又都能说出来一点点，这就是没做好记忆刺激。东西还是要没事拿出来亮亮晒晒才好。我实现的 <code>docs-training</code> 和 <code>interview-template</code> 就是用来搞这个的。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="zzz-1">zzz<a href="#zzz-1" class="hash-link" aria-label="Direct link to zzz" title="Direct link to zzz">​</a></h3>
<p><a href="https://www.bilibili.com/video/BV1ny4y1U79P/" target="_blank" rel="noopener noreferrer">【硬核分享】作为大厂面试官，我是如何面试程序员的_哔哩哔哩_bilibili</a></p>
<p>大厂通常线上笔试 +3~4 轮技术面+HR 面，3 轮技术通常是 team 内资深同事、teamleader、其他团队的 teamleader。</p>
<p>2 页纸以内
了解、熟悉、精通</p>
<p>了解就是基础使用，熟悉就是 xxx，精通就是熟悉源码。所以基本上我们</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">STAR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">situation 事情是在什么背景下发生的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">task 要干什么事</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">action 采用了什么行动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">result 结果怎样，最终得到什么结果</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>STAR</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="链表hashmap">链表+HashMap<a href="#链表hashmap" class="hash-link" aria-label="Direct link to 链表+HashMap" title="Direct link to 链表+HashMap">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">还有哪些算法是用链表+HashMap 实现的？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">除了 LRU Cache 和 LFU Cache，还有一些其他算法也可以使用链表和 HashMap 的组合来实现，例如：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 哈希链表（Hash Linked List）：这种数据结构将链表和 HashMap 结合在一起，用于快速的插入、删除和查找操作。每个链表节点包含一个键和一个值，而 HashMap 用于存储链表节点的引用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 哈希集合（Hash Set）：哈希集合使用链表和 HashMap 实现，其中链表节点用于存储元素，并使用 HashMap 来实现快速的查找和删除操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 哈希图（Hash Graph）：哈希图是一种使用链表和 HashMap 实现的图数据结构。每个图节点包含一个值和一个链表，链表中存储了与该节点相邻的其他节点的引用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 哈希表（Hash Table）：哈希表是一种使用链表和 HashMap 实现的散列表。它将键值对存储在链表节点中，并使用 HashMap 来实现快速的插入、删除和查找操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这些都是一些使用链表和 HashMap 组合实现的常见算法和数据结构。它们的设计目的是在保持高效性能的同时，提供灵活的数据操作和查询能力。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">链表+HashMap 是一种很经典的组合，还有哪些算法是使用这种组合作为数据结构实现的？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">除了上述提到的 LRU Cache、LFU Cache、哈  希链表、哈希集合、哈希图和哈希表之外，还有一些其他算法也可以使用链表和 HashMap 组合作为数据结构实现，例如：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 有序链表（Ordered Linked List）：使用链表和 HashMap 实现的有序链表，可以在常数时间内进行插入、删除和查找操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 栈（Stack）：使用链表和 HashMap 实现的栈，可以在常数时间内进行压栈、弹栈和查看栈顶元素操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 队列（Queue）：使用链表和 HashMap 实现的队列，可以在常数时间内进行入队、出队和查看队首元素操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 图的遍历算法（如深度优先搜索和广度优先搜索）：使用链表和 HashMap 组合实现图的遍历算法，其中链表用于存储节点的邻接关系，HashMap 用于记录已经访问过的 节点。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">5.</span><span class="token plain"> 并查集（Disjoint Set Union）：使用链表和 HashMap 实现的并查集数据结构，用于高效地合并和查找集合。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这些算法和数据结构都是基于链表和 HashMap 的组合实现的，它们的设计旨在提供高效的数据操作和查询能力，同时兼顾灵活性和可扩展性。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分布式锁-核心需求">分布式锁 核心需求<a href="#分布式锁-核心需求" class="hash-link" aria-label="Direct link to 分布式锁 核心需求" title="Direct link to 分布式锁 核心需求">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;&quot;: &quot;防死锁&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;redis&quot;: &quot;expire&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;zk&quot;: &quot;✅ 临时节点&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;&quot;: &quot;锁唤醒&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;redis&quot;: &quot;本身不支持，拓展包支持 (通过轮询检测锁是否空闲，空闲就唤醒内部加锁线程)&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;zk&quot;: &quot;监听机制 (watcher/notify)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;&quot;: &quot;互斥&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;redis&quot;: &quot;&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;zk&quot;: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;&quot;: &quot;可重入&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;redis&quot;: &quot;&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;zk&quot;: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;&quot;: &quot;高可用&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;redis&quot;: &quot;redlock&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;zk&quot;: &quot;✅ zab 协议&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;&quot;: &quot;高并发（服务端）&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;redis&quot;: &quot;✅ Redis 基于内存，只写 Master 就算成功，吞吐量高，Redis 服务器压力小。&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;zk&quot;: &quot;Zk 基于 Zab 协议，需要一半的节点 ACK，才算写入成功，吞吐量较低。&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;&quot;: &quot;高并发（客户端）&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;redis&quot;: &quot;Redis 并没有通知机制，它只能使用类似 CAS 的轮询方式去争抢锁，较多空转，会对客户端造成压力。&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;zk&quot;: &quot;✅ Zk 由于有通知机制，获取锁的过程，添加一个监听器就可以了。避免了轮询，性能消耗较小。&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;&quot;: &quot;实现难度&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;redis&quot;: &quot;Redis 需要考虑太多异常场景，比如锁超时、锁的高可用等，实现难度较大。&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;zk&quot;: &quot;Zk 的 ZNode 天然具有锁的属性，所以直接上手撸的话，很简单。&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">实现方式的不同，Redis 实现为去插入一条占位数据，而 ZK 实现为去注册一个临时节点。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">遇到宕机情况时，Redis 需要等到过期时间到了后自动释放锁，而 ZK 因为是临时节点，在宕机时候已经是删除了节点去释放锁。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Redis 在没抢占到锁的情况下一般会去自旋获取锁，比较浪费性能，而 ZK 是通过注册监听器的方式获取锁，性能而言优于 Redis。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="redis-分布式锁-方案演进"><em>redis 分布式锁 方案演进</em><a href="#redis-分布式锁-方案演进" class="hash-link" aria-label="Direct link to redis-分布式锁-方案演进" title="Direct link to redis-分布式锁-方案演进">​</a></h3>
<ul>
<li><code>setNX EX</code>，加上 expire 可以防止锁<code>忘记释放</code>的问题，但是无法解决<code>超时释放</code>问题</li>
<li><code>redission</code>，<em>利用锁的可重入性，开启一个守护线程定时 (expire/3) 检查锁是否存在，存在则续锁 (刷新 expire)</em>，避免了<code>锁被提前释放</code>和<code>被误删</code>的问题，解决了<code>超时释放</code>问题，保证了<code>单机环境</code>下分布式锁的可用性，但是在<em>redis 集群下，主从切换会发生<code>锁丢失问题</code></em>，比如原 master 节点带着锁 ODOWN 了，新 master 拿不到锁</li>
<li><code>redlock</code></li>
</ul>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;methods&quot;: &quot;setnx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;忘记释放锁&quot;: &quot;✅&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;锁超时释放&quot;: &quot;&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;主从复制锁丢失&quot;: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;methods&quot;: &quot;redison&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;忘记释放锁&quot;: &quot;✅&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;锁超时释放&quot;: &quot;✅&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;主从复制锁丢失&quot;: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;methods&quot;: &quot;redlock&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;忘记释放锁&quot;: &quot;✅&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;锁超时释放&quot;: &quot;✅&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;主从复制锁丢失&quot;: &quot;✅&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>未释放或者错误释放的几种情况：</p>
<ul>
<li>B 锁被 A 给释放了</li>
<li>数据库事务超时</li>
<li>锁超时释放了，业务还没执行完</li>
<li>redis 主从复制，锁丢失：客户端 A 对 master 节点加锁，master 节点主从复制给 slave 节点，此时 master 节点宕机，主从切换，slave 节点成为 master 节点; 此时客户端 B 来尝试加锁时，新 master 节点仍然可以加锁，而客户端 A 认为自己加锁成功，进行解锁操作，但是解锁失败; 多个客户端都可以完成加锁，真正需要解锁却解不了锁;</li>
</ul>
<p>实际上，演进过程中解决了一下几个问题，按版本顺序如下：</p>
<p><a href="https://dbaplus.cn/news-158-2491-1.html" target="_blank" rel="noopener noreferrer">对比各类分布式锁缺陷，抓住 Redis 分布式锁实现命门</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="redlock">RedLock<a href="#redlock" class="hash-link" aria-label="Direct link to RedLock" title="Direct link to RedLock">​</a></h3>
<p><em>可以看见 RedLock 基本原理是利用多个 Redis 集群，用多数的集群加锁成功，减少 Redis 某个集群出故障，造成分布式锁出现问题的概率。</em></p>
<p><em>概括一下，因为分布式环境下，所以对所有 redis 实例进行<code>setNx</code>操作 (redission 是通过复制加锁)，后面的操作都是为了保证无论锁 获取成功或者失败情况下的数据一致性</em></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 客户端获取当前的时间戳。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 对 N 个 Redis 实例进行获取锁的操作，具体的操作同单机分布式锁 (对 Redis 实例的操作时间需要远小于分布式锁的超时时间，这样可以保证在少数 Redis 节点 Down 掉的时候仍可快速对下一个节点进行操作)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 客户端会记录所有实例返回加锁成功的时间，只有从多半的实例 (在这里例子中 &gt;= 3) 获取到了锁，且操作的时间远小于分布式锁的超时时间，才能获取锁。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 如果锁获取成功，当前分布式锁的合法时间为初始设定的合法时间减去上锁所花的时间。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">5.</span><span class="token plain"> 若锁获取失败，会强制对所有实例进行锁释放的操作，即使这个实例上不存在相应的键值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">假设 Redis 的部署模式是 Redis Cluster，总共有 5 个 Master 节点。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">通过以下步骤获取一把锁：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">获取当前时间戳，单位是毫秒。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">轮流尝试在每个 Master 节点上创建锁，过期时间设置较短，一般就几十毫秒。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">尝试在大多数节点上建立一个锁，比如 5 个节点就要求是 3 个节点（n / 2 +1）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">客户端计算建立好锁的时间，如果建立锁的时间小于超时时间，就算建立成功了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">要是锁建立失败了，那么就依次删除这个锁。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">只要别人建立了一把分布式锁，你就得不断轮询去尝试获取锁。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">具体的步骤如下：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">首先生成多个 Redis 集群的 Rlock，并将其构造成 RedLock。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">依次循环对三个集群进行加锁，加锁的过程和 5.2 里面一致。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如果循环加锁的过程中加锁失败，那么需要判断加锁失败的次数是否超出了最大值，这里的最大值是根据集群的个数，比如三个那么只允许失败一个，五个的话只允许失败两个，要保证多数成功。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">加锁的过程中需要判断是否加锁超时，有可能我们设置加锁只能用 3ms，第一个集群加锁已经消耗了 3ms 了。那么也算加锁失败。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3，4 步里面加锁失败的话，那么就会进行解锁操作，解锁会对所有的集群在请求一次解锁。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><a href="https://segmentfault.com/a/1190000022734691" target="_blank" rel="noopener noreferrer">redis 分布式锁的 5 个坑，真是又大又深 - Java 进阶课 - SegmentFault 思否</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="golang-nethttp">golang net/http<a href="#golang-nethttp" class="hash-link" aria-label="Direct link to golang net/http" title="Direct link to golang net/http">​</a></h3>
<p><a href="https://mp.weixin.qq.com/s?__biz=Mzg3NTU3OTgxOA==&amp;mid=2247497925&amp;idx=2&amp;sn=192859739521eb43c192c5ca43debc8e" target="_blank" rel="noopener noreferrer">i/o timeout，希望你不要踩到这个 net/http 包的坑</a></p>
<p>不要在<code>http.Transport</code>中设置超时，那是连接的超时，不是请求的超时。否则可能会出现莫名<code>io timeout</code>报错。</p>
<p>请求的超时在创建<code>client</code>里设置。</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651453895&amp;idx=1&amp;sn=785280d070131ecbe35828a86c7cbe6c" target="_blank" rel="noopener noreferrer">有趣的 Go HttpClient 超时机制</a></p>
<ul>
<li>怎么重试请求？ <a href="https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651453489&amp;idx=1&amp;sn=431f819375b35ae578db87c16db89962" target="_blank" rel="noopener noreferrer">在 Go 中如何正确重试请求</a></li>
</ul>
<hr>
<p>文件操作 io/os/bufio</p>
<ul>
<li><em><a href="https://mp.weixin.qq.com/s?__biz=MzUxMDI4MDc1NA==&amp;mid=2247496305&amp;idx=2&amp;sn=8f3d13db24875c13fef12862b885f570" target="_blank" rel="noopener noreferrer">超全总结：Go 语言如何操作文件</a></em></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzUxMDI4MDc1NA==&amp;mid=2247497042&amp;idx=2&amp;sn=c8c3abfbe2475c92184128945544b599" target="_blank" rel="noopener noreferrer">Go 眼中的文件系统是什么？io.FS</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=Mzg3NTU3OTgxOA==&amp;mid=2247498487&amp;idx=1&amp;sn=da6c0a0f76b5fb120530fc8b4cc41e28" target="_blank" rel="noopener noreferrer">Go 的 IO 流怎么并发？小技巧分享</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="浏览器相关">浏览器相关<a href="#浏览器相关" class="hash-link" aria-label="Direct link to 浏览器相关" title="Direct link to 浏览器相关">​</a></h3>
<p><a href="https://messiahhh.github.io/blog/docs/browser" target="_blank" rel="noopener noreferrer">浏览器相关 | Akara</a></p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">跨域</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">跨域资源共享（CORS）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">预检请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JSONP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">代理服务器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postMessage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP 缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">强制缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">协商缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hr punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">浏览器客户端存储</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LocalStorage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SessionStorage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cookie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JWT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IndexedDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WebWorker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chrome 插件</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="php">PHP<a href="#php" class="hash-link" aria-label="Direct link to PHP" title="Direct link to PHP">​</a></h2>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="php-函数">PHP 函数<a href="#php-函数" class="hash-link" aria-label="Direct link to PHP 函数" title="Direct link to PHP 函数">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="数组相关函数">数组相关函数<a href="#数组相关函数" class="hash-link" aria-label="Direct link to 数组相关函数" title="Direct link to 数组相关函数">​</a></h3>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">常用数组函数</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">取差集</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">取交集</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">操作指针</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">常用回调函数</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">排序函数</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">容易混淆的数组函数</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><ul>
<li>array_keys 返回数组中部分键名或者所有键名</li>
<li>array_key_exists 看数组中是否有指定的键名或者索引</li>
<li>array_merge 合并一个或者多个数组；array_merge_recursive 递归地合并一个或者多个数组</li>
<li>array_pad 以指定长度将一个值填充进数组</li>
<li>array_product 计算数组中所有值的乘积</li>
<li>array_rand 从数组中随机取出一个或者多个元素</li>
<li>array_replace 用数组替换第一个数组的元素；array_replace_recursive 用数组递归替换第一个数组的元素</li>
<li>array_reverse 返回单元顺序相反的数组</li>
<li>array_search 在数组中搜索给定的值，如果成功则返回首个相应的键名</li>
<li>array_sum 对数组中所有值求和</li>
<li>array_unique() 移除数组中重复的值</li>
<li>array_values() 返回数组中所有的值</li>
<li>array_chunk() 将一个数组分割成多个</li>
<li>array_column() 返回数组中指定的一列</li>
<li>array_combine() 创建一个数组，用一个数组的值作为其键名，另一个数组的值作为其键值</li>
<li>array_count_values() 统计数组中所有的值</li>
<li>array_fill 填充数组；array_fill_keys 用键名和键值填充数组</li>
<li>array_flip 交换数组中的键名和键值</li>
<li>*<em>array_slice 从数组中取出一段，array_splice 去掉数组中的某一部分并用其他值取代</em></li>
</ul></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><ul>
<li>array_diff</li>
<li>array_diff_assoc, array_diff_uassoc</li>
<li>array_diff_key, array_diff_ukey</li>
<li>array_udiff</li>
<li>array_udiff_assoc, array_udiff_uassoc</li>
</ul></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>取出两个数组相同的部分</p><ul>
<li>array_intersect</li>
<li>array_intersect_assoc, array_intersect_uassoc</li>
<li>array_intersect_key, array_intersect_ukey</li>
<li>array_uintersect</li>
<li>array_uintersect_assoc, array_uintersect_uassoc</li>
</ul></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><ul>
<li>each()；当前元素的 kv</li>
<li>current()=pos()</li>
<li>reset()</li>
<li>end()；当前元素和最后一个元素</li>
<li>next()，prev()；下一个，上一个</li>
</ul></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><ul>
<li><code>array_reduce()</code>使用回调函数迭代地将数组简化为单一的值</li>
<li><code>array_map()</code>使用自定义函数对数组中的每个元素做回调处理，自定义函数的返回值为 array*map 返回的新数组的元素；*以得到一个新数组；_<!-- -->
<ul>
<li><em>array_map 返回处理完之后的数组（最终得到一个新数组（这也是 array_map() 和 array_walk() 之间最大的区别））</em></li>
<li>array_walk_recursive()...做递归回调处理</li>
</ul>
</li>
<li><code>array_filter()</code>用回调函数过滤数组中的单元，自定义函数返回 true，则 array_filter 返回的数组保留该元素，否则删除该元素。</li>
<li><code>array_walk()</code>对给定的数组执行执行自定义函数，array*walk 返回 true/false，*操作结果影响原来的数组；_<!-- -->
<ul>
<li>array_walk() 和 array_map 一样，把函数，作用于第二个参数（数组里的每一个元素）</li>
</ul>
</li>
<li>使用 array_map() 等数组回调函数，比 foreach() 的优点有哪些？<!-- -->
<ul>
<li>使用链式调用的时候，逻辑清晰，可以避免临时变量</li>
</ul>
</li>
</ul></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><ul>
<li>sort()/rsort()<!-- -->
<ul>
<li>sort() 对索引数组进行升序排序</li>
<li>rsort() 对索引数组进行降序排序；</li>
</ul>
</li>
<li>asort() 和 arsort() 是一对<!-- -->
<ul>
<li>asort() 对关联数组按照值进行升序排序</li>
<li>arsort() 对关联数组降序；</li>
</ul>
</li>
<li>ksort() 和 krsort() krsort() 按照键名对关联数组进行排序，按照键进行逆向排序，为数组值保留原来的键；成功则返回 true，失败则返回 false</li>
<li>usort(),uasort(),uksort() 都是用户自定义排序</li>
<li>自然排序 natsort(), natcasesort()</li>
</ul></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>array_search(), in_array(), array_key_exists() 的区别？</p><ul>
<li>in_array() 只能判断是否存在，返回 bool 值</li>
<li>array_search() 两个参数，要查找的字符串，数组</li>
<li>array_key_exists() 在 key 存在于数组里的石斛返回 true；key 可以是任何能作为数组索引的值</li>
<li>array_key_exists() 的速度比另外两个要快很多，因为 key 是哈希取得的
array+array 和 array_merge()？</li>
<li>键名为数字时，array_merge() 不会覆盖掉原来的值，但 + 合并数组则会把最先出现的值作为最终结果返回，而把后面的数组拥有相同键名的那些值“抛弃”掉；（不是覆盖）</li>
<li>键名字符时，+仍然把最先出现的值作为最终结果返回，而把后面的数组拥有相同键名的那些值“抛弃”掉，但是 array_merge() 此时会覆盖掉前面相同键名的值</li>
</ul><p>empty(), is_null(), isset() 区别？</p><ul>
<li>isset() 判断变量是否被初始化；并不会判断变量是否为空，并且可以用来判断数组中元素是否被定义过；当使用 isset() 来判断数组元素是否被初始化时，他的效率比 array_key_exists() 高 4 倍左右</li>
<li>empty() 检测变量是否为空；任何一个未初始化的变量，值为 0 或者 false 或者“”空字符串或者 null 的变量，空数组，没有任何属性的对象，都将判断为 empty==true</li>
<li>is_null() 判断变量是否为 null</li>
</ul></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="字符串相关函数">字符串相关函数<a href="#字符串相关函数" class="hash-link" aria-label="Direct link to 字符串相关函数" title="Direct link to 字符串相关函数">​</a></h3>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">字符相关函数</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">str</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">pos</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">replace</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">slashes</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">cmp</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">打印输出</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><ul>
<li>strtolower 字符串变成小写</li>
<li>strtoupper 变大写</li>
<li>ucfirst() 把字符串中的首字符转化为大写</li>
<li>lcfirst() 把字符串中的首字符转化为小写</li>
<li>ucwords() 把字符串中每个单词的首字符变成大写</li>
</ul></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><ul>
<li>strstr() 查找字符串在另一个字符串中第一次出现的位置（大小写不敏感）</li>
<li>stristr() 查 找字符串在另一个字符串中第一次出现的位置（大小写不敏感）</li>
<li>strchr()/strstr() 查找字符串在另一个字符串中第一次出现的位置（大小写不敏感）</li>
<li>strrchr() 查找字符串在另一个字符串中最后一次出现的位置</li>
</ul></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><ul>
<li>strpos() 第一次出现的位置（大小写敏感）</li>
<li>stripos() 第一次出现的位置（大小写不敏感）</li>
<li>strrpos() 查找字符串在另一个字符串中<em>最后一次</em>出现的位置（大小写敏感）</li>
<li>strripos() 查找字符串在另一个字符串中最后一次出现的位置（<em>大小写不敏感</em>）</li>
</ul></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><ul>
<li>str_replace() 替换字符串中的一些字符（大小写敏感）</li>
<li>str_ireplace() 替换字符串中的一些字符（大小写不敏感）</li>
<li>substr_replace() 把字符串的一部分替换成另一个字符串，三个参数</li>
</ul></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><ul>
<li>addslashes() 在预定义的字符前面加反斜杠</li>
<li>addcslashes() 在指定的字符前面加反斜杠</li>
</ul></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><ul>
<li>strncmp() 前 n 个字符的字符串比较（大小写敏感）</li>
<li>strncasecmp() 前 n 个字符的字符串比较（大小写不敏感</li>
<li>strnatcmp()...(大小写敏感)</li>
<li>strnatcasecmp() 使用一种“自然排序”算法来比较两个字符串；（大小写不敏感）</li>
</ul></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><ul>
<li>vfprintf() 把格式化的字符串写到指定的输出流</li>
<li>print() 输出一个或者多个字符串</li>
<li>printf() 输出格式化的字符串</li>
<li>sprintf() 把格式化的字符串写入一个变量中 <code>sprintf(&#x27;%02d&#x27;, $month)</code></li>
<li>vprintf() 输出格式化的字符串</li>
<li>vsprintf() 把格式化的字符串写 入变量</li>
<li>fprintf() 把格式化的字符串写入到指定的输出流</li>
</ul></div></div></div>
<p>容易混淆的字符串函数</p>
<p>strtr() 和 str_replace() 的区别</p>
<ul>
<li>strtr() 性能比 str_replace() 高，但是实用性低，所以能用 strtr 的时候才用</li>
<li>strtr 区分大小写，而 str_replace() 不区分大小写</li>
<li>strtr 的第二个参数可以是数组</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="数字相关函数">数字相关函数<a href="#数字相关函数" class="hash-link" aria-label="Direct link to 数字相关函数" title="Direct link to 数字相关函数">​</a></h3>
<ul>
<li>有哪些常见的计算函数？</li>
<li>PHP 运算时为什么会精度丢失？<!-- -->
<ul>
<li>生活中使用十进制，但是计算机使用二进制。<em>所有十进制整数都可以转换成二进制整数，但是二进制中表示十进制的小数就比较麻烦了</em></li>
<li><em>单精度和双精度的浮点数只包括 7 位或者 15 位的有效小数位，存储需要无限位表示的小数时只能存储近似值</em></li>
</ul>
</li>
<li>PHP 精度丢失，有哪些解决方案？<!-- -->
<ul>
<li><em>任何需要十进制运算的地方，都需要用 decimal 取代 float</em></li>
<li>使用 PHP 的高精度拓展<code>BC Math</code></li>
</ul>
</li>
<li><code>BC Math</code>怎么使用？</li>
</ul>
<hr>
<ul>
<li>fmod() 求余</li>
<li>pow()x 的 y 次方</li>
<li>round() 四舍五入</li>
<li>ceil() 向上取整</li>
<li>floor() 向下取整</li>
<li>sqrt() 平方根</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="文件相关函数">文件相关函数<a href="#文件相关函数" class="hash-link" aria-label="Direct link to 文件相关函数" title="Direct link to 文件相关函数">​</a></h3>
<ul>
<li>is_file() 和 file_exists() 文件存在的情况下，is_file 更快。文件不存在的情况下，file_exits() 更快。</li>
<li>filesize() 取得文件大小</li>
<li>is_readable() 判断文件是  否可读</li>
<li>is_writable() 判断文件是否可写</li>
<li>is_executable() 判断文件是否可执行</li>
<li>filectime()</li>
<li>filemtime()</li>
<li>fileatime() 获取文件的上次访问时间</li>
<li>stat() 获取文件大部分属性值</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="变量">变量<a href="#变量" class="hash-link" aria-label="Direct link to 变量" title="Direct link to 变量">​</a></h3>
<p>预定义变量</p>
<p>全局变量 (全局预定义变量) 在函数外部定义的变量，它的作用域从定义的地方到文件结尾</p>
<ul>
<li>$GLOBALS：global 全局变量，是一个包含了所有全局变量的组合数组，全局变量的名称就是该组合数组的键。</li>
<li>$_GET：HTTP GET 变量，通过 URL 参数传递给当前脚本的变量的数组。</li>
<li>$_POST：HTTP POST 变量，通过 HTTP POST 方式传递给当前脚本的变量的数组。</li>
<li>$_COOKIE：HTTP Cookies 变量，通过 HTTP Cookies 方式传递给当前脚本的变量的数组。</li>
<li>$_SESSION：session 变量，当前脚本可用的 SESSION 变量的数组。</li>
<li>$_REQUEST：HTTP Request 变量，默认情况下包含了 <code>$_GET</code>，<code>$_POST</code> 和 <code>$_COOKIE</code> 的数组。</li>
<li>$_FILES：HTTP 文件上传变量，通过 HTTP POST 方式上传到当前脚本的项目的数组。</li>
<li>$_SERVER：服务器信息变量，包含了诸如头信息 (header)、路径 (path)、以及脚本位置 (script locations) 等信息的数组。这个数组中的项目由 Web 服务器创建。</li>
<li>$_ENV：环境变量，通过环境方式传递给当前脚本的变量的数组。</li>
</ul>
<hr>
<p>局部变量 (局部预定义变量) 在函数内部定义的变量，它的作用域为函数定义范围内。</p>
<ul>
<li><code>$php_errormsg</code>：前一个错误信息，$php_errormsg 变量包含由 PHP 生成的最新错误信息。这个变量只在错误发生的作用域内可用，并且要求 track_errors 配置项是开启的（默认是关闭的）。</li>
<li><code>$HTTP_RAW_POST_DATA</code>：包含 POST 提交的原始数据。</li>
<li><code>$http_response_header</code>：HTTP 响应头，$http_response_header 数组与 get_headers() 函数类似。当使用 HTTP 包装器时，$http_response_header 将会被 HTTP 响应头信息填充。</li>
<li><code>$argc</code>：传递给脚本的参数数目，包含当运行于命令行下时传递给当前脚本的参数的数目。脚本的文件名总是作为参数传递给当前脚本，因此 $argc 的最小值为 1，这个变量仅在 register_argc_argv 打开时可用。</li>
<li><code>$argv</code>：传递给脚本的参数数组，包含当运行于命令行下时传递给当前脚本的参数的数组。第一个参数总是当前脚本的文件名，因此 $argv[0] 就是脚本文件名，这个变量仅在 register_argc_argv 打开时可用。</li>
</ul>
<hr>
<p>在 PHP7 怎么在声明变量时赋值而不报错？</p>
<p>属性中的变量可以初始化，但是初始化的值必须是常数，这里的常数是说 PHP 脚本在编译阶段就可以得到其值，而不依赖其他函数处理才能求值。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="修饰符">修饰符<a href="#修饰符" class="hash-link" aria-label="Direct link to 修饰符" title="Direct link to 修饰符">​</a></h3>
<ul>
<li>final 可以修饰类，方法，属性</li>
<li>final 类不可被继承，不能被重写 (被 final 修饰的类不能被继承，只能被实例化)</li>
<li>final 方法不可被覆盖 (属性不能被定义为 final，只有类和方法才能被定义为 final)</li>
<li>final 不能修饰抽象类和接口类</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="php-运算符">PHP 运算符<a href="#php-运算符" class="hash-link" aria-label="Direct link to PHP 运算符" title="Direct link to PHP 运算符">​</a></h3>
<ul>
<li>三元运算符<!-- -->
<ul>
<li>写法 1<code>$a = $a ？ $a : 1;</code></li>
<li>写法 2<code>$a = $a ？ : 1</code>PHP5.3 引入</li>
<li>写法 3<code>$a = $a ？？ 1</code>PHP7 引入</li>
<li><code>$padLength = $type == &#x27;year&#x27; ？ 4 : 2;</code></li>
</ul>
</li>
<li>类型运算符<!-- -->
<ul>
<li>用 instanceof 来判断一个 PHP 变量是否属于某一类 class 的实例</li>
<li>instanceof 也可用来确定一个变量是不是继承自某一父类的子类的实例</li>
</ul>
</li>
<li>赋值运算符</li>
<li>逻辑运算符<!-- -->
<ul>
<li>AND 和&amp;&amp;的区别？</li>
<li>OR 和||的区别？</li>
</ul>
</li>
<li>组合比较符 (太空船运算符) 组合比较运算符可以轻松实现两个变量的比较，当然不仅限于数值类数据的比较。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="php-的-changelog">PHP 的 changelog<a href="#php-的-changelog" class="hash-link" aria-label="Direct link to PHP 的 changelog" title="Direct link to PHP 的 changelog">​</a></h3>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> PHP7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">PHP7 的严格模式和类型声明</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain">(标量类  型声明，返回类型声明)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 性能提升 (为什么 PHP7 的性能提升很大？)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 变量存储字节减小，减少内存占用，提升变量操作速度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 改善数组结构，数组元素和 hash 映射表被分配在同一块内存里，降低了内存占用，提升了 CPU 缓存命中率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 改进了函数的调用机制，通过优化参数传递的环节，减少了一些指令，提高执行效率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`try...catch...`</span><span class="token plain">（增加多条件判断，分出了 exception 和 error 两种异常类型）php7 之后可以一次捕捉多种类型的异常和错误，通过 | 来实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`闭包`</span><span class="token plain">；支持通过 new class 类实例化一个匿名类，可以用来代替一些 阅后即焚的完整类定义</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`三目运算符的？？`</span><span class="token plain">如果有值则取其值，否则则取 $name = $name？？ &#x27;NoName&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`飞船运算符`</span><span class="token plain">（结合比较运算符）；左边大则返回 1；左边小则返回 -1；相等则为 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`常量数组`</span><span class="token plain">，PHP7 之前只允许类或者接口使用常量数组（也就是说，PHP7 之前只能使用 const 来定义常量数组，之后 define() 这种也可以使用常量数组）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`类常量也可以添加“权限修饰符”`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`iterable伪类型`</span><span class="token plain">，iterable 类型适用于数组，生  成器以及实现了 Traversable 的对象，他是 PHP 中的保留类名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> PHP7 引入了</span><span class="token code-snippet code keyword" style="color:#00009f">`可空类型`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> PHP8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="color:#00009f">`Attributes`</span><span class="token plain">注解</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="laravel-starter">laravel-starter<a href="#laravel-starter" class="hash-link" aria-label="Direct link to laravel-starter" title="Direct link to laravel-starter">  ​</a></h3>
<p>Laravel 的一些坑</p>
<ul>
<li>拿 Laravel 开发时，首先要把缓存关闭，否则上线之后，会出一大堆问题</li>
<li>Laravel 转移文件夹到另一 PC 或者环境后访问出现 500，设置权限为 777</li>
<li>设置路由后页面总是 404 Not Found</li>
<li>php+zipkin</li>
<li>laravel 的 composer 包的 Logger 怎么实现？</li>
<li>单元测试，需要现在 phpunit.xml 里预定义各项配置。如果不使用默认的<code>.env</code>文件，需要通过<code>createApplication()</code>方法指定如<code>.env.dev</code>等配置文件。</li>
</ul>
<hr>
<p>设置路由后页面总是 404 Not Found</p>
<ul>
<li>需要在 apache 配置文件里添加对 Laravel 文件夹的访问</li>
<li>laravel-starter 开发中遇到的问题</li>
<li>dingo 遇到路由前缀问题<!-- -->
<ul>
<li>v 里写了 API_PREFIX=api 之后，路由 url 里必须使用 api 作为前缀，否则 404。</li>
<li>案：使用 API_DOMAIN，而不是 API_PREFIX，在<code>Dingo\Api\Http\Validation\Domain</code>里<code>validate()</code>中打印<code>dd($this-&gt;domain, $request-&gt;header(&#x27;host&#x27;));</code>比较一下。</li>
</ul>
</li>
<li>model 层也需要分模块吗，为了解决 api 版本更迭带来 model 层复用问题</li>
<li>学到了用单元测试来测试 laravel 中间件</li>
</ul>
<hr>
<p>php+zipkin</p>
<ul>
<li>jaeger</li>
<li>zipkin</li>
<li>promethues</li>
</ul>
<p>把这个项目 <a href="https://github.com/Jiannei/lumen-api-starter" target="_blank" rel="noopener noreferrer">Jiannei/lumen-api-starter: Lumen 8 基础上扩展出的 API 启动项目，精心设计的目录结构，规范统一的响应数据格式，Repository 模式架构的最佳实践。</a> 的所有 feature 加进来</p>
<p>参考一下 <a href="https://learnku.com/articles/44675" target="_blank" rel="noopener noreferrer">一份经过时间检验的 Laravel PHPUnit 测试经验分享 | Laravel China 社区</a> 这篇文章 phpunit 的用法，优化测试用例</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/archive">Archive</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2024-10-20T11:18:48.000Z" itemprop="dateModified">Oct 20, 2024</time></b> by <b>XBPk3T</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Archive</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2024/geektime-lessons"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">速读几本极客时间课程</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#gmp" class="table-of-contents__link toc-highlight">GMP</a><ul><li><a href="#进程线程用户态线程" class="table-of-contents__link toc-highlight">进程、线程、用户态线程</a></li><li><a href="#gmp-调度器" class="table-of-contents__link toc-highlight">GMP 调度器</a></li><li><a href="#gmp-changelog" class="table-of-contents__link toc-highlight">GMP changelog</a></li><li><a href="#gmp-运行机制调度流程golang-目前异步抢占的整体流程" class="table-of-contents__link toc-highlight"><em>GMP 运行机制/调度流程：golang 目前异步抢占的整体流程？</em></a></li></ul></li><li><a href="#map" class="table-of-contents__link toc-highlight">map</a><ul><li><a href="#golang-map的实现原理" class="table-of-contents__link toc-highlight">golang map 的实现原理</a><ul><li><a href="#遍历过程" class="table-of-contents__link toc-highlight">遍历过程</a></li></ul></li><li><a href="#扩容机制" class="table-of-contents__link toc-highlight">扩容机制</a></li><li><a href="#缩容机制" class="table-of-contents__link toc-highlight">缩容机制</a></li><li><a href="#swissmaptype" class="table-of-contents__link toc-highlight">SwissMapType</a></li><li><a href="#syncmap" class="table-of-contents__link toc-highlight">sync.Map</a></li><li><a href="#syncmap-1" class="table-of-contents__link toc-highlight">sync.Map</a></li><li><a href="#ref" class="table-of-contents__link toc-highlight">ref</a></li></ul></li><li><a href="#互斥锁-mutex" class="table-of-contents__link toc-highlight">互斥锁 Mutex</a></li><li><a href="#读写锁-rwmutex" class="table-of-contents__link toc-highlight">读写锁 RWMutex</a></li><li><a href="#syncwaitgroup" class="table-of-contents__link toc-highlight">sync.WaitGroup</a></li><li><a href="#golang-内存管理" class="table-of-contents__link toc-highlight">golang 内存管理</a><ul><li><a href="#golang-的内存管理" class="table-of-contents__link toc-highlight"><strong>golang 的内存管理？</strong></a></li><li><a href="#tcmalloc-是什么tcmalloc-怎么进行内存分配" class="table-of-contents__link toc-highlight">TCMalloc 是什么？TCMalloc 怎么进行内存分配？</a></li><li><a href="#内存可见性和-happens-before" class="table-of-contents__link toc-highlight">内存可见性和 happens-before</a></li><li><a href="#golang-内存结构" class="table-of-contents__link toc-highlight">golang 内存结构</a></li></ul></li><li><a href="#golang-others" class="table-of-contents__link toc-highlight">golang others</a><ul><li><a href="#golang-changelog" class="table-of-contents__link toc-highlight">golang CHANGELOG</a></li><li><a href="#process-thread-goroutine-区别" class="table-of-contents__link toc-highlight"><em><strong>process, thread, goroutine 区别</strong></em></a></li><li><a href="#使用-golang-时 可能导致内存泄漏的场景" class="table-of-contents__link toc-highlight"><em>使用 golang 时，可能导致内存泄漏的场景？</em></a></li><li><a href="#common-misuses-of-chan" class="table-of-contents__link toc-highlight"><strong>Common Misuses of chan?</strong></a></li></ul></li><li><a href="#regex" class="table-of-contents__link toc-highlight">regex</a><ul><li><a href="#正则表达式" class="table-of-contents__link toc-highlight">正则表达式</a></li><li><a href="#基础" class="table-of-contents__link toc-highlight">基础</a></li><li><a href="#特殊运算符" class="table-of-contents__link toc-highlight">特殊运算符</a></li><li><a href="#模式修正符" class="table-of-contents__link toc-highlight">模式修正符</a></li><li><a href="#断言零宽度断言" class="table-of-contents__link toc-highlight">断言（零宽度断言）</a></li><li><a href="#unicode" class="table-of-contents__link toc-highlight">unicode</a></li><li><a href="#docker" class="table-of-contents__link toc-highlight">docker</a></li><li><a href="#dtm-分布式事务" class="table-of-contents__link toc-highlight">DTM (分布式事务)</a></li></ul></li><li><a href="#redis" class="table-of-contents__link toc-highlight">redis</a><ul><li><a href="#redis-的-changelog" class="table-of-contents__link toc-highlight">redis 的 CHANGELOG</a></li><li><a href="#redis-服务调优有哪些方法" class="table-of-contents__link toc-highlight"><strong>redis 服务调优，有哪些方法？</strong></a></li></ul></li><li><a href="#跨平台方案" class="table-of-contents__link toc-highlight">跨平台方案</a></li><li><a href="#rbac" class="table-of-contents__link toc-highlight">RBAC</a></li><li><a href="#shop" class="table-of-contents__link toc-highlight">shop</a><ul><li><a href="#sku" class="table-of-contents__link toc-highlight">sku</a></li><li><a href="#购物车" class="table-of-contents__link toc-highlight">购物车</a></li><li><a href="#订单模块" class="table-of-contents__link toc-highlight">订单模块</a></li><li><a href="#营销活动模块" class="table-of-contents__link toc-highlight">营销活动模块</a></li><li><a href="#秒杀" class="table-of-contents__link toc-highlight">秒杀</a></li><li><a href="#聚合支付" class="table-of-contents__link toc-highlight">聚合支付</a></li><li><a href="#支付系统" class="table-of-contents__link toc-highlight">支付系统</a></li></ul></li><li><a href="#dockerfile-最佳实践" class="table-of-contents__link toc-highlight"><em><strong>Dockerfile 最佳实践</strong></em></a><ul><li><a href="#build" class="table-of-contents__link toc-highlight">build</a><ul><li><a href="#减小-image-体积" class="table-of-contents__link toc-highlight">减小 image 体积</a></li><li><a href="#减少-image-层数" class="table-of-contents__link toc-highlight">减少 image 层数</a></li><li><a href="#加快-build-速度" class="table-of-contents__link toc-highlight">加快 build 速度</a></li></ul></li><li><a href="#security" class="table-of-contents__link toc-highlight">security</a><ul><li><a href="#hardware-resource-control-cpu-memory-port-namespace" class="table-of-contents__link toc-highlight">hardware resource control (CPU, memory, port, namespace)</a></li><li><a href="#auth-control" class="table-of-contents__link toc-highlight">Auth control</a></li></ul></li><li><a href="#使用-alpine-基础镜像的常见问题" class="table-of-contents__link toc-highlight">使用 alpine 基础镜像的常见问题？</a><ul><li><a href="#dns-请求超时" class="table-of-contents__link toc-highlight">DNS 请求超时</a></li><li><a href="#docker-下无法解析-hosts" class="table-of-contents__link toc-highlight">Docker 下无法解析 hosts</a></li></ul></li></ul></li><li><a href="#weibo" class="table-of-contents__link toc-highlight">weibo</a><ul><li><a href="#点赞" class="table-of-contents__link toc-highlight">点赞</a></li><li><a href="#feed-流" class="table-of-contents__link toc-highlight">feed 流</a></li><li><a href="#评论" class="table-of-contents__link toc-highlight">评  论</a></li><li><a href="#如何设计一个海量的评论系统算是比较常见的场景题吧" class="table-of-contents__link toc-highlight">如何设计一个海量的评论系统？（算是比较常见的场景题吧）</a></li></ul></li><li><a href="#接口优化" class="table-of-contents__link toc-highlight"><em><strong>接口优化</strong></em></a></li><li><a href="#es6-语法" class="table-of-contents__link toc-highlight"><strong>ES6 语法</strong></a></li><li><a href="#nginx" class="table-of-contents__link toc-highlight">Nginx</a><ul><li><a href="#工作原理运行机制" class="table-of-contents__link toc-highlight"><strong>工作原理/运行机制</strong></a></li><li><a href="#怎么优化-nginx-配置文件有哪些优化项" class="table-of-contents__link toc-highlight">怎么优化 nginx 配置文件？有哪些优化项？</a></li><li><a href="#nginx-安全" class="table-of-contents__link toc-highlight">nginx 安全</a></li><li><a href="#怎么自动设置-nginx-的-worker-process" class="table-of-contents__link toc-highlight">怎么自动设置 nginx 的 worker process？</a></li><li><a href="#nginx-热更新" class="table-of-contents__link toc-highlight">nginx 热更新</a></li></ul></li><li><a href="#董泽润的技术笔记-20231123" class="table-of-contents__link toc-highlight"><em><strong>董泽润的技术笔记 [2023/11/23]</strong></em></a></li><li><a href="#git" class="table-of-contents__link toc-highlight">git</a><ul><li><a href="#怎么给-github-的项目提-pr" class="table-of-contents__link toc-highlight">怎么给 github 的项目提 pr？</a></li><li><a href="#怎么压缩-git-项目" class="table-of-contents__link toc-highlight">怎么压缩 git 项目？</a></li><li><a href="#how-to-delete-commit" class="table-of-contents__link toc-highlight">How to delete commit?</a></li></ul></li><li><a href="#alternate-print" class="table-of-contents__link toc-highlight">alternate-print</a><ul><li><a href="#固定值交替打印" class="table-of-contents__link toc-highlight">固定值交替打印</a></li><li><a href="#多线程数字--字母" class="table-of-contents__link toc-highlight">多线程数字 + 字母</a></li><li><a href="#多线程纯数字打印" class="table-of-contents__link toc-highlight">多线程纯数字打印</a></li></ul></li><li><a href="#爬虫通用问题反爬对抗反爬" class="table-of-contents__link toc-highlight"><em><strong>爬虫通用问题（反爬&amp;对抗反爬）</strong></em></a></li><li><a href="#doc-处理onetab中的网页" class="table-of-contents__link toc-highlight">[doc] 处理OneTab中的网页</a><ul><li><a href="#linux-process-and-thread" class="table-of-contents__link toc-highlight">linux process and thread</a></li><li><a href="#golang-channel" class="table-of-contents__link toc-highlight">golang channel</a></li></ul></li><li><a href="#others" class="table-of-contents__link toc-highlight">Others</a><ul><li><a href="#怎么从服务抖动推测具体问题怎么排查排查顺序" class="table-of-contents__link toc-highlight">怎么从服务抖动，推测具体问题？怎么排查（排查顺序）？</a></li><li><a href="#js-process" class="table-of-contents__link toc-highlight">js process</a></li><li><a href="#交易平台" class="table-of-contents__link toc-highlight">交易平台</a></li><li><a href="#swap" class="table-of-contents__link toc-highlight">swap</a></li><li><a href="#怎么在本地执行远程-vps-上的远程脚本" class="table-of-contents__link toc-highlight">怎么在本地执行远程 vps 上的远程脚本？</a></li><li><a href="#服务管理工具-systemd" class="table-of-contents__link toc-highlight"><del>服务管理工具 systemd</del></a></li><li><a href="#怎么用-ssh-连接服务器" class="table-of-contents__link toc-highlight">怎么用 ssh 连接服务器？</a></li><li><a href="#跳板机" class="table-of-contents__link toc-highlight">跳板机</a></li><li><a href="#cdn-ip" class="table-of-contents__link toc-highlight">CDN IP</a></li><li><a href="#服务器性能优化" class="table-of-contents__link toc-highlight">服务器性能优化</a></li><li><a href="#做过的项目" class="table-of-contents__link toc-highlight">做过的项目</a></li><li><a href="#web-框架对比" class="table-of-contents__link toc-highlight">web 框架对比？</a></li><li><a href="#数据分析" class="table-of-contents__link toc-highlight"><del>数据分析</del></a></li><li><a href="#io-流并发" class="table-of-contents__link toc-highlight"><strong>IO 流并发</strong></a></li><li><a href="#bitmapast-实现配置化时长系统" class="table-of-contents__link toc-highlight"><strong>bitmap+AST 实现配置化时长系统</strong></a></li><li><a href="#blog-数据系统那些事" class="table-of-contents__link toc-highlight">[blog] 数据系统那些事</a></li><li><a href="#git-tag" class="table-of-contents__link toc-highlight">git tag</a></li><li><a href="#阿里云-oss-想更省钱怎么操作" class="table-of-contents__link toc-highlight">阿里云 OSS 想更省钱，怎么操作？</a></li><li><a href="#怎么优化字符串和-bytes-切片互相转换" class="table-of-contents__link toc-highlight">怎么优化字符串和 bytes 切片互相转换？</a></li><li><a href="#持续部署-cd" class="table-of-contents__link toc-highlight">持续部署 CD</a></li><li><a href="#进程的内存占用" class="table-of-contents__link toc-highlight">进程的内存占用？</a></li><li><a href="#内核分析工具-bcc-和-ebpf" class="table-of-contents__link toc-highlight">内核分析工具 BCC 和 eBPF</a></li><li><a href="#zzz" class="table-of-contents__link toc-highlight">zzz</a></li><li><a href="#app-能获取数据但是抓包软件抓不到数据为什么" class="table-of-contents__link toc-highlight">app 能获取数据，但是抓包软件抓不到数据，为什么？</a></li><li><a href="#框架-元框架-脚手架" class="table-of-contents__link toc-highlight">框架 元框架 脚手架</a></li><li><a href="#ack-ask" class="table-of-contents__link toc-highlight">ACK, ASK</a></li><li><a href="#简述-vi-或者-vim-修改文件过程" class="table-of-contents__link toc-highlight">简述 vi 或者 vim 修改文件过程</a></li><li><a href="#一些类比" class="table-of-contents__link toc-highlight">一些类比</a></li><li><a href="#web-安全基础pwn" class="table-of-contents__link toc-highlight">web 安全基础（pwn）</a></li><li><a href="#哲学家就餐问题" class="table-of-contents__link toc-highlight">哲学家就餐问题</a></li><li><a href="#使用-containerd-和-docker-有什么区别" class="table-of-contents__link toc-highlight">使用 containerd 和 docker 有什么区别？</a></li><li><a href="#data-center" class="table-of-contents__link toc-highlight">Data Center</a></li><li><a href="#并发编程常见问题" class="table-of-contents__link toc-highlight"><em><strong>并发编程常见问题？</strong></em></a></li><li><a href="#分布式场景常见问题" class="table-of-contents__link toc-highlight"><em><strong>分布式场景常见问题</strong></em></a></li><li><a href="#怎么进行技术选型" class="table-of-contents__link toc-highlight"><em><strong>怎么进行技术选型？</strong></em></a></li><li><a href="#xxx-怎么优化-centos7" class="table-of-contents__link toc-highlight"><em><strong>[xxx] 怎么优化 CentOS7？</strong></em></a></li><li><a href="#doc-myspace-20231123" class="table-of-contents__link toc-highlight"><em><strong>[doc] MySpace [2023/11/23]</strong></em></a></li><li><a href="#top" class="table-of-contents__link toc-highlight"><strong>top</strong></a></li><li><a href="#分布式" class="table-of-contents__link toc-highlight"><em><strong>分布式</strong></em></a></li><li><a href="#社交项目-lbs-social" class="table-of-contents__link toc-highlight">社交项目 LBS-social</a></li><li><a href="#冯诺依曼体系" class="table-of-contents__link toc-highlight">冯诺依曼体系</a></li><li><a href="#mmap" class="table-of-contents__link toc-highlight">mmap</a></li><li><a href="#cmd-和-entrypoint" class="table-of-contents__link toc-highlight">CMD 和 ENTRYPOINT</a></li><li><a href="#lotabout" class="table-of-contents__link toc-highlight">lotabout</a></li><li><a href="#btree-bptree" class="table-of-contents__link toc-highlight">btree, bptree</a></li><li><a href="#极客时间golang-面试题pdf20231127-am" class="table-of-contents__link toc-highlight">极客时间《golang 面试题.pdf》[2023/11/27 AM]</a></li><li><a href="#zzz-1" class="table-of-contents__link toc-highlight">zzz</a></li><li><a href="#链表hashmap" class="table-of-contents__link toc-highlight">链表+HashMap</a></li><li><a href="#分布式锁-核心需求" class="table-of-contents__link toc-highlight">分布式锁 核心需求</a></li><li><a href="#redis-分布式锁-方案演进" class="table-of-contents__link toc-highlight"><em>redis 分布式锁 方案演进</em></a></li><li><a href="#redlock" class="table-of-contents__link toc-highlight">RedLock</a></li><li><a href="#golang-nethttp" class="table-of-contents__link toc-highlight">golang net/http</a></li><li><a href="#浏览器相关" class="table-of-contents__link toc-highlight">浏览器相关</a></li></ul></li><li><a href="#php" class="table-of-contents__link toc-highlight">PHP</a></li><li><a href="#php-函数" class="table-of-contents__link toc-highlight">PHP 函数</a><ul><li><a href="#数组相关函数" class="table-of-contents__link toc-highlight">数组相关函数</a></li><li><a href="#字符串相关函数" class="table-of-contents__link toc-highlight">字符串相关函数</a></li><li><a href="#数字相关函数" class="table-of-contents__link toc-highlight">数字相关函数</a></li><li><a href="#文件相关函数" class="table-of-contents__link toc-highlight">文件相关函数</a></li><li><a href="#变量" class="table-of-contents__link toc-highlight">变量</a></li><li><a href="#修饰符" class="table-of-contents__link toc-highlight">修饰符</a></li><li><a href="#php-运算符" class="table-of-contents__link toc-highlight">PHP 运算符</a></li><li><a href="#php-的-changelog" class="table-of-contents__link toc-highlight">PHP 的 changelog</a></li><li><a href="#laravel-starter" class="table-of-contents__link toc-highlight">laravel-starter</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Docs. Built with Docusaurus. Hosted by Github & Cloudflare.</div></div></div></footer></div>
</body>
</html>